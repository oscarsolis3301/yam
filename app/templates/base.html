<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/search-highlight.css') }}">
    <script src="{{ url_for('static', filename='JS/search-highlight.js') }}"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="YAM Dashboard - Yet Another Module">
    <meta name="application-name" content="YAM Dashboard">
    <meta name="apple-mobile-web-app-title" content="YAM">
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    <!-- Comprehensive Favicon Setup for YAM -->
    <!-- Standard favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/Y.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/Y.png') }}">
    
    <!-- Apple Touch Icon for iOS devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="144x144" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="120x120" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="114x114" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="72x72" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="60x60" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="apple-touch-icon" sizes="57x57" href="{{ url_for('static', filename='images/Y.png') }}">
    
    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/Y.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='images/Y.png') }}">
    
    <!-- Windows Tiles -->
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='images/Y.png') }}">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('YAM Service Worker registered successfully:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('YAM Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <!-- Google Fonts - Orbitron for cyberpunk theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Custom CSS (ensure this is after Bootstrap) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}">
    
    <!-- Bootstrap JavaScript -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script> -->
    
    <!-- Session Monitor -->
    <script src="{{ url_for('static', filename='JS/session_monitor.js') }}"></script>
    
    <!-- Custom CSS -->
    <style>
        :root {
            --bs-body-bg: #0a0a0a;
            --bs-body-color: #fff;
        }
        body {
            background: #0a0a0a !important;
            color: #fff !important;
            overflow-x: hidden !important;
            max-width: 100vw !important;
        }
        
        html {
            overflow-x: hidden !important;
            max-width: 100vw !important;
        }
        
        /* Mac-style Window Controls */
        .window-controls {
          position: fixed;
          top: 20px;
          left: 20px;
          display: flex;
          gap: 8px;
          z-index: 10000;
          -webkit-app-region: no-drag;
        }
        
        /* Ensure window controls don't interfere with YAM layout */
        .yam-page .window-controls {
          z-index: 9999998 !important;
        }
        
        .window-control {
          width: 12px;
          height: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.15s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 8px;
          font-weight: bold;
          color: rgba(0, 0, 0, 0.6);
          border: 0.5px solid rgba(0, 0, 0, 0.1);
          position: relative;
          backdrop-filter: blur(10px);
        }
        
        .window-control:hover {
          transform: scale(1.1);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .window-control.close {
          background: linear-gradient(135deg, #ff5f57 0%, #ff4444 100%);
        }
        
        .window-control.close:hover {
          background: linear-gradient(135deg, #ff6b63 0%, #ff5555 100%);
        }
        
        .window-control.close:hover:after {
          content: '×';
          position: absolute;
          color: rgba(0, 0, 0, 0.8);
          font-size: 10px;
          font-weight: bold;
        }
        
        .window-control.minimize {
          background: linear-gradient(135deg, #ffbd2e 0%, #ffaa00 100%);
        }
        
        .window-control.minimize:hover {
          background: linear-gradient(135deg, #ffce4a 0%, #ffbb22 100%);
        }
        
        .window-control.minimize:hover:after {
          content: '−';
          position: absolute;
          color: rgba(0, 0, 0, 0.8);
          font-size: 10px;
          font-weight: bold;
          line-height: 1;
        }
        
        .window-control:active {
          transform: scale(0.95);
        }
        
        /* Adjust main content to account for window controls*/
        /*.main-content {
            margin-top: 50px;
        }*/
        
        /* Remove top margin for YAM pages to eliminate extra gaps */
        .yam-page .main-content,
        .yam-dashboard-minimal .main-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* Ensure YAM pages have no extra spacing anywhere */
        .yam-page {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .yam-page body,
        .yam-page html {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Force zero spacing on all elements for YAM pages */
        .yam-page * {
            box-sizing: border-box;
        }
        
        /* Ensure outage banner starts exactly at top */
        .yam-page .outage-banner {
            top: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure main content starts immediately after banner */
        .yam-page .main-content.with-outage-banner {
            padding-top: 56px !important;
            margin-top: 0 !important;
        }
        
        /* Ensure YAM page wrapper has proper positioning */
        .yam-page {
            position: relative !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Comprehensive fix for YAM page spacing - ensure no gaps anywhere */
        .yam-page,
        .yam-page *,
        .yam-page *::before,
        .yam-page *::after {
            box-sizing: border-box;
        }
        
        .yam-page .yam-dashboard-minimal {
            margin: 0 !important;
            padding: 0 !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
        }
        
        .yam-page .yam-dashboard-content {
            margin: 0 !important;
            padding: 2rem !important;
            top: 0 !important;
        }
        
        .yam-page .yam-welcome-section {
            margin: 0 !important;
            padding: 1.5rem !important;
        }
        
        /* Final comprehensive fix - ensure no gaps anywhere on YAM pages */
        .yam-page {
            /* Reset all spacing */
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            outline: 0 !important;
            
            /* Ensure proper positioning */
            position: relative !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 100% !important;
            
            /* Ensure no overflow */
            overflow: visible !important;
        }
        
        /* Ensure all child elements have proper box-sizing */
        .yam-page *,
        .yam-page *::before,
        .yam-page *::after {
            box-sizing: border-box !important;
        }
        
        /* Ensure outage banner is exactly at top */
        .yam-page .outage-banner {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 900 !important;
        }
        
        /* Ensure sidebar is exactly at top */
        .yam-page .sidebar-fixed {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 9999999 !important;
        }
        
        /* Ensure main content has no top margin */
        .yam-page .main-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* Ensure main content with outage banner has correct padding */
        .yam-page .main-content.with-outage-banner {
            padding-top: 56px !important;
            margin-top: 0 !important;
        }
        
        /* Ultimate fix - reset everything for YAM pages */
        .yam-page,
        .yam-page *,
        .yam-page *::before,
        .yam-page *::after {
            /* Reset all spacing */
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            outline: 0 !important;
            box-sizing: border-box !important;
        }
        
        /* Specific positioning for key elements */
        .yam-page .outage-banner {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 900 !important;
        }
        
        .yam-page .sidebar-fixed {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999999 !important;
        }
        
        .yam-page .main-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .yam-page .yam-dashboard-minimal {
            margin-top: 0 !important;
            padding-top: 0 !important;
            top: 0 !important;
        }
        
        /* Ensure proper padding for content areas */
        .yam-page .yam-dashboard-content {
            padding: 2rem !important;
        }
        
        .yam-page .yam-welcome-section {
            padding: 1.5rem !important;
        }
        

        
        
        .marquee-container {
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        
        .marquee-text {
            display: inline-block;
            animation: marquee 20s linear infinite;
            white-space: nowrap;
            font-weight: bold;
            padding-left: 100%;
            font-size: 1.1rem;
        }
        
        .marquee-text i {
            margin-right: 8px;
            animation: blink 1s infinite alternate;
        }
        
        @keyframes blink {
            from { opacity: 1; }
            to { opacity: 0.4; }
        }
        
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        /* Outage Modal Styles */
        .outage-modal .modal-content {
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .outage-modal .modal-header {
            border-bottom: 1px solid #333;
        }
        
        .outage-modal .modal-footer {
            border-top: 1px solid #333;
        }
        
        .outage-details {
            padding: 1rem;
        }
        
        .outage-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active { background-color: #dc3545; }
        .status-resolved { background-color: #28a745; }
        .status-scheduled { background-color: #ffc107; }

        .main-content.with-outage-banner {
            padding-top: 90px !important;
            transition: padding-top 0.2s;
            /* Ensure sidebar is not affected */
            margin-left: 3.5rem !important;
        }
        
        /* Add spacing for the sidebar banner */
        .main-content {
            margin-left: 3.5rem !important;
            padding-top: 80px !important; /* Height of sidebar banner */
            transition: padding-top 0.2s;
            /* Prevent horizontal scrollbar */
            overflow-x: hidden;
            max-width: calc(100vw - 3.5rem);
        }
        
        /* When outage banner is present, add extra padding */
        .main-content.with-outage-banner {
            padding-top: 170px !important; /* 80px (sidebar banner) + 90px (outage banner) */
        }
        @media (max-width: 768px) {
            .main-content.with-outage-banner {
                padding-top: 136px !important; /* 80px (sidebar banner) + 56px (outage banner) */
            }
            
            .main-content {
                padding-top: 80px !important; /* Height of sidebar banner */
            }
        }
        
        /* Global horizontal scrollbar prevention */
        html, body {
            overflow-x: hidden !important;
            max-width: 100vw !important;
        }
        
        /* Ensure all pages respect the sidebar space */
        .page-container {
            margin-left: 0 !important;
            padding-left: 1rem !important;
            max-width: calc(100vw - 3.5rem - 2rem) !important;
            overflow-x: hidden !important;
        }
        
        /* Ensure sidebar is never affected by main content changes */
        .sidebar-fixed {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999999 !important;
        }
        
        /* Comprehensive layout fixes for all pages */
        .container, .container-fluid {
            max-width: calc(100vw - 3.5rem - 2rem) !important;
            overflow-x: hidden !important;
        }
        
        .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: 100% !important;
        }
        
        .col, .col-1, .col-2, .col-3, .col-4, .col-5, .col-6, 
        .col-7, .col-8, .col-9, .col-10, .col-11, .col-12 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        /* Ensure all content areas respect the sidebar */
        .content-area, .main-content-area, .page-content {
            margin-left: 0 !important;
            padding-left: 1rem !important;
            max-width: calc(100vw - 3.5rem - 2rem) !important;
            overflow-x: hidden !important;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Mac-style Window Controls -->
    <div class="window-controls">
        <div class="window-control close" id="closeBtn" title="Close"></div>
        <div class="window-control minimize" id="minimizeBtn" title="Minimize"></div>
    </div>
    
    {% include "sidebar.html" %}
    
    <!-- Universal Search Component -->
    {% include "components/universal_search.html" %}
    
    <!-- VNC Viewer Component for Browser-based Remote Access -->
    {% include "components/vnc_viewer.html" %}
    
    <!-- Include Outage Banner Component (exclude for main index page) -->
    {% if request.endpoint and 'main.index' not in request.endpoint %}
        {% include "components/outage_banner.html" %}
    {% endif %}
    <div class="main-content" id="mainContent">
        {% block content %}{% endblock %}
    </div>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script> -->
    <!-- Socket.IO and YAM Socket Manager -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='JS/socket-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='JS/session-monitor.js') }}"></script>
    <script>
        // Initialize YAM Socket Manager
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.yamSocketManager) {
                window.yamSocketManager = new YAMSocketManager();
                console.log('YAM Socket Manager initialized in base template');
            }
            
            // Check for outages on page load
            fetch('/api/admin/outages')
                .then(res => res.json())
                .then(outages => {
                    const banner = document.getElementById('outageBanner');
                    if (banner) {
                        // CRITICAL: Don't affect YAM pages with outage banner logic
                        const isYamPage = document.querySelector('.yam-page') !== null;
                        if (isYamPage) {
                            console.log('Base Template: YAM page detected - skipping outage banner positioning');
                            return; // Don't run outage banner logic on YAM pages
                        }
                        
                        if (outages && outages.length > 0) {
                            // Show banner with outage information
                            const bannerText = document.getElementById('outageBannerText');
                            if (bannerText) {
                                bannerText.textContent = `Active Outage: ${outages[0].title} - ${outages[0].description}`;
                            }
                            banner.style.display = 'block';
                            banner.dataset.outageData = JSON.stringify(outages[0]);
                            banner.className = 'outage-banner alert alert-danger';
                        } else {
                            // Hide banner when no outages exist
                            banner.style.display = 'none';
                            banner.dataset.outageData = '';
                        }
                    }
                })
                .catch(err => {
                    console.error('Error fetching outages on page load:', err);
                    // Hide banner on error
                    const banner = document.getElementById('outageBanner');
                    if (banner) {
                        banner.style.display = 'none';
                    }
                });
            
            // Get socket instance for outage handling
            const socket = window.yamSocketManager.socket;
            
            // Request current outages on connection
            socket.on('connect', () => {
                fetch('/api/admin/outages')
                    .then(res => res.json())
                    .then(outages => {
                        const banner = document.getElementById('outageBanner');
                        const bannerText = document.getElementById('outageBannerText');
                        
                        // CRITICAL: Don't affect YAM pages with outage banner logic
                        const isYamPage = document.querySelector('.yam-page') !== null;
                        if (isYamPage) {
                            console.log('Base Template: YAM page detected - skipping outage banner positioning');
                            return; // Don't run outage banner logic on YAM pages
                        }
                        
                        if (banner && bannerText) {
                            if (outages && outages.length > 0) {
                                // Show banner with outage information
                                bannerText.textContent = `Active Outage: ${outages[0].title} - ${outages[0].description}`;
                                banner.style.display = 'block';
                                banner.dataset.outageData = JSON.stringify(outages[0]);
                                // Preserve the mode class when updating
                                const isElectron = banner.classList.contains('electron-mode');
                                const isWeb = banner.classList.contains('web-mode');
                                banner.className = 'outage-banner alert alert-danger';
                                if (isElectron) banner.classList.add('electron-mode');
                                if (isWeb) banner.classList.add('web-mode');
                            } else {
                                // Hide banner when no outages exist
                                banner.style.display = 'none';
                                banner.dataset.outageData = '';
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching outages:', err);
                        // Hide banner on error
                        const banner = document.getElementById('outageBanner');
                        if (banner) {
                            banner.style.display = 'none';
                            banner.dataset.outageData = '';
                        }
                    });
            });

            // Outage event handlers - only handle if not already handled by page-specific code
            if (!window.outageHandlersInitialized) {
                socket.on('new_outage_announcement', (data) => {
                    console.log('New outage announcement received:', data);
                    const banner = document.getElementById('outageBanner');
                    const bannerText = document.getElementById('outageBannerText');
                    
                    // CRITICAL: Don't affect YAM pages with outage banner logic
                    const isYamPage = document.querySelector('.yam-page') !== null;
                    if (isYamPage) {
                        console.log('Base Template: YAM page detected - skipping outage announcement positioning');
                        // Still show toast notification for YAM pages
                        if (typeof showToast === 'function') {
                            showToast(`New outage alert: ${data.title}`, 'warning');
                        }
                        return; // Don't run outage banner logic on YAM pages
                    }
                    
                    if (data && banner && bannerText) {
                        bannerText.textContent = `Active Outage: ${data.title} - ${data.description}`;
                        banner.style.display = 'block';
                        banner.dataset.outageData = JSON.stringify(data);
                        // Preserve the mode class when updating
                        const isElectron = banner.classList.contains('electron-mode');
                        const isWeb = banner.classList.contains('web-mode');
                        banner.className = 'outage-banner alert alert-danger';
                        if (isElectron) banner.classList.add('electron-mode');
                        if (isWeb) banner.classList.add('web-mode');
                        
                        // Show toast notification for all users
                        if (typeof showToast === 'function') {
                            showToast(`New outage alert: ${data.title}`, 'warning');
                        }
                    }
                });

                socket.on('outage_resolved', (data) => {
                    console.log('Outage resolved:', data);
                    const banner = document.getElementById('outageBanner');
                    const bannerText = document.getElementById('outageBannerText');
                    const currentOutage = banner && banner.dataset.outageData ? JSON.parse(banner.dataset.outageData) : null;
                    
                    // CRITICAL: Don't affect YAM pages with outage banner logic
                    const isYamPage = document.querySelector('.yam-page') !== null;
                    if (isYamPage) {
                        console.log('Base Template: YAM page detected - skipping outage resolution positioning');
                        // Still show toast notification for YAM pages
                        if (typeof showToast === 'function') {
                            showToast(`Outage resolved: ${data.title}`, 'success');
                        }
                        return; // Don't run outage banner logic on YAM pages
                    }
                    
                    if (currentOutage && currentOutage.id === data.id && banner && bannerText) {
                        // Preserve the mode class when updating
                        const isElectron = banner.classList.contains('electron-mode');
                        const isWeb = banner.classList.contains('web-mode');
                        banner.className = 'outage-banner alert alert-success';
                        if (isElectron) banner.classList.add('electron-mode');
                        if (isWeb) banner.classList.add('web-mode');
                        bannerText.textContent = `Resolved Outage: ${data.title} - ${data.description}`;
                        
                        // Show toast notification for all users
                        if (typeof showToast === 'function') {
                            showToast(`Outage resolved: ${data.title}`, 'success');
                        }
                        
                        // Hide the banner after 5 seconds and clear data
                        setTimeout(() => {
                            banner.style.display = 'none';
                            banner.dataset.outageData = '';
                        }, 5000);
                    }
                });

                socket.on('outage_modified', (data) => {
                    console.log('Outage modified:', data);
                    const banner = document.getElementById('outageBanner');
                    const bannerText = document.getElementById('outageBannerText');
                    const currentOutage = banner && banner.dataset.outageData ? JSON.parse(banner.dataset.outageData) : null;
                    
                    if (currentOutage && currentOutage.id === data.id && banner && bannerText) {
                        bannerText.textContent = `Active Outage: ${data.title} - ${data.description}`;
                        banner.dataset.outageData = JSON.stringify(data);
                        // Preserve the mode class when updating
                        const isElectron = banner.classList.contains('electron-mode');
                        const isWeb = banner.classList.contains('web-mode');
                        banner.className = 'outage-banner alert alert-danger';
                        if (isElectron) banner.classList.add('electron-mode');
                        if (isWeb) banner.classList.add('web-mode');
                        
                        // Show toast notification for all users
                        if (typeof showToast === 'function') {
                            showToast(`Outage updated: ${data.title}`, 'info');
                        }
                    }
                });

                socket.on('outage_deleted', (data) => {
                    console.log('Outage deleted:', data);
                    const banner = document.getElementById('outageBanner');
                    const currentOutage = banner && banner.dataset.outageData ? JSON.parse(banner.dataset.outageData) : null;
                    
                    if (currentOutage && currentOutage.id === data.id && banner) {
                        banner.style.display = 'none';
                        banner.dataset.outageData = '';
                        
                        // Show toast notification for all users
                        if (typeof showToast === 'function') {
                            showToast(`Outage deleted: ${currentOutage.title}`, 'info');
                        }
                    }
                });

                window.outageHandlersInitialized = true;
            }
        });
    </script>

<!-- put this in your base template (e.g. base.html), *after* Bootstrap's JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const banner   = document.getElementById('outageBanner');
  const modalEl  = document.getElementById('outageDetailsModal');
  if (!banner || !modalEl) return;

  // initialize the Bootstrap modal once
  const outageModal = new bootstrap.Modal(modalEl);

  // cache all modal fields
  const statusEl   = modalEl.querySelector('#modalOutageStatus');
  const titleEl    = modalEl.querySelector('#modalOutageTitle');
  const descEl     = modalEl.querySelector('#modalOutageDescription');
  const startEl    = modalEl.querySelector('#modalOutageStart');
  const durationEl = modalEl.querySelector('#modalOutageDuration');
  const systemsEl  = modalEl.querySelector('#modalOutageSystems');
  const ticketEl   = modalEl.querySelector('#modalOutageTicket');

  banner.addEventListener('click', () => {
    let data;
    try {
      data = JSON.parse(banner.dataset.outageData || '{}');
    } catch (err) {
      console.error('Invalid outage data JSON:', err);
      return;
    }

    const {
      title = '',
      description = 'No description provided',
      start_time,
      end_time,
      affected_systems,
      ticket_id,
      status = 'active'
    } = data;

    if (!title) return;

    // populate the modal
    statusEl.className = `outage-status status-${status}`;
    titleEl.textContent = title;
    descEl.textContent  = description;
    startEl.textContent = start_time
      ? new Date(start_time).toLocaleString()
      : 'Unknown';
    durationEl.textContent = end_time
      ? `${((new Date(end_time) - new Date(start_time)) / 60000).toFixed(0)} min`
      : 'Ongoing';
    systemsEl.textContent = affected_systems || 'All systems';
    ticketEl.textContent  = ticket_id
      ? `Ticket ID: ${ticket_id}`
      : '';

    outageModal.show();
  });
});
</script>
    <!-- Window Controls JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Only show window controls in Electron environment
            if (window.electronAPI) {
                const closeBtn = document.getElementById('closeBtn');
                const minimizeBtn = document.getElementById('minimizeBtn');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        window.electronAPI.closeApp();
                    });
                }
                
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', () => {
                        window.electronAPI.minimizeWindow();
                    });
                }
            } else {
                // Hide window controls in web browser
                const windowControls = document.querySelector('.window-controls');
                if (windowControls) {
                    windowControls.style.display = 'none';
                }
            }
        });
    </script>
    
    <!-- Session Monitor for enhanced session stability -->
    <script src="{{ url_for('static', filename='JS/session_monitor.js') }}"></script>
    
    <!-- Server Shutdown Handler for forced re-authentication -->
    <script src="{{ url_for('static', filename='JS/server-shutdown-handler.js') }}"></script>
    
    {% block scripts %}{% endblock %}
    
    {% if current_user and current_user.is_authenticated %}
    <script>
        window.CURRENT_USER_ID = parseInt('{{ current_user.id }}');
    </script>
    {% endif %}

    <!-- Global User Activity Tracker -->
    <script>
    (function() {
        // Avoid redefining if a page already provided its own implementation (e.g., dashboard_utilities)
        if (window.trackUserActivity) return;

        /**
         * Send an activity event to the backend for persistence.
         * @param {string} action - Short identifier such as "page_view", "search", etc.
         * @param {string} details - Optional free-form details (e.g., URL, search term).
         */
        window.trackUserActivity = function(action, details = '') {
            if (!action) return;
            try {
                fetch('/api/activity/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, details: details || window.location.pathname })
                }).catch(() => {/* non-blocking */});
            } catch (_) { /* swallow silently */ }
        };

        // Track the initial page view once DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const pageLabel = (document.title ? document.title + ' ' : '') + '(' + window.location.pathname + ')';
            trackUserActivity('page_view', pageLabel.trim());
        });

        // Track clicks on Universal Search result or suggestion items
        document.addEventListener('click', function(evt) {
            const searchContainer = document.getElementById('universalSearchContainer');
            if (!searchContainer) return;
            const item = evt.target.closest('.result-item');
            if (item && searchContainer.contains(item)) {
                // Attempt to extract a readable label for logging
                let label = (item.textContent || '').trim().substring(0, 200);
                trackUserActivity('search', label);
            }
        }, true);
    })();
    </script>
    
    <!-- Chat History Button Force Visibility -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Base template: Checking for chat history button...');
            
            // Function to force show chat history button
            function forceShowChatHistoryButton() {
                const chatHistoryBtn = document.getElementById('chat-history-btn');
                if (chatHistoryBtn) {
                    console.log('Base template: Found chat history button, forcing visibility...');
                    
                    // Force all visibility properties
                    chatHistoryBtn.style.display = 'flex';
                    chatHistoryBtn.style.visibility = 'visible';
                    chatHistoryBtn.style.opacity = '1';
                    chatHistoryBtn.style.backgroundColor = '#dc3545';
                    chatHistoryBtn.style.color = 'white';
                    chatHistoryBtn.style.borderColor = '#dc3545';
                    chatHistoryBtn.style.fontSize = '1.2rem';
                    chatHistoryBtn.style.minWidth = '40px';
                    chatHistoryBtn.style.height = '40px';
                    chatHistoryBtn.style.borderRadius = '8px';
                    chatHistoryBtn.style.boxShadow = '0 2px 4px rgba(220, 53, 69, 0.3)';
                    chatHistoryBtn.style.zIndex = '9999';
                    chatHistoryBtn.style.position = 'relative';
                    chatHistoryBtn.style.animation = 'pulse-red 2s infinite';
                    
                    console.log('Base template: Chat history button forced to be visible');
                } else {
                    console.log('Base template: Chat history button not found yet');
                }
            }
            
            // Try immediately
            forceShowChatHistoryButton();
            
            // Try again after a short delay
            setTimeout(forceShowChatHistoryButton, 100);
            setTimeout(forceShowChatHistoryButton, 500);
            setTimeout(forceShowChatHistoryButton, 1000);
            
            // Also try when chat widget opens
            const chatToggle = document.getElementById('chat-toggle');
            if (chatToggle) {
                chatToggle.addEventListener('click', function() {
                    setTimeout(forceShowChatHistoryButton, 100);
                });
            }
            
            // Watch for DOM changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.id === 'chat-history-btn') {
                                console.log('Base template: Chat history button added to DOM');
                                setTimeout(forceShowChatHistoryButton, 50);
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html> 