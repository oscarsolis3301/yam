<!-- User Profile Sidebar -->
<div class="sidebar-content">
    <!-- Enhanced Quick Reminders Widget - Now Above Profile -->
    <div class="widget reminder-widget-expanded">
        <div class="widget-header">
            <h3><i class="bi bi-bell-fill"></i> Quick Reminders</h3>
            <div class="widget-header-actions">
                <button class="widget-action-btn calendar-btn" onclick="openCalendarModal()" title="Open Calendar">
                    <i class="bi bi-calendar3"></i>
                </button>
                <button class="widget-action-btn add-btn" onclick="openReminderModal()" title="Add New Reminder">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
        <div class="widget-content expanded-content">
            <div id="expandedRemindersList" class="reminders-list-expanded">
                <div class="loading-reminders">
                    <div class="loading-spinner"></div>
                    <p>Loading reminders...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Card -->
    <div class="card user-profile">
        <div class="profile-avatar" id="profileAvatar">
            {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename='uploads/profile_pictures/' + current_user.profile_picture) }}" 
                     alt="Profile Picture" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     class="profile-image">
                <span class="profile-fallback" style="display: none;">{{ current_user.username[0].upper() }}</span>
            {% else %}
                <span class="profile-fallback">{{ current_user.username[0].upper() }}</span>
            {% endif %}
        </div>
        <div class="profile-name" id="profileName">{{ current_user.username.title() }}</div>
        <div class="profile-role" id="profileRole">{{ current_user.role.title() if current_user.role else 'User' }}</div>
        
        <div class="recent-activity">
            <h4 style="color: #ffffff; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">
                Recent Activity
            </h4>
            <div id="totalActivitiesCount" style="
                color: #888;
                font-size: 0.85rem;
                text-align: center;
                padding: 0.3rem;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 6px;
                border: 1px solid rgba(255, 255, 255, 0.05);
                font-weight: 500;
                margin-bottom: 0.8rem;
            ">
                Loading...
            </div>
            <div id="recentActivity">
                <div class="no-data">Loading activity...</div>
            </div>
        </div>
        <!-- View All Activity Button - Positioned outside the scrollable area -->
        <div class="view-all-activity-container">
            <button onclick="openActivityModal()" class="view-all-activity-btn">
                <i class="bi bi-clock-history"></i>
                View All Activity
            </button>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div id="activityModal" class="activity-modal">
    <div class="activity-modal-content">
        <div class="activity-modal-header">
            <h3><i class="bi bi-clock-history"></i> Activity History</h3>
            <button class="activity-modal-close" onclick="closeActivityModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="activity-modal-body">
            <div class="activity-filters">
                <select id="activityFilter" onchange="filterActivity(this.value)">
                    <option value="all">All Activities</option>
                    <option value="login">Logins</option>
                    <option value="page_view">Page Views</option>
                    <option value="search">Searches</option>
                    <option value="file_upload">File Uploads</option>
                    <option value="settings_changed">Settings Changes</option>
                </select>
                <div class="activity-search">
                    <input type="text" id="activitySearch" placeholder="Search activities..." onkeyup="searchActivity(this.value)">
                    <i class="bi bi-search"></i>
                </div>
            </div>
            <div id="activityList" class="activity-list">
                <div class="activity-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading activity history...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Sidebar Content Layout */
.sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    width: 100%;
    height: 100%;
}

/* Hide ALL scrollbars in the entire sidebar content */
.sidebar-content * {
    -ms-overflow-style: none !important; /* Internet Explorer 10+ */
    scrollbar-width: none !important; /* Firefox */
}

.sidebar-content *::-webkit-scrollbar {
    display: none !important; /* Safari and Chrome */
    width: 0 !important;
    height: 0 !important;
}

/* Enhanced Profile Avatar */
.profile-avatar {
    width: 80px; /* Further reduced avatar size */
    height: 80px; /* Further reduced avatar size */
    border-radius: 50%;
    margin: 0 auto 0.8rem; /* Further reduced bottom margin */
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem; /* Further reduced font size */
    font-weight: 800;
    border: 4px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.profile-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 32px rgba(0, 212, 255, 0.4);
}

.profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.profile-fallback {
    color: #ffffff;
    font-size: 2rem; /* Match the smaller avatar size */
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

.profile-name {
    color: #ffffff;
    font-size: 1.2rem; /* Slightly smaller font */
    font-weight: 700;
    text-align: center;
    margin-bottom: 0.25rem; /* Further reduced bottom margin */
}

.profile-role {
    color: #cccccc;
    font-size: 0.9rem; /* Slightly smaller font */
    text-align: center;
    margin-bottom: 0.8rem; /* Further reduced bottom margin */
    padding: 0.4rem 0.9rem; /* Slightly reduced padding */
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: inline-block;
    margin-left: auto;
    margin-right: auto;
}

/* Sidebar Reminders Widget */
.reminder-widget-sidebar {
    background: rgba(15, 15, 15, 0.95);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    margin-top: 0;
}

.reminder-widget-sidebar:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
}

.reminder-widget-sidebar .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.02);
}

.reminder-widget-sidebar .widget-header h3 {
    color: #ffffff;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.reminder-widget-sidebar .widget-action-btn {
    background: rgba(0, 212, 255, 0.1);
    border: 1px solid rgba(0, 212, 255, 0.3);
    color: #00d4ff;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
}

.reminder-widget-sidebar .widget-action-btn:hover {
    background: rgba(139, 92, 246, 0.2) !important;
    border-color: #8B5CF6 !important;
    color: #8B5CF6 !important;
    transform: scale(1.1) !important;
}

.reminder-widget-sidebar .widget-content {
    padding: 1.5rem;
    min-height: 200px;
}

.reminders-list-sidebar {
    max-height: 300px;
    overflow-y: auto;
}

.reminders-list-sidebar .reminder-item {
    display: flex;
    align-items: center;
    padding: 0.8rem;
    margin-bottom: 0.6rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
    position: relative;
}

.reminders-list-sidebar .reminder-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(3px);
}

.reminders-list-sidebar .reminder-item.urgent {
    border-left: 3px solid #ff3b30;
    background: rgba(255, 59, 48, 0.1);
}

.reminders-list-sidebar .reminder-item.high {
    border-left: 3px solid #ff9500;
    background: rgba(255, 149, 0, 0.1);
}

.reminders-list-sidebar .reminder-item.medium {
    border-left: 3px solid #00d4ff;
    background: rgba(0, 212, 255, 0.1);
}

.reminders-list-sidebar .reminder-item.low {
    border-left: 3px solid #34c759;
    background: rgba(52, 199, 89, 0.1);
}

.reminders-list-sidebar .reminder-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.8rem;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.reminders-list-sidebar .reminder-item.urgent .reminder-icon {
    background: rgba(255, 59, 48, 0.2);
    color: #ff3b30;
}

.reminders-list-sidebar .reminder-item.high .reminder-icon {
    background: rgba(255, 149, 0, 0.2);
    color: #ff9500;
}

.reminders-list-sidebar .reminder-item.medium .reminder-icon {
    background: rgba(0, 212, 255, 0.2);
    color: #00d4ff;
}

.reminders-list-sidebar .reminder-item.low .reminder-icon {
    background: rgba(52, 199, 89, 0.2);
    color: #34c759;
}

.reminders-list-sidebar .reminder-content {
    flex: 1;
    min-width: 0;
}

.reminders-list-sidebar .reminder-title {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 0.2rem;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.reminders-list-sidebar .reminder-description {
    color: #cccccc;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.reminders-list-sidebar .reminder-time {
    color: #888888;
    font-size: 0.75rem;
    font-weight: 500;
}

.reminders-list-sidebar .no-reminders {
    text-align: center;
    padding: 2rem 1rem;
    color: #888888;
}

.reminders-list-sidebar .no-reminders i {
    font-size: 2rem;
    margin-bottom: 1rem;
    display: block;
}

.reminders-list-sidebar .no-reminders button {
    margin-top: 1rem;
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    border: none;
    color: white;
    padding: 0.6rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.reminders-list-sidebar .no-reminders button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
}

/* View All Activity Button - Larger and Purple Theme */
.view-all-activity-btn {
    background: rgba(0,0,0,0.9) !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    color: #fff !important;
    padding: 1rem 1.5rem !important; /* Larger padding */
    font-size: 1rem !important; /* Larger font */
    border-radius: 20px !important;
    transition: all 0.3s ease !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important;
    text-decoration: none !important;
    width: 100% !important;
    box-sizing: border-box !important;
    font-weight: 600 !important;
    cursor: pointer !important;
}

.view-all-activity-btn:hover {
    background: rgba(139, 92, 246, 0.1) !important;
    border-color: rgba(139, 92, 246, 0.3) !important;
    color: #fff !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2) !important;
}

.view-all-activity-btn:active,
.view-all-activity-btn.active {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
    border-color: #8B5CF6 !important;
    color: #fff !important;
    box-shadow: 0 0 8px 2px rgba(139,92,246,0.2) !important;
}

/* Quick Navigation Items - Purple Theme */
.reminder-widget-expanded .widget-action-btn:hover {
    background: rgba(139, 92, 246, 0.1) !important;
    border-color: rgba(139, 92, 246, 0.3) !important;
    color: #fff !important;
    transform: scale(1.1) !important;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2) !important;
}

/* Recent Activity Eye Icon - Purple Hover */
#recentActivity .activity-item:hover .activity-icon {
    background: rgba(139, 92, 246, 0.1) !important;
    border-color: rgba(139, 92, 246, 0.3) !important;
    color: #fff !important;
    transform: scale(1.1) !important;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2) !important;
}

/* Activity Modal Styles */
.activity-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(20px);
    z-index: 999999999;
    animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.activity-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.activity-modal-content {
    background: rgba(15, 15, 15, 0.98);
    border-radius: 24px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(30px);
    overflow: hidden;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.activity-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
}

.activity-modal-header h3 {
    color: #ffffff;
    margin: 0;
    font-size: 1.3rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.activity-modal-close {
    background: none;
    border: none;
    color: #888888;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.activity-modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    transform: scale(1.1);
}

.activity-modal-body {
    padding: 2rem;
    max-height: calc(85vh - 100px);
    overflow-y: auto;
}

.activity-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.activity-filters select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: #ffffff;
    padding: 0.8rem 1rem;
    font-size: 0.9rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
    min-width: 150px;
}

.activity-filters select:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.activity-search {
    position: relative;
    flex: 1;
    min-width: 200px;
}

.activity-search input {
    width: 100%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: #ffffff;
    padding: 0.8rem 1rem 0.8rem 2.5rem;
    font-size: 0.9rem;
    backdrop-filter: blur(10px);
}

.activity-search input:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.activity-search i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #888888;
    font-size: 0.9rem;
}

.activity-list {
    max-height: 500px;
    overflow-y: auto;
}

.activity-loading {
    text-align: center;
    padding: 3rem;
    color: #888888;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid #00d4ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

.activity-item-modal {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
}

.activity-item-modal:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px);
}

.activity-icon-modal {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(0, 212, 255, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1rem;
    color: #00d4ff;
    border: 1px solid rgba(0, 212, 255, 0.3);
    flex-shrink: 0;
}

.activity-content-modal {
    flex: 1;
}

.activity-desc-modal {
    color: #ffffff;
    font-weight: 500;
    margin-bottom: 0.3rem;
}

.activity-time-modal {
    color: #888888;
    font-size: 0.8rem;
}

.activity-meta-modal {
    color: #cccccc;
    font-size: 0.85rem;
    margin-top: 0.3rem;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar-content {
        gap: 1rem;
    }
    
    .profile-avatar {
        width: 70px; /* Smaller on mobile */
        height: 70px; /* Smaller on mobile */
        font-size: 1.8rem; /* Smaller font on mobile */
        margin-bottom: 0.8rem; /* Reduced margin on mobile */
    }
    
    .user-profile {
        min-height: 600px; /* Increased height on mobile to accommodate larger activity section */
    }
    
    .recent-activity {
        min-height: 420px; /* Increased height on mobile */
    }
    
    #recentActivity {
        min-height: 360px; /* Increased height on mobile */
        max-height: 360px; /* Increased max height on mobile */
    }
    
    .reminder-widget-sidebar .widget-header {
        padding: 1rem 1.2rem;
    }
    
    .reminder-widget-sidebar .widget-header h3 {
        font-size: 1rem;
    }
    
    .reminder-widget-sidebar .widget-content {
        padding: 1.2rem;
        min-height: 180px;
    }
    
    .reminders-list-sidebar {
        max-height: 250px;
    }
    
    .reminders-list-sidebar .reminder-item {
        padding: 0.6rem;
        margin-bottom: 0.5rem;
    }
    
    .reminders-list-sidebar .reminder-icon {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
        margin-right: 0.6rem;
    }
    
    .reminders-list-sidebar .reminder-title {
        font-size: 0.85rem;
    }
    
    .reminders-list-sidebar .reminder-description {
        font-size: 0.75rem;
    }
    
    .reminders-list-sidebar .reminder-time {
        font-size: 0.7rem;
    }
    
    .activity-modal-content {
        width: 95%;
        max-height: 90vh;
        margin: 1rem;
    }
    
    .activity-modal-header {
        padding: 1rem 1.5rem;
    }
    
    .activity-modal-body {
        padding: 1.5rem;
    }
    
    .activity-filters {
        flex-direction: column;
    }
    
    .activity-search {
        min-width: auto;
    }
}

/* Enhanced Expanded Reminders Widget */
.reminder-widget-expanded {
    background: rgba(15, 15, 15, 0.95);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    margin-bottom: 0.8rem;
}

.reminder-widget-expanded:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
}

.reminder-widget-expanded .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.02);
}

.reminder-widget-expanded .widget-header h3 {
    color: #ffffff;
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.widget-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.reminder-widget-expanded .widget-action-btn {
    background: rgba(0,0,0,0.9) !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    color: #fff !important;
}
.reminder-widget-expanded .widget-action-btn.active,
.reminder-widget-expanded .widget-action-btn:active {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
    border-color: #8B5CF6 !important;
    color: #fff !important;
    box-shadow: 0 0 8px 2px rgba(139,92,246,0.2);
}

.reminder-widget-expanded .widget-action-btn:hover {
    transform: scale(1.1);
}

.reminder-widget-expanded .widget-action-btn:hover {
    background: rgba(0, 212, 255, 0.2);
    border-color: #00d4ff;
}

.reminder-widget-expanded .widget-action-btn.calendar-btn:hover {
    background: rgba(52, 199, 89, 0.2);
    border-color: #34c759;
}

.expanded-content {
    padding: 1.5rem;
    min-height: 250px;
    max-height: 400px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.reminders-list-expanded {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 0.5rem;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 1rem; /* Add space for button */
}

.reminders-list-expanded::-webkit-scrollbar {
    width: 6px;
}

.reminders-list-expanded::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.reminders-list-expanded::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.reminders-list-expanded::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

.reminders-list-expanded .reminder-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.2rem;
    margin-bottom: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    width: 100%;
    box-sizing: border-box;
}

.reminders-list-expanded .reminder-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(3px);
    border-color: rgba(255, 255, 255, 0.15);
}

.reminders-list-expanded .reminder-item:active {
    transform: scale(0.98);
}

.reminders-list-expanded .reminder-item.urgent {
    border-left: 4px solid #ff3b30;
    background: rgba(255, 59, 48, 0.1);
}

.reminders-list-expanded .reminder-item.high {
    border-left: 4px solid #ff9500;
    background: rgba(255, 149, 0, 0.1);
}

.reminders-list-expanded .reminder-item.medium {
    border-left: 4px solid #00d4ff;
    background: rgba(0, 212, 255, 0.1);
}

.reminders-list-expanded .reminder-item.low {
    border-left: 4px solid #34c759;
    background: rgba(52, 199, 89, 0.1);
}

.reminders-list-expanded .reminder-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0;
    font-size: 1rem;
    flex-shrink: 0;
}

.reminders-list-expanded .reminder-item.urgent .reminder-icon {
    background: rgba(255, 59, 48, 0.2);
    color: #ff3b30;
    border: 1px solid rgba(255, 59, 48, 0.3);
}

.reminders-list-expanded .reminder-item.high .reminder-icon {
    background: rgba(255, 149, 0, 0.2);
    color: #ff9500;
    border: 1px solid rgba(255, 149, 0, 0.3);
}

.reminders-list-expanded .reminder-item.medium .reminder-icon {
    background: rgba(0, 212, 255, 0.2);
    color: #00d4ff;
    border: 1px solid rgba(0, 212, 255, 0.3);
}

.reminders-list-expanded .reminder-item.low .reminder-icon {
    background: rgba(52, 199, 89, 0.2);
    color: #34c759;
    border: 1px solid rgba(52, 199, 89, 0.3);
}

.reminders-list-expanded .reminder-content {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.reminders-list-expanded .reminder-title {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    line-height: 1.3;
    word-wrap: break-word;
    overflow: visible;
    white-space: normal;
}

.reminders-list-expanded .reminder-description {
    color: #cccccc;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
    word-wrap: break-word;
    overflow: visible;
    white-space: normal;
    max-height: none;
}

.reminders-list-expanded .reminder-time {
    color: #888888;
    font-size: 0.8rem;
    font-weight: 500;
}

.reminders-list-expanded .reminder-actions {
    display: flex;
    gap: 0.4rem;
    flex-shrink: 0;
    margin-top: 0.5rem;
}

.reminders-list-expanded .reminder-action-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.reminders-list-expanded .reminder-action-btn:hover {
    background: rgba(0, 212, 255, 0.3);
    color: #00d4ff;
    transform: scale(1.1);
}

.reminders-list-expanded .no-reminders {
    text-align: center;
    padding: 2rem 1rem;
    color: #888888;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.reminders-list-expanded .no-reminders i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
    color: #555555;
}

.reminders-list-expanded .no-reminders p {
    margin-bottom: 1rem;
}

.reminders-list-expanded .no-reminders button {
    background: linear-gradient(135deg, #00d4ff, #0099cc);
    border: none;
    color: white;
    padding: 0.8rem 1.2rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 0.5rem;
}

.reminders-list-expanded .no-reminders button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
}

/* User Profile Card - Extended to match media player height */
.user-profile {
    background: rgba(15, 15, 15, 0.95);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    min-height: 700px; /* Much larger height to accommodate extended activity section */
}

.user-profile:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
}

/* Recent Activity Section - Completely redesigned for maximum height and single scrollbar */
.recent-activity {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-top: 0.8rem;
    min-height: 520px; /* Even more increased minimum height */
    max-height: 520px; /* Set maximum height to prevent overflow */
    position: relative;
}

.recent-activity h4 {
    color: #ffffff; 
    font-weight: 600; 
    margin-bottom: 0.5rem;
    text-align: center;
    flex-shrink: 0; /* Prevent header from shrinking */
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(15, 15, 15, 0.95);
    padding: 0.5rem 0;
    margin: 0;
}

#totalActivitiesCount {
    flex-shrink: 0;
    margin-bottom: 0.8rem;
}

#recentActivity {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0 0.5rem;
    min-height: 420px; /* Adjusted for new header structure */
    max-height: 420px; /* Adjusted for new header structure */
    position: relative;
    scroll-behavior: smooth;
    /* Hide scrollbar for webkit browsers */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* Internet Explorer 10+ */
}

/* Hide scrollbar for webkit browsers */
#recentActivity::-webkit-scrollbar {
    width: 0 !important;
    background: transparent !important;
}

#recentActivity::-webkit-scrollbar-track {
    background: transparent !important;
}

#recentActivity::-webkit-scrollbar-thumb {
    background: transparent !important;
}

/* Ensure content is properly spaced */
#recentActivity {
    padding: 0 1rem;
    text-align: center;
}

/* Activity Items in User Profile - Optimized for larger container */
#recentActivity .activity-item {
    display: flex;
    align-items: center;
    padding: 0.8rem 1rem;
    margin-bottom: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-sizing: border-box;
    cursor: pointer;
    min-height: 70px; /* Minimum height to ensure consistent sizing */
    width: 100%; /* Ensure all items have the same width */
    flex-shrink: 0; /* Prevent shrinking */
}

/* Activity Header Styling - Enhanced */
#recentActivity .activity-header {
    color: #888 !important;
    font-size: 0.85rem !important;
    margin-bottom: 1rem !important;
    text-align: center !important;
    padding: 0.5rem !important;
    background: rgba(255, 255, 255, 0.03) !important;
    border-radius: 8px !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    font-weight: 500 !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 5 !important;
    backdrop-filter: blur(10px) !important;
}

#recentActivity .activity-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.1);
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

#recentActivity .activity-item:last-child {
    margin-bottom: 0;
}

#recentActivity .activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0,0,0,0.9) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    transition: background 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.8rem;
    font-size: 0.8rem;
    flex-shrink: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#recentActivity .activity-item:hover .activity-icon {
    transform: scale(1.1);
    background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
    color: #fff !important;
    border-color: #8B5CF6 !important;
    box-shadow: 0 0 8px 2px rgba(139,92,246,0.2);
}

#recentActivity .activity-item:active .activity-icon,
#recentActivity .activity-item.active .activity-icon {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
    color: #fff !important;
    border-color: #8B5CF6 !important;
    box-shadow: 0 0 8px 2px rgba(139,92,246,0.2);
}

#recentActivity .activity-content {
    flex: 1;
    min-width: 0;
    text-align: left;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 0.2rem 0;
}

#recentActivity .activity-desc {
    color: #ffffff;
    font-weight: 500;
    margin-bottom: 0.2rem;
    font-size: 0.85rem;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

#recentActivity .activity-time {
    color: #888888;
    font-size: 0.75rem;
    font-weight: 500;
    opacity: 0.8;
    line-height: 1.2;
    white-space: nowrap;
}

#recentActivity .no-data {
    text-align: center;
    padding: 2rem 1rem;
    color: #888888;
    font-style: italic;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 200px;
}

#recentActivity .no-data::before {
    content: "üìä";
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Loading indicator for lazy loading */
#recentActivity .loading-more {
    text-align: center;
    padding: 1.5rem;
    color: #888888;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    margin: 0.5rem 0;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

#recentActivity .loading-more .loading-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid #00d4ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 0.8rem;
}

#recentActivity .loading-more p {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
}

/* Placeholder shimmer effect for instant loading */
.placeholder-shimmer {
    opacity: 0.7;
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0.05) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* View All Activity Button Container - Positioned outside scrollable area */
.view-all-activity-container {
    margin-top: 1.2rem; /* Increased margin to push button further down */
    text-align: center;
    flex-shrink: 0; /* Prevent button from shrinking */
}

/* View All Activity Button - Always visible at bottom */
.view-all-activity-btn {
    background: rgba(0,0,0,0.9) !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    color: #fff !important;
}
.view-all-activity-btn:active,
.view-all-activity-btn.active {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
    border-color: #8B5CF6 !important;
    color: #fff !important;
    box-shadow: 0 0 8px 2px rgba(139,92,246,0.2);
}

.view-all-activity-btn:hover {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 204, 0.2));
    border-color: #00d4ff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
}

/* Activity Wrapper Styling */
.activity-wrapper {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    width: 100% !important;
}

.activities-list {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 0 0.5rem !important;
    /* Hide scrollbar for webkit browsers */
    scrollbar-width: none !important; /* Firefox */
    -ms-overflow-style: none !important; /* Internet Explorer 10+ */
}

.activities-list::-webkit-scrollbar {
    width: 0 !important;
    background: transparent !important;
}

.activities-list::-webkit-scrollbar-track {
    background: transparent !important;
}

.activities-list::-webkit-scrollbar-thumb {
    background: transparent !important;
}

/* New Activity Container Styling */
.activity-main-container {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    width: 100% !important;
}

.activity-header-container {
    flex-shrink: 0 !important;
    margin-bottom: 1rem !important;
    order: 1 !important;
}

.activities-list-container {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 0 0.5rem !important;
    height: 100% !important;
    /* Hide scrollbar for webkit browsers */
    scrollbar-width: none !important; /* Firefox */
    -ms-overflow-style: none !important; /* Internet Explorer 10+ */
}

.activities-list-container::-webkit-scrollbar {
    width: 0 !important;
    background: transparent !important;
}

.activities-list-container::-webkit-scrollbar-track {
    background: transparent !important;
}

.activities-list-container::-webkit-scrollbar-thumb {
    background: transparent !important;
}
</style>

<script>
function openActivityModal() {
    const modal = document.getElementById('activityModal');
    modal.classList.add('show');
    loadFullActivityHistory();
}

function closeActivityModal() {
    const modal = document.getElementById('activityModal');
    modal.classList.remove('show');
}

function loadFullActivityHistory() {
    const activityList = document.getElementById('activityList');
    
    fetch('/api/activity/all')
        .then(response => response.json())
        .then(result => {
            const activities = result.activities || [];
            displayActivityHistory(activities);
        })
        .catch(error => {
            console.error('Error loading activity history:', error);
            activityList.innerHTML = '<div class="no-data">Error loading activity history</div>';
        });
}

function displayActivityHistory(activities) {
    const activityList = document.getElementById('activityList');
    
    if (activities.length === 0) {
        activityList.innerHTML = '<div class="no-data">No activity history found</div>';
        return;
    }
    
    const activitiesHTML = activities.map(activity => {
        const time = new Date(activity.timestamp);
        const timeAgo = getTimeAgo(time);
        const icon = getActivityIcon(activity.action);
        const description = formatActivityType(activity.action, activity.details);
        
        return `
            <div class="activity-item-modal" data-type="${activity.action}">
                <div class="activity-icon-modal">${icon}</div>
                <div class="activity-content-modal">
                    <div class="activity-desc-modal">${description}</div>
                    <div class="activity-time-modal">${timeAgo}</div>
                    ${activity.details ? `<div class="activity-meta-modal">${activity.details}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    activityList.innerHTML = activitiesHTML;
}

function filterActivity(type) {
    const activityItems = document.querySelectorAll('.activity-item-modal');
    
    activityItems.forEach(item => {
        if (type === 'all' || item.dataset.type === type) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function searchActivity(query) {
    const activityItems = document.querySelectorAll('.activity-item-modal');
    const searchTerm = query.toLowerCase();
    
    activityItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// Close modal when clicking outside
document.getElementById('activityModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeActivityModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeActivityModal();
    }
});

// Expanded Reminders Functions
function renderExpandedReminders() {
    const expandedRemindersList = document.getElementById('expandedRemindersList');
    
    if (!expandedRemindersList) return;
    
    if (typeof reminders === 'undefined' || reminders.length === 0) {
        expandedRemindersList.innerHTML = `
            <div class="no-reminders">
                <i class="bi bi-bell-slash"></i>
                <p>No reminders set</p>
            </div>
        `;
        return;
    }
    
    // Sort reminders by date/time
    const sortedReminders = reminders.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
    
    const remindersHTML = sortedReminders.map(reminder => {
        const reminderDate = new Date(reminder.datetime);
        const timeAgo = getTimeUntil(reminderDate);
        const isOverdue = reminderDate < new Date();
        
        return `
            <div class="reminder-item ${reminder.priority} ${isOverdue ? 'overdue' : ''}" 
                 onclick="editReminderExpanded('${reminder.id}')"
                 data-reminder-id="${reminder.id}">
                <div class="reminder-icon">
                    <i class="bi bi-bell-fill"></i>
                </div>
                <div class="reminder-content">
                    <div class="reminder-title">${reminder.title}</div>
                    ${reminder.description ? `<div class="reminder-description">${reminder.description}</div>` : ''}
                    <div class="reminder-time">${formatDateTime(reminderDate)} ${isOverdue ? '(Overdue)' : `(${timeAgo})`}</div>
                    <div class="reminder-actions" onclick="event.stopPropagation()">
                        <button class="reminder-action-btn" onclick="completeReminder('${reminder.id}')" title="Mark Complete">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="reminder-action-btn" onclick="editReminderExpanded('${reminder.id}')" title="Edit">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="reminder-action-btn" onclick="deleteReminderExpanded('${reminder.id}')" title="Delete">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    expandedRemindersList.innerHTML = remindersHTML;
    
    // Ensure the container height is properly set
    const expandedContent = document.querySelector('.expanded-content');
    if (expandedContent) {
        expandedContent.style.height = 'auto';
        expandedContent.style.minHeight = '250px';
    }
}

function editReminderExpanded(id) {
    const reminder = reminders.find(r => r.id === id);
    if (!reminder) return;
    
    // Populate form with reminder data
    document.getElementById('reminderTitle').value = reminder.title;
    document.getElementById('reminderDescription').value = reminder.description || '';
    document.getElementById('reminderDate').value = new Date(reminder.datetime).toISOString().split('T')[0];
    document.getElementById('reminderTime').value = new Date(reminder.datetime).toTimeString().slice(0, 5);
    document.getElementById('reminderPriority').value = reminder.priority;
    document.getElementById('reminderCategory').value = reminder.category || 'work';
    
    // Store the ID for updating
    document.getElementById('reminderForm').setAttribute('data-editing-id', id);
    
    // Open modal
    openReminderModal();
}

function deleteReminderExpanded(id) {
    if (confirm('Are you sure you want to delete this reminder?')) {
        if (typeof reminders !== 'undefined') {
            const index = reminders.findIndex(r => r.id === id);
            if (index > -1) {
                reminders.splice(index, 1);
                if (typeof saveReminders === 'function') {
                    saveReminders();
                }
                renderExpandedReminders();
                // Also update other reminder displays if they exist
                if (typeof renderReminders === 'function') {
                    renderReminders();
                }
                if (typeof renderSidebarReminders === 'function') {
                    renderSidebarReminders();
                }
                showToast('Reminder deleted!', 'info');
            }
        }
    }
}

// Override the existing renderSidebarReminders function to also update expanded view
const originalRenderSidebarReminders = renderSidebarReminders;
function renderSidebarReminders() {
    if (originalRenderSidebarReminders) {
        originalRenderSidebarReminders.call(this);
    }
    renderExpandedReminders();
}

// Simple loading variables
let isLoading = false;
let activitiesLoaded = false;

// Initialize expanded reminders when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    renderExpandedReminders();
    // Load activity data immediately for instant display
    console.log('üöÄ Starting instant activity loader...');
    loadAllActivityInstant();
    
    // Track initial page load activity with proper timestamp
    setTimeout(() => {
        if (typeof trackActivityWithTimestamp === 'function') {
            trackActivityWithTimestamp('page_view', window.location.pathname);
        }
    }, 1000);
});

// Load all activity data instantly - no loading indicator flash
function loadAllActivityInstant() {
    if (isLoading) {
        console.log('‚è≥ Activity loading already in progress...');
        return;
    }
    
    console.log('üîÑ INSTANT: Loading all activity data...');
    isLoading = true;
    
    // First, completely take over the container to prevent other systems from interfering
    const container = document.getElementById('recentActivity');
    if (!container) {
        console.error('‚ùå Recent activity container not found!');
        isLoading = false;
        return;
    }
    
    // Add a flag to prevent other systems from updating this container
    container.setAttribute('data-enhanced-loader', 'true');
    
    // Pre-populate with placeholder content to prevent any flash
    if (container.innerHTML.trim() === '') {
        container.innerHTML = `
            <div class="activity-item placeholder-shimmer">
                <div class="activity-icon">‚è≥</div>
                <div class="activity-content">
                    <div class="activity-desc">Loading recent activity...</div>
                    <div class="activity-time">Just now</div>
                </div>
            </div>
        `;
    }
    
    // Skip loading indicator - go straight to fetching data for instant display
    
    // Use the correct API endpoint that returns all user activities
    fetch('/api/activity/all')
        .then(response => {
            if (!response.ok) {
                throw new Error(`API returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            const activities = result.activities || [];
            console.log(`‚úÖ API returned ${activities.length} total activities`);
            
            // Debug: Check timestamp patterns in API data
            if (activities.length > 0) {
                console.log('üìä API Data Sample:');
                activities.slice(0, 5).forEach((activity, index) => {
                    console.log(`  ${index}: ${activity.action} - ${activity.timestamp}`);
                    const parsed = new Date(activity.timestamp);
                    console.log(`     Parsed: ${parsed.toISOString()}`);
                    console.log(`     Age: ${Math.floor((new Date() - parsed) / 1000)}s`);
                });
            }
            
            // Analyze timestamp patterns to understand the data
            const timestampAnalysis = {
                oldest: null,
                newest: null,
                timeSpread: 0,
                allRecent: false
            };
            
            if (activities.length > 0) {
                const times = activities.map(a => new Date(a.timestamp));
                timestampAnalysis.oldest = new Date(Math.min(...times));
                timestampAnalysis.newest = new Date(Math.max(...times));
                timestampAnalysis.timeSpread = timestampAnalysis.newest - timestampAnalysis.oldest;
                timestampAnalysis.allRecent = timestampAnalysis.timeSpread < (5 * 60 * 1000); // Less than 5 minutes spread
                
                console.log('üìä Timestamp Analysis:', {
                    totalActivities: activities.length,
                    oldest: timestampAnalysis.oldest.toISOString(),
                    newest: timestampAnalysis.newest.toISOString(),
                    spreadMinutes: Math.floor(timestampAnalysis.timeSpread / (1000 * 60)),
                    allRecent: timestampAnalysis.allRecent
                });
            }
            
            if (activities.length > 0) {
                handleAllActivityData(activities);
                activitiesLoaded = true;
                console.log('‚úÖ Real API data loaded successfully');
                
                // Update total count immediately
                const totalCount = document.getElementById('totalActivitiesCount');
                if (totalCount) {
                    totalCount.textContent = `${activities.length} Total Activities`;
                    console.log(`üìä Updated total count: ${activities.length} activities`);
                }
            } else {
                console.log('‚ö†Ô∏è API returned no activities, using mock data');
                const mockActivities = generateComprehensiveMockData();
                handleAllActivityData(mockActivities);
                activitiesLoaded = true;
                
                // Update total count for mock data
                const totalCount = document.getElementById('totalActivitiesCount');
                if (totalCount) {
                    totalCount.textContent = `${mockActivities.length} Total Activities`;
                    console.log(`üìä Updated total count: ${mockActivities.length} activities`);
                }
            }
        })
        .catch(error => {
            console.log('‚ö†Ô∏è API not available, using mock data:', error.message);
            // Generate a larger set of mock data for demonstration
            const mockActivities = generateComprehensiveMockData();
            handleAllActivityData(mockActivities);
            activitiesLoaded = true;
            
            // Update total count for mock data
            const totalCount = document.getElementById('totalActivitiesCount');
            if (totalCount) {
                totalCount.textContent = `${mockActivities.length} Total Activities`;
                console.log(`üìä Updated total count: ${mockActivities.length} activities`);
            }
        })
        .finally(() => {
            isLoading = false;
            hideLoadingIndicator();
            
            // Override any future attempts to modify this container
            preventOtherUpdates();
        });
}

// Legacy function - kept for compatibility but calls instant version
function loadAllActivity() {
    loadAllActivityInstant();
}

// Handle all activity data at once
function handleAllActivityData(activities) {
    console.log(`Handling ${activities.length} total activities`);
    
    if (activities.length === 0) {
        showNoActivityMessage();
        return;
    }
    
    // Process and display all activities
    displayAllActivities(activities);
}

// Display all activities in the container - COMPLETELY REWRITTEN
function displayAllActivities(activities) {
    const recentActivity = document.getElementById('recentActivity');
    const totalActivitiesCount = document.getElementById('totalActivitiesCount');
    
    if (!recentActivity) {
        console.error('‚ùå Recent activity container not found during display!');
        return;
    }
    
    console.log(`üìä Displaying ${activities.length} activities...`);
    
    // Update the total activities count in the header
    if (totalActivitiesCount) {
        totalActivitiesCount.textContent = `${activities.length} Total Activities`;
    }
    
    // Clear any existing content completely
    recentActivity.innerHTML = '';
    
    // Create the activities list container directly (no header needed)
    const activitiesContainer = document.createElement('div');
    activitiesContainer.className = 'activities-list-container';
    activitiesContainer.style.cssText = `
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0 0.5rem;
        height: 100%;
    `;
    
    // Generate activities HTML
    const activitiesHTML = activities.map((activity, index) => {
        const time = new Date(activity.timestamp);
        const timeAgo = getTimeAgo(time);
        const icon = getActivityIcon(activity.action);
        const description = formatActivityType(activity.action, activity.details);
        
        // Debug log for first few activities
        if (index < 5) {
            console.log(`Activity ${index}: ${description} - ${timeAgo || 'No timestamp'}`);
            console.log(`  Raw timestamp: ${activity.timestamp}`);
            console.log(`  Parsed time: ${time}`);
            console.log(`  Current time: ${new Date()}`);
            console.log(`  Difference: ${new Date() - time}ms`);
        }
        
        // Only show time element if we have a valid timestamp
        const timeElement = timeAgo ? `<div class="activity-time">${timeAgo}</div>` : '';
        
        return `
            <div class="activity-item" data-activity-id="${activity.id}" data-timestamp="${activity.timestamp}">
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-desc">${description}</div>
                    ${timeElement}
                </div>
            </div>
        `;
    }).join('');
    
    // Add activities to the container
    activitiesContainer.innerHTML = activitiesHTML;
    recentActivity.appendChild(activitiesContainer);
    
    // Add marker to show this was loaded by enhanced system
    recentActivity.setAttribute('data-loaded-by', 'enhanced-system');
    recentActivity.setAttribute('data-load-time', new Date().toISOString());
    
    console.log(`‚úÖ Successfully displayed ${activities.length} activities with enhanced loader`);
}

// Show no activity message
function showNoActivityMessage() {
    const recentActivity = document.getElementById('recentActivity');
    if (!recentActivity) return;
    
    recentActivity.innerHTML = `
        <div class="no-data">
            <i class="bi bi-clock-history" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <p>No recent activity found</p>
        </div>
    `;
}

// Generate comprehensive mock activity data for demonstration
function generateComprehensiveMockData() {
    const activities = [];
    
    // Create a more diverse set of activities to avoid duplicates
    const activityTemplates = [
        // Page views with realistic paths
        { action: 'page_view', details: '/' },
        { action: 'page_view', details: '/oralyzer' },
        { action: 'page_view', details: '/admin' },
        { action: 'page_view', details: '/tickets' },
        { action: 'page_view', details: '/outages' },
        { action: 'page_view', details: '/kb' },
        { action: 'page_view', details: '/profile' },
        { action: 'page_view', details: '/settings' },
        { action: 'page_view', details: '/' },
        { action: 'page_view', details: '/oralyzer' },
        { action: 'page_view', details: '/admin' },
        { action: 'page_view', details: '/tickets' },
        { action: 'page_view', details: '/outages' },
        { action: 'page_view', details: '/kb' },
        
        // Searches with more specific terms
        { action: 'search', details: 'network outage' },
        { action: 'search', details: 'user tickets' },
        { action: 'search', details: 'system logs' },
        { action: 'search', details: 'backup status' },
        { action: 'search', details: 'security alerts' },
        { action: 'search', details: 'performance issues' },
        { action: 'search', details: 'database errors' },
        { action: 'search', details: 'server maintenance' },
        { action: 'search', details: 'user permissions' },
        { action: 'search', details: 'system updates' },
        { action: 'search', details: 'error reports' },
        
        // File uploads with more context
        { action: 'file_upload', details: 'Monthly Report (PDF)' },
        { action: 'file_upload', details: 'System Data (Excel)' },
        { action: 'file_upload', details: 'Configuration File (JSON)' },
        { action: 'file_upload', details: 'Backup Archive (ZIP)' },
        { action: 'file_upload', details: 'Screenshot (PNG)' },
        { action: 'file_upload', details: 'Error Log (TXT)' },
        { action: 'file_upload', details: 'Presentation (PPTX)' },
        { action: 'file_upload', details: 'Documentation (DOCX)' },
        
        // Settings changes with more detail
        { action: 'settings_changed', details: 'Profile settings updated' },
        { action: 'settings_changed', details: 'Notification preferences changed' },
        { action: 'settings_changed', details: 'Theme switched to dark mode' },
        { action: 'settings_changed', details: 'Language changed to English' },
        { action: 'settings_changed', details: 'Password updated' },
        { action: 'settings_changed', details: 'Email preferences modified' },
        { action: 'settings_changed', details: 'Security settings adjusted' },
        
        // Outage creation with more specific issues
        { action: 'outage_created', details: 'Network connectivity issue' },
        { action: 'outage_created', details: 'Server maintenance scheduled' },
        { action: 'outage_created', details: 'Database backup in progress' },
        { action: 'outage_created', details: 'Security update applied' },
        { action: 'outage_created', details: 'System restart required' },
        { action: 'outage_created', details: 'Power outage detected' },
        { action: 'outage_created', details: 'Hardware failure reported' },
        
        // Ticket creation with more specific types
        { action: 'ticket_created', details: 'User access request' },
        { action: 'ticket_created', details: 'Bug report submitted' },
        { action: 'ticket_created', details: 'Feature request created' },
        { action: 'ticket_created', details: 'Support inquiry opened' },
        { action: 'ticket_created', details: 'Account issue reported' },
        { action: 'ticket_created', details: 'System error reported' },
        { action: 'ticket_created', details: 'Performance issue logged' },
        
        // Login/logout events
        { action: 'login', details: 'User logged in successfully' },
        { action: 'logout', details: 'User logged out' },
        { action: 'login', details: 'Session started' },
        { action: 'logout', details: 'Session ended' }
    ];
    
    // Generate a comprehensive set of recent activities with varied timestamps
    const now = Date.now();
    const totalActivities = 50; // Generate 50 mock activities
    
    for (let i = 0; i < totalActivities; i++) {
        // Create timestamps going back in time with much more spread
        // First 10 activities: minutes ago
        // Next 20 activities: hours ago  
        // Last 20 activities: days ago
        let timestamp;
        if (i < 10) {
            // 5 minutes to 2 hours ago
            const minutesAgo = (i * 15) + Math.floor(Math.random() * 20); // 15-35 minutes spread
            timestamp = new Date(now - (minutesAgo * 60 * 1000));
        } else if (i < 30) {
            // 2 hours to 2 days ago
            const hoursAgo = 2 + ((i - 10) * 2) + Math.floor(Math.random() * 3); // 2-44 hours
            timestamp = new Date(now - (hoursAgo * 60 * 60 * 1000));
        } else {
            // 2 days to 2 weeks ago
            const daysAgo = 2 + ((i - 30) * 0.5) + Math.floor(Math.random() * 2); // 2-12 days
            timestamp = new Date(now - (daysAgo * 24 * 60 * 60 * 1000));
        }
        
        // Use different templates cyclically with some randomization
        const templateIndex = i % activityTemplates.length;
        const template = activityTemplates[templateIndex];
        
        // Add some variation to details
        let details = template.details;
        if (template.action === 'page_view' && Math.random() > 0.7) {
            details = `${details} (${Math.floor(Math.random() * 100)})`;
        } else if (template.action === 'search' && Math.random() > 0.6) {
            details = `${details} ${Math.floor(Math.random() * 1000)}`;
        }
        
        const activityId = `mock_${i}_${timestamp.getTime()}_${Math.random().toString(36).substr(2, 9)}`;
        
        activities.push({
            id: activityId,
            action: template.action,
            details: details,
            timestamp: timestamp.toISOString()
        });
        
        // Only log first few to avoid spam
        if (i < 5) {
            console.log(`Generated activity ${i}: ${template.action} - ${getTimeAgo(timestamp)} (${timestamp.toISOString()})`);
        }
    }
    
    console.log(`Generated ${activities.length} comprehensive mock activities`);
    return activities;
}



// Show loading indicator - optimized for instant loading
function showLoadingIndicator() {
    const recentActivity = document.getElementById('recentActivity');
    if (!recentActivity) return;
    
    // Only show loading if container is completely empty
    if (recentActivity.innerHTML.trim() === '') {
        recentActivity.innerHTML = `
            <div class="no-data">
                <div class="loading-spinner"></div>
                <p>Loading activities...</p>
            </div>
        `;
    }
}

// Hide loading indicator
function hideLoadingIndicator() {
    const recentActivity = document.getElementById('recentActivity');
    if (!recentActivity) return;
    
    const loadingIndicator = recentActivity.querySelector('.no-data');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
}

// Reset activity loading state
function resetActivityLoading() {
    isLoading = false;
    activitiesLoaded = false;
    
    const recentActivity = document.getElementById('recentActivity');
    if (recentActivity) {
        recentActivity.innerHTML = '<div class="no-data">Loading activity...</div>';
        console.log('Reset activity feed - cleared all existing activities');
    }
    
    loadAllActivityInstant();
}

// Manual refresh function - can be called from console or button
function refreshActivityFeed() {
    console.log('Manually refreshing activity feed...');
    resetActivityLoading();
}

// Add keyboard shortcut for manual refresh (Ctrl+Shift+R)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        refreshActivityFeed();
    }
});

// COMPLETELY FIXED getTimeAgo function - Enhanced for very recent activities
function getTimeAgo(date) {
    const now = new Date();
    let activityDate;
    
    // Handle null, undefined, or empty timestamps
    if (!date || date === null || date === undefined || date === '') {
        console.warn('‚ùå Missing or empty timestamp received');
        return ''; // Return empty string instead of "Just now"
    }
    
    // Parse the date properly
    if (typeof date === 'string') {
        activityDate = new Date(date);
    } else if (date instanceof Date) {
        activityDate = date;
    } else {
        activityDate = new Date(date);
    }
    
    // Validate the date
    if (isNaN(activityDate.getTime())) {
        console.warn('‚ùå Invalid date received:', date);
        return ''; // Return empty string for invalid dates
    }
    
    // Calculate the time difference
    const diffMs = now.getTime() - activityDate.getTime();
    
    // Debug logging for troubleshooting (reduced frequency)
    const debugThis = Math.random() < 0.01; // Log 1% of calls
    if (debugThis) {
        console.log('üïê Timestamp Debug:', {
            input: date,
            parsed: activityDate.toISOString(),
            current: now.toISOString(),
            diffMs: diffMs,
            diffMins: Math.floor(diffMs / 60000)
        });
    }
    
    // Handle future dates (shouldn't happen but let's be safe)
    if (diffMs < 0) {
        console.warn('‚ö†Ô∏è Future date:', activityDate.toISOString(), 'vs', now.toISOString());
        return ''; // Return empty string for future dates
    }
    
    // Convert to time units
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    // For very recent activities (less than 1 minute), show more precise timing
    if (diffSecs < 60) {
        if (diffSecs < 3) return 'Just now';
        if (diffSecs < 10) return 'A few seconds ago';
        if (diffSecs < 30) return 'Less than a minute ago';
        return `${diffSecs} seconds ago`;
    }
    
    // For activities within the last hour, show minutes
    if (diffMins < 60) {
        if (diffMins === 1) return '1 minute ago';
        return `${diffMins} minutes ago`;
    }
    
    // For activities within the last day, show hours
    if (diffHours < 24) {
        if (diffHours === 1) return '1 hour ago';
        return `${diffHours} hours ago`;
    }
    
    // For activities within the last week, show days
    if (diffDays < 7) {
        if (diffDays === 1) return '1 day ago';
        return `${diffDays} days ago`;
    }
    
    // For activities within the last month, show weeks
    if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        if (weeks === 1) return '1 week ago';
        return `${weeks} weeks ago`;
    }
    
    // For older activities, show months
    const months = Math.floor(diffDays / 30);
    if (months === 1) return '1 month ago';
    return `${months} months ago`;
}

// Expose functions globally for debugging
window.refreshActivityFeed = refreshActivityFeed;
window.resetActivityLoading = resetActivityLoading;
window.loadAllActivity = loadAllActivity;
window.clearActivityFeed = function() {
    const recentActivity = document.getElementById('recentActivity');
    if (recentActivity) {
        recentActivity.innerHTML = '<div class="no-data">Activity feed cleared</div>';
        console.log('Activity feed manually cleared');
    }
};

// Debug function to check current state
window.debugActivityState = function() {
    console.log('=== Activity Debug State ===');
    console.log('isLoading:', isLoading);
    console.log('activitiesLoaded:', activitiesLoaded);
    
    const recentActivity = document.getElementById('recentActivity');
    if (recentActivity) {
        const items = recentActivity.querySelectorAll('.activity-item');
        console.log('Current activity items in DOM:', items.length);
        
        // Show first few activities with their timestamps
        items.forEach((item, index) => {
            if (index < 3) {
                const desc = item.querySelector('.activity-desc')?.textContent;
                const time = item.querySelector('.activity-time')?.textContent;
                console.log(`Activity ${index + 1}: ${desc} - ${time}`);
            }
        });
    }
};

// Prevent other systems from updating the activity container
function preventOtherUpdates() {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    // Override the updateRecentActivity function if it exists
    if (typeof window.updateRecentActivity === 'function') {
        console.log('üö´ Overriding old updateRecentActivity function');
        window.updateRecentActivity = function(activities) {
            console.log('üö´ Blocked old updateRecentActivity call - enhanced loader is active');
            return;
        };
    }
    
    // Block any external modifications to this container
    const originalSetHTML = container.innerHTML;
    Object.defineProperty(container, 'innerHTML', {
        set: function(value) {
            // Only allow updates from our enhanced system
            if (container.getAttribute('data-enhanced-loader') === 'true') {
                Object.getPrototypeOf(this).innerHTML = value;
            } else {
                console.log('üö´ Blocked external update to recent activity container');
            }
        },
        get: function() {
            return Object.getPrototypeOf(this).innerHTML;
        }
    });
}

// Manual reload function for testing
window.manualReloadActivity = function() {
    console.log('üîÑ Manually reloading all activity...');
    activitiesLoaded = false; // Reset the flag
    if (!isLoading) {
        loadAllActivityInstant();
    } else {
        console.log('‚è≥ Cannot reload - currently loading');
    }
};

// Debug function to check what's in the container
window.debugRecentActivity = function() {
    const container = document.getElementById('recentActivity');
    if (!container) {
        console.log('‚ùå Container not found');
        return;
    }
    
    console.log('üîç Recent Activity Container Debug:');
    console.log('- Enhanced loader flag:', container.getAttribute('data-enhanced-loader'));
    console.log('- Loaded by:', container.getAttribute('data-loaded-by'));
    console.log('- Load time:', container.getAttribute('data-load-time'));
    console.log('- Activity items:', container.querySelectorAll('.activity-item').length);
    console.log('- isLoading:', isLoading);
    console.log('- activitiesLoaded:', activitiesLoaded);
    
    // Show first few activity timestamps with detailed analysis
    const items = container.querySelectorAll('.activity-item');
    console.log('\nüìä Sample Activities:');
    items.forEach((item, index) => {
        if (index < 10) { // Show more for debugging
            const desc = item.querySelector('.activity-desc')?.textContent;
            const time = item.querySelector('.activity-time')?.textContent;
            const timestamp = item.getAttribute('data-timestamp');
            
            console.log(`${index + 1}. ${desc}`);
            console.log(`   Display: ${time}`);
            console.log(`   Raw: ${timestamp}`);
            
            if (timestamp) {
                const parsed = new Date(timestamp);
                const now = new Date();
                const diffMs = now - parsed;
                console.log(`   Parsed: ${parsed.toISOString()}`);
                console.log(`   Diff: ${diffMs}ms (${Math.floor(diffMs/1000)}s)`);
                console.log(`   Manual calc: ${getTimeAgo(parsed)}`);
            }
            console.log('---');
        }
    });
};

// Force regenerate timestamps function for testing
window.forceRegenerateTimestamps = function() {
    console.log('üîÑ Force regenerating all timestamps...');
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const items = container.querySelectorAll('.activity-item');
    items.forEach((item, index) => {
        const timestamp = item.getAttribute('data-timestamp');
        const timeElement = item.querySelector('.activity-time');
        
        if (timestamp && timeElement) {
            const newTimeAgo = getTimeAgo(new Date(timestamp));
            timeElement.textContent = newTimeAgo;
            
            if (index < 10) {
                console.log(`Updated item ${index}: ${timestamp} -> ${newTimeAgo}`);
            }
        }
    });
};

// Test specific timestamp parsing
window.testTimestamp = function(timestampString) {
    console.log('üß™ Testing timestamp:', timestampString);
    const parsed = new Date(timestampString);
    const now = new Date();
    const diff = now - parsed;
    
    console.log('Results:', {
        input: timestampString,
        parsed: parsed.toISOString(),
        current: now.toISOString(),
        diffMs: diff,
        diffSecs: Math.floor(diff / 1000),
        diffMins: Math.floor(diff / 60000),
        diffHours: Math.floor(diff / 3600000),
        calculated: getTimeAgo(parsed)
    });
};

// Quick fix for showing real times
window.showRealTimes = function() {
    console.log('üïê Showing real activity times...');
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const items = container.querySelectorAll('.activity-item');
    console.log('üìä Real Timestamp Analysis:');
    
    items.forEach((item, index) => {
        if (index < 15) { // Show first 15
            const timestamp = item.getAttribute('data-timestamp');
            const desc = item.querySelector('.activity-desc')?.textContent;
            const timeElement = item.querySelector('.activity-time');
            
            if (timestamp) {
                const parsed = new Date(timestamp);
                const now = new Date();
                const ageMinutes = Math.floor((now - parsed) / 60000);
                
                console.log(`${index + 1}. ${desc.substring(0, 30)}...`);
                console.log(`   Timestamp: ${timestamp}`);
                console.log(`   Age: ${ageMinutes} minutes (${Math.floor(ageMinutes/60)}h ${ageMinutes%60}m)`);
                console.log(`   Display: ${timeElement?.textContent}`);
                console.log('---');
            }
        }
    });
};

// Enhanced activity tracking with proper timestamps
function trackActivityWithTimestamp(action, details = null) {
    const timestamp = new Date().toISOString();
    const activityData = {
        action: action,
        details: details,
        timestamp: timestamp
    };
    
    console.log(`üìù Tracking activity: ${action} - ${details} at ${timestamp}`);
    
    // Send to server for storage
    fetch('/api/activity/track', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(activityData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('‚úÖ Activity tracked successfully');
        } else {
            console.warn('‚ö†Ô∏è Activity tracking failed:', result.error);
        }
    })
    .catch(error => {
        console.error('‚ùå Error tracking activity:', error);
    });
    
    return activityData;
}

// Expose activity tracking globally for other components
window.trackActivityWithTimestamp = trackActivityWithTimestamp;

// Real-time activity refresh function
function refreshActivityDisplay() {
    console.log('üîÑ Refreshing activity display...');
    
    // Reload activity data
    fetch('/api/activity/all')
        .then(response => response.json())
        .then(result => {
            const activities = result.activities || [];
            if (activities.length > 0) {
                displayAllActivities(activities);
                console.log('‚úÖ Activity display refreshed successfully');
            } else {
                console.log('‚ö†Ô∏è No activities found during refresh');
            }
        })
        .catch(error => {
            console.error('‚ùå Error refreshing activity display:', error);
        });
}

// Update timestamps in real-time (called periodically)
function updateActivityTimestamps() {
    const activityItems = document.querySelectorAll('#recentActivity .activity-item');
    
    activityItems.forEach(item => {
        const timestampAttr = item.getAttribute('data-timestamp');
        const timeElement = item.querySelector('.activity-time');
        
        if (timestampAttr && timeElement) {
            const time = new Date(timestampAttr);
            const timeAgo = getTimeAgo(time);
            
            if (timeAgo) {
                timeElement.textContent = timeAgo;
            }
        }
    });
}

// Start real-time timestamp updates
setInterval(updateActivityTimestamps, 30000); // Update every 30 seconds

// Expose refresh function globally
window.refreshActivityDisplay = refreshActivityDisplay;

// Test function to create sample activities with proper timestamps
function createTestActivities() {
    console.log('üß™ Creating test activities...');
    
    const testActions = [
        { action: 'page_view', details: 'Test Page Visit' },
        { action: 'search', details: 'Test Search Query' },
        { action: 'settings_changed', details: 'Test Settings Update' },
        { action: 'file_upload', details: 'Test File Upload' },
        { action: 'outage_created', details: 'Test Outage Report' }
    ];
    
    // Create activities with staggered timestamps
    testActions.forEach((testAction, index) => {
        setTimeout(() => {
            trackActivityWithTimestamp(testAction.action, testAction.details);
        }, index * 2000); // 2 seconds apart
    });
    
    // Refresh display after creating test activities
    setTimeout(() => {
        refreshActivityDisplay();
    }, testActions.length * 2000 + 1000);
}

// Expose test function globally
window.createTestActivities = createTestActivities;

// Enhanced debugging function for activity system
window.debugActivitySystem = function() {
    console.log('=== Activity System Debug ===');
    
    const recentActivity = document.getElementById('recentActivity');
    if (!recentActivity) {
        console.error('‚ùå Recent activity container not found!');
        return;
    }
    
    console.log('üìä Container Info:', {
        innerHTML: recentActivity.innerHTML.substring(0, 200) + '...',
        dataLoadedBy: recentActivity.getAttribute('data-loaded-by'),
        dataLoadTime: recentActivity.getAttribute('data-load-time'),
        childNodes: recentActivity.childNodes.length
    });
    
    const activityItems = recentActivity.querySelectorAll('.activity-item');
    console.log(`üìã Found ${activityItems.length} activity items`);
    
    activityItems.forEach((item, index) => {
        if (index < 5) { // Only show first 5
            const desc = item.querySelector('.activity-desc')?.textContent;
            const time = item.querySelector('.activity-time')?.textContent;
            const timestamp = item.getAttribute('data-timestamp');
            
            console.log(`Activity ${index + 1}:`, {
                description: desc,
                timeDisplay: time,
                rawTimestamp: timestamp,
                parsedTime: timestamp ? new Date(timestamp) : null
            });
        }
    });
    
    // Test timestamp parsing
    console.log('üïê Timestamp Test:', {
        now: new Date().toISOString(),
        test1: getTimeAgo(new Date()),
        test2: getTimeAgo(new Date(Date.now() - 60000)), // 1 minute ago
        test3: getTimeAgo(new Date(Date.now() - 3600000)), // 1 hour ago
        test4: getTimeAgo(''), // Empty string
        test5: getTimeAgo(null) // Null
    });
};

// Test function to create sample activities with different timestamps
function createTestActivitiesWithTimestamps() {
    console.log('üß™ Creating test activities with varied timestamps...');
    
    const now = Date.now();
    const testActivities = [
        { action: 'page_view', details: 'Just visited (5 seconds ago)', timestamp: new Date(now - 5000).toISOString() },
        { action: 'search', details: 'Searched for "test" (30 seconds ago)', timestamp: new Date(now - 30000).toISOString() },
        { action: 'settings_changed', details: 'Updated profile (2 minutes ago)', timestamp: new Date(now - 120000).toISOString() },
        { action: 'file_upload', details: 'Uploaded document (15 minutes ago)', timestamp: new Date(now - 900000).toISOString() },
        { action: 'outage_created', details: 'Created outage report (1 hour ago)', timestamp: new Date(now - 3600000).toISOString() },
        { action: 'login', details: 'Logged in (3 hours ago)', timestamp: new Date(now - 10800000).toISOString() },
        { action: 'page_view', details: 'Visited dashboard (1 day ago)', timestamp: new Date(now - 86400000).toISOString() },
        { action: 'search', details: 'Searched for "help" (3 days ago)', timestamp: new Date(now - 259200000).toISOString() }
    ];
    
    // Create activities with staggered timestamps
    testActivities.forEach((testActivity, index) => {
        setTimeout(() => {
            // Create activity with specific timestamp
            const activityData = {
                action: testActivity.action,
                details: testActivity.details,
                timestamp: testActivity.timestamp
            };
            
            console.log(`Creating activity: ${testActivity.details} at ${testActivity.timestamp}`);
            
            // Send to server for storage
            fetch('/api/activity/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(activityData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log(`‚úÖ Activity created: ${testActivity.details}`);
                } else {
                    console.warn(`‚ö†Ô∏è Activity creation failed: ${result.error}`);
                }
            })
            .catch(error => {
                console.error(`‚ùå Error creating activity: ${error}`);
            });
        }, index * 1000); // 1 second apart
    });
    
    // Refresh display after creating test activities
    setTimeout(() => {
        refreshActivityDisplay();
        console.log('üîÑ Refreshed activity display after creating test activities');
    }, testActivities.length * 1000 + 2000);
}

// Expose test function globally
window.createTestActivitiesWithTimestamps = createTestActivitiesWithTimestamps;



// Test function to create activities with older timestamps for demonstration
function createOlderTestActivities() {
    console.log('üß™ Creating test activities with older timestamps...');
    
    const now = Date.now();
    const testActivities = [
        { action: 'page_view', details: 'Visited Home (/)', timestamp: new Date(now - 5000).toISOString() },
        { action: 'page_view', details: 'Visited Outages (/outages/)', timestamp: new Date(now - 30000).toISOString() },
        { action: 'page_view', details: 'Visited Settings (/settings/)', timestamp: new Date(now - 120000).toISOString() },
        { action: 'search', details: 'Searched for "network"', timestamp: new Date(now - 900000).toISOString() },
        { action: 'file_upload', details: 'Uploaded report.pdf', timestamp: new Date(now - 3600000).toISOString() },
        { action: 'login', details: 'User logged in', timestamp: new Date(now - 10800000).toISOString() },
        { action: 'page_view', details: 'Visited Dashboard', timestamp: new Date(now - 86400000).toISOString() },
        { action: 'search', details: 'Searched for "help"', timestamp: new Date(now - 259200000).toISOString() }
    ];
    
    // Create activities with staggered timestamps
    testActivities.forEach((testActivity, index) => {
        setTimeout(() => {
            // Create activity with specific timestamp
            const activityData = {
                action: testActivity.action,
                details: testActivity.details,
                timestamp: testActivity.timestamp
            };
            
            console.log(`Creating activity: ${testActivity.details} at ${testActivity.timestamp}`);
            
            // Send to server for storage
            fetch('/api/activity/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(activityData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log(`‚úÖ Activity created: ${testActivity.details}`);
                } else {
                    console.warn(`‚ö†Ô∏è Activity creation failed: ${result.error}`);
                }
            })
            .catch(error => {
                console.error(`‚ùå Error creating activity: ${error}`);
            });
        }, index * 1000); // 1 second apart
    });
    
    // Refresh display after creating test activities
    setTimeout(() => {
        loadAllActivityInstant();
        console.log('üîÑ Refreshed activity display after creating test activities');
    }, testActivities.length * 1000 + 2000);
}

// Expose test function globally
window.createOlderTestActivities = createOlderTestActivities;

// Function to clear all activities and start fresh
function clearAllActivities() {
    console.log('üßπ Clearing all activities...');
    
    fetch('/api/settings/clear-activity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        console.log('‚úÖ Activities cleared:', result.message);
        // Refresh the display
        setTimeout(() => {
            loadAllActivityInstant();
        }, 1000);
    })
    .catch(error => {
        console.error('‚ùå Error clearing activities:', error);
    });
}

// Expose clear function globally
window.clearAllActivities = clearAllActivities;

// Test function to manually trigger activity loading
function testActivityDisplay() {
    console.log('üß™ Testing activity display...');
    loadAllActivityInstant();
}

// Expose test function globally
window.testActivityDisplay = testActivityDisplay;
</script> 