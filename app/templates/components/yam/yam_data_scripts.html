<script>
// Data loading functions
const currentUserRole = '{{ current_user.role }}';
function loadOutagesData(period = '7d', customStart = null, customEnd = null) {
    console.log('Loading outages data for period:', period);
    
    fetch('/api/admin/outages?all=true')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(outages => {
            console.log('Received outages data:', outages);
            
            // Ensure outages is an array
            if (!Array.isArray(outages)) {
                console.warn('Outages data is not an array:', outages);
                outages = [];
            }
            
            // Process outages data
            const processedOutages = outages.map(outage => ({
                ...outage,
                start_time: new Date(outage.start_time).toISOString(),
                end_time: outage.end_time ? new Date(outage.end_time).toISOString() : null
            }));
            
            updateOutageStats(processedOutages);
            updateCurrentOutages(processedOutages);
            updateOutageChart(processedOutages, period, customStart, customEnd);
        })
        .catch(error => {
            console.error('Error loading outages:', error);
            document.getElementById('currentOutages').innerHTML = '<div class="no-data">Error loading outages: ' + error.message + '</div>';
            
            // Show empty chart on error
            if (outageChart) {
                outageChart.data.labels = [];
                outageChart.data.datasets[0].data = [];
                outageChart.update();
            }
        });
}

function loadUserActivity() {
    // Fetch the full activity log for the current user then show the latest 5
    fetch('/api/activity/all')
        .then(response => response.json())
        .then(result => {
            const activities = (result.activities || []).slice(0, 5); // only latest 5 for sidebar widget
            updateRecentActivity(activities);
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            document.getElementById('recentActivity').innerHTML = '<div class="no-data">Error loading activity</div>';
        });
}

function loadOutagesForManagement() {
    fetch('/api/admin/outages?all=true')
        .then(response => response.json())
        .then(outages => {
            updateOutagesList(outages);
        })
        .catch(error => {
            console.error('Error loading outages for management:', error);
            document.getElementById('currentOutagesList').innerHTML = '<div class="no-data">Error loading outages</div>';
        });
}

// Update functions
function updateOutageStats(outages) {
    const now = new Date();
    const activeOutages = outages.filter(outage => outage.status === 'active');
    const totalOutages = outages.length;
    
    // Update active outages count
    const activeOutagesElement = document.getElementById('activeOutages');
    const activeOutagesStat = document.getElementById('activeOutagesStat');
    
    if (activeOutagesElement) {
        activeOutagesElement.textContent = activeOutages.length;
        
        // Hide active outages stat if count is 0
        if (activeOutagesStat) {
            if (activeOutages.length === 0) {
                activeOutagesStat.classList.add('hidden');
            } else {
                activeOutagesStat.classList.remove('hidden');
            }
        }
    }
    
    // Update total outages count
    const totalOutagesElement = document.getElementById('totalOutages');
    if (totalOutagesElement) {
        totalOutagesElement.textContent = totalOutages;
    }
    
    console.log('Updated outage stats - Active:', activeOutages.length, 'Total:', totalOutages);
}

function updateCurrentOutages(outages) {
    const currentOutagesContainer = document.getElementById('currentOutages');
    const currentOutagesModalContent = document.getElementById('currentOutagesModalContent');
    
    // Update both the hidden container and modal content
    const containers = [currentOutagesContainer, currentOutagesModalContent];
    
    containers.forEach(container => {
        if (!container) return;
        
        const activeOutages = outages.filter(outage => outage.status === 'active');
        
        if (activeOutages.length === 0) {
            container.innerHTML = `
                <div class="no-outages">
                    <div class="no-outages-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="no-outages-text">
                        <h4>All Systems Operational</h4>
                        <p>No active outages at this time</p>
                    </div>
                </div>
            `;
            return;
        }
        
        const outagesHTML = activeOutages.map(outage => {
            const startTime = new Date(outage.start_time);
            const duration = getDuration(startTime);
            const severity = getSeverityLevel(outage.title, outage.description);
            
            return `
                <div class="outage-item ${severity}" onclick="showOutageDetails('${outage.id}')">
                    <div class="outage-header">
                        <div class="outage-title">${outage.title}</div>
                        <div class="outage-severity ${severity}">${severity.toUpperCase()}</div>
                    </div>
                    <div class="outage-description">${outage.description}</div>
                    <div class="outage-meta">
                        <span class="outage-time">
                            <i class="bi bi-clock"></i>
                            Started ${formatTimeAgo(startTime)} (${duration})
                        </span>
                        ${outage.affected_systems ? `
                            <span class="outage-systems">
                                <i class="bi bi-server"></i>
                                ${outage.affected_systems}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = outagesHTML;
    });
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity');

    // Filter activities for current user and limit to 5
    const userActivities = activities.filter(a => a.user === '{{ current_user.username }}').slice(0, 5);

    if (userActivities.length === 0) {
        container.innerHTML = '<div class="no-data">No recent activity</div>';
        return;
    }

    container.innerHTML = userActivities.map(activity => {
        const time = new Date(activity.timestamp);
        const timeAgo = getTimeAgo(time);
        const icon = getActivityIcon(activity.action);

        const description = formatActivityType(activity.action, activity.details);

        return `
            <div class="activity-item">
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-desc">${description}</div>
                    <div class="activity-time">${timeAgo}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Utility functions
function getActivityIcon(action) {
    const icons = {
        'page_view': 'bi-eye',
        'search': 'bi-search',
        'login': 'bi-box-arrow-in-right',
        'logout': 'bi-box-arrow-left',
        'outage_created': 'bi-exclamation-triangle',
        'file_upload': 'bi-cloud-upload',
        'file_download': 'bi-cloud-download',
        'settings_changed': 'bi-gear'
    };
    const iconClass = icons[action] || 'bi-activity';
    return `<i class="bi ${iconClass}"></i>`;
}

function formatActivityType(action, details = '') {
    const baseMap = {
        'page_view': 'Visited',
        'search': 'Selected',
        'login': 'Logged In',
        'logout': 'Logged Out',
        'outage_created': 'Created Outage',
        'file_upload': 'Uploaded File',
        'file_download': 'Downloaded File',
        'settings_changed': 'Changed Settings'
    };

    let text = baseMap[action] || action.replace('_', ' ').toUpperCase();

    // Add details for page views and searches to make the feed meaningful
    if (action === 'page_view' && details) {
        text = `${text} ${details}`;
    } else if (action === 'search' && details) {
        text = `${text} "${details}"`;
    }

    return text;
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
}

function getDuration(startTime) {
    const now = new Date();
    const diffMs = now - startTime;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (diffHours > 0) {
        return `${diffHours}h ${diffMinutes}m`;
    } else {
        return `${diffMinutes}m`;
    }
}

function getSeverityLevel(title, description) {
    const text = (title + ' ' + description).toLowerCase();
    
    if (text.includes('critical') || text.includes('emergency') || text.includes('down')) {
        return 'critical';
    } else if (text.includes('high') || text.includes('major')) {
        return 'high';
    } else if (text.includes('medium') || text.includes('minor')) {
        return 'medium';
    } else {
        return 'low';
    }
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays > 0) {
        return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    } else if (diffHours > 0) {
        return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    } else if (diffMinutes > 0) {
        return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
    } else {
        return 'Just now';
    }
}

function filterOutages(severity) {
    // This function can be enhanced to filter outages by severity
    console.log('Filtering outages by severity:', severity);
    // For now, just reload the data
    loadOutagesData();
}

function showOutageDetails(outageId) {
    // This function can be enhanced to show detailed outage information
    console.log('Showing details for outage:', outageId);
    // You can implement a modal or redirect to a detailed view
}

// Time period button functionality
document.addEventListener('DOMContentLoaded', function() {
    const timeButtons = document.querySelectorAll('.outages-card .time-btn');
    
    timeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            timeButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get the period and load data
            const period = this.getAttribute('data-period');
            if (period === 'custom') {
                // Handle custom date selection
                openCustomDateModal();
            } else {
                loadOutagesData(period);
            }
        });
    });
    
    // Custom date button functionality
    const customDateBtn = document.getElementById('customDateBtn');
    if (customDateBtn) {
        customDateBtn.addEventListener('click', function() {
            openCustomDateModal();
        });
    }
});

function openCustomDateModal() {
    // This function can be implemented to open a custom date selection modal
    console.log('Opening custom date modal');
    // You can implement a modal for date selection
}

// Real-time update functionality
let outageUpdateInterval;

function startOutageUpdates() {
    // Update outages every 30 seconds
    outageUpdateInterval = setInterval(() => {
        loadOutagesData();
    }, 30000);
    
    console.log('Started real-time outage updates');
}

function stopOutageUpdates() {
    if (outageUpdateInterval) {
        clearInterval(outageUpdateInterval);
        outageUpdateInterval = null;
        console.log('Stopped real-time outage updates');
    }
}

// Initialize real-time updates when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initial activity fetch
    loadUserActivity();

    // Start outage polling after a short delay
    setTimeout(startOutageUpdates, 2000);

    // Live activity updates via Socket.IO
    if (typeof window.yamSocketManager !== 'undefined' && window.yamSocketManager.socket) {
        const sock = window.yamSocketManager.socket;

        if (!sock._recentActivityBound) { // prevent double-binding
            sock.on('activity_update', (payload) => {
                try {
                    if (!payload) return;
                    const username = (typeof payload.user === 'string') ? payload.user : (payload.user && payload.user.name);
                    if (username !== '{{ current_user.username }}') return; // only own events
                    // Prepend new event and redraw list (keep max 5)
                    const container = document.getElementById('recentActivity');
                    if (!container) return;

                    const latest = {
                        id: payload.id,
                        user: payload.user,
                        action: payload.type || payload.action,
                        details: payload.description || payload.details || '',
                        timestamp: payload.timestamp || new Date().toISOString()
                    };

                    // Build existing cache from DOM if available
                    const current = Array.from(container.querySelectorAll('.activity-item')).map(item => ({
                        html: item.outerHTML
                    }));

                    // Render new item HTML using utility
                    const icon = getActivityIcon(latest.action);
                    const description = formatActivityType(latest.action, latest.details);
                    const timeAgo = 'Just now';
                    const newHtml = `
                        <div class="activity-item">
                            <div class="activity-icon">${icon}</div>
                            <div class="activity-content">
                                <div class="activity-desc">${description}</div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>`;

                    // Insert new and trim
                    container.insertAdjacentHTML('afterbegin', newHtml);
                    const extra = container.querySelectorAll('.activity-item');
                    extra.forEach((el, idx) => { if (idx > 4) el.remove(); });

                } catch (e) { console.debug('activity_update handling failed', e); }
            });
            sock._recentActivityBound = true;
        }
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', stopOutageUpdates);
});

// Socket.io integration for real-time updates (if available)
if (typeof window.yamSocketManager !== 'undefined' && window.yamSocketManager.socket) {
    const socket = window.yamSocketManager.socket;
    
    socket.on('outage_update', (data) => {
        console.log('Received real-time outage update:', data);
        // Refresh outages data immediately
        const activeBtn = document.querySelector('.time-btn.active');
        if (activeBtn && activeBtn.id !== 'customDateBtn') {
            loadOutagesData(activeBtn.dataset.period);
        } else {
            loadOutagesData('7d');
        }
    });
    
    socket.on('new_outage', (data) => {
        console.log('Received new outage notification:', data);
        // Refresh outages data immediately
        const activeBtn = document.querySelector('.time-btn.active');
        if (activeBtn && activeBtn.id !== 'customDateBtn') {
            loadOutagesData(activeBtn.dataset.period);
        } else {
            loadOutagesData('7d');
        }
    });
}

// Export functions for global access
window.loadOutagesData = loadOutagesData;
window.updateOutageChart = updateOutageChart;
window.startOutageUpdates = startOutageUpdates;
window.stopOutageUpdates = stopOutageUpdates;

// Test function to verify chart functionality
window.testOutageChart = function() {
    console.log('Testing outage chart functionality...');
    
    // Test data
    const testOutages = [
        {
            id: 1,
            title: 'Test Outage 1',
            description: 'This is a test outage',
            start_time: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
            end_time: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(), // 12 hours ago
            status: 'resolved',
            affected_systems: 'Test System'
        },
        {
            id: 2,
            title: 'Test Outage 2',
            description: 'This is another test outage',
            start_time: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(), // 6 hours ago
            end_time: null,
            status: 'active',
            affected_systems: 'Test System 2'
        }
    ];
    
    console.log('Test outages data:', testOutages);
    
    // Update chart with test data
    updateOutageStats(testOutages);
    updateCurrentOutages(testOutages);
    updateOutageChart(testOutages, '7d');
    
    console.log('Test completed. Check the chart and stats for test data.');
};

// Add a function to check chart status
window.checkChartStatus = function() {
    console.log('Chart status check:');
    console.log('- outageChart variable:', typeof outageChart);
    console.log('- Chart instance:', outageChart);
    console.log('- Chart data:', outageChart ? outageChart.data : 'N/A');
    console.log('- Chart options:', outageChart ? outageChart.options : 'N/A');
    
    const canvas = document.getElementById('outageChart');
    console.log('- Canvas element:', canvas);
    console.log('- Canvas context:', canvas ? canvas.getContext('2d') : 'N/A');
};

// Modal functions for current outages
function openCurrentOutagesModal() {
    const modal = document.getElementById('currentOutagesModal');
    if (modal) {
        modal.classList.add('show');
        // Refresh the data in the modal
        if (typeof loadOutagesData === 'function') {
            loadOutagesData();
        }
    }
}

function closeCurrentOutagesModal() {
    const modal = document.getElementById('currentOutagesModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('outage-modal')) {
        e.target.classList.remove('show');
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.querySelector('.outage-modal.show');
        if (modal) {
            modal.classList.remove('show');
        }
    }
});
</script> 