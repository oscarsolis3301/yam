{% extends "base.html" %}

{% block content %}
<style>
body {
    background: #0a0a0a;
    color: #e0e0e0;
    margin: 0;
    padding: 0;
    font-family: 'Inter', Arial, sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
}

.dashboard-container {
    padding: 0.5rem;
    width: 100%;
    min-height: 100vh;
    box-sizing: border-box;
}

.welcome-header {
    text-align: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(20, 20, 20, 0.8);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.welcome-title {
    font-size: 2.2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
    min-height: calc(100vh - 160px);
}

.main-content {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    height: 100%;
}

.yam-main-content {
    height: 100%;
}

.card {
    background: rgba(20, 20, 20, 0.8);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    height: fit-content;
}

/* Outages container with proper padding and height */
.outages-card {
    background: rgba(20, 20, 20, 0.8);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    height: 100%;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #00d4ff;
    margin: 0;
}

.time-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.time-btn {
    padding: 0.4rem 0.8rem;
    background: rgba(40, 40, 40, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.time-btn:hover, .time-btn.active {
    background: rgba(220, 53, 69, 0.3);
    border-color: #dc3545;
    color: #fff;
}

.custom-date-btn {
    background: rgba(0, 212, 255, 0.2) !important;
    border-color: #00d4ff !important;
}

.custom-date-btn:hover, .custom-date-btn.active {
    background: rgba(0, 212, 255, 0.4) !important;
    border-color: #00d4ff !important;
}

.outage-chart {
    height: 300px;
    position: relative;
    margin-bottom: 1.5rem;
    flex-shrink: 0;
}

.chart-canvas {
    width: 100%;
    height: 100%;
}

.outage-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-shrink: 0;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: rgba(40, 40, 40, 0.6);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #dc3545;
}

.stat-label {
    font-size: 0.8rem;
    color: #999;
}

.outage-management {
    margin-top: 1rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.current-outages {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
    flex: 1;
    margin-bottom: 1rem;
}

.outage-item {
    padding: 0.8rem;
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
    border-radius: 6px;
    font-size: 0.9rem;
    border: 1px solid rgba(220, 53, 69, 0.2);
}

.outage-item strong {
    color: #ff6b7a;
}

.user-profile {
    text-align: center;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 1rem;
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    border: 3px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.profile-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #fff;
}

.profile-role {
    font-size: 0.9rem;
    color: #999;
    margin-bottom: 1rem;
}

.recent-activity {
    text-align: left;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 0.6rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 0.85rem;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0, 212, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.8rem;
    font-size: 0.7rem;
    color: #00d4ff;
}

.activity-content {
    flex: 1;
}

.activity-time {
    color: #666;
    font-size: 0.7rem;
}

.directory-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: space-between;
}

.directory-item {
    padding: 1.5rem;
    background: rgba(40, 40, 40, 0.6);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    text-decoration: none;
    color: #e0e0e0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    text-align: left;
    flex: 1;
    min-width: 200px;
    max-width: 300px;
}

.directory-item:hover {
    background: rgba(60, 60, 60, 0.8);
    transform: translateY(-2px);
    color: #fff;
    text-decoration: none;
    border-color: rgba(0, 212, 255, 0.3);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.directory-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(0, 212, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: #00d4ff;
    border: 1px solid rgba(0, 212, 255, 0.2);
}

.directory-content {
    flex: 1;
}

.directory-name {
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: #fff;
}

.directory-desc {
    font-size: 0.75rem;
    color: #999;
    line-height: 1.3;
}

.no-data {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 2rem;
}

.admin-actions {
    margin-top: auto;
    text-align: center;
    flex-shrink: 0;
}

.admin-btn {
    background: linear-gradient(45deg, #dc3545, #c82333);
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.admin-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* Custom Date Modal */
.custom-date-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
}

.custom-date-content {
    background: rgba(20, 20, 20, 0.95);
    margin: 15% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.custom-date-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.custom-date-title {
    color: #00d4ff;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}

.close-modal {
    color: #666;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

.close-modal:hover {
    color: #fff;
}

.date-input-group {
    margin-bottom: 1rem;
}

.date-input-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #ccc;
    font-size: 0.9rem;
}

.date-input-group input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    background: rgba(40, 40, 40, 0.8);
    color: #e0e0e0;
    font-size: 0.9rem;
    box-sizing: border-box;
}

.date-input-group input:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.apply-custom-date {
    width: 100%;
    padding: 0.8rem;
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.apply-custom-date:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
}

@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        order: -1;
    }
    
    .outages-card {
        height: auto;
        min-height: 600px;
    }
    
    .user-profile {
        height: auto;
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 0.4rem;
    }
    
    .welcome-title {
        font-size: 1.8rem;
    }
    
    .time-controls {
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .time-btn {
        width: 100%;
        text-align: center;
    }
    
    .directory-grid {
        flex-direction: column;
    }
    
    .directory-item {
        min-width: auto;
        max-width: none;
    }
    
    .outage-stats {
        grid-template-columns: 1fr;
    }
    
    .outage-chart {
        height: 250px;
    }
}
</style>

<div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="welcome-header">
        <h1 class="welcome-title">Welcome, {{ current_user.username.title() }}!</h1>
        <p style="color: #999; margin: 0;">Your YAM Dashboard - System Overview</p>
    </div>

    <!-- Main Dashboard Grid - FLIPPED LAYOUT -->
    <div class="dashboard-grid">
        <!-- Sidebar (now on the left) -->
        <div class="sidebar">
            <!-- User Profile -->
            <div class="card user-profile">
                <div class="profile-avatar" id="profileAvatar">
                    {% if current_user.profile_picture %}
                        <img src="{{ current_user.profile_picture }}" alt="Profile Picture" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <span style="display: none;">{{ current_user.username[0].upper() }}</span>
                    {% else %}
                        {{ current_user.username[0].upper() }}
                    {% endif %}
                </div>
                <div class="profile-name" id="profileName">{{ current_user.username.title() }}</div>
                <div class="profile-role" id="profileRole">{{ current_user.role.title() if current_user.role else 'User' }}</div>
                
                <div class="recent-activity">
                    <h4 style="color: #00d4ff; margin-bottom: 0.8rem; text-align: center;">Recent Activity</h4>
                    <div id="recentActivity">
                        <div class="no-data">Loading activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content (now on the right) -->
        <div class="yam-main-content">
            <!-- Outages Section -->
            <div class="outages-card">
                <div class="card-header">
                    <h2 class="card-title">System Outages</h2>
                    <div class="time-controls">
                        <button class="time-btn" data-period="3d">3D</button>
                        <button class="time-btn active" data-period="7d">7D</button>
                        <button class="time-btn" data-period="14d">14D</button>
                        <button class="time-btn" data-period="30d">30D</button>
                        <button class="time-btn custom-date-btn" id="customDateBtn">Custom</button>
                    </div>
                </div>
                
                <div class="outage-chart">
                    <canvas id="outageChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="outage-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="activeOutages">-</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalOutages">-</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgDuration">-</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                </div>

                <!-- Current Outages -->
                <div class="outage-management">
                    <h3 style="color: #dc3545; margin-bottom: 0.8rem;">Current Outages</h3>
                    <div class="current-outages" id="currentOutages">
                        <div class="no-data">Loading outages...</div>
                    </div>
                    
                    {% if current_user.role in ['admin', 'manager', 'developer'] %}
                    <div class="admin-actions">
                        <button class="admin-btn" onclick="window.location.href='/outages'">Manage Outages</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Directory -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Quick Navigation</h2>
        </div>
        
        <div class="directory-grid">
            <a href="/kb" class="directory-item">
                <div class="directory-icon">KB</div>
                <div class="directory-content">
                    <div class="directory-name">Knowledge Base</div>
                    <div class="directory-desc">Search articles & documentation</div>
                </div>
            </a>
            
            <a href="/collab_notes" class="directory-item">
                <div class="directory-icon">NT</div>
                <div class="directory-content">
                    <div class="directory-name">Notes</div>
                    <div class="directory-desc">Collaborative notes & documents</div>
                </div>
            </a>
            
            <a href="/outages" class="directory-item">
                <div class="directory-icon">AL</div>
                <div class="directory-content">
                    <div class="directory-name">Outages</div>
                    <div class="directory-desc">System status & incidents</div>
                </div>
            </a>
            
            <a href="/settings" class="directory-item">
                <div class="directory-icon">ST</div>
                <div class="directory-content">
                    <div class="directory-name">Settings</div>
                    <div class="directory-desc">Account & system preferences</div>
                </div>
            </a>
            
            <a href="/service_desk" class="directory-item">
                <div class="directory-icon">SD</div>
                <div class="directory-content">
                    <div class="directory-name">Service Desk</div>
                    <div class="directory-desc">Tickets & support requests</div>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- Custom Date Modal -->
<div id="customDateModal" class="custom-date-modal">
    <div class="custom-date-content">
        <div class="custom-date-header">
            <h3 class="custom-date-title">Select Custom Date Range</h3>
            <button class="close-modal" onclick="closeCustomDateModal()">&times;</button>
        </div>
        <div class="date-input-group">
            <label for="startDate">Start Date:</label>
            <input type="datetime-local" id="startDate" required>
        </div>
        <div class="date-input-group">
            <label for="endDate">End Date:</label>
            <input type="datetime-local" id="endDate" required>
        </div>
        <button class="apply-custom-date" onclick="applyCustomDate()">Apply Date Range</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart
    const ctx = document.getElementById('outageChart').getContext('2d');
    let outageChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Outages',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: '#999'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: '#999',
                        beginAtZero: true
                    }
                }
            }
        }
    });

    // Load real data
    loadOutagesData();
    loadUserActivity();

    // Time period controls
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.id === 'customDateBtn') {
                openCustomDateModal();
                return;
            }
            
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadOutagesData(this.dataset.period);
        });
    });

    // Custom date modal functions
    window.openCustomDateModal = function() {
        document.getElementById('customDateModal').style.display = 'block';
        
        // Set default dates (last 7 days)
        const now = new Date();
        const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
        
        document.getElementById('endDate').value = now.toISOString().slice(0, 16);
        document.getElementById('startDate').value = sevenDaysAgo.toISOString().slice(0, 16);
    };

    window.closeCustomDateModal = function() {
        document.getElementById('customDateModal').style.display = 'none';
    };

    window.applyCustomDate = function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        if (new Date(startDate) >= new Date(endDate)) {
            alert('Start date must be before end date');
            return;
        }
        
        // Update button states
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('customDateBtn').classList.add('active');
        
        // Load data with custom date range
        loadOutagesData('custom', startDate, endDate);
        closeCustomDateModal();
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('customDateModal');
        if (event.target === modal) {
            closeCustomDateModal();
        }
    };

    function loadOutagesData(period = '7d', customStart = null, customEnd = null) {
        fetch('/api/admin/outages?all=true')
            .then(response => response.json())
            .then(outages => {
                updateOutageStats(outages);
                updateCurrentOutages(outages);
                updateOutageChart(outages, period, customStart, customEnd);
            })
            .catch(error => {
                console.error('Error loading outages:', error);
                document.getElementById('currentOutages').innerHTML = '<div class="no-data">Error loading outages</div>';
            });
    }

    function updateOutageStats(outages) {
        const activeOutages = outages.filter(o => o.status === 'active');
        const resolvedOutages = outages.filter(o => o.status === 'resolved');
        
        document.getElementById('activeOutages').textContent = activeOutages.length;
        document.getElementById('totalOutages').textContent = outages.length;
        
        if (resolvedOutages.length > 0) {
            const avgDuration = resolvedOutages.reduce((sum, o) => {
                const start = new Date(o.start_time);
                const end = new Date(o.end_time);
                return sum + (end - start);
            }, 0) / resolvedOutages.length;
            
            const hours = Math.round(avgDuration / (1000 * 60 * 60));
            document.getElementById('avgDuration').textContent = hours + 'h';
        } else {
            document.getElementById('avgDuration').textContent = 'N/A';
        }
    }

    function updateCurrentOutages(outages) {
        const activeOutages = outages.filter(o => o.status === 'active');
        const container = document.getElementById('currentOutages');
        
        if (activeOutages.length === 0) {
            container.innerHTML = '<div class="no-data">No active outages</div>';
            return;
        }
        
        container.innerHTML = activeOutages.map(outage => {
            const startTime = new Date(outage.start_time);
            const timeDiff = new Date() - startTime;
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            return `
                <div class="outage-item">
                    <strong>${outage.title}</strong><br>
                    <small>${outage.description}</small><br>
                    <small style="color: #ff9999;">Duration: ${hours}h ${minutes}m</small>
                </div>
            `;
        }).join('');
    }

    function updateOutageChart(outages, period, customStart = null, customEnd = null) {
        const now = new Date();
        const labels = [];
        const data = [];
        
        let periodHours, intervalHours, format, startDate, endDate;
        
        if (period === 'custom' && customStart && customEnd) {
            startDate = new Date(customStart);
            endDate = new Date(customEnd);
            const totalHours = (endDate - startDate) / (1000 * 60 * 60);
            
            if (totalHours <= 24) {
                intervalHours = 1;
                format = { hour: 'numeric', minute: '2-digit' };
            } else if (totalHours <= 168) { // 7 days
                intervalHours = 6;
                format = { day: 'numeric', hour: 'numeric' };
            } else {
                intervalHours = 24;
                format = { day: 'numeric', month: 'short' };
            }
        } else {
            switch(period) {
                case '3d':
                    periodHours = 3 * 24;
                    intervalHours = 6;
                    format = { day: 'numeric', hour: 'numeric' };
                    break;
                case '7d':
                    periodHours = 7 * 24;
                    intervalHours = 12;
                    format = { day: 'numeric', hour: 'numeric' };
                    break;
                case '14d':
                    periodHours = 14 * 24;
                    intervalHours = 24;
                    format = { day: 'numeric', month: 'short' };
                    break;
                case '30d':
                    periodHours = 30 * 24;
                    intervalHours = 24;
                    format = { day: 'numeric', month: 'short' };
                    break;
                default: // 7d
                    periodHours = 7 * 24;
                    intervalHours = 12;
                    format = { day: 'numeric', hour: 'numeric' };
            }
            startDate = new Date(now.getTime() - (periodHours * 60 * 60 * 1000));
            endDate = now;
        }
        
        // Generate labels and data points
        const totalHours = (endDate - startDate) / (1000 * 60 * 60);
        const numPoints = Math.ceil(totalHours / intervalHours);
        
        for (let i = 0; i <= numPoints; i++) {
            const time = new Date(startDate.getTime() + (i * intervalHours * 60 * 60 * 1000));
            if (time > endDate) break;
            
            labels.push(time.toLocaleString('en-US', format));
            
            const periodStart = new Date(time.getTime() - (intervalHours * 60 * 60 * 1000));
            const periodEnd = time;
            
            const outagesInPeriod = outages.filter(outage => {
                const outageStart = new Date(outage.start_time);
                return outageStart >= periodStart && outageStart < periodEnd;
            });
            
            data.push(outagesInPeriod.length);
        }
        
        outageChart.data.labels = labels;
        outageChart.data.datasets[0].data = data;
        outageChart.update();
    }

    function loadUserActivity() {
        fetch('/api/activity/recent')
            .then(response => response.json())
            .then(result => {
                const activities = result.activities || [];
                updateRecentActivity(activities);
            })
            .catch(error => {
                console.error('Error loading activity:', error);
                document.getElementById('recentActivity').innerHTML = '<div class="no-data">Error loading activity</div>';
            });
    }

    function updateRecentActivity(activities) {
        const container = document.getElementById('recentActivity');
        
        // Filter activities for current user
        const userActivities = activities.filter(a => a.user === '{{ current_user.username }}').slice(0, 5);
        
        if (userActivities.length === 0) {
            container.innerHTML = '<div class="no-data">No recent activity</div>';
            return;
        }
        
        container.innerHTML = userActivities.map(activity => {
            const time = new Date(activity.timestamp);
            const timeAgo = getTimeAgo(time);
            const icon = getActivityIcon(activity.action);
            
            return `
                <div class="activity-item">
                    <div class="activity-icon">${icon}</div>
                    <div class="activity-content">
                        <div>${formatActivityType(activity.action)}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getActivityIcon(action) {
        const icons = {
            'page_view': 'V',
            'search': 'S',
            'login': 'L',
            'logout': 'O',
            'outage_created': 'A',
            'file_upload': 'F',
            'settings_changed': 'C'
        };
        return icons[action] || 'A';
    }

    function formatActivityType(action) {
        const types = {
            'page_view': 'Viewed Page',
            'search': 'Performed Search',
            'login': 'Logged In',
            'logout': 'Logged Out',
            'outage_created': 'Created Outage',
            'file_upload': 'Uploaded File',
            'settings_changed': 'Changed Settings'
        };
        return types[action] || action.replace('_', ' ').toUpperCase();
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
    }

    // Refresh data every 30 seconds
    setInterval(() => {
        const activeBtn = document.querySelector('.time-btn.active');
        if (activeBtn && activeBtn.id !== 'customDateBtn') {
            loadOutagesData(activeBtn.dataset.period);
        }
        loadUserActivity();
    }, 30000);
});
</script>
{% endblock %}
