{% extends "base.html" %}

{% block content %}
<!-- Cache Busting for Session Monitor Fix -->
<script>
// Force refresh of cached JavaScript files - Session Monitor Fix v1.1
if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
    });
}
// Clear any existing session activity throttles
if (window.YAM_SESSION_ACTIVITY_THROTTLE) {
    window.YAM_SESSION_ACTIVITY_THROTTLE = null;
}

// GLOBAL EMERGENCY OVERRIDE - Block ALL session activity spam
window.YAM_EMERGENCY_THROTTLE = {
    lastCall: 0,
    callCount: 0,
    blocked: 0
};

// Override fetch to block excessive session activity calls
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (url && url.includes('/api/session/activity')) {
        const now = Date.now();
        const throttle = window.YAM_EMERGENCY_THROTTLE;
        
        // Allow maximum 1 call per 10 minutes
        if ((now - throttle.lastCall) < 600000) {
            throttle.blocked++;
            console.debug(`ðŸš« Blocked session activity call #${throttle.blocked} - throttling active`);
            return Promise.resolve(new Response('{"success":true,"throttled":true}', {
                status: 200,
                headers: { 'Content-Type': 'application/json' }
            }));
        }
        
        throttle.lastCall = now;
        throttle.callCount++;
        console.log(`âœ… Allowing session activity call #${throttle.callCount}`);
    }
    return originalFetch.apply(this, arguments);
};

console.log('YAM: Cleared cache, session activity throttles, and installed emergency override');
</script>

<!-- Include all styles -->
{% include 'components/yam/yam_dashboard_styles.html' %}

<div class="dashboard-container">
    <!-- Welcome Header -->
    {% include 'components/yam/yam_welcome_header.html' %}

    <!-- Main Dashboard Grid - Optimized Layout -->
    <div class="dashboard-grid">
        <!-- Sidebar (left side) - Enhanced with Expanded Reminders -->
        <div class="sidebar">
            <!-- Enhanced User Profile with Expanded Reminders Above -->
            {% include 'components/yam/yam_user_profile.html' %}
        </div>

        <!-- Main Content (right side) - Optimized -->
        <div class="yam-main-content">
            <!-- Charts Grid - Side by Side Layout -->
            <div class="charts-grid">
                <!-- Outages Section -->
                {% include 'components/yam/yam_outages_section.html' %}
                
                <!-- User Tickets Section -->
                {% include 'components/yam/yam_user_tickets_section.html' %}
            </div>
            
            <!-- Dashboard Widgets - Media Player replaces Calendar -->
            {% include 'components/yam/yam_dashboard_widgets.html' %}
        </div>
    </div>

    <!-- Navigation Directory -->
    {% include 'components/yam/yam_navigation_directory.html' %}
</div>

<!-- Modals -->
{% include 'components/yam/yam_outage_detail_modal.html' %}
{% include 'components/yam/yam_custom_date_modal.html' %}
{% include 'components/yam/yam_outages_management_modal.html' %}

<!-- Include all JavaScript -->
{% include 'components/yam/yam_core_scripts.html' %}
{% include 'components/yam/yam_modal_scripts.html' %}
{% include 'components/yam/yam_data_scripts.html' %}
{% include 'components/yam/yam_chart_and_management_scripts.html' %}
{% include 'components/yam/yam_outage_management_scripts.html' %}
{% include 'components/yam/yam_widget_scripts.html' %}
{% include 'components/yam/yam_user_tickets_scripts.html' %}

<style>
/* YAM Layout Enhancements - Optimized Flow */
.dashboard-container {
    gap: 0.8rem; /* Reduced gap for tighter layout */
}

.dashboard-grid {
    gap: 0.8rem; /* Reduced gap */
    min-height: auto; /* Remove fixed height */
    align-items: stretch; /* Ensure containers stretch to match */
}

.yam-main-content {
    gap: 0.8rem; /* Reduced gap */
    height: auto; /* Remove fixed height */
}

.charts-grid {
    gap: 0.8rem; /* Reduced gap */
    margin-bottom: 0.8rem; /* Reduced margin */
}

/* Ensure sidebar and main content are properly aligned */
.sidebar {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.sidebar-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* Responsive optimizations */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 0.6rem;
    }
    
    .sidebar {
        order: -1; /* Keep reminders at top on mobile */
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 0.6rem;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        gap: 0.5rem;
        padding: 0.5rem;
    }
    
    .dashboard-grid {
        gap: 0.5rem;
    }
    
    .yam-main-content {
        gap: 0.5rem;
    }
    
    .charts-grid {
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
}
</style>

<script>
// Enhanced YAM Dashboard Initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('YAM Dashboard Enhanced - Loaded');
    
    // Initialize all components
    if (typeof loadReminders === 'function') {
        loadReminders();
    }
    
    if (typeof loadCalendarEvents === 'function') {
        loadCalendarEvents();
    }
    
    if (typeof renderCalendar === 'function') {
        renderCalendar();
    }
    
    if (typeof renderExpandedReminders === 'function') {
        renderExpandedReminders();
    }
    
    // Add smooth scroll behavior
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Show welcome message
    setTimeout(() => {
        if (typeof showToast === 'function') {
            showToast('Welcome to your enhanced YAM Dashboard!', 'success');
        }
    }, 1000);
});

// Enhanced calendar modal opening from reminders widget
function openCalendarModal() {
    const modal = document.getElementById('calendarModal');
    if (modal) {
        modal.classList.add('show');
        // Ensure calendar is rendered when modal opens
        if (typeof renderCalendar === 'function') {
            renderCalendar();
        }
    }
}

function closeCalendarModal() {
    const modal = document.getElementById('calendarModal');
    if (modal) {
        modal.classList.remove('show');
    }
}
</script>
{% endblock %}
