{% extends "base.html" %}

{% block content %}
<!-- MODULAR YAM DASHBOARD - Clean and Organized -->
<script>
// CRITICAL: Static outages configuration
window.YAM_STATIC_OUTAGES = {
    enabled: true,
    loaded: false,
    data: null,
    lastLoad: 0
};

// CRITICAL: Global emergency throttle for session activity
window.YAM_EMERGENCY_THROTTLE = {
    lastCall: 0,
    callCount: 0,
    blocked: 0
};

// Override fetch to block excessive session activity calls
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (url && url.includes('/api/session/activity')) {
        const now = Date.now();
        const throttle = window.YAM_EMERGENCY_THROTTLE;
        
        if ((now - throttle.lastCall) < 600000) {
            throttle.blocked++;
            console.debug(`ðŸš« Blocked session activity call #${throttle.blocked} - throttling active`);
            return Promise.resolve(new Response('{"success":true,"throttled":true}', {
                status: 200,
                headers: { 'Content-Type': 'application/json' }
            }));
        }
        
        throttle.lastCall = now;
        throttle.callCount++;
        console.log(`âœ… Allowing session activity call #${throttle.callCount}`);
    }
    return originalFetch.apply(this, arguments);
};

console.log('YAM: Enhanced session management initialized');
</script>

<!-- DASHBOARD LAYOUT -->
<div class="dashboard-container">
    <!-- Welcome Header -->
    {% include 'components/yam/yam_welcome_header.html' %}

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Sidebar -->
        <div class="sidebar">
            {% include 'components/yam/yam_user_profile.html' %}
        </div>

        <!-- Main Content -->
        <div class="yam-main-content">
            <!-- Charts Grid -->
            <div class="charts-grid">
                {% include 'components/yam/yam_outages_section.html' %}
                {% include 'components/yam/yam_user_tickets_section.html' %}
            </div>
            
            <!-- Dashboard Widgets -->
            {% include 'components/yam/yam_dashboard_widgets.html' %}
        </div>
    </div>

    <!-- Navigation Directory -->
    {% include 'components/yam/yam_navigation_directory.html' %}
</div>

<!-- MODALS -->
{% include 'components/yam/yam_outage_detail_modal.html' %}
{% include 'components/yam/yam_custom_date_modal.html' %}
{% include 'components/yam/yam_outages_management_modal.html' %}

<!-- STYLES - IN CORRECT ORDER -->
{% include 'components/yam/yam_dashboard_styles.html' %}
{% include 'components/yam/yam_unified_chart_styles.html' %}
{% include 'components/yam/yam_modal_styles.html' %}

<!-- RESPONSIVE LAYOUT FIX - NO SCALING, NO GAPS -->
<style>
/* CRITICAL: Remove all scaling and implement responsive layout */
.dashboard-container {
    /* Remove all scaling - use natural dimensions */
    transform: none !important;
    transform-origin: initial !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    position: relative !important;
    height: auto !important;
    z-index: 1 !important;
    
    /* Ensure proper padding and spacing */
    padding: 1rem !important;
    box-sizing: border-box !important;
    background: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%) !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
    min-height: 100vh !important;
}

/* RESPONSIVE GRID LAYOUT - NO GAPS */
.dashboard-grid {
    display: grid !important;
    grid-template-columns: minmax(320px, 350px) 1fr !important;
    gap: 1rem !important;
    margin-bottom: 0 !important;
    flex: 1 !important;
    min-height: 0 !important;
    align-items: start !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* SIDEBAR - FIXED WIDTH, NO GAPS */
.sidebar {
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
    height: 100% !important;
    align-self: start !important;
    width: 100% !important;
    max-width: 350px !important;
    min-width: 320px !important;
    flex-shrink: 0 !important;
}

/* MAIN CONTENT - FLEXIBLE, NO GAPS */
.yam-main-content {
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
    width: 100% !important;
    min-width: 0 !important;
    flex: 1 !important;
}

/* CHARTS GRID - RESPONSIVE, NO GAPS */
.charts-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 1rem !important;
    margin-bottom: 0 !important;
    flex-shrink: 0 !important;
    width: 100% !important;
    min-width: 0 !important;
}

/* ENSURE ALL CHART CONTAINERS MAINTAIN PRECISE MOUSE EVENTS */
.charts-grid,
.yam-outages-section,
.yam-user-tickets-section,
.dashboard-widgets {
    /* Remove any transform interference */
    transform: none !important;
    transform-origin: initial !important;
    
    /* Ensure proper positioning */
    position: relative !important;
    z-index: 2 !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* SPECIFIC CHART CONTAINER PRECISION */
.chart-container,
canvas,
svg {
    /* Ensure charts maintain precise mouse coordinates */
    transform: none !important;
    transform-origin: initial !important;
    
    /* Maintain proper positioning for tooltips and interactions */
    position: relative !important;
    z-index: 3 !important;
    width: 100% !important;
    height: auto !important;
}

/* RESPONSIVE BREAKPOINTS - MAINTAIN EXACT FORMATTING */
@media (max-width: 1400px) {
    .dashboard-grid {
        grid-template-columns: minmax(300px, 320px) 1fr !important;
        gap: 0.8rem !important;
    }
    
    .sidebar {
        max-width: 320px !important;
        min-width: 300px !important;
    }
}

@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: minmax(280px, 300px) 1fr !important;
        gap: 0.6rem !important;
    }
    
    .sidebar {
        max-width: 300px !important;
        min-width: 280px !important;
    }
    
    .charts-grid {
        gap: 0.8rem !important;
    }
}

@media (max-width: 1024px) {
    .dashboard-grid {
        grid-template-columns: minmax(260px, 280px) 1fr !important;
        gap: 0.5rem !important;
    }
    
    .sidebar {
        max-width: 280px !important;
        min-width: 260px !important;
    }
    
    .charts-grid {
        gap: 0.6rem !important;
    }
}

@media (max-width: 900px) {
    .dashboard-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    .sidebar {
        max-width: 100% !important;
        min-width: 100% !important;
        order: 2 !important;
    }
    
    .yam-main-content {
        order: 1 !important;
    }
    
    .charts-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
}

@media (max-width: 600px) {
    .dashboard-container {
        padding: 0.5rem !important;
        gap: 0.8rem !important;
    }
    
    .dashboard-grid {
        gap: 0.8rem !important;
    }
    
    .charts-grid {
        gap: 0.8rem !important;
    }
    
    .sidebar {
        gap: 0.8rem !important;
    }
    
    .yam-main-content {
        gap: 0.8rem !important;
    }
}

/* ENSURE NO HORIZONTAL SCROLLING */
body {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100% !important;
}

/* ENSURE ALL CARDS AND WIDGETS FIT PROPERLY */
.card,
.outages-card,
.user-profile,
.welcome-header {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important;
}

/* ENSURE CHARTS RESPOND PROPERLY */
.chart-container {
    width: 100% !important;
    height: auto !important;
    min-height: 300px !important;
    max-height: 500px !important;
}

/* ENSURE NAVIGATION DIRECTORY RESPONDS PROPERLY */
.directory-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
    gap: 1rem !important;
    margin-top: 0.5rem !important;
    width: 100% !important;
    max-width: 100% !important;
}

.directory-item {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important;
}

/* RESPONSIVE NAVIGATION DIRECTORY BREAKPOINTS */
@media (max-width: 1200px) {
    .directory-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
        gap: 0.8rem !important;
    }
}

@media (max-width: 900px) {
    .directory-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
        gap: 0.6rem !important;
    }
}

@media (max-width: 600px) {
    .directory-grid {
        grid-template-columns: 1fr !important;
        gap: 0.8rem !important;
    }
    
    .directory-item {
        padding: 1.2rem !important;
    }
    
    .directory-icon {
        width: 40px !important;
        height: 40px !important;
        margin-right: 1rem !important;
        font-size: 1.2rem !important;
    }
    
    .directory-name {
        font-size: 0.95rem !important;
    }
    
    .directory-desc {
        font-size: 0.75rem !important;
    }
}

/* ENSURE MODALS WORK PROPERLY WITHOUT SCALING */
.widget-modal,
.yam-modal-overlay,
.custom-date-modal,
.performance-modal,
.admin-sync-modal,
.user-ticket-details-modal,
.reminder-modal,
#calendarModal,
#calendarEventModal,
#playlistModal,
#reminderModal {
    display: none !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.85) !important;
    backdrop-filter: blur(20px) !important;
    z-index: 999999999 !important;
    animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    right: auto !important;
    bottom: auto !important;
    min-width: auto !important;
    min-height: auto !important;
    max-width: none !important;
    max-height: none !important;
    transform: none !important;
}

.widget-modal.show,
.yam-modal-overlay.show,
.custom-date-modal.show,
.performance-modal.show,
.admin-sync-modal.show,
.user-ticket-details-modal.show,
.reminder-modal.show,
#calendarModal.show,
#calendarEventModal.show,
#playlistModal.show,
#reminderModal.show {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* PERFECT MODAL CENTERING AND SIZING */
.widget-modal-content,
.yam-modal-container,
.custom-date-content,
.performance-modal-content,
.admin-sync-modal-content,
.user-ticket-details-modal-content,
.reminder-modal-content {
    background: rgba(15, 15, 15, 0.98) !important;
    border-radius: 24px !important;
    width: 92% !important;
    max-width: 1000px !important;
    max-height: 90vh !important;
    min-height: auto !important;
    height: auto !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(30px) !important;
    overflow: hidden !important;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    transform: translateY(-8vh) !important;
    margin: 0 auto !important;
    padding: 0 !important;
    min-width: auto !important;
    flex-direction: column !important;
    display: flex !important;
    /* Perfect centering */
    align-self: center !important;
    justify-self: center !important;
}

/* ENHANCED CALENDAR MODAL - TALLER AND NO SCROLLING */
.calendar-modal-content {
    background: rgba(15, 15, 15, 0.98) !important;
    border-radius: 24px !important;
    width: 95% !important;
    max-width: 1200px !important;
    height: 95vh !important;
    max-height: 95vh !important;
    min-height: 95vh !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(30px) !important;
    overflow: hidden !important;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    transform: translateY(-8vh) !important;
    margin: 0 auto !important;
    padding: 0 !important;
    min-width: auto !important;
    flex-direction: column !important;
    display: flex !important;
    /* Perfect centering */
    align-self: center !important;
    justify-self: center !important;
}

/* EXACT ACTIVITY MODAL HEADER AND BODY STYLING */
.widget-modal-header,
.yam-modal-header,
.custom-date-header,
.performance-modal-header,
.admin-sync-modal-header,
.user-ticket-details-modal-header,
.reminder-modal-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 1.5rem 2rem !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    background: rgba(255, 255, 255, 0.02) !important;
    margin: 0 !important;
    border-radius: 0 !important;
    flex-shrink: 0 !important;
}

.widget-modal-header h3,
.yam-modal-header h3,
.custom-date-header h3,
.performance-modal-header h3,
.admin-sync-modal-header h3,
.user-ticket-details-modal-header h3,
.reminder-modal-header h3 {
    color: #ffffff !important;
    margin: 0 !important;
    font-size: 1.3rem !important;
    font-weight: 700 !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.8rem !important;
}

.widget-modal-close,
.yam-modal-close,
.custom-date-close,
.performance-modal-close,
.admin-sync-modal-close,
.user-ticket-details-modal-close,
.reminder-modal-close {
    background: none !important;
    border: none !important;
    color: #888888 !important;
    font-size: 1.2rem !important;
    cursor: pointer !important;
    padding: 0.5rem !important;
    border-radius: 50% !important;
    width: 40px !important;
    height: 40px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s ease !important;
}

.widget-modal-close:hover,
.yam-modal-close:hover,
.custom-date-close:hover,
.performance-modal-close:hover,
.admin-sync-modal-close:hover,
.user-ticket-details-modal-close:hover,
.reminder-modal-close:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #ffffff !important;
    transform: scale(1.1) !important;
}

.widget-modal-body,
.yam-modal-body,
.custom-date-body,
.performance-modal-body,
.admin-sync-modal-body,
.user-ticket-details-modal-body,
.reminder-modal-body {
    padding: 0.8rem !important;
    max-height: calc(90vh - 80px) !important;
    height: auto !important;
    overflow-y: visible !important;
    overflow-x: hidden !important;
    flex: 1 !important;
    margin: 0 !important;
    border: none !important;
    background: transparent !important;
    /* Custom scrollbar for modal content */
    scrollbar-width: thin !important;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent !important;
}

/* ENHANCED CALENDAR MODAL BODY - FULL HEIGHT UTILIZATION */
#calendarModal .widget-modal-body {
    padding: 1rem !important;
    max-height: calc(95vh - 100px) !important;
    height: calc(95vh - 100px) !important;
    overflow: hidden !important;
    flex: 1 !important;
    margin: 0 !important;
    border: none !important;
    background: transparent !important;
    display: flex !important;
    flex-direction: column !important;
}

/* Custom scrollbar styling for modal body */
.widget-modal-body::-webkit-scrollbar,
.yam-modal-body::-webkit-scrollbar,
.custom-date-body::-webkit-scrollbar,
.performance-modal-body::-webkit-scrollbar,
.admin-sync-modal-body::-webkit-scrollbar,
.user-ticket-details-modal-body::-webkit-scrollbar,
.reminder-modal-body::-webkit-scrollbar {
    width: 6px !important;
}

.widget-modal-body::-webkit-scrollbar-track,
.yam-modal-body::-webkit-scrollbar-track,
.custom-date-body::-webkit-scrollbar-track,
.performance-modal-body::-webkit-scrollbar-track,
.admin-sync-modal-body::-webkit-scrollbar-track,
.user-ticket-details-modal-body::-webkit-scrollbar-track,
.reminder-modal-body::-webkit-scrollbar-track {
    background: transparent !important;
}

.widget-modal-body::-webkit-scrollbar-thumb,
.yam-modal-body::-webkit-scrollbar-thumb,
.custom-date-body::-webkit-scrollbar-thumb,
.performance-modal-body::-webkit-scrollbar-thumb,
.admin-sync-modal-body::-webkit-scrollbar-thumb,
.user-ticket-details-modal-body::-webkit-scrollbar-thumb,
.reminder-modal-body::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3) !important;
    border-radius: 3px !important;
}

.widget-modal-body::-webkit-scrollbar-thumb:hover,
.yam-modal-body::-webkit-scrollbar-thumb:hover,
.custom-date-body::-webkit-scrollbar-thumb:hover,
.performance-modal-body::-webkit-scrollbar-thumb:hover,
.admin-sync-modal-body::-webkit-scrollbar-thumb:hover,
.user-ticket-details-modal-body::-webkit-scrollbar-thumb:hover,
.reminder-modal-body::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5) !important;
}
</style>

<!-- JAVASCRIPT - IN CORRECT ORDER -->
{% include 'components/yam/yam_core_scripts.html' %}
{% include 'components/yam/yam_modal_scripts.html' %}
{% include 'components/yam/yam_data_scripts.html' %}
{% include 'components/yam/yam_chart_and_management_scripts.html' %}
{% include 'components/yam/yam_outage_management_scripts.html' %}
{% include 'components/yam/yam_widget_scripts.html' %}
{% include 'components/yam/yam_user_tickets_scripts.html' %}

<!-- ENHANCED CHART INTERACTIONS FOR RESPONSIVE LAYOUT -->
<script>
// Enhanced chart interactions for responsive dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('YAM: Initializing enhanced chart interactions for responsive layout');
    
    // Enhanced tooltip positioning for responsive charts
    function enhanceChartTooltips() {
        const charts = document.querySelectorAll('canvas');
        charts.forEach(canvas => {
            if (canvas.chart) {
                const chart = canvas.chart;
                const originalOptions = chart.options;
                
                // Ensure tooltip configuration exists
                if (!originalOptions.plugins) originalOptions.plugins = {};
                if (!originalOptions.plugins.tooltip) originalOptions.plugins.tooltip = {};
                
                // Enhanced tooltip callbacks for better data display
                if (!originalOptions.plugins.tooltip.callbacks) {
                    originalOptions.plugins.tooltip.callbacks = {};
                }
                
                // Ensure tooltips show on hover
                originalOptions.plugins.tooltip.enabled = true;
                originalOptions.plugins.tooltip.intersect = true;
                originalOptions.plugins.tooltip.mode = 'nearest';
                
                console.log(`âœ… Enhanced tooltip for chart: ${chart.id || 'unnamed'}`);
            }
        });
    }
    
    // Apply enhanced tooltip positioning after charts are rendered
    setTimeout(enhanceChartTooltips, 1000);
    
    // Re-apply after any dynamic chart updates
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                setTimeout(enhanceChartTooltips, 500);
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    
    // Monitor for chart updates and re-apply enhancements
    const chartUpdateObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-chart-updated') {
                setTimeout(enhanceChartTooltips, 100);
            }
        });
    });
    
    chartUpdateObserver.observe(document.body, { 
        attributes: true, 
        attributeFilter: ['data-chart-updated'],
        subtree: true 
    });
    
    console.log('YAM: Enhanced chart interactions initialized');
    
    // Specific enhancement for user tickets chart
    function enhanceUserTicketsChart() {
        const userTicketsCanvas = document.getElementById('userTicketsChart');
        if (userTicketsCanvas && userTicketsCanvas.chart) {
            const chart = userTicketsCanvas.chart;
            
            // Ensure the chart has proper interaction settings
            if (chart.options) {
                chart.options.onClick = function(event, elements) {
                    if (elements.length > 0) {
                        const element = elements[0];
                        const username = this.data.labels[element.index];
                        const ticketCount = this.data.datasets[0].data[element.index];
                        
                        console.log(`ðŸŽ¯ User clicked on ${username} with ${ticketCount} tickets`);
                        if (typeof showUserTicketDetails === 'function') {
                            showUserTicketDetails(username, ticketCount);
                        }
                    }
                };
                
                // Ensure tooltips work properly
                if (!chart.options.plugins) chart.options.plugins = {};
                if (!chart.options.plugins.tooltip) chart.options.plugins.tooltip = {};
                
                chart.options.plugins.tooltip.enabled = true;
                chart.options.plugins.tooltip.intersect = true;
                chart.options.plugins.tooltip.mode = 'nearest';
                
                // Enhanced tooltip callbacks
                if (!chart.options.plugins.tooltip.callbacks) {
                    chart.options.plugins.tooltip.callbacks = {};
                }
                
                chart.options.plugins.tooltip.callbacks.title = function(context) {
                    return context[0].label; // Username
                };
                
                chart.options.plugins.tooltip.callbacks.label = function(context) {
                    const value = context.parsed.y;
                    return `${value} ticket${value !== 1 ? 's' : ''}`;
                };
                
                chart.options.plugins.tooltip.callbacks.afterLabel = function(context) {
                    return 'Click to view details';
                };
                
                console.log('âœ… User tickets chart enhanced for responsive interactions');
            }
        }
    }
    
    // Apply user tickets chart enhancement
    setTimeout(enhanceUserTicketsChart, 1500);
    
    // Re-apply user tickets chart enhancement after updates
    const userTicketsObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                setTimeout(enhanceUserTicketsChart, 500);
            }
        });
    });
    
    userTicketsObserver.observe(document.body, { childList: true, subtree: true });
    
    // Responsive layout monitoring
    function monitorResponsiveLayout() {
        const dashboardContainer = document.querySelector('.dashboard-container');
        const dashboardGrid = document.querySelector('.dashboard-grid');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.yam-main-content');
        
        if (dashboardContainer && dashboardGrid && sidebar && mainContent) {
            // Ensure no gaps by monitoring layout changes
            const resizeObserver = new ResizeObserver(function(entries) {
                entries.forEach(function(entry) {
                    const element = entry.target;
                    
                    // Ensure proper width constraints
                    if (element.classList.contains('dashboard-container')) {
                        element.style.width = '100%';
                        element.style.maxWidth = '100%';
                    }
                    
                    if (element.classList.contains('dashboard-grid')) {
                        element.style.width = '100%';
                        element.style.maxWidth = '100%';
                    }
                    
                    if (element.classList.contains('sidebar')) {
                        element.style.width = '100%';
                        element.style.maxWidth = '350px';
                        element.style.minWidth = '320px';
                    }
                    
                    if (element.classList.contains('yam-main-content')) {
                        element.style.width = '100%';
                        element.style.minWidth = '0';
                        element.style.flex = '1';
                    }
                });
            });
            
            // Observe all layout elements
            resizeObserver.observe(dashboardContainer);
            resizeObserver.observe(dashboardGrid);
            resizeObserver.observe(sidebar);
            resizeObserver.observe(mainContent);
            
            console.log('âœ… Responsive layout monitoring initialized');
        }
    }
    
    // Initialize responsive layout monitoring
    setTimeout(monitorResponsiveLayout, 500);
});
</script>

<!-- EXACT ACTIVITY MODAL ANIMATIONS -->
<style>
@keyframes modalFadeIn {
    from { 
        opacity: 0; 
        backdrop-filter: blur(0px);
    }
    to { 
        opacity: 1; 
        backdrop-filter: blur(20px);
    }
}

@keyframes modalSlideIn {
    from { 
        opacity: 0;
        transform: translateY(-42vh) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(-8vh) scale(1);
    }
}

/* ENHANCED CALENDAR MODAL ANIMATION */
#calendarModal .calendar-modal-content {
    animation: calendarModalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

@keyframes calendarModalSlideIn {
    from { 
        opacity: 0;
        transform: translateY(-8vh) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(-8vh) scale(1);
    }
}

/* FORCE ALL MODALS TO USE ACTIVITY MODAL BEHAVIOR */
.widget-modal,
.yam-modal-overlay,
.custom-date-modal,
.performance-modal,
.admin-sync-modal,
.user-ticket-details-modal,
.reminder-modal,
#calendarModal,
#calendarEventModal,
#playlistModal,
#reminderModal {
    /* Override any conflicting CSS from other files */
    background-color: rgba(0, 0, 0, 0.85) !important;
    background-image: none !important;
    background: rgba(0, 0, 0, 0.85) !important;
}

/* Ensure content doesn't get full width/height overrides */
.widget-modal-content,
.yam-modal-container,
.custom-date-content,
.performance-modal-content,
.admin-sync-modal-content,
.user-ticket-details-modal-content,
.reminder-modal-content,
.calendar-modal-content {
    /* Force Activity Modal dimensions with proper centering */
    width: 92% !important;
    height: auto !important;
    max-width: 1000px !important;
    max-height: 90vh !important;
    min-height: auto !important;
    min-width: auto !important;
    transform: translateY(-8vh) !important;
    overflow: hidden !important;
}

/* IMPROVED CALENDAR STYLING */
.calendar-container {
    width: 100% !important;
    height: 100% !important;
    padding: 0.5rem !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 0.8rem !important;
    min-height: auto !important;
    align-items: center !important;
    justify-content: flex-start !important;
    flex: 1 !important;
    overflow: hidden !important;
}

/* ENHANCED CALENDAR CONTAINER FOR MODAL - FULL HEIGHT */
#calendarModal .calendar-container {
    width: 100% !important;
    height: 100% !important;
    padding: 0.5rem !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
    min-height: auto !important;
    align-items: center !important;
    justify-content: space-between !important;
    flex: 1 !important;
    overflow: hidden !important;
}

.calendar-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 0.8rem !important;
    padding: 0 0.5rem !important;
    width: 100% !important;
    max-width: 650px !important;
    margin-left: auto !important;
    margin-right: auto !important;
}

.calendar-header h4 {
    color: #ffffff !important;
    font-size: 1.2rem !important;
    font-weight: 600 !important;
    margin: 0 !important;
}

.calendar-nav-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    border: none !important;
    color: #ffffff !important;
    padding: 0.5rem !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    width: 36px !important;
    height: 36px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 1rem !important;
}

.calendar-nav-btn:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: scale(1.1) !important;
}

/* PERFECT CALENDAR GRID */
.calendar-grid {
    display: grid !important;
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 6px !important;
    width: 100% !important;
    max-width: 650px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 12px !important;
    padding: 12px !important;
    aspect-ratio: 7/6.5 !important;
    min-height: 320px !important;
    margin: 0 auto !important;
    align-items: center !important;
    justify-items: center !important;
}

/* ENHANCED CALENDAR GRID FOR MODAL - FULL HEIGHT UTILIZATION */
#calendarModal .calendar-grid {
    display: grid !important;
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 8px !important;
    width: 100% !important;
    max-width: 800px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 16px !important;
    padding: 16px !important;
    height: calc(100% - 120px) !important;
    min-height: 400px !important;
    margin: 0 auto !important;
    align-items: center !important;
    justify-items: center !important;
    flex: 1 !important;
    overflow: hidden !important;
}

/* DAY HEADER STYLING */
.calendar-grid > div:nth-child(-n+7) {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #cccccc !important;
    font-weight: 600 !important;
    font-size: 0.8rem !important;
    text-align: center !important;
    padding: 0 !important;
    border-radius: 6px !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    width: 100% !important;
    height: 42px !important;
    min-height: 42px !important;
    max-height: 42px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 0 !important;
}

/* ENHANCED DAY HEADER STYLING FOR MODAL */
#calendarModal .calendar-grid > div:nth-child(-n+7) {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #cccccc !important;
    font-weight: 600 !important;
    font-size: 0.9rem !important;
    text-align: center !important;
    padding: 0 !important;
    border-radius: 8px !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    width: 100% !important;
    height: 50px !important;
    min-height: 50px !important;
    max-height: 50px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 0 !important;
}

/* CALENDAR DAY CELLS */
.calendar-day {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: rgba(25, 25, 25, 0.8) !important;
    border-radius: 6px !important;
    color: #ffffff !important;
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    position: relative !important;
    width: 100% !important;
    height: 42px !important;
    min-height: 42px !important;
    max-height: 42px !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* ENHANCED CALENDAR DAY CELLS FOR MODAL - TALLER AND MORE SPACIOUS */
#calendarModal .calendar-day {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: rgba(25, 25, 25, 0.8) !important;
    border-radius: 8px !important;
    color: #ffffff !important;
    font-size: 1.1rem !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    position: relative !important;
    width: 100% !important;
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    margin: 0 !important;
    padding: 0 !important;
}

.calendar-day:hover {
    background: rgba(139, 92, 246, 0.15) !important;
    border-color: rgba(139, 92, 246, 0.3) !important;
    transform: scale(1.02) !important;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2) !important;
}

.calendar-day.today {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6) !important;
    color: #ffffff !important;
    font-weight: 700 !important;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
}

.calendar-day.other-month {
    color: #666666 !important;
    background: rgba(15, 15, 15, 0.4) !important;
    border-color: transparent !important;
}

.calendar-day.other-month:hover {
    background: rgba(255, 255, 255, 0.05) !important;
    color: #888888 !important;
}

/* CALENDAR QUICK ACTIONS */
.calendar-quick-actions {
    display: flex !important;
    gap: 0.8rem !important;
    margin-top: 1rem !important;
    padding: 0 0.5rem !important;
    width: 100% !important;
    max-width: 650px !important;
    margin-left: auto !important;
    margin-right: auto !important;
}

/* ENHANCED CALENDAR QUICK ACTIONS FOR MODAL */
#calendarModal .calendar-quick-actions {
    display: flex !important;
    gap: 1rem !important;
    margin-top: 0.5rem !important;
    padding: 0 0.5rem !important;
    width: 100% !important;
    max-width: 800px !important;
    margin-left: auto !important;
    margin-right: auto !important;
    flex-shrink: 0 !important;
}

.calendar-quick-actions button {
    flex: 1 !important;
    padding: 0.6rem 0.8rem !important;
    border-radius: 8px !important;
    border: none !important;
    font-weight: 600 !important;
    font-size: 0.8rem !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.3rem !important;
    min-height: 36px !important;
}

/* ENHANCED CALENDAR QUICK ACTION BUTTONS FOR MODAL - BIGGER */
#calendarModal .calendar-quick-actions button {
    flex: 1 !important;
    padding: 0.8rem 1.2rem !important;
    border-radius: 12px !important;
    border: none !important;
    font-weight: 600 !important;
    font-size: 1rem !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important;
    min-height: 48px !important;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #ffffff !important;
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateY(-1px) !important;
}

.btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6) !important;
    color: #ffffff !important;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3) !important;
}
</style>

<!-- Simple JavaScript matching Activity Modal -->
<script>

// ENHANCED MODAL FUNCTIONS WITH BODY SCROLL LOCK
function openCalendarModal() {
    const modal = document.getElementById('calendarModal');
    if (modal) {
        // Lock body scrolling - disable page scrollbar
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.paddingRight = '0px'; // Prevent layout shift
        
        modal.classList.add('show');
        
        // Render calendar content
        setTimeout(() => {
            if (typeof renderCalendarForModal === 'function') {
                renderCalendarForModal();
            } else if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
        }, 50);
    }
}

function closeCalendarModal() {
    const modal = document.getElementById('calendarModal');
    if (modal) {
        modal.classList.remove('show');
        // Restore body scrolling - re-enable page scrollbar
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.paddingRight = '';
        // Remove any potential scroll lock classes
        document.body.classList.remove('modal-open');
        document.documentElement.classList.remove('modal-open');
    }
}

function openCalendarEventModal() {
    const modal = document.getElementById('calendarEventModal');
    if (modal) {
        // Lock body scrolling - disable page scrollbar
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.paddingRight = '0px'; // Prevent layout shift
        
        modal.classList.add('show');
        
        // Set today's date as default
        const today = new Date();
        const eventStartDate = document.getElementById('eventStartDate');
        const eventEndDate = document.getElementById('eventEndDate');
        
        if (eventStartDate) eventStartDate.value = today.toISOString().split('T')[0];
        if (eventEndDate) eventEndDate.value = today.toISOString().split('T')[0];
    }
}

function closeCalendarEventModal() {
    const modal = document.getElementById('calendarEventModal');
    if (modal) {
        modal.classList.remove('show');
        // Restore body scrolling - re-enable page scrollbar
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.paddingRight = '';
        // Remove any potential scroll lock classes
        document.body.classList.remove('modal-open');
        document.documentElement.classList.remove('modal-open');
        // Reset the form
        const form = document.getElementById('calendarForm');
        if (form) form.reset();
    }
}

function openReminderModal() {
    // Use calendar event modal for reminders
    openCalendarEventModal();
}

function openPlaylistModal() {
    const modal = document.getElementById('playlistModal');
    if (modal) {
        // Lock body scrolling - disable page scrollbar
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.paddingRight = '0px'; // Prevent layout shift
        modal.classList.add('show');
    }
}

function closePlaylistModal() {
    const modal = document.getElementById('playlistModal');
    if (modal) {
        modal.classList.remove('show');
        // Restore body scrolling - re-enable page scrollbar
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.paddingRight = '';
        // Remove any potential scroll lock classes
        document.body.classList.remove('modal-open');
        document.documentElement.classList.remove('modal-open');
    }
}

// Enhanced initialization with ESC key support, click-outside, and cleanup
document.addEventListener('DOMContentLoaded', function() {
    console.log('YAM Dashboard: Enhanced modal system loaded');
    
    // Ensure no modals are open on load and restore scrolling
    const allModals = document.querySelectorAll('.widget-modal, .yam-modal-overlay, .custom-date-modal, .reminder-modal, #calendarModal, #calendarEventModal, #playlistModal, #reminderModal');
    allModals.forEach(modal => modal.classList.remove('show'));
    
    // Restore body scrolling on page load
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    document.body.style.paddingRight = '';
    document.body.classList.remove('modal-open');
    document.documentElement.classList.remove('modal-open');
    
    // Add click-outside-to-close functionality
    allModals.forEach(modal => {
        modal.addEventListener('click', function(event) {
            // Only close if clicking the modal overlay (not the content)
            if (event.target === modal) {
                // Close the appropriate modal with proper scroll restoration
                if (modal.id === 'calendarModal') {
                    closeCalendarModal();
                } else if (modal.id === 'calendarEventModal') {
                    closeCalendarEventModal();
                } else if (modal.id === 'playlistModal') {
                    closePlaylistModal();
                } else {
                    // Generic close with scroll restoration
                    modal.classList.remove('show');
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.body.classList.remove('modal-open');
                    document.documentElement.classList.remove('modal-open');
                }
            }
        });
    });
    
    // ESC key support for closing modals
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            // Find any open modal
            const openModal = document.querySelector('.widget-modal.show, .yam-modal-overlay.show, .custom-date-modal.show, .reminder-modal.show, #calendarModal.show, #calendarEventModal.show, #playlistModal.show, #reminderModal.show');
            if (openModal) {
                // Close the appropriate modal
                if (openModal.id === 'calendarModal') {
                    closeCalendarModal();
                } else if (openModal.id === 'calendarEventModal') {
                    closeCalendarEventModal();
                } else if (openModal.id === 'playlistModal') {
                    closePlaylistModal();
                } else {
                    // Generic close
                    openModal.classList.remove('show');
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.body.classList.remove('modal-open');
                    document.documentElement.classList.remove('modal-open');
                }
            }
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        document.body.style.paddingRight = '';
        document.body.classList.remove('modal-open');
        document.documentElement.classList.remove('modal-open');
    });
});
</script>
{% endblock %}