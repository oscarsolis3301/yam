{% extends "base.html" %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebars.css') }}">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
  /* === Dark Theme Design System === */
  :root {
    --dark-bg: #0d1117;
    --dark-surface: #161b22;
    --dark-surface-2: #21262d;
    --dark-border: #30363d;
    --dark-border-light: #21262d;
    --dark-text: #f0f6fc;
    --dark-text-secondary: #8b949e;
    --dark-text-muted: #6e7681;
    --dark-accent: #58a6ff;
    --dark-accent-hover: #79c0ff;
    --dark-success: #3fb950;
    --dark-warning: #d29922;
    --dark-danger: #f85149;
    --dark-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    --dark-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.4);
    --dark-radius: 8px;
    --dark-radius-small: 6px;
    --dark-transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  /* === Layout === */
  body {
    background: var(--dark-bg);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    padding: 0;
    color: var(--dark-text);
    overflow-x: hidden;
  }
  
  .workspace-wrapper {
    display: flex;
    height: 100vh;
    background: var(--dark-bg);
    margin-left: 3.5rem;
    position: relative;
    z-index: 10;
    width: calc(100vw - 3.5rem);
  }

  /* === Enhanced Sidebar === */
  .kb-sidebar {
    width: 320px;
    min-width: 320px;
    max-width: 320px;
    background: var(--dark-surface);
    border-right: 1px solid var(--dark-border);
    display: flex;
    flex-direction: column;
    box-shadow: var(--dark-shadow);
    position: relative;
    z-index: 11;
    flex-shrink: 0;
    height: 100vh;
  }
  
  .sidebar-header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  
  .sidebar-header h6 {
    margin: 0;
    font-weight: 600;
    font-size: 16px;
    color: var(--dark-text);
  }
  
  .btn-new-note {
    background: var(--dark-accent);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: var(--dark-radius-small);
    cursor: pointer;
    transition: var(--dark-transition);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: var(--dark-shadow);
  }
  
  .btn-new-note:hover {
    background: var(--dark-accent-hover);
    transform: translateY(-1px);
    box-shadow: var(--dark-shadow-hover);
  }
  
  .sidebar-search {
    padding: 16px 20px;
    border-bottom: 1px solid var(--dark-border);
    flex-shrink: 0;
  }
  
  .search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--dark-border);
    border-radius: var(--dark-radius-small);
    font-size: 14px;
    background: var(--dark-surface-2);
    color: var(--dark-text);
    transition: var(--dark-transition);
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--dark-accent);
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
  }
  
  .search-input::placeholder {
    color: var(--dark-text-muted);
  }

  /* === Enhanced Main Content Area === */
  .editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--dark-surface);
    margin: 16px;
    border-radius: var(--dark-radius);
    box-shadow: var(--dark-shadow);
    overflow: hidden;
  }
  
  .editor-header {
    padding: 24px 32px 16px;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    flex-shrink: 0;
  }

  .kb-search-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.2rem;
    max-width: 900px;
    margin: 0 auto;
    background: var(--dark-surface-2);
    border-radius: 2rem;
    box-shadow: var(--dark-shadow);
    padding: 0.5rem 1.5rem;
  }

  .kb-search-btn, .kb-refresh-btn, .kb-test-btn {
    background: var(--dark-surface-2);
    border: none;
    color: var(--dark-accent);
    font-size: 1.5rem;
    border-radius: 50%;
    width: 2.7rem;
    height: 2.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--dark-transition);
    margin: 0 0.2rem;
  }
  
  .kb-search-btn:hover, .kb-refresh-btn:hover, .kb-test-btn:hover {
    background: var(--dark-surface);
    color: var(--dark-accent-hover);
    transform: translateY(-1px);
  }

  .kb-search-input {
    flex: 1 1 300px;
    background: var(--dark-surface);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 1.5rem;
    padding: 0.8rem 1.2rem;
    font-size: 1.15rem;
    margin: 0 0.5rem;
    box-shadow: var(--dark-shadow);
    transition: var(--dark-transition);
  }
  
  .kb-search-input:focus {
    outline: none;
    background: var(--dark-surface-2);
    border-color: var(--dark-accent);
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
  }

  /* === Enhanced Filters Section === */
  .filters-section {
    margin-top: 16px;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .filter-label {
    color: var(--dark-text-secondary);
    font-size: 12px;
    font-weight: 500;
  }

  .filter-select {
    background: var(--dark-surface-2);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    border-radius: var(--dark-radius-small);
    padding: 6px 12px;
    font-size: 12px;
    transition: var(--dark-transition);
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--dark-accent);
    box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
  }

  /* === Enhanced Results Area === */
  .editor-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .kb-results-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    position: relative;
  }

  .kb-list-group {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* === Enhanced Article Cards === */
  .kb-article-card {
    background: var(--dark-surface-2);
    border: 1px solid var(--dark-border);
    border-radius: var(--dark-radius);
    padding: 20px;
    cursor: pointer;
    transition: var(--dark-transition);
    position: relative;
    overflow: hidden;
  }

  .kb-article-card:hover {
    background: var(--dark-surface);
    border-color: var(--dark-accent);
    transform: translateY(-2px);
    box-shadow: var(--dark-shadow-hover);
  }

  .kb-article-card.active {
    background: rgba(88, 166, 255, 0.1);
    border-color: var(--dark-accent);
  }

  .kb-article-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
  }

  .kb-article-number {
    font-weight: bold;
    color: var(--dark-accent);
    font-size: 1.1rem;
    min-width: 30px;
  }

  .kb-article-icon {
    font-size: 1.5rem;
    margin-top: 2px;
  }

  .kb-article-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-accent);
    margin: 0;
    flex: 1;
  }

  .kb-article-content {
    color: var(--dark-text-secondary);
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 12px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .kb-article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .kb-article-tag {
    background: var(--dark-surface);
    color: var(--dark-accent);
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 0.8rem;
    border: 1px solid var(--dark-border);
  }

  .kb-article-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--dark-border);
    font-size: 0.8rem;
    color: var(--dark-text-muted);
  }

  /* === Enhanced Sidebar Article List === */
  .notes-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .sidebar-article-item {
    padding: 12px 20px;
    cursor: pointer;
    margin: 4px 8px;
    border-radius: 6px;
    background: transparent;
    border: 1px solid transparent;
    transition: var(--dark-transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .sidebar-article-item:hover {
    background: var(--dark-surface-2);
    border-color: var(--dark-border);
  }
  
  .sidebar-article-item.active {
    background: rgba(88, 166, 255, 0.1);
    border-left: 3px solid var(--dark-accent);
  }

  .sidebar-article-icon {
    font-size: 1rem;
    flex-shrink: 0;
  }

  .sidebar-article-title {
    font-size: 0.9rem;
    color: var(--dark-text);
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* === Enhanced PDF Modal === */
  .pdf-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--dark-bg);
    z-index: 3100;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    margin: 0;
    padding: 0;
    border-radius: 0;
  }
  .pdf-modal.active {
    opacity: 1;
    pointer-events: auto;
  }
  .pdf-modal-header {
    position: sticky;
    top: 0;
    background: var(--dark-surface);
    padding: 1.2rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    z-index: 10;
    width: 100%;
    border-radius: 0;
    margin: 0;
  }
  .pdf-modal-title {
    color: var(--dark-accent);
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
  }
  .pdf-modal-content {
    flex: 1;
    overflow: hidden;
    background: var(--dark-bg);
    width: 100%;
    min-height: 0;
    margin: 0;
    padding: 0;
    border-radius: 0;
    display: flex;
    flex-direction: column;
  }
  .pdf-viewer-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: var(--dark-bg);
    display: block;
    margin: 0;
    padding: 0;
  }
  .pdf-error-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    text-align: center;
  }
  .pdf-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(13, 17, 23, 0.8);
    z-index: 3000;
    backdrop-filter: blur(8px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .pdf-modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  @media (max-width: 768px) {
    .pdf-modal {
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
    }
  }

  /* === Loading States === */
  .loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }

  .no-results {
    text-align: center;
    padding: 40px;
    color: var(--dark-text-muted);
    font-style: italic;
  }

  /* === Responsive Design === */
  @media (max-width: 768px) {
    .workspace-wrapper {
      flex-direction: column;
      margin-left: 0;
    }
    
    .kb-sidebar {
      width: 100%;
      height: 200px;
    }
    
    .editor-container {
      height: calc(100vh - 200px);
      margin: 8px;
    }
  }

  /* Remove vertical gap above content ONLY on kb page */
  .main-content {
    margin-top: 3px !important;
  }

  /* === Scrollbar Styling === */
  .kb-results-list::-webkit-scrollbar,
  .notes-list::-webkit-scrollbar {
    width: 8px;
  }

  .kb-results-list::-webkit-scrollbar-track,
  .notes-list::-webkit-scrollbar-track {
    background: var(--dark-surface);
  }

  .kb-results-list::-webkit-scrollbar-thumb,
  .notes-list::-webkit-scrollbar-thumb {
    background: var(--dark-border);
    border-radius: 4px;
  }

  .kb-results-list::-webkit-scrollbar-thumb:hover,
  .notes-list::-webkit-scrollbar-thumb:hover {
    background: var(--dark-accent);
  }
</style>
{% endblock %}

{% block content %}
{{ super() }}
<div class="workspace-wrapper">
  <!-- Enhanced Sidebar -->
  <div class="kb-sidebar">
    <div class="sidebar-header">
      <h6><i class="bi bi-journal-text"></i> Knowledge Base</h6>
      <button class="btn-new-note" id="openUploadModal" title="Upload Document">
        <i class="bi bi-cloud-arrow-up"></i>
      </button>
    </div>
    <div class="sidebar-search">
      <input type="text" class="search-input" id="searchInput" placeholder="Search knowledge base..." />
    </div>
    <!-- Sidebar Filters -->
    <div class="sidebar-filters" style="padding: 16px 20px; border-bottom: 1px solid var(--dark-border);">
      <div class="filter-group">
        <label class="filter-label">Category:</label>
        <select id="kbCategoryFilter" class="filter-select">
          <option value="all">All Categories</option>
          <!-- Categories will be populated dynamically -->
        </select>
      </div>
      <div class="filter-group" style="margin-top: 8px;">
        <label class="filter-label">File Type:</label>
        <select id="kbTypeFilter" class="filter-select">
          <option value="all">All Types</option>
          <option value="pdf">PDF Files</option>
          <option value="doc">Word Documents</option>
          <option value="txt">Text Files</option>
        </select>
      </div>
      <div class="filter-group" style="margin-top: 8px;">
        <label class="filter-label">Tags:</label>
        <div id="kbTagsList" style="display: flex; flex-wrap: wrap; gap: 4px;"></div>
      </div>
    </div>
    <div class="notes-list" id="kbListGroup">
      <!-- Sidebar articles will be populated here -->
    </div>
  </div>

  <!-- Enhanced Main Content Area -->
  <div class="editor-container">
    <div class="editor-header">
      <div class="title-section" style="width: 100%;">
        <div class="kb-search-bar" style="width: 100%; max-width: none;">
          <button class="kb-refresh-btn" id="refreshKbBtn" title="Refresh KB Cache">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button class="kb-test-btn" id="testPdfBtn" title="Test PDF Viewer">
            <i class="bi bi-file-earmark-pdf"></i>
          </button>
          <input type="text" id="searchInputMain" class="kb-search-input" placeholder="Search or ask a question..." style="flex: 1 1 0; min-width: 0;">
          <button class="kb-search-btn" id="searchButton" title="Submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>
    
    <div class="editor-content">
      <div id="kbResults" class="kb-results-list">
        <div class="kb-list-group" id="kbListGroupMain">
          <!-- Enhanced article cards will appear here -->
        </div>
        <div id="kbNoResults" class="no-results" style="display:none;">
          <i class="bi bi-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
          <h4>No results found</h4>
          <p>Try adjusting your search terms or filters</p>
        </div>
        <div id="kbLoading" class="loading-spinner" style="display:none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" style="background: var(--dark-surface); border: 1px solid var(--dark-border);">
      <div class="modal-header" style="border-bottom: 1px solid var(--dark-border);">
        <h5 class="modal-title" style="color: var(--dark-accent);">
          <i class="bi bi-cloud-arrow-up"></i> Upload Document
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color: var(--dark-text);">
        <form id="uploadForm">
          <div class="mb-3">
            <label for="uploadFile" class="form-label">Choose a document:</label>
            <input type="file" id="uploadFile" name="file" class="form-control" accept=".pdf,.txt,.doc,.docx,.rtf,.md" style="background: var(--dark-surface-2); border: 1px solid var(--dark-border); color: var(--dark-text);">
            <div class="form-text" style="color: var(--dark-text-muted);">Supported formats: PDF, TXT, DOC, DOCX, RTF, MD</div>
          </div>
          <div class="mb-3">
            <label for="uploadTitle" class="form-label">Title (optional):</label>
            <input type="text" id="uploadTitle" name="title" class="form-control" placeholder="Document title" style="background: var(--dark-surface-2); border: 1px solid var(--dark-border); color: var(--dark-text);">
          </div>
          <div class="mb-3">
            <label for="uploadTags" class="form-label">Tags (comma-separated):</label>
            <input type="text" id="uploadTags" name="tags" class="form-control" placeholder="e.g. pdf, document, guide" style="background: var(--dark-surface-2); border: 1px solid var(--dark-border); color: var(--dark-text);">
          </div>
          <button type="submit" class="btn btn-primary w-100" style="background: var(--dark-accent); border: none;">
            <i class="bi bi-cloud-arrow-up"></i> Upload
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Article Detail Modal -->
<div class="modal fade" id="articleDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background: var(--dark-surface); border: 1px solid var(--dark-border); max-width:700px;min-height:60vh;">
      <div class="modal-header" style="border-bottom: 1px solid var(--dark-border);">
        <span class="modal-title" id="articleDetailTitle" style="color: var(--dark-accent);"></span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div id="articleDetailContent" style="padding:1.5rem; color: var(--dark-text);"></div>
    </div>
  </div>
</div>

<!-- Enhanced PDF Modal -->
<div class="pdf-modal" id="pdfModal">
  <div class="pdf-modal-header" style="border-radius: 0; width: 100%;">
    <h3 class="pdf-modal-title" id="pdfModalTitle"></h3>
    <button type="button" class="btn-close btn-close-white" id="pdfModalClose" aria-label="Close"></button>
  </div>
  
  <div class="pdf-modal-content" id="pdfModalContent">
    <!-- PDF viewer will be embedded here -->
  </div>
</div>
<div class="pdf-modal-overlay" id="pdfModalOverlay"></div>

<!-- Enhanced Download Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content text-center" style="background: var(--dark-surface); border: 1px solid var(--dark-border);">
      <div class="modal-header" style="border-bottom: 1px solid var(--dark-border);">
        <h5 class="modal-title" style="color: var(--dark-accent);">
          <i class="bi bi-file-earmark-arrow-down"></i> Download File
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="color: var(--dark-text);">
        <p class="mb-4">This file type is not supported for inline viewing.<br>Click below to download:</p>
        <a id="downloadFileBtn" class="btn btn-primary rounded-pill" href="#" download style="font-size:1.2rem; background: var(--dark-accent); border: none;">
          <i class="bi bi-download"></i> Download
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
// Global variables
let allArticles = [];
let filteredArticles = [];
let currentSearchQuery = '';
let currentFilters = {
  sortBy: 'recent',
  fileType: 'all',
  category: 'all',
  tags: []
};
let allCategories = new Set();
let allTags = new Set();

document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap modals
  const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
  const articleDetailModal = new bootstrap.Modal(document.getElementById('articleDetailModal'));
  const downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
  
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Initialize event listeners
  initializeEventListeners();
  
  // Load initial articles
  loadArticles();
});

function initializeEventListeners() {
  // Upload functionality
  const openUploadBtn = document.getElementById('openUploadModal');
  if (openUploadBtn) {
    openUploadBtn.addEventListener('click', () => {
      const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
      uploadModal.show();
    });
  }

  // Upload form submission
  const uploadForm = document.getElementById('uploadForm');
  if (uploadForm) {
    uploadForm.addEventListener('submit', handleUpload);
  }

  // Search functionality
  const searchInput = document.getElementById('searchInput');
  const searchInputMain = document.getElementById('searchInputMain');
  const searchButton = document.getElementById('searchButton');
  let searchTimeout;

  // Real-time search
  [searchInput, searchInputMain].forEach(input => {
    if (input) {
      input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentSearchQuery = this.value.trim();
          performSearch();
        }, 300);
      });

      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          currentSearchQuery = this.value.trim();
          performSearch();
        }
      });
    }
  });

  // Search button
  if (searchButton) {
    searchButton.addEventListener('click', () => {
      currentSearchQuery = searchInput.value.trim() || searchInputMain.value.trim();
      performSearch();
    });
  }

  // Filter functionality
  const categoryFilter = document.getElementById('kbCategoryFilter');
  const typeFilter = document.getElementById('kbTypeFilter');
  
  if (categoryFilter) {
    categoryFilter.addEventListener('change', function() {
      currentFilters.category = this.value;
      applyFilters();
    });
  }
  
  if (typeFilter) {
    typeFilter.addEventListener('change', function() {
      currentFilters.fileType = this.value;
      applyFilters();
    });
  }

  // Refresh button
  const refreshBtn = document.getElementById('refreshKbBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', handleRefresh);
  }

  // Test PDF button
  const testPdfBtn = document.getElementById('testPdfBtn');
  if (testPdfBtn) {
    testPdfBtn.addEventListener('click', () => {
      showPdfModal('Kevin_Clark_Resume.pdf', 'Test PDF - Kevin Clark Resume');
    });
  }

  // Socket.IO connection
  const socket = io();
  
  socket.on('kb_upload_progress', handleUploadProgress);
  socket.on('kb_update', handleKbUpdate);
}

function handleUpload(e) {
  e.preventDefault();
  const fileInput = document.getElementById('uploadFile');
  const uploadBtn = e.target.querySelector('button[type="submit"]');
  const originalBtnText = uploadBtn.innerHTML;
  
  if (!fileInput.files.length) {
    showToast('Please select a file to upload');
    return;
  }
  
  const file = fileInput.files[0];
  const maxSizeMB = 50;
  if (file.size > maxSizeMB * 1024 * 1024) {
    showToast(`File is too large. Maximum allowed size is ${maxSizeMB}MB`);
    return;
  }
  
  // Show loading state
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
  
  const formData = new FormData();
  formData.append('file', file);
  formData.append('title', document.getElementById('uploadTitle').value || file.name);
  formData.append('tags', document.getElementById('uploadTags').value || '');
  
  const endpoint = file.name.toLowerCase().endsWith('.pdf') ? '/api/kb/upload-pdf' : '/api/kb/upload';
  
  // Add progress indicator
  const progressDiv = document.createElement('div');
  progressDiv.className = 'progress mt-3';
  progressDiv.innerHTML = `
    <div class="progress-bar progress-bar-striped progress-bar-animated" 
         role="progressbar" 
         style="width: 0%" 
         aria-valuenow="0" 
         aria-valuemin="0" 
         aria-valuemax="100">0%</div>
  `;
  e.target.appendChild(progressDiv);
  
  fetch(endpoint, {
    method: 'POST',
    body: formData
  })
  .then(res => {
    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    return res.json();
  })
  .then(data => {
    if (data.success) {
      uploadBtn.innerHTML = '<i class="bi bi-check-circle"></i> Upload Complete';
      progressDiv.querySelector('.progress-bar').style.width = '100%';
      progressDiv.querySelector('.progress-bar').textContent = '100%';
      
      setTimeout(() => {
        // Clean up form
        fileInput.value = '';
        document.getElementById('uploadTitle').value = '';
        document.getElementById('uploadTags').value = '';
        progressDiv.remove();
        
        // Reset button and close modal
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalBtnText;
        const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        uploadModal.hide();
        
        // Refresh the list
        loadArticles();
        showToast('File uploaded and processed successfully!');
      }, 2000);
    } else {
      throw new Error(data.error || 'Upload failed');
    }
  })
  .catch(error => {
    console.error('Upload error:', error);
    showToast(`Upload failed: ${error.message}`);
    
    progressDiv.remove();
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = originalBtnText;
  });
}

function handleUploadProgress(data) {
  const uploadBtn = document.querySelector('#uploadForm button[type="submit"]');
  const progressBar = document.querySelector('#uploadForm .progress-bar');
  
  if (uploadBtn && progressBar) {
    if (data.done) {
      uploadBtn.innerHTML = '<i class="bi bi-check-circle"></i> Upload Complete';
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';
    } else {
      uploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${data.status}`;
      if (data.progress) {
        const progress = Math.round(data.progress * 100);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
      }
    }
  }
}

function handleKbUpdate(data) {
  loadArticles();
  
  if (data.type === 'new') {
    showToast('A new article has been added to the Knowledge Base');
  } else if (data.type === 'update') {
    showToast('An article has been updated');
  } else if (data.type === 'delete') {
    showToast('An article has been removed');
  }
}

function autoTagArticle(article) {
  // Auto-tag based on content and file type
  const tags = [];
  const fileName = article.file_path ? article.file_path.split(/[\\/]/).pop() : '';
  const content = (article.content || '').toLowerCase();
  const title = (article.title || '').toLowerCase();
  
  // File type tags
  if (fileName.toLowerCase().endsWith('.pdf')) {
    tags.push('pdf', 'document');
  } else if (fileName.toLowerCase().endsWith('.doc') || fileName.toLowerCase().endsWith('.docx')) {
    tags.push('word', 'document');
  } else if (fileName.toLowerCase().endsWith('.txt')) {
    tags.push('text', 'document');
  }
  
  // Content-based tags
  if (content.includes('resume') || title.includes('resume')) {
    tags.push('resume', 'employment');
  }
  if (content.includes('manual') || title.includes('manual')) {
    tags.push('manual', 'guide');
  }
  if (content.includes('policy') || title.includes('policy')) {
    tags.push('policy', 'legal');
  }
  if (content.includes('procedure') || title.includes('procedure')) {
    tags.push('procedure', 'guide');
  }
  if (content.includes('report') || title.includes('report')) {
    tags.push('report', 'analysis');
  }
  if (content.includes('contract') || title.includes('contract')) {
    tags.push('contract', 'legal');
  }
  if (content.includes('invoice') || title.includes('invoice')) {
    tags.push('invoice', 'financial');
  }
  if (content.includes('receipt') || title.includes('receipt')) {
    tags.push('receipt', 'financial');
  }
  if (content.includes('certificate') || title.includes('certificate')) {
    tags.push('certificate', 'official');
  }
  if (content.includes('license') || title.includes('license')) {
    tags.push('license', 'legal');
  }
  
  // Category-based tags
  if (article.category) {
    tags.push(article.category.toLowerCase());
  }
  
  // Remove duplicates and return
  return [...new Set(tags)];
}

function handleRefresh() {
  const refreshBtn = document.getElementById('refreshKbBtn');
  const originalHtml = refreshBtn.innerHTML;
  refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
  refreshBtn.disabled = true;

  // First check for new documents, then refresh cache
  fetch('/api/kb/check-new-documents', {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.has_new_documents) {
          showToast('New documents found and imported!');
        } else {
          showToast('No new documents found.');
        }
        // Always refresh the display
        loadArticles();
      } else {
        showToast('Failed to check for new documents.');
      }
    })
    .catch(() => showToast('Failed to check for new documents.'))
    .finally(() => {
      refreshBtn.innerHTML = originalHtml;
      refreshBtn.disabled = false;
    });
}

function performSearch() {
  showLoading();
  
  const query = currentSearchQuery;
  if (!query) {
    loadArticles();
    return;
  }

  fetch(`/api/kb_public?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      allArticles = data.articles || [];
      extractCategoriesAndTags();
      populateFilters();
      applyFilters();
    })
    .catch(error => {
      console.error('Search error:', error);
      showError('Error performing search. Please try again.');
    });
}

function loadArticles() {
  showLoading();
  
  fetch('/api/kb_public?page=1&per_page=1000')
    .then(res => res.json())
    .then(data => {
      allArticles = data.articles || [];
      extractCategoriesAndTags();
      populateFilters();
      applyFilters();
    })
    .catch(error => {
      console.error('Load error:', error);
      showError('Error loading articles. Please try again.');
    });
}

function extractCategoriesAndTags() {
  allCategories.clear();
  allTags.clear();
  
  allArticles.forEach(article => {
    if (article.category) {
      allCategories.add(article.category);
    }
    
    // Get tags from article or auto-generate them
    let tags = article.tags || [];
    if (!tags.length) {
      tags = autoTagArticle(article);
    }
    
    if (Array.isArray(tags)) {
      tags.forEach(tag => allTags.add(tag));
    }
  });
}

function populateFilters() {
  // Populate category filter
  const categoryFilter = document.getElementById('kbCategoryFilter');
  if (categoryFilter) {
    const currentValue = categoryFilter.value;
    categoryFilter.innerHTML = '<option value="all">All Categories</option>';
    
    Array.from(allCategories).sort().forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });
    
    if (currentValue && Array.from(allCategories).includes(currentValue)) {
      categoryFilter.value = currentValue;
    }
  }
  
  // Populate tag filter
  const tagsList = document.getElementById('kbTagsList');
  if (tagsList) {
    tagsList.innerHTML = '';
    
    Array.from(allTags).sort().forEach(tag => {
      const tagBtn = document.createElement('button');
      tagBtn.className = 'btn btn-sm';
      tagBtn.style.cssText = `
        background: var(--dark-surface-2);
        border: 1px solid var(--dark-border);
        color: var(--dark-text-secondary);
        margin: 2px;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 12px;
        cursor: pointer;
        transition: var(--dark-transition);
      `;
      tagBtn.textContent = tag;
      tagBtn.title = `Filter by ${tag}`;
      
      tagBtn.addEventListener('click', () => {
        const isActive = currentFilters.tags.includes(tag);
        if (isActive) {
          currentFilters.tags = currentFilters.tags.filter(t => t !== tag);
          tagBtn.style.background = 'var(--dark-surface-2)';
          tagBtn.style.color = 'var(--dark-text-secondary)';
        } else {
          currentFilters.tags.push(tag);
          tagBtn.style.background = 'var(--dark-accent)';
          tagBtn.style.color = 'white';
        }
        applyFilters();
      });
      
      tagsList.appendChild(tagBtn);
    });
  }
}

function applyFilters() {
  filteredArticles = [...allArticles];
  
  // Apply search filter
  if (currentSearchQuery) {
    const query = currentSearchQuery.toLowerCase();
    filteredArticles = filteredArticles.filter(article => 
      article.title.toLowerCase().includes(query) ||
      (article.content && article.content.toLowerCase().includes(query)) ||
      (article.tags && article.tags.some(tag => tag.toLowerCase().includes(query)))
    );
  }
  
  // Apply category filter
  if (currentFilters.category !== 'all') {
    filteredArticles = filteredArticles.filter(article => 
      article.category === currentFilters.category
    );
  }
  
  // Apply file type filter
  if (currentFilters.fileType !== 'all') {
    filteredArticles = filteredArticles.filter(article => {
      const fileName = article.file_path ? article.file_path.split(/[\\/]/).pop() : '';
      const fileExt = fileName.toLowerCase().split('.').pop();
      
      switch (currentFilters.fileType) {
        case 'pdf': return fileExt === 'pdf';
        case 'doc': return ['doc', 'docx'].includes(fileExt);
        case 'txt': return fileExt === 'txt';
        default: return true;
      }
    });
  }
  
  // Apply tag filter
  if (currentFilters.tags.length > 0) {
    filteredArticles = filteredArticles.filter(article => {
      let tags = article.tags || [];
      if (!tags.length) {
        tags = autoTagArticle(article);
      }
      return tags.some(tag => currentFilters.tags.includes(tag));
    });
  }
  
  // Apply sorting (default to recent)
  filteredArticles.sort((a, b) => {
    const dateA = new Date(a.created_at || 0);
    const dateB = new Date(b.created_at || 0);
    return dateB - dateA; // Most recent first
  });
  
  renderArticles();
  updateSidebar();
  updateFilterStatus();
}

function updateFilterStatus() {
  // Update tag button states
  const tagsList = document.getElementById('kbTagsList');
  if (tagsList) {
    tagsList.querySelectorAll('button').forEach(btn => {
      const tag = btn.textContent;
      const isActive = currentFilters.tags.includes(tag);
      if (isActive) {
        btn.style.background = 'var(--dark-accent)';
        btn.style.color = 'white';
      } else {
        btn.style.background = 'var(--dark-surface-2)';
        btn.style.color = 'var(--dark-text-secondary)';
      }
    });
  }
}

function renderArticles() {
  const listGroup = document.getElementById('kbListGroupMain');
  const noResults = document.getElementById('kbNoResults');
  const loading = document.getElementById('kbLoading');
  
  // Hide loading
  if (loading) loading.style.display = 'none';
  
  if (!filteredArticles.length) {
    listGroup.innerHTML = '';
    noResults.style.display = '';
    return;
  }
  
  noResults.style.display = 'none';
  listGroup.innerHTML = '';
  
  filteredArticles.forEach((article, idx) => {
    const card = createArticleCard(article, idx);
    listGroup.appendChild(card);
  });
}

function createArticleCard(article, idx) {
  const fileName = article.file_path ? article.file_path.split(/[\\/]/).pop() : '';
  const isPdf = fileName && fileName.toLowerCase().endsWith('.pdf');
  const isDoc = fileName && (fileName.toLowerCase().endsWith('.doc') || fileName.toLowerCase().endsWith('.docx'));
  const isTxt = fileName && fileName.toLowerCase().endsWith('.txt');
  const fileMissing = article.file_missing;

  let icon = '';
  let iconClass = '';
  if (isPdf) {
    icon = 'bi-file-earmark-pdf';
    iconClass = 'text-danger';
  } else if (isDoc) {
    icon = 'bi-file-earmark-word';
    iconClass = 'text-primary';
  } else if (isTxt) {
    icon = 'bi-file-earmark-text';
    iconClass = 'text-info';
  } else {
    icon = 'bi-file-earmark';
    iconClass = 'text-secondary';
  }

  const card = document.createElement('div');
  card.className = 'kb-article-card';
  if (fileMissing) {
    card.style.opacity = '0.6';
    card.style.cursor = 'not-allowed';
  }

  // Highlight search terms
  let titleHtml = article.title;
  let contentHtml = article.content || '';
  
  if (currentSearchQuery) {
    const regex = new RegExp(`(${currentSearchQuery})`, 'gi');
    titleHtml = article.title.replace(regex, '<mark style="background-color: rgba(255, 193, 7, 0.3); color: #fff; padding: 0.1em 0.2em; border-radius: 0.2em;">$1</mark>');
    contentHtml = (article.content || '').replace(regex, '<mark style="background-color: rgba(255, 193, 7, 0.3); color: #fff; padding: 0.1em 0.2em; border-radius: 0.2em;">$1</mark>');
  }

  // Auto-tag if no tags exist
  let displayTags = article.tags || [];
  if (!displayTags.length) {
    displayTags = autoTagArticle(article);
  }
  
  card.innerHTML = `
    <div class="kb-article-header">
      <span class="kb-article-number">${idx + 1}</span>
      <i class="bi ${icon} kb-article-icon ${iconClass}"></i>
      <h5 class="kb-article-title">${titleHtml}</h5>
      ${fileMissing ? '<span class="badge bg-danger ms-2">File Missing</span>' : ''}
    </div>
    ${contentHtml ? `<div class="kb-article-content">${contentHtml}</div>` : ''}
    ${displayTags.length ? `
      <div class="kb-article-tags">
        ${displayTags.map(tag => `<span class="kb-article-tag">${tag}</span>`).join('')}
      </div>
    ` : ''}
    <div class="kb-article-meta">
      <span>${fileName || 'No file'}</span>
      <span>${displayTags.length} tags</span>
    </div>
  `;

  if (!fileMissing && fileName) {
    card.addEventListener('click', () => handleArticleClick(article, fileName, isPdf));
    card.addEventListener('mouseenter', () => {
      if (!fileMissing) card.style.transform = 'translateY(-2px)';
    });
    card.addEventListener('mouseleave', () => {
      if (!fileMissing) card.style.transform = 'translateY(0)';
    });
  } else {
    card.title = 'File not found';
  }

  return card;
}

function updateSidebar() {
  const sidebarList = document.getElementById('kbListGroup');
  sidebarList.innerHTML = '';
  
  filteredArticles.slice(0, 20).forEach((article, idx) => {
    const fileName = article.file_path ? article.file_path.split(/[\\/]/).pop() : '';
    const isPdf = fileName && fileName.toLowerCase().endsWith('.pdf');
    const isDoc = fileName && (fileName.toLowerCase().endsWith('.doc') || fileName.toLowerCase().endsWith('.docx'));
    const isTxt = fileName && fileName.toLowerCase().endsWith('.txt');
    
    let icon = '';
    let iconClass = '';
    if (isPdf) {
      icon = 'bi-file-earmark-pdf';
      iconClass = 'text-danger';
    } else if (isDoc) {
      icon = 'bi-file-earmark-word';
      iconClass = 'text-primary';
    } else if (isTxt) {
      icon = 'bi-file-earmark-text';
      iconClass = 'text-info';
    } else {
      icon = 'bi-file-earmark';
      iconClass = 'text-secondary';
    }

    const item = document.createElement('div');
    item.className = 'sidebar-article-item';
    item.innerHTML = `
      <i class="bi ${icon} sidebar-article-icon ${iconClass}"></i>
      <h6 class="sidebar-article-title">${article.title}</h6>
    `;
    
    item.addEventListener('click', () => {
      // Remove active class from all items
      document.querySelectorAll('.sidebar-article-item').forEach(el => el.classList.remove('active'));
      // Add active class to clicked item
      item.classList.add('active');
      
      // Scroll to the corresponding card in main area
      const mainCards = document.querySelectorAll('.kb-article-card');
      if (mainCards[idx]) {
        mainCards[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Add highlight effect
        mainCards[idx].classList.add('active');
        setTimeout(() => mainCards[idx].classList.remove('active'), 2000);
      }
    });
    
    sidebarList.appendChild(item);
  });
}

function handleArticleClick(article, fileName, isPdf) {
  if (isPdf) {
    showPdfModal(fileName, article.title);
  } else {
    const fileUrl = `/static/docs/${encodeURIComponent(fileName)}`;
    window.open(fileUrl, '_blank');
  }
}

function showPdfModal(filename, title) {
  const modal = document.getElementById('pdfModal');
  const overlay = document.getElementById('pdfModalOverlay');
  const content = document.getElementById('pdfModalContent');
  const titleEl = document.getElementById('pdfModalTitle');
  
  titleEl.textContent = title;
  
  // Show loading state
  content.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
  
  modal.classList.add('active');
  overlay.classList.add('active');
  
  // Load PDF
  const pdfUrl = `/static/docs/${encodeURIComponent(filename)}`;
  
  // Check if browser supports PDF viewing
  const supportsPdf = navigator.mimeTypes && navigator.mimeTypes['application/pdf'];
  
  if (!supportsPdf) {
    // Browser doesn't support PDF viewing, show fallback immediately
    showPdfFallback(pdfUrl, filename, 'no-support');
    return;
  }
  
  const iframe = document.createElement('iframe');
  iframe.src = pdfUrl;
  iframe.className = 'pdf-viewer-iframe';
  iframe.allowFullscreen = true;
  iframe.setAttribute('type', 'application/pdf');
  iframe.setAttribute('data', pdfUrl);
  
  // Track loading state
  let pdfLoaded = false;
  let fallbackShown = false;
  
  iframe.onload = function() {
    console.log('PDF iframe loaded successfully:', filename);
    pdfLoaded = true;
    
    // Remove loading spinner and show iframe
    if (content.querySelector('.spinner-border')) {
      content.innerHTML = '';
      content.appendChild(iframe);
    }
    
    // Additional check to ensure PDF is actually rendering
    setTimeout(() => {
      try {
        if (iframe.contentDocument && iframe.contentDocument.body) {
          const bodyHeight = iframe.contentDocument.body.scrollHeight;
          if (bodyHeight > 100) {
            console.log('PDF content confirmed loaded, height:', bodyHeight);
          }
        }
      } catch (e) {
        // Cross-origin access blocked - this is expected and normal
        console.log('Cross-origin access blocked (normal for PDFs)');
      }
    }, 1000);
  };
  
  iframe.onerror = function() {
    console.log('PDF iframe error:', filename);
    if (!fallbackShown) {
      fallbackShown = true;
      showPdfFallback(pdfUrl, filename, 'iframe error');
    }
  };
  
  // Add iframe to DOM after a short delay to allow proper loading
  setTimeout(() => {
    if (content.querySelector('.spinner-border') && !pdfLoaded) {
      content.innerHTML = '';
      content.appendChild(iframe);
      
      // Set a longer timeout for actual PDF rendering issues
      setTimeout(() => {
        if (!pdfLoaded && !fallbackShown) {
          // Check if iframe is still trying to load
          try {
            if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
              console.log('PDF appears to have loaded successfully');
              pdfLoaded = true;
              return;
            }
          } catch (e) {
            // Cross-origin access blocked - this is normal for PDFs
            console.log('Cross-origin access blocked (expected for PDFs)');
            // For cross-origin issues, give the PDF more time to load
            // Many browsers block access but the PDF still loads successfully
            setTimeout(() => {
              if (!pdfLoaded && !fallbackShown) {
                console.log('PDF may have loaded despite cross-origin restrictions');
                pdfLoaded = true;
              }
            }, 3000);
            return;
          }
          
          // Only show fallback if we're sure there's an issue
          if (!fallbackShown) {
            fallbackShown = true;
            showPdfFallback(pdfUrl, filename, 'timeout');
          }
        }
      }, 8000); // Increased timeout to 8 seconds for better reliability
    }
  }, 1000); // Increased initial delay to 1 second
  
  // Fallback: if onload doesn't fire within 3 seconds, assume PDF is loading
  setTimeout(() => {
    if (!pdfLoaded && !fallbackShown && content.querySelector('.spinner-border')) {
      console.log('PDF onload event didn\'t fire, but continuing to wait...');
      // Don't show fallback yet, just log and continue waiting
    }
  }, 3000);
}

function showPdfFallback(pdfUrl, filename, reason = 'error') {
  const content = document.getElementById('pdfModalContent');
  
  let message = 'The PDF could not be displayed inline.';
  let details = 'You can download it to view in your PDF reader.';
  let icon = 'bi-exclamation-triangle';
  let iconColor = 'text-warning';
  
  switch (reason) {
    case 'iframe error':
      message = 'PDF viewer failed to load.';
      details = 'The browser could not display the PDF inline.';
      icon = 'bi-exclamation-circle';
      iconColor = 'text-danger';
      break;
    case 'timeout':
      message = 'PDF loading timeout.';
      details = 'The PDF took too long to load or your browser doesn\'t support inline PDF viewing.';
      icon = 'bi-clock';
      iconColor = 'text-warning';
      break;
    case 'cross-origin':
      message = 'PDF viewing not available.';
      details = 'Your browser cannot display this PDF inline due to security restrictions.';
      icon = 'bi-shield-exclamation';
      iconColor = 'text-info';
      break;
    case 'no-support':
      message = 'PDF viewing not supported.';
      details = 'Your browser doesn\'t support inline PDF viewing. Please download the file or open it in a new tab.';
      icon = 'bi-browser';
      iconColor = 'text-info';
      break;
  }
  
  content.innerHTML = `
    <div class="pdf-error-message">
      <i class="bi ${icon} ${iconColor}" style="font-size: 3rem; margin-bottom: 1rem;"></i>
      <h4>${message}</h4>
      <p>${details}</p>
      <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="${pdfUrl}" class="btn btn-primary" download="${filename}" style="background: var(--dark-accent); border: none;">
          <i class="bi bi-download"></i> Download PDF
        </a>
        <a href="${pdfUrl}" class="btn btn-outline-primary" target="_blank" style="border-color: var(--dark-accent); color: var(--dark-accent);">
          <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
        </a>
        <button class="btn btn-secondary" onclick="closePdfModal()" style="background: var(--dark-surface-2); border: 1px solid var(--dark-border);">
          <i class="bi bi-x-lg"></i> Close
        </button>
      </div>
    </div>
  `;
}

function closePdfModal() {
  const pdfModal = document.getElementById('pdfModal');
  const pdfModalOverlay = document.getElementById('pdfModalOverlay');
  const content = document.getElementById('pdfModalContent');
  
  if (pdfModal && pdfModalOverlay) {
    pdfModal.classList.remove('active');
    pdfModalOverlay.classList.remove('active');
    
    // Clean up content after modal closes
    setTimeout(() => {
      if (content) {
        content.innerHTML = '';
      }
    }, 300);
  }
}

function showLoading() {
  const listGroup = document.getElementById('kbListGroupMain');
  const noResults = document.getElementById('kbNoResults');
  const loading = document.getElementById('kbLoading');
  
  listGroup.innerHTML = '';
  noResults.style.display = 'none';
  if (loading) loading.style.display = '';
}

function showError(message) {
  const listGroup = document.getElementById('kbListGroupMain');
  const noResults = document.getElementById('kbNoResults');
  const loading = document.getElementById('kbLoading');
  
  listGroup.innerHTML = '';
  if (loading) loading.style.display = 'none';
  noResults.style.display = '';
  noResults.innerHTML = `
    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--dark-danger);"></i>
    <h4>Error</h4>
    <p>${message}</p>
  `;
}

function showToast(msg) {
  let toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = `
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--dark-surface);
    color: var(--dark-accent);
    padding: 1rem 2rem;
    border-radius: 1rem;
    box-shadow: var(--dark-shadow);
    z-index: 3000;
    border: 1px solid var(--dark-border);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Initialize modal close functionality
document.addEventListener('DOMContentLoaded', function() {
  const pdfModal = document.getElementById('pdfModal');
  const pdfModalOverlay = document.getElementById('pdfModalOverlay');
  const pdfModalClose = document.getElementById('pdfModalClose');

  if (pdfModalClose) {
    pdfModalClose.addEventListener('click', closePdfModal);
  }

  if (pdfModalOverlay) {
    pdfModalOverlay.addEventListener('click', closePdfModal);
  }

  if (pdfModal) {
    pdfModal.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && pdfModal && pdfModal.classList.contains('active')) {
      closePdfModal();
    }
  });
});
</script>
{% endblock %}