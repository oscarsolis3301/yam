<html lang="en" data-bs-theme="dark">
<head>
  <title>
    {% if active_page == 'home' %}Home
    {% elif active_page == 'offices' %}Offices
    {% elif active_page == 'workstations' %}Workstations
    {% elif active_page == 'users' %}Users
    {% elif active_page == 'outages' %}Outages
    {% elif active_page == 'oralyzer_dashboard' %}Oralyzer Dashboard
    {% elif active_page == 'oralyzer' %}Oralyzer
    {% elif active_page == 'lab' %}Lab
    {% elif active_page == 'tracking' %}Tracking
    {% elif active_page == 'kb' %}Knowledge Base
    {% elif active_page == 'team' %}Team Members
    {% elif active_page == 'patterson' %}Patterson Dispatch
    {% elif active_page == 'dameware' %}Dameware Remote
    {% elif active_page == 'service_desk' %}Service Desk
    {% elif active_page == 'service_desk_dashboard' %}Service Desk Dashboard
    {% elif active_page == 'workspace' %}Notes
    {% elif active_page == 'jarvis' %}Jarvis
    {% elif active_page == 'chat_history' %}Chat History
    {% elif active_page == 'clock_id_cache' %}Clock ID Cache
    {% else %}YAM
    {% endif %}
  </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    .logo-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  
  </style>

  <style>
    .logo-glow-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Animated Y logo styles from login page */
    .main-logo { 
      font-size: 2.7rem;
      font-weight: 900; 
      background: linear-gradient(45deg, #7289da, #43b581, #faa61a, #f04747); 
      background-size: 400% 400%; 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
      animation: gradientShift 3s ease-in-out infinite, logoGlow 2s ease-in-out infinite alternate; 
      margin-bottom: 0; 
      text-shadow: 0 0 40px rgba(114,137,218,0.5); 
      line-height: 1;
    }
    @keyframes gradientShift { 
      0%,100% { background-position: 0% 50%; } 
      50% { background-position: 100% 50%; } 
    }
    @keyframes logoGlow { 
      from { 
        text-shadow: 0 0 40px rgba(114,137,218,0.5); 
        transform: scale(1); 
      } 
      to { 
        text-shadow: 0 0 60px rgba(114,137,218,0.8); 
        transform: scale(1.05); 
      } 
    }
    
  </style>
  

</head>
<body>
<style>
.sidebar-fixed {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 3.5rem;
    height: 100vh;
    background: rgba(24, 28, 35, 0.88); /* translucent dark glass */
    backdrop-filter: blur(8px);          /* soft glass effect */
    border-right: 1px solid rgba(255,255,255,0.05); /* subtle divider */
    box-shadow: 2px 0 8px rgba(0,0,0,0.35);        /* depth */
    z-index: 9999999 !important;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: visible;
    transition: transform 0.3s ease-in-out;
    /* Ensure sidebar is never affected by other elements */
    margin: 0 !important;
    padding: 0 !important;
}

/* Dynamic Banner Styles */
.sidebar-banner {
    position: absolute;
    top: 0;
    left: 30px;
    width: calc(100vw - 30px); /* Account for scrollbar width */
    height: 80px;
    background: #000000;
    z-index: 9999998; /* Just below sidebar */
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-left: 3.5rem; /* Offset by sidebar width */
    padding-right: 3rem; /* Increased space for search bar and scrollbar */
    font-family: 'Inter', 'Segoe UI', sans-serif;
    font-size: 22px;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.sidebar-banner::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 3.5rem;
    height: 100%;
    background: #000000;
    z-index: -1;
}

/* Banner text content based on active page */
.sidebar-banner-text {
    opacity: 0.9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: calc(100vw - 350px); /* Reduced to make room for search and scrollbar */
}

/* Banner Search Bar Styles */
.banner-search-container {
    position: relative;
    width: 280px;
    height: 40px;
    z-index: 9999999;
    min-width: 200px;
    max-width: 350px;
}

@media (max-width: 768px) {
    .banner-search-container {
        width: 180px;
        min-width: 120px;
    }
    
    .sidebar-banner-text {
        max-width: calc(100vw - 280px);
        font-size: 18px;
    }
    
    .sidebar-banner {
        padding-right: 1.5rem;
        width: calc(100vw - 40px);
    }
}

.banner-search-wrapper {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    height: 100%;
    display: flex;
    align-items: center;
    position: relative;
}

.banner-search-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.banner-search-wrapper:hover::before {
    opacity: 1;
}

.banner-search-wrapper:focus-within {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transform: scale(1.02);
}

.banner-search-input-group {
    display: flex;
    align-items: center;
    padding: 0 16px;
    width: 100%;
    height: 100%;
}

.banner-search-icon {
    color: rgba(255, 255, 255, 0.7);
    margin-right: 10px;
    font-size: 16px;
    transition: color 0.2s ease;
}

.banner-search-wrapper:focus-within .banner-search-icon {
    color: #ffffff;
}

.banner-search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 14px;
    color: #ffffff;
    font-weight: 400;
    line-height: 1.4;
    height: 100%;
}

.banner-search-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
    font-weight: 400;
}

.banner-search-clear-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-left: 8px;
}

.banner-search-clear-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}

.banner-search-loading {
    margin-left: 8px;
    width: 16px;
    height: 16px;
}

/* Banner Search Results Dropdown */
.banner-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(35, 39, 47, 0.95);
    backdrop-filter: blur(15px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-height: 400px;
    overflow-y: auto;
    z-index: 10000000;
    margin-top: 8px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.banner-search-results.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.banner-search-result-item {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.banner-search-result-item:last-child {
    border-bottom: none;
}

.banner-search-result-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.banner-search-result-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
}

.banner-search-result-content {
    flex: 1;
    min-width: 0;
}

.banner-search-result-title {
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.banner-search-result-subtitle {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.banner-search-no-results {
    padding: 20px 16px;
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
}

/* Banner Search Suggestions Dropdown */
.banner-search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(35, 39, 47, 0.95);
    backdrop-filter: blur(15px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 10000000;
    margin-top: 8px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.banner-search-suggestions.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.banner-search-suggestion-item {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
}

.banner-search-suggestion-item:last-child {
    border-bottom: none;
}

.banner-search-suggestion-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.banner-search-suggestion-item.selected {
    background: rgba(13, 110, 253, 0.2);
    color: #ffffff;
}

.banner-search-suggestion-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
}

.banner-search-suggestion-text {
    flex: 1;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 400;
}

.banner-search-suggestion-category {
    color: rgba(255, 255, 255, 0.5);
    font-size: 12px;
    margin-left: auto;
}

/* Suggestion categories styling */
.banner-suggestion-category-header {
    padding: 8px 16px 4px 16px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-fixed.collapsed {
    transform: translateX(-100%);
}

/* Fix sidebar item spacing */
.sidebar-fixed .nav li {
    margin-bottom: 0.5rem;
}

.sidebar-fixed .nav li:last-child {
    margin-bottom: 0;
}

.sidebar-fixed .nav-link {
    padding: 0.75rem 0.5rem !important;
    margin: 0.25rem 0;
    border-radius: 0.5rem !important;
    transition: all 0.2s ease;
}

.sidebar-fixed .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
    transform: translateX(2px);
}

.collapse-btn {
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    background: #181c23;
    border: 1px solid #333;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #fff;
    z-index: 9999999;
    transition: background-color 0.2s;
}

.collapse-btn:hover {
    background: #23272f;
}

.collapse-btn i {
    transition: transform 0.3s ease-in-out;
}

.sidebar-fixed.collapsed .collapse-btn i {
    transform: rotate(180deg);
}

.test-toggle-btn {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 9999998;
}

.test-toggle-btn:hover {
    background: #0056b3;
}

.dropdown-menu {
    z-index: 9999999999 !important;
}

/* Ensure sidebar is always positioned correctly */
body {
    margin: 0 !important;
    padding: 0 !important;
}

/* Prevent any interference with sidebar positioning */
.sidebar-fixed * {
    box-sizing: border-box;
}

/* Ensure navigation links have consistent spacing */
.nav-pills .nav-link {
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #c4cad4;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
    margin: 0 !important;
    padding: 0.5rem 0 !important;
}
</style>

<!-- Dynamic Banner -->
<div class="sidebar-banner">
    <div class="sidebar-banner-text">
        {% if active_page == 'home' %}Dashboard
        {% elif active_page == 'offices' %}Offices
        {% elif active_page == 'workstations' %}Workstations
        {% elif active_page == 'users' %}Users
        {% elif active_page == 'outages' %}Outages
        {% elif active_page == 'oralyzer_dashboard' %}Oralyzer Dashboard
        {% elif active_page == 'oralyzer' %}Oralyzer
        {% elif active_page == 'lab' %}Lab
        {% elif active_page == 'tracking' %}Tracking
        {% elif active_page == 'kb' %}Knowledge Base
        {% elif active_page == 'team' %}Team Members
        {% elif active_page == 'patterson' %}Patterson Dispatch
        {% elif active_page == 'dameware' %}Dameware Remote
        {% elif active_page == 'service_desk' %}Service Desk
        {% elif active_page == 'service_desk_dashboard' %}Service Desk Dashboard
        {% elif active_page == 'workspace' %}Notes
        {% elif active_page == 'jarvis' %}Jarvis
        {% elif active_page == 'chat_history' %}Chat History
        {% elif active_page == 'clock_id_cache' %}Clock ID Cache
        {% else %}YAM
        {% endif %}
    </div>
    
    <!-- Banner Search Bar -->
    <div class="banner-search-container">
        <div class="banner-search-wrapper">
            <div class="banner-search-input-group">
                <div class="banner-search-icon">
                    <i class="bi bi-search"></i>
                </div>
                <input 
                    type="text" 
                    id="bannerSearchInput" 
                    class="banner-search-input" 
                    placeholder="Search everything... (Ctrl+K)"
                    autocomplete="off"
                    spellcheck="false"
                >
                <button id="bannerSearchClearBtn" class="banner-search-clear-btn" style="display: none;">
                    <i class="bi bi-x"></i>
                </button>
                <div id="bannerSearchLoading" class="banner-search-loading" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 40 40">
                        <circle cx="20" cy="20" r="18" stroke="#ffffff" stroke-width="3" fill="none" opacity="0.3"/>
                        <path fill="#ffffff" fill-opacity="0.7">
                            <animate attributeName="d" dur="1.2s" repeatCount="indefinite"
                                values="M2,20 Q20,10 38,20 Q20,30 2,20 Z;M2,22 Q20,12 38,22 Q20,32 2,22 Z;M2,20 Q20,10 38,20 Q20,30 2,20 Z"/>
                        </path>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Banner Search Results Dropdown -->
        <div id="bannerSearchResults" class="banner-search-results">
            <div id="bannerResultsContent"></div>
        </div>
        
        <!-- Banner Search Suggestions Dropdown -->
        <div id="bannerSearchSuggestions" class="banner-search-suggestions">
            <div id="bannerSuggestionsContent"></div>
        </div>
    </div>
</div>

<div class="sidebar-fixed">
  <button class="collapse-btn" id="sidebarCollapseBtn">
    <i class="bi bi-chevron-left"></i>
  </button>
  <!-- START SIDEBAR CONTENT ONLY -->
  <div class="d-flex flex-column flex-shrink-0 bg-body-tertiary" style="width: 3.5rem; height: 100vh; margin: 0; padding: 0;">
      <!-- ANIMATED Y LOGO -->
      <a href="/" class="d-block p-3 link-body-emphasis text-decoration-none" title="" data-bs-toggle="tooltip" data-bs-placement="right" style="margin: 0; padding: 0.75rem;">
        <div class="logo-glow-wrapper">
          <div class="main-logo">Y</div>
        </div>  
        <span class="visually-hidden">Icon-only</span>
      </a>
      <ul class="nav nav-pills nav-flush flex-column mb-auto text-center" style="margin: 0; padding: 0; gap: 0.5rem;">
        <!-- Authentication detection element -->
        {% if current_user and current_user.is_authenticated %}
        <div class="user-info" data-user="{{ current_user.username if current_user and current_user.username else 'Unknown' }}" style="display: none;"></div>
        {% endif %}
        
        <li style="position: relative;">
          <a href="#" id="sidebarUniversalSearchToggle" class="nav-link py-2 rounded-0" title="Search" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-search" alt="Spark" style="font-size: 20px"></i>
          </a>
          <!-- Submenu for Unified -->
          <div class="submenu-container">
            <ul class="nav flex-column submenu">
              <li class="nav-item">
                <a href="/offices" class="nav-link py-1 rounded-pill {% if active_page == 'offices' %}active{% endif %}" title="Office" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-building-fill" style="font-size: 16px;"></i>
                </a>
              </li>
              <li class="nav-item">
                <a href="/workstations" class="nav-link py-1 rounded-pill {% if active_page == 'workstations' %}active{% endif %}" title="Workstation" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-laptop-fill" style="font-size: 16px;"></i>
                </a>
              </li>
              <li class="nav-item">
                <a href="/users" class="nav-link py-1 rounded-pill {% if active_page == 'users' %}active{% endif %}" title="User" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-people-fill" style="font-size: 16px;"></i>
                </a>
              </li>
            </ul>
          </div>
        </li>
        <li>
          <a href="/outages" class="nav-link py-2 rounded-0 {% if active_page == 'outages' %}active{% endif %}" title="Outage" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-exclamation-triangle-fill" style="font-size: 20px;"></i>
          </a>
        </li>
        <li style="position: relative;">
          <a href="/oralyzer/dashboard" class="nav-link py-2 rounded-0 {% if active_page == 'oralyzer_dashboard' %}active{% endif %}" title="Oralyzer Dashboard" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-layers-fill" style="font-size: 20px;"></i>
          </a>
          <!-- Submenu for Oralyzer -->
          <div class="submenu-container">
            <ul class="nav flex-column submenu">
              <li class="nav-item">
                <a href="/oralyzer" class="nav-link py-1 rounded-pill {% if active_page == 'oralyzer' %}active{% endif %}" title="Oralyzer" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-speedometer2" style="font-size: 16px;"></i>
                </a>
              </li>
              <li class="nav-item">
                <a href="/lab" class="nav-link py-1 rounded-pill {% if active_page == 'lab' %}active{% endif %}" title="Lab" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi-hospital" style="font-size: 16px;"></i>
                </a>
              </li>
            </ul>
          </div>
        </li>
        <li>
          <a href="/notes" class="nav-link py-2 rounded-0 {% if active_page == 'workspace' %}active{% endif %}" title="Notes" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-journal-richtext" style="font-size: 20px;"></i>
          </a>
        </li>
        <li>
          <a href="/kb" class="nav-link py-2 rounded-0 {% if active_page == 'kb' %}active{% endif %}" title="Knowledge Base" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-book-fill" style="font-size: 20px;"></i>
          </a>
        </li>
        <!-- <li>
          <a href="/tracking" class="nav-link py-2 rounded-0 {% if active_page == 'tracking' %}active{% endif %}" title="Tracking" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-geo-fill" style="font-size: 20px;"></i>
          </a>
        </li> -->

        <!-- <li>
          <a href="/team" class="nav-link py-2 rounded-0 {% if active_page == 'team' %}active{% endif %}" title="Team Members" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-person-bounding-box" style="font-size: 20px;"></i>
          </a>
        </li> -->
        <li>
          <a href="/patterson" class="nav-link py-2 rounded-0 {% if active_page == 'patterson' %}active{% endif %}" title="Patterson Dispatch" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-tools" style="font-size: 20px;"></i>
          </a>
        </li>
        <li>
          <a href="/dameware" class="nav-link py-2 rounded-0 {% if active_page == 'dameware' %}active{% endif %}" title="Dameware Remote" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-display" style="font-size: 20px;"></i>
          </a>
        </li>
        <li style="position: relative;">
          <a href="/service-desk" class="nav-link py-2 rounded-0 {% if active_page == 'service_desk' %}active{% endif %}" title="Service Desk" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-headset" style="font-size: 20px;"></i>
          </a>
          <!-- Submenu for Service Desk -->
          <div class="submenu-container">
            <ul class="nav flex-column submenu">
              <li class="nav-item">
                <a href="/service-desk/dashboard" class="nav-link py-1 rounded-pill {% if active_page == 'service_desk_dashboard' %}active{% endif %}" title="Dashboard" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-speedometer2" style="font-size: 16px;"></i>
                </a>
              </li>
              <li class="nav-item">
                <a href="/service-desk/tickets" class="nav-link py-1 rounded-pill {% if active_page == 'service_desk_tickets' %}active{% endif %}" title="Tickets" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-list-ul" style="font-size: 16px;"></i>
                </a>
              </li>
              <li class="nav-item">
                <a href="/service-desk/knowledge-base" class="nav-link py-1 rounded-pill {% if active_page == 'service_desk_kb' %}active{% endif %}" title="Knowledge Base" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-book" style="font-size: 16px;"></i>
                </a>
              </li>
            </ul>
          </div>
        </li>

        {% if current_user.is_authenticated and current_user.is_admin %}
        <li>
          <a href="/admin/clock-id-cache" class="nav-link py-2 rounded-0 {% if active_page == 'clock_id_cache' %}active{% endif %}" title="Clock ID Cache" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-database-check" style="font-size: 20px;"></i>
          </a>
        </li>
        {% endif %}
        <!-- ======================================================== -->
        <!-- Jarvis AI Dashboard & Chat History                      -->
        <!-- ======================================================== -->
        {% if current_user.is_authenticated and current_user.role != 'user' %}
        <li style="position: relative;">
          <a href="/jarvis/dashboard" class="nav-link py-2 rounded-0 {% if active_page == 'jarvis' %}active{% endif %}" title="Jarvis" data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="bi bi-robot" style="font-size: 20px;"></i>
          </a>
          <!-- Submenu for Jarvis -->
          <div class="submenu-container">
            <ul class="nav flex-column submenu">
              <li class="nav-item">
                <a href="/admin/chat-history" class="nav-link py-1 rounded-pill {% if active_page == 'chat_history' %}active{% endif %}" title="Chat History" data-bs-toggle="tooltip" data-bs-placement="right">
                  <i class="bi bi-clock-history" style="font-size: 16px;"></i>
                </a>
              </li>
            </ul>
          </div>
        </li>
        {% endif %}
      </ul>
      <!-- THE OFF CANVAS OUTAGE MENU -->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvasExampleLabel">Outages</h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <div>
            Please select what you would like to see: all, current, previous, or the menu to create a new outage.
          </div>
          <div class="dropdown mt-3">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
              Select one
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <li><a class="dropdown-item" href="/all_outages">All</a></li> 
              <li><a class="dropdown-item" href="/current_outages">Current</a></li>
              <li><a class="dropdown-item" href="/previous_outages">Previous</a></li>
              <li><a class="dropdown-item" href="/new_outage">Create New</a></li>
            </ul>
          </div>
        </div>
      </div>

      <script>
          document.addEventListener('DOMContentLoaded', function () {
              const navLinks = document.querySelectorAll('.nav-link');
  
              navLinks.forEach(link => {
                  link.addEventListener('click', function () {
                      navLinks.forEach(nav => nav.classList.remove('active')); // Remove from all
                      this.classList.add('active'); // Add to clicked one
                  });
              });
          });
      </script>
      
      
      <div class="dropdown border-top mt-auto user-dropdown">
        <a href="#" class="d-block link-body-emphasis text-decoration-none" data-bs-toggle="dropdown" aria-expanded="false">

          <div class="sidebar-profile-picture-wrapper">
            <div class="sidebar-profile-picture-container">
              <img 
                src="{{ url_for('static', filename='uploads/profile_pictures/' + (current_user.profile_picture if current_user and current_user.profile_picture else 'boy.png')) }}"
                alt="Profile Picture" 
                class="sidebar-profile-picture"
                onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/PFP/boy.png') }}';">
            </div>
            <span class="online-status-dot"></span>
          </div>
        </a>
      
        <ul class="dropdown-menu text-small shadow">
          <li><a class="dropdown-item" href="#" id="openStickyNotes">Notes</a></li>
          <li><a class="dropdown-item" href="/settings">Settings</a></li>
          <li><a class="dropdown-item" href="/profile">Profile</a></li>
          {% if current_user and current_user.is_authenticated and current_user.is_admin %}
          <li><a class="dropdown-item" href="/dashboard">Admin Dashboard</a></li>
          <li><a class="dropdown-item" href="/admin/cache-management">Cache Management</a></li>
          {% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="/logout">Sign out</a></li>
        </ul>
      </div>
      
      
      
  </div>
  <!-- END SIDEBAR CONTENT -->
</div>

<div class="b-example-divider b-example-vr"></div>

{% include "AI.html" %}

<div id="stickyNotesWidget" class="sticky-notes-widget" style="display:none; position:fixed; top:32px; right:32px; z-index:3000;">
  <div class="sticky-header" id="stickyHeader">
    <span>Sticky Notes</span>
    <div class="sticky-actions">
      <button class="sticky-btn" id="addNoteBtn" title="Add Note"><i class="bi bi-plus"></i></button>
      <button class="sticky-btn" id="minimizeNotesBtn" title="Minimize/Maximize"><i class="bi bi-arrows-angle-expand"></i></button>
      <button class="sticky-btn" id="closeNotesBtn" title="Close"><i class="bi bi-x"></i></button>
    </div>
  </div>
  <div class="sticky-content" id="stickyContent">
    <div id="notesList"></div>
  </div>
  <div id="stickyToast" class="sticky-toast"></div>
</div>

<script>
const notesBtn = document.getElementById('openStickyNotes');
if (notesBtn) {
  notesBtn.onclick = function() {
    document.getElementById('stickyNotesWidget').style.display = 'block';
  };
}
const closeBtn = document.getElementById('closeNotesBtn');
if (closeBtn) {
  closeBtn.onclick = function() {
    document.getElementById('stickyNotesWidget').style.display = 'none';
  };
}
</script>

<style>
  .sidebar-profile-picture-wrapper:hover {
    filter: brightness(1.1);
    cursor: pointer;
  }
  
  .nav-pills .nav-link {
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #c4cad4;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
  }
  
  .nav-pills .nav-link:hover {
    background: rgba(255,255,255,0.08);
    color: #ffffff;
    transform: scale(1.08);
  }
  
  .nav-pills .nav-link:last-child {
    border-bottom: none;
  }
  
  .nav-pills .nav-link.active {
    background: #0d6efd;
    color: #ffffff;
    border-radius: .75rem;
  }

  /* --- Online Status Dot --- */
  .sidebar-profile-picture-container {
    position: relative;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    background: #181c23;
    border: 1.5px solid #23272f;
    margin: 0 auto;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

/* --- Online Status Dot --- */
.online-status-dot {
  position: absolute;
  bottom: 3px; /* Adjusted for smaller container */
  right: 1px;  /* Adjusted for smaller container */
  width: 10px;
  height: 10px;
  background-color: #28a745;
  border: 2px solid #181c23;
  border-radius: 50%;
  box-shadow: 0 0 6px #28a745;
  animation: pulse 2s infinite;
  z-index: 2;
}


  @keyframes pulse {
    0%   { box-shadow: 0 0 0px #28a745; }
    50%  { box-shadow: 0 0 6px #28a745; }
    100% { box-shadow: 0 0 0px #28a745; }
  }

  .sidebar-profile-picture {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    display: block;
    background: #23272f;
  }

  /* --- Sticky Notes Widget --- */
  .sticky-notes-widget {
    position: fixed;
    top: 32px;
    right: 32px;
    width: 370px;
    min-width: 240px;
    min-height: 160px;
    height: 520px;
    background: rgba(35, 39, 47, 0.92);
    color: #fff;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    z-index: 3000;
    font-family: 'Inter', 'Segoe UI', sans-serif;
    user-select: none;
    transition: box-shadow 0.2s, width 0.2s, height 0.2s, border-radius 0.2s;
    resize: both;
    overflow: hidden;
    backdrop-filter: blur(4px);
  }

  .sticky-header {
    background: transparent;
    color: #fff;
    padding: 18px 16px 18px 26px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    font-weight: 600;
    font-size: 1.18rem;
    gap: 10px;
    letter-spacing: 0.01em;
  }

  .sticky-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .sticky-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.35rem;
    cursor: pointer;
    padding: 3px 10px;
    border-radius: 7px;
    transition: background 0.18s, color 0.18s;
    outline: none;
  }

  .sticky-btn:hover {
    background: #23272f;
    color: #ffd700;
  }

  .sticky-content {
    padding: 22px;
    background: transparent;
    border-radius: 0 0 20px 20px;
    max-height: 420px;
    overflow-y: auto;
    transition: max-height 0.3s;
  }

  .sticky-note-item {
    background: rgba(44,49,58,0.98);
    color: #fff;
    border-radius: 14px;
    margin-bottom: 18px;
    padding: 16px 16px 12px 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    position: relative;
    transition: box-shadow 0.2s, background 0.2s, border-radius 0.2s;
    animation: fadeIn 0.4s;
    border: 1.5px solid rgba(255,255,255,0.04);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .sticky-note-item:focus-within {
    box-shadow: 0 0 0 2px #007bff;
  }

  .sticky-note-title,
  .sticky-note-content {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    border-radius: 7px;
    font-family: inherit;
    letter-spacing: 0.01em;
  }

  .sticky-note-title {
    color: #fff;
    font-weight: 500;
    font-size: 1.09rem;
    margin-bottom: 7px;
  }

  .sticky-note-content {
    color: #eaeaea;
    font-size: 1.04rem;
    min-height: 48px;
    resize: vertical;
    font-weight: 400;
  }

  .sticky-note-delete,
  .sticky-note-pin,
  .sticky-note-collapse,
  .sticky-note-color {
    background: none;
    border: none;
    font-size: 1.18rem;
    cursor: pointer;
    padding: 0 6px;
    border-radius: 6px;
    transition: background 0.18s, color 0.18s;
  }

  .sticky-note-delete {
    color: #ff6b6b;
  }

  .sticky-note-pin {
    color: #ffd700;
    margin-right: 2px;
  }

  .sticky-note-pin.pinned {
    color: #ffe066;
  }

  .sticky-note-collapse {
    color: #aaa;
    margin-right: 2px;
  }

  .sticky-note-collapse.collapsed {
    color: #007bff;
  }

  .sticky-note-delete:hover {
    background: #3a2323;
  }

  .sticky-note-color {
    color: #fff;
    margin-right: 2px;
  }

  .sticky-color-picker {
    display: flex;
    gap: 5px;
    margin-top: 6px;
  }

  .sticky-color-dot {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #23272f;
    cursor: pointer;
    display: inline-block;
    transition: border 0.2s, transform 0.2s;
  }

  .sticky-color-dot.selected {
    border: 2px solid #fff;
    transform: scale(1.1);
  }

  .sticky-toast {
    position: absolute;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: #23272f;
    color: #fff;
    padding: 10px 22px;
    border-radius: 8px;
    font-size: 1.05rem;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    transition: opacity 0.3s;
    z-index: 9999;
  }

  .sticky-toast.show {
    opacity: 1;
  }

  .sticky-notes-widget.minimized {
    height: 60px !important;
    min-height: 60px !important;
  }

  .sticky-notes-widget.minimized .sticky-content {
    display: none;
  }

  .sticky-notes-widget.resizing {
    box-shadow: 0 0 0 2px #007bff;
  }
</style>


<script>
let notes = [];
let isDraggingSticky = false;
let stickyOffset = { x: 0, y: 0 };
let stickyInitial = { x: 0, y: 0 };
let resizing = false;
let searchQuery = '';

// --- Dragging ---
function initStickyDrag() {
  const widget = document.getElementById('stickyNotesWidget');
  const header = document.getElementById('stickyHeader');
  header.addEventListener('mousedown', (e) => {
    if (e.target.closest('.sticky-btn')) return;
    isDraggingSticky = true;
    const rect = widget.getBoundingClientRect();
    stickyOffset.x = e.clientX - rect.left;
    stickyOffset.y = e.clientY - rect.top;
    document.body.style.userSelect = 'none';
  });
  document.addEventListener('mousemove', (e) => {
    if (!isDraggingSticky) return;
    const x = e.clientX - stickyOffset.x;
    const y = e.clientY - stickyOffset.y;
    widget.style.left = x + 'px';
    widget.style.top = y + 'px';
    widget.style.right = 'auto';
  });
  document.addEventListener('mouseup', () => {
    isDraggingSticky = false;
    document.body.style.userSelect = '';
  });
}

// --- Resizing ---
document.getElementById('resizeNotesBtn').addEventListener('mousedown', function(e) {
  resizing = true;
  const widget = document.getElementById('stickyNotesWidget');
  widget.classList.add('resizing');
  let startX = e.clientX;
  let startY = e.clientY;
  let startWidth = widget.offsetWidth;
  let startHeight = widget.offsetHeight;
  function onMove(ev) {
    widget.style.width = Math.max(260, startWidth + (ev.clientX - startX)) + 'px';
    widget.style.height = Math.max(120, startHeight + (ev.clientY - startY)) + 'px';
  }
  function onUp() {
    resizing = false;
    widget.classList.remove('resizing');
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  }
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
});

// --- Notes CRUD ---
function fetchNotes() {
  fetch('/api/notes')
    .then(res => res.json())
    .then(data => {
      notes = data;
      renderNotes();
    });
}
function renderNotes() {
  const notesList = document.getElementById('notesList');
  notesList.innerHTML = '';
  let filtered = notes.filter(note =>
    note.title.toLowerCase().includes(searchQuery) || note.content.toLowerCase().includes(searchQuery)
  );
  if (!filtered.length) {
    notesList.innerHTML = '<div style="color:#aaa;text-align:center;">No notes found.</div>';
    return;
  }
  // Pinned notes first
  filtered.sort((a, b) => (b.pinned || 0) - (a.pinned || 0));
  filtered.forEach(note => {
    const div = document.createElement('div');
    div.className = 'sticky-note-item';
    div.style.background = note.color || '#2c313a';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:4px;">
        <button class="sticky-note-pin${note.pinned ? ' pinned' : ''}" title="Pin" onclick="togglePin(${note.id})"><i class="bi bi-pin-angle-fill"></i></button>
        <button class="sticky-note-collapse${note.collapsed ? ' collapsed' : ''}" title="Collapse" onclick="toggleCollapse(${note.id})"><i class="bi bi-chevron-${note.collapsed ? 'down' : 'up'}"></i></button>
        <button class="sticky-note-color" title="Color" onclick="showColorPicker(this, ${note.id})"><i class="bi bi-palette"></i></button>
        <button class="sticky-note-delete" title="Delete" onclick="deleteNote(${note.id})"><i class="bi bi-trash"></i></button>
        <span style="flex:1;"></span>
        <span id="autosave-${note.id}" style="font-size:0.9em;color:#8f8;opacity:0;transition:opacity 0.3s;">Saved</span>
      </div>
      <input class="sticky-note-title" value="${escapeHtml(note.title) || ''}" placeholder="Title..." onchange="updateNote(${note.id}, 'title', this.value)">
      <div class="sticky-color-picker" id="colorPicker-${note.id}" style="display:none;"></div>
      <div class="sticky-note-body" style="display:${note.collapsed ? 'none' : 'block'};">
        <textarea class="sticky-note-content" placeholder="Write a note..." onchange="updateNote(${note.id}, 'content', this.value)">${escapeHtml(note.content)}</textarea>
      </div>
    `;
    notesList.appendChild(div);
  });
}
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"]|'/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
  });
}
function addNote() {
  fetch('/api/notes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: 'New Note', content: '', color: '#2c313a', pinned: false, collapsed: false })
  })
    .then(res => res.json())
    .then(note => {
      notes.push(note);
      renderNotes();
      showToast('Note created');
    });
}
function updateNote(id, field, value) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  note[field] = value;
  fetch(`/api/notes/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(note)
  }).then(() => {
    showAutoSave(id);
  });
}
function deleteNote(id) {
  if (!confirm('Delete this note?')) return;
  fetch(`/api/notes/${id}`, { method: 'DELETE' })
    .then(() => {
      notes = notes.filter(n => n.id !== id);
      renderNotes();
      showToast('Note deleted');
    });
}
function togglePin(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  note.pinned = !note.pinned;
  updateNote(id, 'pinned', note.pinned);
  renderNotes();
}
function toggleCollapse(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  note.collapsed = !note.collapsed;
  updateNote(id, 'collapsed', note.collapsed);
  renderNotes();
}
function showColorPicker(btn, id) {
  const picker = document.getElementById(`colorPicker-${id}`);
  if (!picker) return;
  picker.innerHTML = '';
  const colors = ['#2c313a','#ffd700','#ff6b6b','#6bcfff','#b2f296','#f8bbd0','#e1bee7','#d1c4e9','#c5cae9','#bbdefb','#b3e5fc','#b2ebf2','#b2dfdb','#c8e6c9','#dcedc8'];
  colors.forEach(color => {
    const dot = document.createElement('div');
    dot.className = 'sticky-color-dot' + (notes.find(n => n.id === id).color === color ? ' selected' : '');
    dot.style.background = color;
    dot.onclick = () => {
      updateNote(id, 'color', color);
      picker.style.display = 'none';
      renderNotes();
    };
    picker.appendChild(dot);
  });
  picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
}
function showAutoSave(id) {
  const el = document.getElementById(`autosave-${id}`);
  if (!el) return;
  el.style.opacity = 1;
  setTimeout(() => { el.style.opacity = 0; }, 1200);
}
function showToast(msg) {
  const toast = document.getElementById('stickyToast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1800);
}
function filterNotes() {
  searchQuery = document.getElementById('stickySearch').value.toLowerCase();
  renderNotes();
}
// --- Minimize ---
document.getElementById('minimizeNotesBtn').onclick = function() {
  const widget = document.getElementById('stickyNotesWidget');
  widget.classList.toggle('minimized');
  if (!widget.classList.contains('minimized')) {
    widget.style.height = '540px';
    widget.style.minHeight = '180px';
  }
};
// --- Add Note ---
document.getElementById('addNoteBtn').onclick = addNote;
// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
  fetchNotes();
  initStickyDrag();
});
</script>

<!-- <button class="test-toggle-btn" id="testToggleBtn">Toggle Sidebar</button> -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.querySelector('.sidebar-fixed');
    const collapseBtn = document.getElementById('sidebarCollapseBtn');
    const testToggleBtn = document.getElementById('testToggleBtn');

    // Function to ensure sidebar is always positioned correctly
    function ensureSidebarPosition() {
        if (sidebar) {
            sidebar.style.position = 'fixed';
            sidebar.style.top = '0';
            sidebar.style.left = '0';
            sidebar.style.zIndex = '9999999';
            sidebar.style.margin = '0';
            sidebar.style.padding = '0';
        }
    }

    function toggleSidebar() {
        const wasCollapsed = sidebar.classList.contains('collapsed');
        sidebar.classList.toggle('collapsed');
        
        // Dispatch custom event with collapsed state
        document.dispatchEvent(new CustomEvent('sidebarCollapsed', {
            detail: {
                collapsed: !wasCollapsed
            }
        }));

        // Store the state in localStorage
        localStorage.setItem('sidebarCollapsed', !wasCollapsed);
    }

    // Initialize sidebar state from localStorage
    const savedState = localStorage.getItem('sidebarCollapsed');
    if (savedState === 'true') {
        sidebar.classList.add('collapsed');
        document.dispatchEvent(new CustomEvent('sidebarCollapsed', {
            detail: {
                collapsed: true
            }
        }));
    }

    // Ensure sidebar position on load and periodically
    ensureSidebarPosition();
    setInterval(ensureSidebarPosition, 1000);

    collapseBtn.addEventListener('click', toggleSidebar);
    if (testToggleBtn) {
        testToggleBtn.addEventListener('click', toggleSidebar);
    }
});
</script>

<style>
.submenu-container {
  position: absolute;
  left: 100%; /* Position to the right of the sidebar */
  top: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
  transform: translateX(-10px);
  transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
              opacity 0.2s ease-in-out,
              transform 0.2s ease-in-out;
  margin-left: 0 !important;
  margin-top: 0;
  width: auto;
  padding-left: 0 !important;
  padding-right: 0 !important;
  z-index: 9999998;
}

.nav-link:hover + .submenu-container,
.submenu-container:hover,
.submenu-container.open {
  max-height: 200px;
  opacity: 1;
  transform: translateX(0);
}

.submenu {
  list-style: none;
  padding-left: 0;
  margin: 0;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
  width: auto;
  background: #20242b;
  border-radius: 1rem;
  box-shadow: 0 4px 18px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.5rem 0.3rem;
  gap: 0.2rem;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  min-width: 3rem;
}

.submenu .nav-link {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: transparent;
  color: #b0b8c1;
  margin: 0.05rem 0;
  box-shadow: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 16px;
  position: relative;
  overflow: hidden;
}

.submenu .nav-link::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #0d6efd;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: -1;
}

.submenu .nav-link:hover {
  color: #fff;
  transform: scale(1.12);
}

.submenu .nav-link:hover::before {
  opacity: 1;
}

.submenu .nav-link.active {
  color: #fff;
  background: #0d6efd;
  box-shadow: 0 2px 8px 0 rgba(13,110,253,0.28);
}

.submenu .nav-link i {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
}

.submenu .nav-link:hover i,
.submenu .nav-link.active i {
  transform: scale(1.15);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const navLinks = document.querySelectorAll('.nav-link');
    const submenuLinks = document.querySelectorAll('.submenu .nav-link');
    const submenuContainers = document.querySelectorAll('.submenu-container');

    // Function to update active states
    function updateActiveStates() {
        // Normalize paths by removing trailing slash (except for root) so \
        // that links like "/unified" match currentPath "/unified/" after Flask redirect.
        const normalizePath = (p) => {
            if (!p) return '';
            return p.length > 1 && p.endsWith('/') ? p.slice(0, -1) : p;
        };
        const currentPath = normalizePath(window.location.pathname);
        
        // Update main nav links
        navLinks.forEach(link => {
            link.classList.remove('active');
            const linkPath = normalizePath(link.getAttribute('href'));
            if (linkPath === currentPath) {
                link.classList.add('active');
            }
        });

        // Update submenu links and containers
        submenuLinks.forEach(link => {
            link.classList.remove('active');
            const linkPathSub = normalizePath(link.getAttribute('href'));
            if (linkPathSub === currentPath) {
                link.classList.add('active');
                // Keep parent submenu open when a submenu item is active
                const submenuContainer = link.closest('.submenu-container');
                if (submenuContainer) {
                    submenuContainer.classList.add('open');
                }
            }
        });
    }

    // Handle submenu clicks
    submenuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const submenuContainer = this.closest('.submenu-container');
            if (submenuContainer) {
                // Add open class to keep submenu visible
                submenuContainer.classList.add('open');
            }
        });
    });

    // Handle main nav clicks
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Only handle clicks on main nav items (not submenu items)
            if (!this.closest('.submenu')) {
                navLinks.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });

    // Initial update
    updateActiveStates();

    // Update on navigation
    window.addEventListener('popstate', updateActiveStates);
});
</script>

<script>
// --- Universal Search toggle via sidebar icon ---
const searchToggle = document.getElementById('sidebarUniversalSearchToggle');
if (searchToggle) {
    const updateActiveVisual = (isActive) => {
        if (isActive) {
            searchToggle.classList.add('search-active');
        } else {
            searchToggle.classList.remove('search-active');
        }
    };

    searchToggle.addEventListener('click', function (e) {
        e.preventDefault();
        if (window.isUniversalSearchOpen && window.isUniversalSearchOpen()) {
            window.closeUniversalSearchBar();
            updateActiveVisual(false);
        } else {
            window.openUniversalSearchBar();
            updateActiveVisual(true);
        }
    });

    // Sync with other toggles (keyboard shortcut etc.)
    window.addEventListener('universalSearchToggled', function (evt) {
        updateActiveVisual(evt.detail === 'open');
    });
}
</script>

<style>
/* subtle glow when universal search is active */
.search-active {
  background-color: #0d6efd !important;
}
.search-active i {
  color: #ffffff !important;
}
</style>

<!-- Banner Search Functionality -->
<script>
(function() {
    'use strict';
    
    class BannerSearch {
        constructor() {
            this.searchInput = document.getElementById('bannerSearchInput');
            this.clearBtn = document.getElementById('bannerSearchClearBtn');
            this.loading = document.getElementById('bannerSearchLoading');
            this.results = document.getElementById('bannerSearchResults');
            this.resultsContent = document.getElementById('bannerResultsContent');
            this.suggestions = document.getElementById('bannerSearchSuggestions');
            this.suggestionsContent = document.getElementById('bannerSuggestionsContent');
            
            this.searchTimeout = null;
            this.suggestionsTimeout = null;
            this.isSearching = false;
            this.isGettingSuggestions = false;
            this.selectedSuggestionIndex = -1;
            this.currentSuggestions = [];
            this.currentQuery = '';
            
            // Caching for suggestions
            this.suggestionCache = new Map();
            this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
            
            this.init();
        }
        
        init() {
            if (!this.searchInput) return;
            
            // Input event handling
            this.searchInput.addEventListener('input', (e) => {
                this.handleInput(e.target.value);
            });
            
            // Clear button
            if (this.clearBtn) {
                this.clearBtn.addEventListener('click', () => {
                    this.clearSearch();
                });
            }
            
            // Keyboard navigation
            this.searchInput.addEventListener('keydown', (e) => {
                this.handleKeydown(e);
            });
            
            // Click outside to close results
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.banner-search-container')) {
                    this.hideAll();
                }
            });
            
            // Focus to show suggestions if there's a query
            this.searchInput.addEventListener('focus', () => {
                if (this.searchInput.value.trim()) {
                    this.showSuggestions();
                }
            });
            
            // Blur to hide suggestions after a delay
            this.searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!this.suggestions?.matches(':hover')) {
                        this.hideSuggestions();
                    }
                }, 150);
            });
        }
        
        handleInput(value) {
            const query = value.trim();
            this.currentQuery = query;
            
            // Show/hide clear button
            if (this.clearBtn) {
                this.clearBtn.style.display = query ? 'flex' : 'none';
            }
            
            // Clear previous timeouts
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }
            if (this.suggestionsTimeout) {
                clearTimeout(this.suggestionsTimeout);
            }
            
            if (!query) {
                this.hideAll();
                return;
            }
            
            // Get suggestions immediately for short queries
            if (query.length <= 3) {
                this.getSuggestions(query);
            } else {
                // Debounce suggestions for longer queries
                this.suggestionsTimeout = setTimeout(() => {
                    this.getSuggestions(query);
                }, 200);
                
                // Debounce search for longer queries
                this.searchTimeout = setTimeout(() => {
                    this.performSearch(query);
                }, 300);
            }
        }
        
        async getSuggestions(query) {
            if (this.isGettingSuggestions || !query.trim()) return;
            
            // Check cache first
            const cacheKey = `suggestions_${query.toLowerCase()}`;
            const cached = this.suggestionCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
                this.displaySuggestions(cached.data);
                return;
            }
            
            this.isGettingSuggestions = true;
            
            try {
                const response = await fetch(`/api/universal-search/suggestions?q=${encodeURIComponent(query)}&limit=10`);
                
                if (!response.ok) throw new Error('Suggestions failed');
                
                const data = await response.json();
                const suggestions = data.suggestions || [];
                
                // Cache the suggestions
                this.suggestionCache.set(cacheKey, {
                    data: suggestions,
                    timestamp: Date.now()
                });
                
                this.displaySuggestions(suggestions);
                
            } catch (error) {
                console.error('Suggestions error:', error);
                // Fallback to basic suggestions
                this.displayBasicSuggestions(query);
            } finally {
                this.isGettingSuggestions = false;
            }
        }
        
        displaySuggestions(suggestions) {
            if (!this.suggestionsContent) return;
            
            if (suggestions.length === 0) {
                this.displayBasicSuggestions(this.currentQuery);
                return;
            }
            
            // Group suggestions by type
            const grouped = this.groupSuggestions(suggestions);
            
            let html = '';
            
            // Recent searches
            if (grouped.recent && grouped.recent.length > 0) {
                html += '<div class="banner-suggestion-category-header">Recent Searches</div>';
                grouped.recent.forEach(suggestion => {
                    html += this.createSuggestionItem(suggestion, 'recent');
                });
            }
            
            // Quick actions
            if (grouped.actions && grouped.actions.length > 0) {
                html += '<div class="banner-suggestion-category-header">Quick Actions</div>';
                grouped.actions.forEach(suggestion => {
                    html += this.createSuggestionItem(suggestion, 'action');
                });
            }
            
            // Content suggestions
            if (grouped.content && grouped.content.length > 0) {
                html += '<div class="banner-suggestion-category-header">Content</div>';
                grouped.content.forEach(suggestion => {
                    html += this.createSuggestionItem(suggestion, 'content');
                });
            }
            
            this.suggestionsContent.innerHTML = html;
            this.showSuggestions();
        }
        
        displayBasicSuggestions(query) {
            if (!this.suggestionsContent) return;
            
            const basicSuggestions = [
                { text: `Search for "${query}"`, type: 'search', icon: 'bi-search' },
                { text: `Find users like "${query}"`, type: 'user', icon: 'bi-person-fill' },
                { text: `Find offices like "${query}"`, type: 'office', icon: 'bi-building-fill' },
                { text: `Find workstations like "${query}"`, type: 'workstation', icon: 'bi-laptop-fill' }
            ];
            
            let html = '<div class="banner-suggestion-category-header">Suggestions</div>';
            basicSuggestions.forEach(suggestion => {
                html += this.createSuggestionItem(suggestion, 'basic');
            });
            
            this.suggestionsContent.innerHTML = html;
            this.showSuggestions();
        }
        
        createSuggestionItem(suggestion, category) {
            const icon = suggestion.icon || this.getIconForType(suggestion.type || 'default');
            const text = this.escapeHtml(suggestion.text || suggestion);
            const categoryText = this.escapeHtml(category);
            
            return `
                <div class="banner-search-suggestion-item" onclick="window.bannerSearch.handleSuggestionClick('${text}')">
                    <div class="banner-search-suggestion-icon">
                        <i class="bi ${icon}"></i>
                    </div>
                    <div class="banner-search-suggestion-text">${text}</div>
                    <div class="banner-search-suggestion-category">${categoryText}</div>
                </div>
            `;
        }
        
        groupSuggestions(suggestions) {
            const grouped = {
                recent: [],
                actions: [],
                content: []
            };
            
            suggestions.forEach(suggestion => {
                if (typeof suggestion === 'string') {
                    grouped.content.push({ text: suggestion, type: 'content' });
                } else if (suggestion.type === 'recent') {
                    grouped.recent.push(suggestion);
                } else if (suggestion.type === 'action') {
                    grouped.actions.push(suggestion);
                } else {
                    grouped.content.push(suggestion);
                }
            });
            
            return grouped;
        }
        
        handleSuggestionClick(suggestionText) {
            this.searchInput.value = suggestionText;
            this.searchInput.focus();
            this.performSearch(suggestionText);
        }
        
        async performSearch(query) {
            if (this.isSearching) return;
            
            this.isSearching = true;
            this.showLoading(true);
            this.hideSuggestions();
            
            try {
                const response = await fetch(`/api/universal-search/?q=${encodeURIComponent(query)}&limit=8`);
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                this.displayResults(data.results || []);
                
            } catch (error) {
                console.error('Search error:', error);
                this.displayError('Search failed. Please try again.');
            } finally {
                this.isSearching = false;
                this.showLoading(false);
            }
        }
        
        displayResults(results) {
            if (!this.resultsContent) return;
            
            if (results.length === 0) {
                this.resultsContent.innerHTML = `
                    <div class="banner-search-no-results">
                        No results found for "${this.searchInput.value}"
                    </div>
                `;
            } else {
                this.resultsContent.innerHTML = results.map(result => `
                    <div class="banner-search-result-item" onclick="window.location.href='${result.url || '#'}'">
                        <div class="banner-search-result-icon">
                            <i class="bi ${this.getIconForType(result.content_type)}"></i>
                        </div>
                        <div class="banner-search-result-content">
                            <div class="banner-search-result-title">${this.escapeHtml(result.title)}</div>
                            <div class="banner-search-result-subtitle">${this.escapeHtml(result.description || result.content_type)}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            this.showResults();
        }
        
        displayError(message) {
            if (!this.resultsContent) return;
            
            this.resultsContent.innerHTML = `
                <div class="banner-search-no-results">
                    ${this.escapeHtml(message)}
                </div>
            `;
            this.showResults();
        }
        
        getIconForType(type) {
            const iconMap = {
                'user': 'bi-person-fill',
                'office': 'bi-building-fill',
                'workstation': 'bi-laptop-fill',
                'outage': 'bi-exclamation-triangle-fill',
                'kb_article': 'bi-book-fill',
                'document': 'bi-file-text-fill',
                'note': 'bi-journal-text',
                'activity': 'bi-activity',
                'recent': 'bi-clock-history',
                'action': 'bi-lightning-fill',
                'search': 'bi-search',
                'default': 'bi-search'
            };
            return iconMap[type] || iconMap.default;
        }
        
        showResults() {
            if (this.results) {
                this.results.classList.add('show');
            }
            if (this.suggestions) {
                this.suggestions.classList.remove('show');
            }
        }
        
        showSuggestions() {
            if (this.suggestions) {
                this.suggestions.classList.add('show');
            }
            if (this.results) {
                this.results.classList.remove('show');
            }
        }
        
        hideResults() {
            if (this.results) {
                this.results.classList.remove('show');
            }
        }
        
        hideSuggestions() {
            if (this.suggestions) {
                this.suggestions.classList.remove('show');
            }
        }
        
        hideAll() {
            this.hideResults();
            this.hideSuggestions();
        }
        
        showLoading(show) {
            if (this.loading) {
                this.loading.style.display = show ? 'block' : 'none';
            }
        }
        
        clearSearch() {
            this.searchInput.value = '';
            this.hideAll();
            if (this.clearBtn) {
                this.clearBtn.style.display = 'none';
            }
            this.searchInput.focus();
        }
        
        handleKeydown(e) {
            if (e.key === 'Escape') {
                this.hideAll();
                this.searchInput.blur();
            } else if (e.key === 'Enter') {
                if (this.suggestions?.classList.contains('show')) {
                    const selectedItem = this.suggestionsContent?.querySelector('.banner-search-suggestion-item.selected');
                    if (selectedItem) {
                        selectedItem.click();
                    } else {
                        const firstItem = this.suggestionsContent?.querySelector('.banner-search-suggestion-item');
                        if (firstItem) {
                            firstItem.click();
                        }
                    }
                } else if (this.results?.classList.contains('show')) {
                    const firstResult = this.resultsContent?.querySelector('.banner-search-result-item');
                    if (firstResult) {
                        firstResult.click();
                    }
                } else {
                    this.performSearch(this.searchInput.value);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                this.navigateSuggestions(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                this.navigateSuggestions(-1);
            }
        }
        
        navigateSuggestions(direction) {
            const items = this.suggestionsContent?.querySelectorAll('.banner-search-suggestion-item');
            if (!items || items.length === 0) return;
            
            // Remove current selection
            items.forEach(item => item.classList.remove('selected'));
            
            // Update index
            this.selectedSuggestionIndex += direction;
            
            // Wrap around
            if (this.selectedSuggestionIndex >= items.length) {
                this.selectedSuggestionIndex = 0;
            } else if (this.selectedSuggestionIndex < 0) {
                this.selectedSuggestionIndex = items.length - 1;
            }
            
            // Add selection
            if (items[this.selectedSuggestionIndex]) {
                items[this.selectedSuggestionIndex].classList.add('selected');
                items[this.selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }
    
    // Initialize banner search when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const bannerSearch = new BannerSearch();
        
        // Add global keyboard shortcut handler for banner search
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                const bannerSearchInput = document.getElementById('bannerSearchInput');
                if (bannerSearchInput && !bannerSearchInput.matches(':focus')) {
                    e.preventDefault();
                    bannerSearchInput.focus();
                    bannerSearchInput.select();
                }
            }
        });
        
        // Expose banner search instance globally for debugging
        window.bannerSearch = bannerSearch;
    });
})();
</script>
</body>
</html>