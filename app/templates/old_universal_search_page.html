{% extends "base.html" %}

{% block title %}Universal Search - {{ query }}{% endblock %}

{% block head %}
{{ super() }}
<!-- Quill Rich Text Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
.universal-search-page {
    width: 100%;
    min-height: 100vh;
    background: linear-gradient(90deg, #23272f 0%, #2b2b2d 100%);
    padding: 0;
    margin: 0;
    overflow-x: hidden;
}

.us-container {
    max-width: 100%;
    margin: 0;
    padding: 0 1rem 2rem 4.5rem; /* Adjusted padding for better mobile */
    min-height: 100vh;
    box-sizing: border-box;
}

.us-header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 2.5rem 0 1.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    background: none;
}

.us-title {
    font-size: 2.2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.2rem;
    letter-spacing: -0.5px;
}

.us-stats {
    color: #b0b8c1;
    font-size: 1.05rem;
    margin-bottom: 0.5rem;
}

.us-filters-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0 2rem 0;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    flex-wrap: wrap;
    gap: 1rem;
}

.us-filter-summary {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    flex: 1;
    min-width: 0;
}

.us-filter-label {
    color: #7ecbff;
    font-size: 1rem;
    font-weight: 500;
    white-space: nowrap;
}

#active-filters-display {
    color: #e0e0e0;
    font-size: 0.95rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.us-filter-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.13);
    border-radius: 18px;
    color: #e0e0e0;
    font-size: 0.95rem;
    padding: 0.5rem 1.2rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.us-filter-button:hover {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
}

.filter-count {
    background: #0a84ff;
    color: #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.25rem;
}

.search-results-container {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
}

.result-group {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.04);
    border-radius: 20px;
    padding: 2rem;
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.result-group:hover {
    border-color: rgba(255, 255, 255, 0.08);
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
}

.result-group-header {
    display: flex;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

.result-group-icon {
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
    color: #3b82f6;
    font-size: 1.6rem;
    position: relative;
    overflow: hidden;
}

.result-group-icon::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border-radius: 16px;
}

.result-group-title {
    color: #fff;
    font-weight: 700;
    font-size: 1.4rem;
    margin-right: auto;
    letter-spacing: -0.01em;
}

.result-group-count {
    color: #94a3b8;
    font-size: 0.9rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.04);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.result-item {
    display: flex;
    align-items: flex-start;
    padding: 1.5rem;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.02);
    position: relative;
    background: rgba(255, 255, 255, 0.01);
    overflow: hidden;
}

.result-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.02), rgba(139, 92, 246, 0.02));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.result-item:hover {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(59, 130, 246, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}

.result-item:hover::before {
    opacity: 1;
}

.result-item:active {
    transform: translateY(0);
}

.result-item:last-child {
    margin-bottom: 0;
}

.result-content {
    flex: 1;
    min-width: 0;
    position: relative;
    z-index: 1;
}

.result-title {
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
    letter-spacing: -0.01em;
}

.result-title mark {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: #fff;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.result-click-indicator {
    opacity: 0;
    margin-left: 0.75rem;
    font-size: 0.9rem;
    color: #94a3b8;
    transition: all 0.3s ease;
}

.result-item:hover .result-click-indicator {
    opacity: 1;
    color: #3b82f6;
    transform: translateX(2px);
}

.result-description {
    color: #cbd5e1;
    font-size: 0.95rem;
    line-height: 1.7;
    margin-bottom: 1rem;
    font-weight: 400;
}

.result-description mark {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: #fff;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
}

.result-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: #94a3b8;
    flex-wrap: wrap;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.03);
}

.result-meta-item {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.02);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.04);
    transition: all 0.2s ease;
}

.result-meta-item:hover {
    background: rgba(255, 255, 255, 0.04);
    border-color: rgba(255, 255, 255, 0.08);
}

.result-meta-item i {
    margin-right: 0.4rem;
    font-size: 0.9rem;
    color: #64748b;
}

.result-url {
    color: #64748b;
    font-size: 0.8rem;
    margin-top: 0.75rem;
    display: inline-block;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    background: rgba(255, 255, 255, 0.02);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.04);
}

.no-results {
    text-align: center;
    padding: 5rem 2rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.04);
    border-radius: 24px;
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    max-width: 600px;
    margin: 0 auto;
}

.no-results i {
    font-size: 4.5rem;
    background: linear-gradient(135deg, #64748b, #94a3b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 2rem;
    opacity: 0.7;
}

.no-results h3 {
    color: #fff;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
}

.no-results p {
    color: #cbd5e1;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.no-results-suggestions {
    color: #94a3b8 !important;
    font-size: 0.95rem;
    font-weight: 500;
}

.loading-container {
    text-align: center;
    padding: 5rem 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.loading-spinner {
    width: 3.5rem;
    height: 3.5rem;
    border: 3px solid rgba(255, 255, 255, 0.05);
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    position: relative;
}

.loading-spinner::after {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 3px solid transparent;
    border-top: 3px solid rgba(59, 130, 246, 0.3);
    border-radius: 50%;
    animation: spin 1.5s linear infinite reverse;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #94a3b8;
    font-size: 1.1rem;
    font-weight: 500;
    letter-spacing: 0.02em;
}

.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.pagination-btn {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.pagination-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.didy-mean-container {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}
.didy-mean-container h4 {
    color: #fff;
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.didy-mean-container h4::before {
    content: '';
    width: 3px;
    height: 20px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    border-radius: 2px;
}

.didy-mean-container ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
}

.suggestion-group {
    width: 100%;
    margin-bottom: 1.5rem;
}

.suggestion-group h5 {
    color: #7ecbff;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
}
.didy-mean-container li {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 0.75rem 1.25rem;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
    color: #e2e8f0;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.didy-mean-container li::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
    transition: left 0.5s;
}

.didy-mean-container li:hover::before {
    left: 100%;
}

.didy-mean-container li:hover {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.didy-mean-container .pattern-suggestion {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)) !important;
    border: 1px solid rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    font-weight: 600;
}

.didy-mean-container .pattern-suggestion:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)) !important;
    border-color: rgba(59, 130, 246, 0.3);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
}

.didy-mean-container .suggestion-item i {
    margin-right: 0.3rem;
    margin-left: 0.1rem;
    font-size: 1.1rem;
    opacity: 0.8;
    align-self: flex-start;
}

mark, .filter-option.active, .result-group-icon {
    background: #0a84ff;
    border-color: #0a84ff;
    color: #fff;
}

@media (max-width: 768px) {
    .us-container {
        padding: 0 0.75rem 2rem 4rem;
    }
    
    .us-header {
        padding: 1.5rem 0 1rem 0;
    }
    
    .us-title {
        font-size: 1.8rem;
        word-wrap: break-word;
    }
    
    .us-filters-bar {
        padding: 0.75rem 1rem;
        margin: 1rem 0 1.5rem 0;
        gap: 0.75rem;
        flex-direction: column;
        align-items: stretch;
    }
    
    .us-filter-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .us-filter-button {
        align-self: flex-start;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .result-group {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .result-group-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .result-group-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
        margin-right: 0.75rem;
    }
    
    .result-group-title {
        font-size: 1.1rem;
        flex: 1;
        min-width: 0;
    }
    
    .result-item {
        padding: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .result-title {
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .result-description {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .result-meta {
        gap: 0.5rem;
        font-size: 0.75rem;
        flex-wrap: wrap;
    }
    
    .result-meta-item {
        padding: 0.15rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .result-url {
        font-size: 0.7rem;
        word-break: break-all;
    }
    
    .didy-mean-container li {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }
    
    .filter-modal {
        width: 95vw;
        max-height: 90vh;
    }
    
    .filter-modal-content {
        padding: 1.5rem;
    }
    
    .filter-options-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .us-container {
        padding: 0 0.5rem 1.5rem 3.5rem;
    }
    
    .us-title {
        font-size: 1.5rem;
        line-height: 1.3;
    }
    
    .us-stats {
        font-size: 0.9rem;
    }
    
    .us-filters-bar {
        padding: 0.5rem 0.75rem;
        margin: 0.75rem 0 1rem 0;
    }
    
    .us-filter-summary {
        gap: 0.25rem;
    }
    
    .us-filter-label {
        font-size: 0.9rem;
    }
    
    #active-filters-display {
        font-size: 0.85rem;
    }
    
    .us-filter-button {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
    
    .result-group {
        padding: 0.75rem;
        border-radius: 16px;
    }
    
    .result-item {
        padding: 0.75rem;
        border-radius: 12px;
    }
    
    .result-title {
        font-size: 0.9rem;
    }
    
    .result-description {
        font-size: 0.85rem;
    }
    
    .result-meta {
        gap: 0.25rem;
    }
    
    .result-meta-item {
        padding: 0.1rem 0.4rem;
        font-size: 0.7rem;
    }
    
    .filter-modal {
        width: 98vw;
        max-height: 95vh;
    }
    
    .filter-modal-header {
        padding: 1rem 1.5rem 0.75rem 1.5rem;
    }
    
    .filter-modal-content {
        padding: 1rem;
    }
    
    .filter-section {
        margin-bottom: 1.5rem;
    }
    
    .filter-section-title {
        font-size: 1rem;
    }
    
    .filter-option {
        padding: 0.6rem 0.8rem;
        font-size: 0.85rem;
    }
}

.universal-search-page .container {
    background: linear-gradient(180deg,#fafafa 0%,#f0f0f3 100%);
    border-radius: 14px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    backdrop-filter: saturate(180%) blur(24px);
    -webkit-backdrop-filter: saturate(180%) blur(24px);
    padding: 2rem 3rem;
}

[data-bs-theme="dark"] .universal-search-page .container {
    background: #2b2b2d;
}

/* PDF Modal Styles (matching existing KB modal) */
.pdf-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(24, 26, 26, 0.55);
    z-index: 3000;
    backdrop-filter: blur(8px);
    transition: opacity 0.25s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    pointer-events: none;
}

.pdf-modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.pdf-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    background: #23272f;
    z-index: 3100;
    box-shadow: 0 8px 48px rgba(0,0,0,0.4);
    border-radius: 1.5rem;
    width: min(95vw, 900px);
    height: min(90vh, 750px);
    min-width: 320px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s cubic-bezier(.4,0,.2,1), transform 0.25s cubic-bezier(.4,0,.2,1);
}

.pdf-modal.active {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}

.pdf-modal-header {
    position: sticky;
    top: 0;
    background: #23272f;
    padding: 1.2rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
    z-index: 10;
    border-radius: 1.5rem 1.5rem 0 0;
}

.pdf-modal-title {
    color: #7ecbff;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}

.pdf-modal-content {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 0;
    background: #181a1a;
    border-radius: 0 0 1.5rem 1.5rem;
}

/* Note Modal Styles */
.note-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(24, 26, 26, 0.55);
    z-index: 3000;
    backdrop-filter: blur(8px);
    transition: opacity 0.25s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    pointer-events: none;
}

.note-modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.note-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    background: #23272f;
    z-index: 3100;
    box-shadow: 0 8px 48px rgba(0,0,0,0.4);
    border-radius: 1.5rem;
    width: min(90vw, 700px);
    max-height: min(85vh, 600px);
    min-width: 320px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s cubic-bezier(.4,0,.2,1), transform 0.25s cubic-bezier(.4,0,.2,1);
}

.note-modal.active {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}

.note-modal-header {
    position: sticky;
    top: 0;
    background: #23272f;
    padding: 1.2rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
    z-index: 10;
    border-radius: 1.5rem 1.5rem 0 0;
}

.note-modal-title {
    color: #f8f9fa;
    font-size: 1.2rem;
    font-weight: 500;
    margin: 0;
    flex: 1;
}

.note-modal-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.note-modal-content {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 2rem;
    background: #181a1a;
    border-radius: 0 0 1.5rem 1.5rem;
}

/* Note Content Styles */
.note-view-only, .note-editable-view {
    color: #e0e0e0;
}

.note-content-display {
    margin-bottom: 2rem;
}

.note-text-content {
    line-height: 1.6;
    font-size: 1rem;
    white-space: pre-wrap;
    color: #e0e0e0;
    background: rgba(255, 255, 255, 0.02);
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.note-meta-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.note-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.note-tag {
    background: rgba(126, 203, 255, 0.1);
    color: #7ecbff;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid rgba(126, 203, 255, 0.2);
}

.note-privacy {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.note-dates {
    color: rgba(255, 255, 255, 0.5);
}

/* Note editing styles */
.note-edit-mode {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.note-title-edit {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 0.75rem;
    color: #fff;
    font-size: 1.1rem;
    font-weight: 500;
    outline: none;
    transition: all 0.2s ease;
}

.note-title-edit:focus {
    border-color: #007bff;
    background: rgba(255, 255, 255, 0.15);
}

.note-editor-container {
    min-height: 300px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    overflow: hidden;
}

.note-edit-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.note-edit-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    border: 1px solid;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.note-edit-btn.primary {
    background: #007bff;
    border-color: #007bff;
    color: #fff;
}

.note-edit-btn.primary:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.note-edit-btn.secondary {
    background: transparent;
    border-color: rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.8);
}

.note-edit-btn.secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
    color: #fff;
}

/* Quill editor dark theme overrides for modal */
.note-modal .ql-toolbar {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.note-modal .ql-container {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-top: none !important;
    border-radius: 0 0 0.5rem 0.5rem !important;
    color: #fff !important;
}

.note-modal .ql-editor {
    color: #fff !important;
    min-height: 200px !important;
}

.note-modal .ql-toolbar .ql-stroke {
    stroke: #fff !important;
}

.note-modal .ql-toolbar .ql-fill {
    fill: #fff !important;
}

.note-modal .ql-toolbar .ql-picker {
    color: #fff !important;
}

.note-modal .ql-editor.ql-blank::before {
    color: rgba(255, 255, 255, 0.5) !important;
}

/* Filter Modal Styles */
.filter-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(24, 26, 26, 0.55);
    z-index: 3000;
    backdrop-filter: blur(8px);
    transition: opacity 0.25s cubic-bezier(.4,0,.2,1);
    opacity: 0;
    pointer-events: none;
}

.filter-modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.filter-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    background: #23272f;
    z-index: 3100;
    box-shadow: 0 8px 48px rgba(0,0,0,0.4);
    border-radius: 1.5rem;
    width: min(90vw, 600px);
    max-height: min(85vh, 700px);
    min-width: 320px;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: all 0.25s cubic-bezier(.4,0,.2,1);
}

.filter-modal.active {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}

.filter-modal-header {
    position: sticky;
    top: 0;
    background: #23272f;
    padding: 1.5rem 2rem 1rem 2rem;
    border-bottom: 1px solid #333;
    z-index: 10;
    border-radius: 1.5rem 1.5rem 0 0;
}

.filter-modal-title {
    color: #7ecbff;
    font-size: 1.3rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

.filter-modal-subtitle {
    color: #94a3b8;
    font-size: 0.9rem;
    margin: 0;
}

.filter-modal-content {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 2rem;
    background: #181a1a;
    border-radius: 0 0 1.5rem 1.5rem;
}

.filter-section {
    margin-bottom: 2rem;
}

.filter-section-title {
    color: #fff;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.filter-option {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    color: #e0e0e0;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-option:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.2);
}

.filter-option.active {
    background: #0a84ff;
    color: #fff;
    border-color: #0a84ff;
}

.filter-option i {
    font-size: 1rem;
    opacity: 0.8;
}

.filter-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: 2rem;
}

.filter-modal-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: 1px solid;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.filter-modal-btn.primary {
    background: #007bff;
    border-color: #007bff;
    color: #fff;
}

.filter-modal-btn.primary:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.filter-modal-btn.secondary {
    background: transparent;
    border-color: rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.8);
}

.filter-modal-btn.secondary:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
    color: #fff;
}

/* Close modal functionality */
.pdf-modal-overlay:not(.active),
.note-modal-overlay:not(.active),
.filter-modal-overlay:not(.active) {
    display: none;
}

.pdf-modal:not(.active),
.note-modal:not(.active),
.filter-modal:not(.active) {
    display: none;
}


</style>
{% endblock %}

{% block content %}
<div class="universal-search-page">
    <div class="us-container">
        <!-- Header -->
        <div class="us-header">
            <div class="us-title">Search results for "<span id="search-query">{{ query }}</span>"</div>
            <div class="us-stats">
                <span id="total-results">0</span> results found <span id="search-time" style="margin-left: 1rem;"></span>
            </div>
        </div>
        <!-- Filters Bar -->
        <div class="us-filters-bar">
            <div class="us-filter-summary">
                <span class="us-filter-label">Filters:</span>
                <span id="active-filters-display">All content types</span>
            </div>
            <button class="us-filter-button" id="open-filter-modal">
                <i class="bi bi-funnel"></i>
                <span>Filter Results</span>
                <span class="filter-count" id="filter-count" style="display: none;">0</span>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading-container" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Searching across all content...</div>
        </div>

        <!-- No Results -->
        <div id="no-results" class="no-results" style="display: none;">
            <i class="bi bi-emoji-frown"></i>
            <h3>No results found</h3>
            <p>We couldn't find any content matching "<span id="no-results-query"></span>"</p>
            <p class="no-results-suggestions">Try different keywords, check your spelling, or browse our content sections</p>
            <div id="no-results-did-you-mean" class="didy-mean-container" style="display:none;">
                <h4>Did you mean...</h4>
                <ul id="suggestions-list"></ul>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="search-results-container">
            <!-- Dynamically populated -->
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="pagination-container" style="display: none;">
            <button id="prev-page" class="pagination-btn">Previous</button>
            <div class="pagination-info">
                Page <span id="current-page">1</span> of <span id="total-pages">1</span>
            </div>
            <button id="next-page" class="pagination-btn">Next</button>
        </div>
    </div>
</div>

<!-- PDF Modal -->
<div class="pdf-modal" id="universalSearchPdfModal">
    <div class="pdf-modal-header">
        <h3 class="pdf-modal-title" id="universalSearchPdfModalTitle">Document</h3>
        <button
            type="button"
            class="btn-close btn-close-white"
            aria-label="Close"
            onclick="
                document.getElementById('universalSearchPdfModal').classList.remove('active');
                document.getElementById('universalSearchPdfModalOverlay').classList.remove('active');
            "
        ></button>
    </div>
    
    <div class="pdf-modal-content" id="universalSearchPdfModalContent">
        <!-- PDF content will be loaded here -->
    </div>
</div>
<div class="pdf-modal-overlay" id="universalSearchPdfModalOverlay"></div>

<!-- Note Modal -->
<div class="note-modal" id="universalSearchNoteModal">
    <div class="note-modal-header">
        <h3 class="note-modal-title" id="universalSearchNoteModalTitle">Note</h3>
        <div class="note-modal-actions">
            <button
                type="button"
                class="btn btn-sm btn-primary"
                id="universalSearchNoteEditBtn"
                style="display: none;"
            >
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button
                type="button"
                class="btn-close btn-close-white"
                aria-label="Close"
                onclick="
                    document.getElementById('universalSearchNoteModal').classList.remove('active');
                    document.getElementById('universalSearchNoteModalOverlay').classList.remove('active');
                "
            ></button>
        </div>
    </div>
    
    <div class="note-modal-content" id="universalSearchNoteModalContent">
        <!-- Note content will be loaded here -->
    </div>
</div>
<div class="note-modal-overlay" id="universalSearchNoteModalOverlay"></div>

<!-- Filter Modal -->
<div class="filter-modal" id="universalSearchFilterModal">
    <div class="filter-modal-header">
        <h3 class="filter-modal-title">Filter Search Results</h3>
        <p class="filter-modal-subtitle">Refine your search by content type and section</p>
        <button
            type="button"
            class="btn-close btn-close-white"
            aria-label="Close"
            onclick="
                document.getElementById('universalSearchFilterModal').classList.remove('active');
                document.getElementById('universalSearchFilterModalOverlay').classList.remove('active');
            "
        ></button>
    </div>
    
    <div class="filter-modal-content">
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="bi bi-collection"></i>
                Content Types
            </div>
            <div class="filter-options-grid" id="modal-content-type-filters">
                <!-- Dynamically populated -->
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="bi bi-diagram-3"></i>
                Sections
            </div>
            <div class="filter-options-grid" id="modal-section-filters">
                <!-- Dynamically populated -->
            </div>
        </div>
        
        <div class="filter-modal-actions">
            <button class="filter-modal-btn secondary" onclick="
                document.getElementById('universalSearchFilterModal').classList.remove('active');
                document.getElementById('universalSearchFilterModalOverlay').classList.remove('active');
            ">
                Cancel
            </button>
            <button class="filter-modal-btn primary" id="apply-filters">
                Apply Filters
            </button>
        </div>
    </div>
</div>
<div class="filter-modal-overlay" id="universalSearchFilterModalOverlay"></div>

<script>
class UniversalSearchPage {
    constructor() {
        this.query = new URLSearchParams(window.location.search).get('q') || '';
        this.currentPage = 1;
        this.resultsPerPage = 10000; // Increased to show all results without pagination
        this.totalResults = 0;
        this.currentFilters = {
            contentTypes: [],
            sections: []
        };
        
        this.initializePage();
    }
    
    async initializePage() {
        if (!this.query) {
            this.showNoResults();
            return;
        }
        
        this.showLoading();
        await this.loadFilters();
        await this.performSearch();
    }
    
    async loadFilters() {
        try {
            const [contentTypesResponse, sectionsResponse] = await Promise.all([
                fetch('/api/universal-search/content-types'),
                fetch('/api/universal-search/sections')
            ]);
            
            const contentTypesData = await contentTypesResponse.json();
            const sectionsData = await sectionsResponse.json();
            
            this.contentTypes = contentTypesData.content_types;
            this.sections = sectionsData.sections;
            this.populateFilterModal();
        } catch (error) {
            console.error('Failed to load filters:', error);
        }
    }
    
    populateFilterModal() {
        const contentTypeFilters = document.getElementById('modal-content-type-filters');
        const sectionFilters = document.getElementById('modal-section-filters');
        
        // Populate content type filters
        contentTypeFilters.innerHTML = '';
        this.contentTypes.forEach(type => {
            const filter = document.createElement('div');
            filter.className = 'filter-option';
            filter.innerHTML = `<i class="${type.icon}"></i><span>${type.name}</span>`;
            filter.dataset.type = 'contentTypes';
            filter.dataset.value = type.id;
            filter.dataset.name = type.name;
            filter.addEventListener('click', () => this.toggleModalFilter(filter));
            contentTypeFilters.appendChild(filter);
        });
        
        // Populate section filters
        sectionFilters.innerHTML = '';
        this.sections.forEach(section => {
            const filter = document.createElement('div');
            filter.className = 'filter-option';
            filter.innerHTML = `<i class="${section.icon}"></i><span>${section.name}</span>`;
            filter.dataset.type = 'sections';
            filter.dataset.value = section.id;
            filter.dataset.name = section.name;
            filter.addEventListener('click', () => this.toggleModalFilter(filter));
            sectionFilters.appendChild(filter);
        });
        
        // Set up filter button click handler
        document.getElementById('open-filter-modal').addEventListener('click', () => {
            this.openFilterModal();
        });
        
        // Set up apply filters button
        document.getElementById('apply-filters').addEventListener('click', () => {
            this.applyFilters();
        });
    }
    
    toggleModalFilter(filterElement) {
        filterElement.classList.toggle('active');
    }
    
    openFilterModal() {
        const modal = document.getElementById('universalSearchFilterModal');
        const overlay = document.getElementById('universalSearchFilterModalOverlay');
        
        // Update modal filters to reflect current state
        this.updateModalFilterStates();
        
        modal.classList.add('active');
        overlay.classList.add('active');
    }
    
    updateModalFilterStates() {
        // Update content type filters
        document.querySelectorAll('#modal-content-type-filters .filter-option').forEach(filter => {
            const value = filter.dataset.value;
            if (this.currentFilters.contentTypes.includes(value)) {
                filter.classList.add('active');
            } else {
                filter.classList.remove('active');
            }
        });
        
        // Update section filters
        document.querySelectorAll('#modal-section-filters .filter-option').forEach(filter => {
            const value = filter.dataset.value;
            if (this.currentFilters.sections.includes(value)) {
                filter.classList.add('active');
            } else {
                filter.classList.remove('active');
            }
        });
    }
    
    applyFilters() {
        // Clear current filters
        this.currentFilters.contentTypes = [];
        this.currentFilters.sections = [];
        
        // Get active filters from modal
        document.querySelectorAll('#modal-content-type-filters .filter-option.active').forEach(filter => {
            this.currentFilters.contentTypes.push(filter.dataset.value);
        });
        
        document.querySelectorAll('#modal-section-filters .filter-option.active').forEach(filter => {
            this.currentFilters.sections.push(filter.dataset.value);
        });
        
        // Update filter display
        this.updateFilterDisplay();
        
        // Close modal
        document.getElementById('universalSearchFilterModal').classList.remove('active');
        document.getElementById('universalSearchFilterModalOverlay').classList.remove('active');
        
        // Reset to first page and perform new search
        this.currentPage = 1;
        this.performSearch();
    }
    
    updateFilterDisplay() {
        const display = document.getElementById('active-filters-display');
        const count = document.getElementById('filter-count');
        
        const totalFilters = this.currentFilters.contentTypes.length + this.currentFilters.sections.length;
        
        if (totalFilters === 0) {
            display.textContent = 'All content types';
            count.style.display = 'none';
        } else {
            const activeFilters = [];
            
            // Add content type names
            this.currentFilters.contentTypes.forEach(id => {
                const type = this.contentTypes.find(t => t.id === id);
                if (type) activeFilters.push(type.name);
            });
            
            // Add section names
            this.currentFilters.sections.forEach(id => {
                const section = this.sections.find(s => s.id === id);
                if (section) activeFilters.push(section.name);
            });
            
            display.textContent = activeFilters.slice(0, 2).join(', ') + (activeFilters.length > 2 ? ` +${activeFilters.length - 2} more` : '');
            count.textContent = totalFilters;
            count.style.display = 'flex';
        }
    }
    
    async performSearch() {
        this.showLoading();
        
        try {
            const startTime = Date.now();
            
            const params = new URLSearchParams({
                q: this.query,
                limit: 10000, // Increased to get all results
                page: this.currentPage
            });
            
            if (this.currentFilters.contentTypes.length > 0) {
                params.append('content_types', this.currentFilters.contentTypes.join(','));
            }
            
            if (this.currentFilters.sections.length > 0) {
                params.append('sections', this.currentFilters.sections.join(','));
            }
            
            const response = await fetch(`/api/universal-search?${params}`);
            const data = await response.json();
            
            const searchTime = Date.now() - startTime;
            
            if (data.results && data.results.length > 0) {
                this.displayResults(data, searchTime);
            } else {
                this.showNoResults();
            }
        } catch (error) {
            console.error('Search error:', error);
            this.showError();
        } finally {
            this.hideLoading();
        }
        
        // Update filter display
        this.updateFilterDisplay();
    }
    
    displayResults(data, searchTime) {
        this.totalResults = data.total;
        
        // Update search stats
        document.getElementById('total-results').textContent = this.totalResults;
        document.getElementById('search-time').textContent = `(${(searchTime / 1000).toFixed(2)}s)`;
        
        // Display results
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        // Group results by content type
        const grouped = data.grouped_results || {};
        
        Object.entries(grouped).forEach(([contentType, results]) => {
            const groupElement = this.createResultGroup(contentType, results);
            resultsContainer.appendChild(groupElement);
        });
        
        // Show pagination if needed
        this.updatePagination();
        
        // Hide no results
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('search-results').style.display = 'grid';
    }
    
    createResultGroup(contentType, results) {
        const group = document.createElement('div');
        group.className = 'result-group';
        
        const icon = this.getContentTypeIcon(contentType);
        const title = this.getContentTypeTitle(contentType);
        
        group.innerHTML = `
            <div class="result-group-header">
                <div class="result-group-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="result-group-title">${title}</div>
                <div class="result-group-count">${results.length}</div>
            </div>
            <div class="result-group-items">
            </div>
        `;
        
        // Append result items with proper event listeners
        const itemsContainer = group.querySelector('.result-group-items');
        results.forEach(result => {
            const resultItem = this.createResultItem(result);
            itemsContainer.appendChild(resultItem);
        });
        
        return group;
    }
    
    createResultItem(result) {
        const item = document.createElement('div');
        item.className = 'result-item';
        
        const meta = this.createResultMeta(result);
        
        item.innerHTML = `
            <div class="result-content">
                <div class="result-title">
                    ${result.highlighted_title || result.title}
                    <i class="bi bi-box-arrow-up-right result-click-indicator"></i>
                </div>
                <div class="result-description">${result.highlighted_content || result.description}</div>
                <div class="result-meta">${meta}</div>
                <span class="result-url">${result.url}</span>
            </div>
        `;
        
        item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.navigateToResult(result);
        });
        return item;
    }
    
    createResultMeta(result) {
        const meta = [];
        
        if (result.author) {
            meta.push(`<span class="result-meta-item"><i class="bi bi-person"></i>${result.author}</span>`);
        }
        
        if (result.created_at) {
            const date = new Date(result.created_at).toLocaleDateString();
            meta.push(`<span class="result-meta-item"><i class="bi bi-calendar"></i>${date}</span>`);
        }
        
        if (result.tags) {
            meta.push(`<span class="result-meta-item"><i class="bi bi-tags"></i>${result.tags}</span>`);
        }
        
        if (result.category) {
            meta.push(`<span class="result-meta-item"><i class="bi bi-folder"></i>${result.category}</span>`);
        }
        
        return meta.join('');
    }
    
    getContentTypeIcon(contentType) {
        const icons = {
            'kb_article': 'bi-journal-text',
            'outage': 'bi-exclamation-triangle',
            'user': 'bi-person',
            'office': 'bi-building',
            'workstation': 'bi-laptop',
            'document': 'bi-file-earmark-text',
            'note': 'bi-sticky'
        };
        return icons[contentType] || 'bi-file-earmark';
    }
    
    getContentTypeTitle(contentType) {
        const titles = {
            'kb_article': 'Knowledge Base Articles',
            'outage': 'Outages',
            'user': 'Users',
            'office': 'Offices',
            'workstation': 'Workstations',
            'document': 'Documents',
            'note': 'Notes'
        };
        return titles[contentType] || 'Other';
    }
    
    navigateToResult(result) {
        // Persist search context for downstream highlighting / analytics
        sessionStorage.setItem('searchContext', JSON.stringify({
            query: this.query,
            resultId: result.id,
            timestamp: Date.now()
        }));

        // Determine navigation behaviour based on content type
        const url = result.url;
        const type = result.content_type || '';

        // Handle different content types with appropriate actions
        if (type === 'document' || this.isPdfUrl(url)) {
            this.openPdfModal(result);
            return;
        }

        if (type === 'note') {
            this.openNoteModal(result);
            return;
        }

        if (type === 'kb_article' && this.isPdfUrl(url)) {
            this.openPdfModal(result);
            return;
        }

        // For all other resources use a standard in-app navigation so the
        // browser's back button remains functional.
        window.location.href = url;
    }

    isPdfUrl(url) {
        return url && (url.toLowerCase().endsWith('.pdf') || url.includes('/static/docs/'));
    }

    openPdfModal(result) {
        const modal = document.getElementById('universalSearchPdfModal');
        const overlay = document.getElementById('universalSearchPdfModalOverlay');
        const content = document.getElementById('universalSearchPdfModalContent');
        const titleEl = document.getElementById('universalSearchPdfModalTitle');
        
        if (!modal || !overlay || !content || !titleEl) {
            // Fallback to opening in new tab if modal elements don't exist
            window.open(result.url, '_blank');
            return;
        }

        titleEl.textContent = result.title || 'Document';
        
        // Show loading state
        content.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        modal.classList.add('active');
        overlay.classList.add('active');
        
        // Extract filename for PDF URLs
        let pdfUrl = result.url;
        if (result.url.includes('/static/docs/')) {
            pdfUrl = result.url;
        } else if (result.url.toLowerCase().endsWith('.pdf')) {
            pdfUrl = result.url;
        }
        
        // Add PDF viewer parameters for better display
        if (pdfUrl.includes('?')) {
            pdfUrl += '&toolbar=1&navpanes=0&scrollbar=1';
        } else {
            pdfUrl += '#toolbar=1&navpanes=0&scrollbar=1';
        }
        
        // Load PDF with proper viewer
        content.innerHTML = `
            <div class="pdf-viewer-container" style="width:100%;height:calc(100vh - 80px);position:relative;background:#2c2c2c;">
                <div class="pdf-toolbar" style="background:#1e1e1e;padding:8px 16px;border-bottom:1px solid #444;display:flex;align-items:center;justify-content:space-between;">
                    <div class="pdf-controls">
                        <button class="btn btn-sm btn-outline-light me-2" onclick="window.open('${pdfUrl}', '_blank')" title="Open in new tab">
                            <i class="bi bi-box-arrow-up-right"></i> Open in New Tab
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="this.closest('.pdf-viewer-container').querySelector('iframe').contentWindow.print()" title="Print">
                            <i class="bi bi-printer"></i> Print
                        </button>
                    </div>
                    <div class="pdf-title" style="color:#fff;font-weight:500;flex:1;text-align:center;margin:0 1rem;">
                        ${result.title || 'Document'}
                    </div>
                    <div class="pdf-info" style="color:#aaa;font-size:0.8rem;">
                        PDF Document
                    </div>
                </div>
                <iframe src="${pdfUrl}#toolbar=1&navpanes=1&scrollbar=1&view=FitH" 
                        style="width:100%;height:calc(100% - 60px);border:none;background:#fff;" 
                        title="PDF Viewer"
                        onerror="this.parentNode.innerHTML='<div class=\\'error-container\\' style=\\'display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#fff;\\'>\\
                            <i class=\\'bi bi-file-earmark-x\\' style=\\'font-size:3rem;color:#dc3545;margin-bottom:1rem;\\'></i>\\
                            <h4>PDF Failed to Load</h4>\\
                            <p style=\\'color:#aaa;text-align:center;margin-bottom:1rem;\\'>The PDF document could not be displayed in the viewer.</p>\\
                            <a href=\\'${pdfUrl}\\' target=\\'_blank\\' class=\\'btn btn-primary\\'>\\
                                <i class=\\'bi bi-download\\' style=\\'margin-right:0.5rem;\\'></i>Download PDF\\
                            </a>\\
                        </div>';" 
                        allowfullscreen>
                </iframe>
            </div>`;
    }

    async openNoteModal(result) {
        console.log('openNoteModal called with:', result);
        try {
            // Extract note ID from the result - try multiple sources
            let noteId = result.id;
            
            // If the ID has the "note_" prefix, extract the numeric part
            if (noteId && typeof noteId === 'string' && noteId.startsWith('note_')) {
                noteId = noteId.replace('note_', '');
            }
            
            // If no direct ID, try to extract from URL
            if (!noteId && result.url) {
                noteId = this.extractNoteIdFromUrl(result.url);
            }
            
            // If still no ID, try to extract from other result fields
            if (!noteId && result.note_id) {
                noteId = result.note_id;
            }
            
            // If still no ID, try to parse from result data
            if (!noteId && result.data && result.data.id) {
                noteId = result.data.id;
            }
            
            console.log('Final note ID:', noteId);
            
            if (!noteId) {
                console.error('Could not determine note ID from result:', result);
                // Show a user-friendly error modal instead of failing silently
                this.showNoteErrorModal(result, 'Could not identify note ID');
                return;
            }

            console.log('Fetching note data for ID:', noteId);
            
            // First try to fetch as owner
            let response = await fetch(`/notes/api/notes/${noteId}`);
            
            console.log('Owner fetch response status:', response.status);
            
            if (response.status === 403) {
                // User doesn't own this note - try public endpoint
                console.log('User not owner, trying public endpoint');
                response = await fetch(`/notes/api/notes/public/${noteId}`);
                
                console.log('Public fetch response status:', response.status);
                
                if (response.status === 403) {
                    // Note is private and user doesn't own it
                    this.showNoteAccessDeniedModal(result);
                    return;
                }
                
                if (response.status === 404) {
                    this.showNoteErrorModal(result, 'Note not found');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch public note: ${response.status} ${response.statusText}`);
                }
                
                const noteData = await response.json();
                console.log('Public note data received:', noteData);
                // Show view-only modal for public notes from other users
                this.showNoteViewOnlyModal(result, noteData);
                return;
            }
            
            if (response.status === 404) {
                this.showNoteErrorModal(result, 'Note not found');
                return;
            }
            
            if (!response.ok) {
                throw new Error(`Failed to fetch note: ${response.status} ${response.statusText}`);
            }
            
            const noteData = await response.json();
            console.log('Owner note data received:', noteData);
            
            // User owns this note - show editable modal
            this.showNoteEditableModal(noteData);
            
        } catch (error) {
            console.error('Error opening note modal:', error);
            this.showNoteErrorModal(result, `Error loading note: ${error.message}`);
        }
    }

    extractNoteIdFromUrl(url) {
        console.log('Extracting note ID from URL:', url);
        
        // Extract note ID from various URL patterns
        const patterns = [
            /\/notes\/(\d+)/,           // /notes/123
            /\/note\/(\d+)/,            // /note/123
            /note_id=(\d+)/,            // ?note_id=123
            /noteId=(\d+)/,             // ?noteId=123
            /id=(\d+)/,                 // ?id=123
            /notes.*\/(\d+)/,           // /notes/anything/123
            /\/(\d+)$/                  // ends with /123
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) {
                console.log('Note ID extracted:', parseInt(match[1]));
                return parseInt(match[1]);
            }
        }
        
        console.log('Could not extract note ID from URL:', url);
        return null;
    }

    showNoteViewOnlyModal(result, noteData) {
        const modal = document.getElementById('universalSearchNoteModal');
        const overlay = document.getElementById('universalSearchNoteModalOverlay');
        const content = document.getElementById('universalSearchNoteModalContent');
        const titleEl = document.getElementById('universalSearchNoteModalTitle');
        const editBtn = document.getElementById('universalSearchNoteEditBtn');
        
        if (!modal || !overlay || !content || !titleEl) {
            // Fallback to regular navigation if modal elements don't exist
            window.location.href = result.url;
            return;
        }

        // Use note data if provided, otherwise use result data
        const displayData = noteData || result;
        
        titleEl.textContent = displayData.title || 'Note';
        
        // Hide edit button for view-only mode
        if (editBtn) {
            editBtn.style.display = 'none';
        }
        
        // Parse and display content with proper formatting
        let displayContent = '';
        if (noteData) {
            // Use full note data from API
            try {
                if (noteData.content) {
                    const content = JSON.parse(noteData.content);
                    if (content.ops && Array.isArray(content.ops)) {
                        // Process Quill.js Delta format
                        displayContent = content.ops
                            .filter(op => op.insert && typeof op.insert === 'string')
                            .map(op => {
                                let text = op.insert;
                                // Convert newlines to proper HTML
                                text = text.replace(/\n/g, '<br>');
                                // Apply basic formatting if attributes exist
                                if (op.attributes) {
                                    if (op.attributes.bold) text = `<strong>${text}</strong>`;
                                    if (op.attributes.italic) text = `<em>${text}</em>`;
                                    if (op.attributes.underline) text = `<u>${text}</u>`;
                                }
                                return text;
                            })
                            .join('');
                    } else {
                        // Fallback for other JSON formats
                        displayContent = JSON.stringify(content, null, 2).replace(/\n/g, '<br>');
                    }
                }
            } catch (e) {
                displayContent = noteData.content ? noteData.content.replace(/\n/g, '<br>') : '';
            }
        } else {
            // Use search result description as fallback
            displayContent = result.highlighted_description || result.description || 'No content available';
        }
        
        // Ensure we have some content to display
        if (!displayContent || displayContent.trim() === '') {
            displayContent = '<em style="color: rgba(255, 255, 255, 0.5);">This note appears to be empty.</em>';
        }
        
        // Show note content in read-only format
        content.innerHTML = `
            <div class="note-view-only" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="note-content-display" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="note-text-content" style="color: #fff; line-height: 1.6; font-size: 1rem;">${displayContent}</div>
                </div>
                <div class="note-meta-info" style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 1rem;">
                    ${noteData && noteData.tags ? `<div class="note-tags" style="margin-bottom: 0.75rem;">${this.renderNoteTags(noteData.tags)}</div>` : ''}
                    <div class="note-metadata" style="display: flex; flex-wrap: wrap; gap: 1rem; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                        ${noteData && noteData.author ? `<div class="note-author"><i class="bi bi-person" style="margin-right: 0.25rem;"></i> ${noteData.author.username}</div>` : ''}
                        ${noteData ? `<div class="note-dates"><i class="bi bi-calendar" style="margin-right: 0.25rem;"></i> ${new Date(noteData.updated_at).toLocaleDateString()}</div>` : ''}
                        <div class="note-access-info">
                            <i class="bi bi-eye" style="margin-right: 0.25rem; color: #ffc107;"></i> View Only
                        </div>
                        ${noteData && noteData.is_public ? '<div class="note-visibility"><i class="bi bi-unlock" style="margin-right: 0.25rem; color: #28a745;"></i> Public</div>' : '<div class="note-visibility"><i class="bi bi-lock" style="margin-right: 0.25rem; color: #dc3545;"></i> Private</div>'}
                    </div>
                </div>
            </div>`;
        
        modal.classList.add('active');
        overlay.classList.add('active');
    }

    showNoteAccessDeniedModal(result) {
        const modal = document.getElementById('universalSearchNoteModal');
        const overlay = document.getElementById('universalSearchNoteModalOverlay');
        const content = document.getElementById('universalSearchNoteModalContent');
        const titleEl = document.getElementById('universalSearchNoteModalTitle');
        const editBtn = document.getElementById('universalSearchNoteEditBtn');
        
        if (!modal || !overlay || !content || !titleEl) {
            return;
        }

        titleEl.textContent = result.title || 'Private Note';
        
        // Hide edit button
        if (editBtn) {
            editBtn.style.display = 'none';
        }
        
        content.innerHTML = `
            <div class="note-access-denied">
                <div class="access-denied-icon">
                    <i class="bi bi-lock-fill" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                </div>
                <h4 style="color: #fff; margin-bottom: 1rem;">Access Denied</h4>
                <p style="color: rgba(255, 255, 255, 0.7); text-align: center; line-height: 1.6;">
                    This note is private and you don't have permission to view it.
                    Only the note owner can access private notes.
                </p>
            </div>`;
        
        modal.classList.add('active');
        overlay.classList.add('active');
    }

    showNoteErrorModal(result, errorMessage) {
        const modal = document.getElementById('universalSearchNoteModal');
        const overlay = document.getElementById('universalSearchNoteModalOverlay');
        const content = document.getElementById('universalSearchNoteModalContent');
        const titleEl = document.getElementById('universalSearchNoteModalTitle');
        const editBtn = document.getElementById('universalSearchNoteEditBtn');
        
        if (!modal || !overlay || !content || !titleEl) {
            // Fallback: show alert and try to navigate to notes page
            alert(`Note Error: ${errorMessage}`);
            window.location.href = '/notes';
            return;
        }

        titleEl.textContent = result.title || 'Note Error';
        
        // Hide edit button
        if (editBtn) {
            editBtn.style.display = 'none';
        }
        
        content.innerHTML = `
            <div class="note-error" style="text-align: center; padding: 2rem;">
                <div class="error-icon">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                </div>
                <h4 style="color: #fff; margin-bottom: 1rem;">Unable to Load Note</h4>
                <p style="color: rgba(255, 255, 255, 0.7); text-align: center; line-height: 1.6; margin-bottom: 1.5rem;">
                    ${errorMessage}
                </p>
                <div class="error-actions">
                    <button class="btn btn-primary me-2" onclick="window.location.href='/notes'">
                        <i class="bi bi-journal-text"></i> Go to Notes
                    </button>
                    <button class="btn btn-secondary" onclick="
                        document.getElementById('universalSearchNoteModal').classList.remove('active');
                        document.getElementById('universalSearchNoteModalOverlay').classList.remove('active');
                    ">
                        <i class="bi bi-x"></i> Close
                    </button>
                </div>
            </div>`;
        
        modal.classList.add('active');
        overlay.classList.add('active');
    }

    showNoteEditableModal(noteData) {
        const modal = document.getElementById('universalSearchNoteModal');
        const overlay = document.getElementById('universalSearchNoteModalOverlay');
        const content = document.getElementById('universalSearchNoteModalContent');
        const titleEl = document.getElementById('universalSearchNoteModalTitle');
        const editBtn = document.getElementById('universalSearchNoteEditBtn');
        
        if (!modal || !overlay || !content || !titleEl) {
            // Fallback to notes page if modal elements don't exist
            window.location.href = '/notes';
            return;
        }

        titleEl.textContent = noteData.title || 'Untitled Note';
        
        // Show edit button for owners
        if (editBtn) {
            editBtn.style.display = 'inline-flex';
            editBtn.onclick = () => {
                if (window.searchPageInstance && window.searchPageInstance.enableNoteEditing) {
                    window.searchPageInstance.enableNoteEditing(noteData);
                } else {
                    console.error('Note editing not available');
                    alert('Note editing is not available. Please try refreshing the page.');
                }
            };
        }
        
        // Parse and display content with proper formatting
        let displayContent = '';
        try {
            if (noteData.content) {
                const content = JSON.parse(noteData.content);
                if (content.ops && Array.isArray(content.ops)) {
                    // Process Quill.js Delta format
                    displayContent = content.ops
                        .filter(op => op.insert && typeof op.insert === 'string')
                        .map(op => {
                            let text = op.insert;
                            // Convert newlines to proper HTML
                            text = text.replace(/\n/g, '<br>');
                            // Apply basic formatting if attributes exist
                            if (op.attributes) {
                                if (op.attributes.bold) text = `<strong>${text}</strong>`;
                                if (op.attributes.italic) text = `<em>${text}</em>`;
                                if (op.attributes.underline) text = `<u>${text}</u>`;
                            }
                            return text;
                        })
                        .join('');
                } else {
                    // Fallback for other JSON formats
                    displayContent = JSON.stringify(content, null, 2).replace(/\n/g, '<br>');
                }
            }
        } catch (e) {
            // Fallback for plain text content
            displayContent = noteData.content ? noteData.content.replace(/\n/g, '<br>') : '';
        }
        
        // Ensure we have some content to display
        if (!displayContent || displayContent.trim() === '') {
            displayContent = '<em style="color: rgba(255, 255, 255, 0.5);">This note appears to be empty.</em>';
        }
        
        // Show note content with edit option
        content.innerHTML = `
            <div class="note-editable-view" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="note-content-display" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="note-text-content" style="color: #fff; line-height: 1.6; font-size: 1rem;">${displayContent || '<em style="color: rgba(255, 255, 255, 0.5);">No content</em>'}</div>
                </div>
                <div class="note-meta-info" style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 1rem;">
                    ${noteData.tags ? `<div class="note-tags" style="margin-bottom: 0.75rem;">${this.renderNoteTags(noteData.tags)}</div>` : ''}
                    <div class="note-metadata" style="display: flex; flex-wrap: wrap; gap: 1rem; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                        <div class="note-privacy">
                            <i class="bi ${noteData.is_public ? 'bi-unlock' : 'bi-lock-fill'}" style="margin-right: 0.25rem; color: ${noteData.is_public ? '#28a745' : '#dc3545'};"></i>
                            ${noteData.is_public ? 'Public' : 'Private'}
                        </div>
                        <div class="note-dates">
                            <i class="bi bi-calendar" style="margin-right: 0.25rem;"></i>
                            Updated: ${new Date(noteData.updated_at).toLocaleDateString()}
                        </div>
                        <div class="note-owner-info">
                            <i class="bi bi-person-check" style="margin-right: 0.25rem; color: #007bff;"></i> You own this note
                        </div>
                    </div>
                </div>
            </div>`;
        
        modal.classList.add('active');
        overlay.classList.add('active');
    }

    renderNoteTags(tagsString) {
        if (!tagsString) return '';
        
        const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
        return tags.map(tag => `
            <span class="note-tag" style="
                display: inline-block;
                background: rgba(0, 123, 255, 0.2);
                color: #007bff;
                padding: 0.25rem 0.75rem;
                border-radius: 15px;
                font-size: 0.8rem;
                margin: 0.125rem;
                border: 1px solid rgba(0, 123, 255, 0.3);
            ">
                <i class="bi bi-tag" style="margin-right: 0.25rem;"></i>${tag}
            </span>
        `).join('');
    }
    
    updatePagination() {
        // Since we're showing all results, hide pagination
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.style.display = 'none';
    }
    
    showLoading() {
        document.getElementById('loading-container').style.display = 'block';
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('pagination-container').style.display = 'none';
    }
    
    hideLoading() {
        document.getElementById('loading-container').style.display = 'none';
    }
    
    showNoResults() {
        document.getElementById('no-results-query').textContent = this.query;
        document.getElementById('no-results').style.display = 'block';
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('pagination-container').style.display = 'none';
        document.getElementById('total-results').textContent = '0';
        document.getElementById('search-time').textContent = '';
        this.fetchSuggestions();
    }
    
    async fetchSuggestions(){
        try {
            const resp = await fetch(`/api/universal-search/suggestions?q=${encodeURIComponent(this.query)}&limit=12`);
            const data = await resp.json();
            const container = document.getElementById('no-results-did-you-mean');
            const list = document.getElementById('suggestions-list');
            
            if(data.suggestions && data.suggestions.length){
                // Process suggestions to handle special patterns
                const processedSuggestions = this.processSuggestions(data.suggestions);
                
                // Group suggestions by type
                const groupedSuggestions = this.groupSuggestions(processedSuggestions);
                
                let suggestionsHtml = '';
                
                // Add pattern suggestions first
                if (groupedSuggestions.patterns.length > 0) {
                    suggestionsHtml += '<div class="suggestion-group"><h5>Quick Actions</h5>';
                    suggestionsHtml += groupedSuggestions.patterns.map(s => {
                        const icon = this.getSuggestionIcon(s);
                        return `<li class="suggestion-item pattern-suggestion" data-suggestion="${s}">
                            <i class="${icon}"></i> ${s}
                        </li>`;
                    }).join('');
                    suggestionsHtml += '</div>';
                }
                
                // Add related searches
                if (groupedSuggestions.related.length > 0) {
                    suggestionsHtml += '<div class="suggestion-group"><h5>Related Searches</h5>';
                    suggestionsHtml += groupedSuggestions.related.map(s => {
                        const icon = this.getSuggestionIcon(s);
                        return `<li class="suggestion-item" data-suggestion="${s}">
                            <i class="${icon}"></i> ${s}
                        </li>`;
                    }).join('');
                    suggestionsHtml += '</div>';
                }
                
                // Add popular searches
                if (groupedSuggestions.popular.length > 0) {
                    suggestionsHtml += '<div class="suggestion-group"><h5>Popular Searches</h5>';
                    suggestionsHtml += groupedSuggestions.popular.map(s => {
                        const icon = this.getSuggestionIcon(s);
                        return `<li class="suggestion-item" data-suggestion="${s}">
                            <i class="${icon}"></i> ${s}
                        </li>`;
                    }).join('');
                    suggestionsHtml += '</div>';
                }
                
                list.innerHTML = suggestionsHtml;
                
                container.style.display='block';
                list.querySelectorAll('.suggestion-item').forEach(el => el.addEventListener('click', () => {
                    // Clear all filters before searching
                    this.currentFilters.contentTypes = [];
                    this.currentFilters.sections = [];
                    this.updateFilterDisplay();

                    const suggestion = el.dataset.suggestion;
                    // Handle pattern suggestions specially
                    if (suggestion.startsWith('Search for Clock ID') || suggestion.startsWith('Find employee')) {
                        // Extract the number and search for it
                        const match = suggestion.match(/\d+/);
                        if (match) {
                            this.query = match[0];
                            document.getElementById('search-query').textContent = this.query;
                            this.currentPage = 1;
                            this.performSearch();
                        }
                    } else if (suggestion.startsWith('Search for') || suggestion.startsWith('Find')) {
                        // Extract the actual search term
                        const searchTerm = suggestion.replace(/^(Search for|Find)\s+/i, '');
                        this.query = searchTerm;
                        document.getElementById('search-query').textContent = this.query;
                        this.currentPage = 1;
                        this.performSearch();
                    } else {
                        // Regular suggestion
                        this.query = suggestion;
                        document.getElementById('search-query').textContent = this.query;
                        this.currentPage = 1;
                        this.performSearch();
                    }
                }));
            } else {
                container.style.display='none';
            }
        } catch(err){
            console.error('Suggestion fetch failed', err);
        }
    }
    
    groupSuggestions(suggestions) {
        const groups = {
            patterns: [],
            related: [],
            popular: []
        };
        
        suggestions.forEach(suggestion => {
            if (suggestion.startsWith('Search for') || suggestion.startsWith('Find')) {
                groups.patterns.push(suggestion);
            } else if (suggestion.includes('error') || suggestion.includes('issue') || suggestion.includes('problem')) {
                groups.related.push(suggestion);
            } else {
                groups.popular.push(suggestion);
            }
        });
        
        return groups;
    }
    
    processSuggestions(suggestions) {
        // Remove duplicates and prioritize pattern suggestions
        const uniqueSuggestions = [];
        const seen = new Set();
        
        for (const suggestion of suggestions) {
            if (!seen.has(suggestion)) {
                seen.add(suggestion);
                uniqueSuggestions.push(suggestion);
            }
        }
        
        // Sort pattern suggestions first
        return uniqueSuggestions.sort((a, b) => {
            const aIsPattern = a.startsWith('Search for') || a.startsWith('Find');
            const bIsPattern = b.startsWith('Search for') || b.startsWith('Find');
            
            if (aIsPattern && !bIsPattern) return -1;
            if (!aIsPattern && bIsPattern) return 1;
            return 0;
        });
    }
    
    getSuggestionIcon(suggestion) {
        if (suggestion.includes('Clock ID') || suggestion.includes('employee')) {
            return 'bi bi-person-badge';
        } else if (suggestion.includes('IP') || suggestion.includes('network')) {
            return 'bi bi-hdd-network';
        } else if (suggestion.includes('MAC') || suggestion.includes('device')) {
            return 'bi bi-laptop';
        } else if (suggestion.includes('ticket') || suggestion.includes('case')) {
            return 'bi bi-ticket-detailed';
        } else if (suggestion.includes('email') || suggestion.includes('contact')) {
            return 'bi bi-envelope';
        } else if (suggestion.includes('phone') || suggestion.includes('call')) {
            return 'bi bi-telephone';
        } else if (suggestion.includes('users')) {
            return 'bi bi-people';
        } else if (suggestion.includes('offices')) {
            return 'bi bi-building';
        } else if (suggestion.includes('workstations')) {
            return 'bi bi-laptop';
        } else if (suggestion.includes('knowledge base')) {
            return 'bi bi-journal-text';
        } else if (suggestion.includes('outages')) {
            return 'bi bi-exclamation-triangle';
        } else {
            return 'bi bi-search';
        }
    }
    
    showError() {
        document.getElementById('search-results').innerHTML = `
            <div class="no-results">
                <i class="bi bi-exclamation-triangle"></i>
                <h3>Search Error</h3>
                <p>Unable to perform search. Please try again.</p>
            </div>
        `;
        document.getElementById('search-results').style.display = 'grid';
    }
}

// Initialize search page when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const searchInstance = new UniversalSearchPage();
    
    // Add note editing functionality to the instance
    searchInstance.enableNoteEditing = function(noteData) {
        this.loadQuillAndEnableEditing(noteData);
    };
    
    searchInstance.loadQuillAndEnableEditing = function(noteData) {
        // Load Quill if not already loaded
        if (typeof window.Quill === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.quilljs.com/1.3.6/quill.min.js';
            script.onload = () => {
                this.showEditableNoteModal(noteData);
            };
            script.onerror = () => {
                console.error('Failed to load Quill editor');
                alert('Failed to load the editor. Please try again.');
            };
            document.head.appendChild(script);
        } else {
            this.showEditableNoteModal(noteData);
        }
    };
    
    searchInstance.showEditableNoteModal = function(noteData) {
        const content = document.getElementById('universalSearchNoteModalContent');
        const titleEl = document.getElementById('universalSearchNoteModalTitle');
        const editBtn = document.getElementById('universalSearchNoteEditBtn');
        
        if (!content || !titleEl) return;
        
        // Update modal title to show editing mode
        titleEl.textContent = `Edit: ${noteData.title || 'Untitled Note'}`;
        
        // Hide edit button and show save/cancel
        if (editBtn) {
            editBtn.style.display = 'none';
        }
        
        // Parse note content
        let initialContent;
        try {
            initialContent = noteData.content ? JSON.parse(noteData.content) : { ops: [] };
        } catch (e) {
            initialContent = { ops: [{ insert: noteData.content || '' }] };
        }
        
        // Create edit interface
        content.innerHTML = `
            <div class="note-edit-mode">
                <input type="text" class="note-title-edit" id="editNoteTitle" value="${(noteData.title || '').replace(/"/g, '&quot;')}" placeholder="Note title...">
                <div class="note-editor-container">
                    <div id="editNoteEditor"></div>
                </div>
                <div class="note-edit-actions">
                    <button class="note-edit-btn secondary" onclick="window.searchPageInstance.cancelNoteEdit('${noteData.id}')">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button class="note-edit-btn primary" onclick="window.searchPageInstance.saveNoteEdit('${noteData.id}')">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
        `;
        
        // Initialize Quill editor
        setTimeout(() => {
            try {
                const toolbarOptions = [
                    ['bold', 'italic', 'underline'],
                    [{ 'header': [1, 2, 3, false] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote', 'code-block'],
                    ['clean']
                ];
                
                this.noteEditor = new Quill('#editNoteEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: toolbarOptions
                    },
                    placeholder: 'Start writing your note...'
                });
                
                // Set initial content
                this.noteEditor.setContents(initialContent);
                
                // Focus the editor
                this.noteEditor.focus();
                
                // Store original data for cancel functionality
                this.originalNoteData = noteData;
                
            } catch (error) {
                console.error('Error initializing note editor:', error);
                alert('Failed to initialize the editor. Please try again.');
            }
        }, 100);
    };
    
    searchInstance.saveNoteEdit = async function(noteId) {
        const titleInput = document.getElementById('editNoteTitle');
        
        if (!this.noteEditor || !titleInput) {
            alert('Editor not initialized properly');
            return;
        }
        
        try {
            const title = titleInput.value.trim() || 'Untitled Note';
            const content = JSON.stringify(this.noteEditor.getContents());
            
            // Show saving state
            const saveBtn = document.querySelector('.note-edit-btn.primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';
            saveBtn.disabled = true;
            
            const response = await fetch(`/notes/api/notes/${noteId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save note: ${response.status} ${response.statusText}`);
            }
            
            const updatedNote = await response.json();
            
            // Show success and close modal after a short delay
            saveBtn.innerHTML = '<i class="bi bi-check"></i> Saved!';
            saveBtn.style.background = '#28a745';
            
            setTimeout(() => {
                // Close the modal
                const modal = document.getElementById('universalSearchNoteModal');
                const overlay = document.getElementById('universalSearchNoteModalOverlay');
                if (modal && overlay) {
                    modal.classList.remove('active');
                    overlay.classList.remove('active');
                }
                
                // Clean up editor
                this.noteEditor = null;
                this.originalNoteData = null;
                
                // Show toast notification
                this.showToast('Note saved successfully!', 'success');
            }, 1000);
            
        } catch (error) {
            console.error('Error saving note:', error);
            alert(`Failed to save note: ${error.message}`);
            
            // Restore save button
            const saveBtn = document.querySelector('.note-edit-btn.primary');
            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save';
            saveBtn.disabled = false;
            saveBtn.style.background = '#007bff';
        }
    };
    
    searchInstance.cancelNoteEdit = function(noteId) {
        if (this.originalNoteData) {
            // Restore the original view
            this.showNoteEditableModal(this.originalNoteData);
            
            // Clean up
            this.noteEditor = null;
            this.originalNoteData = null;
        }
    };
    
    searchInstance.showToast = function(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 11200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    };
    
    // Make instance globally available for callbacks
    window.searchPageInstance = searchInstance;
});
</script>
{% endblock %} 