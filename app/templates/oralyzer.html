{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="../static/CSS/style.css">
<link rel="stylesheet" href="../static/CSS/search.css">
<link rel="stylesheet" href="../static/CSS/oralyzer.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client/dist/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/RoundedBoxGeometry.js"></script>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/Y.ico') }}">

{% endblock %}

{% block content %}
<div class="with-outage-banner">
<!-- Move the model-toggle button outside the 3d-container so it is always visible -->
<button class="model-toggle" id="model-toggle-btn" onclick="toggleModel()">
    <!-- <span class="icon">🎮</span> -->
    <span class="text">Hide 3D Model</span>
</button>

<div id="3d-container" style="width: 100vw; height: 100vh; background: transparent;"></div>
<!-- Interactive UI overlay for the 3D screen -->
<div id="screen-ui" style="position: absolute; pointer-events: none; display: none; z-index: 10;"></div>

<script>
    let modelVisible = true; // Show 3D model by default
    let animationFrameId = null;

    function toggleModel() {
        const container = document.getElementById('3d-container');
        const button = document.getElementById('model-toggle-btn');
        const buttonText = button.querySelector('.text');
        const screenUI = document.getElementById('screen-ui');
        
        modelVisible = !modelVisible;
        
        if (modelVisible) {
            container.style.display = 'block';
            buttonText.textContent = 'Hide 3D Model';
            screenUI.classList.remove('fullscreen');
            if (!animationFrameId) {
                animate();
            }
        } else {
            container.style.display = 'none';
            buttonText.textContent = 'Show 3D Model';
            screenUI.classList.add('fullscreen');
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
        // Always show the toggle button
        button.classList.toggle('hide-3d', !modelVisible);
        updateScreenUIVisibility();
        updateScreenUIPosition();
    }

    // Patch updateScreenUIVisibility to always show the overlay in fullscreen mode when 3D is hidden
    const origUpdateScreenUIVisibility = updateScreenUIVisibility;
    updateScreenUIVisibility = function() {
        const screenUI = document.getElementById('screen-ui');
        if (!modelVisible) {
            screenUI.style.display = 'flex';
            screenUI.classList.add('fullscreen');
            return;
        } else {
            screenUI.classList.remove('fullscreen');
        }
        origUpdateScreenUIVisibility();
    };

    // Patch updateScreenUIPosition to skip positioning when fullscreen
    const origUpdateScreenUIPosition = updateScreenUIPosition;
    updateScreenUIPosition = function() {
        const screenUI = document.getElementById('screen-ui');
        if (!modelVisible) {
            // Fullscreen mode, no need to position
            screenUI.style.left = '0';
            screenUI.style.top = '0';
            screenUI.style.width = '100vw';
            screenUI.style.height = '100vh';
            return;
        }
        origUpdateScreenUIPosition();
    };

    // On page load, ensure correct state
    window.addEventListener('DOMContentLoaded', () => {
        if (!modelVisible) {
            document.getElementById('screen-ui').classList.add('fullscreen');
        }
        updateScreenUIVisibility();
        updateScreenUIPosition();
    });

    // Initialize Three.js scene
    const scene = new THREE.Scene();

    // Create fullscreen plane that stays behind the scene
    const bgGeometry = new THREE.PlaneGeometry(2, 2);
    const bgMaterial = new THREE.ShaderMaterial({
    uniforms: {
        uTime: { value: 0 },
        uMouse: { value: new THREE.Vector2() },
    },
    vertexShader: `
        void main() {
        gl_Position = vec4(position, 1.0);
        }
    `,
    fragmentShader: `
        uniform float uTime;
        uniform vec2 uMouse;

        void main() {
        vec2 uv = gl_FragCoord.xy / vec2(1920.0, 1080.0); // adjust to your screen
        float dist = distance(uv, uMouse);

        vec3 centerColor = vec3(0.95);      // Light gray center
        vec3 edgeColor = vec3(0.7);         // Darker gray edges

        vec3 color = mix(centerColor, edgeColor, dist * 1.8);
        gl_FragColor = vec4(color, 1.0);
        }
    `,
    depthTest: false,
    depthWrite: false,
    side: THREE.DoubleSide
    });

    const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
    bgMesh.frustumCulled = false;  // Always render
    scene.add(bgMesh);

    const camera = new THREE.PerspectiveCamera(90, document.getElementById('3d-container').offsetWidth / document.getElementById('3d-container').offsetHeight, 0.3, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(document.getElementById('3d-container').offsetWidth, document.getElementById('3d-container').offsetHeight);
    renderer.setClearColor(0x000000, 0);
    document.getElementById('3d-container').appendChild(renderer.domElement);

    // Orbit controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 3.5; // Reduced from 5.5 to allow closer zoom
    controls.maxDistance = 15;
    controls.maxPolarAngle = Math.PI / 2;
    controls.zoomSpeed = 1.2; // Added zoom speed control for smoother zooming

    // Group for the device
    const deviceGroup = new THREE.Group();
    deviceGroup.scale.set(1.7, 1.7, 1.7);
    deviceGroup.position.y = -1.2; // Move the device down
    scene.add(deviceGroup);

    // === MAIN BODY: Two-tone (top/sides silver, front/base black) ===
    // Top/sides (metallic silver)
    const bodyW = 2.7, bodyH = 2.2, bodyD = 2.1;
    const bodyRadius = 0.22, bodySmooth = 6;
    const bodyTopGeometry = new THREE.RoundedBoxGeometry(bodyW, bodyH, bodyD, bodySmooth, bodyRadius);
    const bodyTopMaterial = new THREE.MeshPhysicalMaterial({ color: 0xe6e7ea, metalness: 0.85, roughness: 0.18, clearcoat: 0.7, clearcoatRoughness: 0.08 });
    
    const bodyTop = new THREE.Mesh(bodyTopGeometry, bodyTopMaterial);
    bodyTop.position.set(0, bodyH / 2, 0);
    deviceGroup.add(bodyTop);
    // Front/base (black)
    const bodyFrontGeometry = new THREE.RoundedBoxGeometry(bodyW, bodyH, bodyD, bodySmooth, bodyRadius);
    const bodyFrontMaterial = new THREE.MeshPhysicalMaterial({ color: 0xe6e7ea , metalness: 0, roughness: 1, clearcoat: 0, clearcoatRoughness: 0 });
    const bodyFront = new THREE.Mesh(bodyFrontGeometry, bodyFrontMaterial);
    bodyFront.position.set(0, bodyH / 2, 0);
    // Mask to only show front and base (simulate by slightly offsetting and scaling)
    bodyFront.scale.set(1.01, .01, 0.51); // Only front half
    bodyFront.position.z += bodyD * 0.05;
    bodyFront.rotation.x = -Math.PI / 4;
    deviceGroup.add(bodyFront);

    const buttonPlate = new THREE.Mesh(bodyFrontGeometry, bodyFrontMaterial);
    buttonPlate.position.set(0, bodyH - 1.75, 1.05);
    // Mask to only show front and base (simulate by slightly offsetting and scaling)
    buttonPlate.scale.set(.3, .02, 0.08); // Only front half
    buttonPlate.rotation.x = -Math.PI / 4 + 2.4;
    deviceGroup.add(buttonPlate);

    // === ETHERNET PORT (smaller, square, realistic, with working link lights) ===
    const ethW = 0.19, ethH = 0.19, ethD = 0.13, ethInset = 0.01;
    const ethX = bodyW/2 - ethW/2 - 0.10;
    const ethY = ethH/2 + 0.10;
    const backZ = -bodyD/2;
    // Metallic frame (4 thin boxes)
    const frameT = 0.008, frameL = 0.012;
    const frameMat = new THREE.MeshPhysicalMaterial({ color: 0xbfc3c7, metalness: 0.85, roughness: 0.13, clearcoat: 1, clearcoatRoughness: 0.08 });
    // Top
    const frameTop = new THREE.Mesh(new THREE.BoxGeometry(ethW + frameL, frameT, frameT), frameMat);
    frameTop.position.set(ethX, ethY + ethH/2 + frameT/2, backZ + frameT/2 + 0.001);
    deviceGroup.add(frameTop);
    // Bottom
    const frameBot = new THREE.Mesh(new THREE.BoxGeometry(ethW + frameL, frameT, frameT), frameMat);
    frameBot.position.set(ethX, ethY - ethH/2 - frameT/2, backZ + frameT/2 + 0.001);
    deviceGroup.add(frameBot);
    // Left
    const frameLeft = new THREE.Mesh(new THREE.BoxGeometry(frameT, ethH + frameL, frameT), frameMat);
    frameLeft.position.set(ethX - ethW/2 - frameT/2, ethY, backZ + frameT/2 + 0.001);
    deviceGroup.add(frameLeft);
    // Right
    const frameRight = new THREE.Mesh(new THREE.BoxGeometry(frameT, ethH + frameL, frameT), frameMat);
    frameRight.position.set(ethX + ethW/2 + frameT/2, ethY, backZ + frameT/2 + 0.001);
    deviceGroup.add(frameRight);
    // Port cavity (black, deep inset)
    const ethPortGeo = new THREE.BoxGeometry(ethW, ethH, ethD);
    const ethPortMat = new THREE.MeshPhysicalMaterial({ color: 0x181a23, metalness: 0.7, roughness: 0.3, clearcoat: 0.5, clearcoatRoughness: 0.1 });
    const ethPort = new THREE.Mesh(ethPortGeo, ethPortMat);
    ethPort.position.set(ethX, ethY, backZ + ethD/2 + ethInset);
    deviceGroup.add(ethPort);
    // Inner contacts (simulate pins)
    const pinW = 0.018, pinH = 0.01, pinD = 0.03;
    for (let i = 0; i < 4; ++i) {
        const pinGeo = new THREE.BoxGeometry(pinW, pinH, pinD);
        const pinMat = new THREE.MeshPhysicalMaterial({ color: 0xcccccc, metalness: 0.7, roughness: 0.2 });
        const pin = new THREE.Mesh(pinGeo, pinMat);
        pin.position.set(ethX - 0.03 + i*0.02, ethY - 0.025, backZ + ethInset + pinD/2 + 0.01);
        deviceGroup.add(pin);
    }
    // Link lights (above port, flush with back, visible)
    const lightW = 0.03, lightH = 0.016, lightD = 0.018;
    const lightY = ethY + ethH/2 + lightH/2 + 0.004;
    const lightZ = backZ + lightD/2 + 0.018; // further out from back face
    // Green (left, static)
    const greenMat = new THREE.MeshPhysicalMaterial({ color: 0x00ff44, metalness: 0.2, roughness: 0.1, emissive: 0x00ff44, emissiveIntensity: 10.0 });
    const greenLight = new THREE.Mesh(new THREE.BoxGeometry(lightW, lightH, lightD), greenMat);
    greenLight.position.set(ethX - 0.055, lightY, lightZ);
    deviceGroup.add(greenLight);
    // Yellow (right, blinking)
    const yellowMat = new THREE.MeshPhysicalMaterial({ color: 0xffd700, metalness: 0.2, roughness: 0.1, emissive: 0xffd700, emissiveIntensity: 10.0 });
    const yellowLight = new THREE.Mesh(new THREE.BoxGeometry(lightW, lightH, lightD), yellowMat);
    yellowLight.position.set(ethX + 0.055, lightY, lightZ);
    deviceGroup.add(yellowLight);
    // Blinking animation for yellow light
    let yellowOn = true, yellowBlinkTimer = 0, yellowBlinkInterval = 0;
    function updateEthernetLights(dt) {
        yellowBlinkTimer += dt;
        if (yellowBlinkTimer > yellowBlinkInterval) {
            yellowOn = !yellowOn;
            yellowMat.emissiveIntensity = yellowOn ? 10.0 : 0.08;
            yellowMat.color.setHex(yellowOn ? 0xffd700 : 0x222200);
            yellowBlinkTimer = 0;
            yellowBlinkInterval = 0.08 + Math.random() * 0.5;
        }
    }
    // Patch animate loop to include ethernet light blinking
    const origAnimateEthernet = animate;
    let lastEthernetTime = performance.now();
    animate = function() {
        const now = performance.now();
        const dt = (now - lastEthernetTime) / 1000;
        lastEthernetTime = now;
        updateEthernetLights(dt);
        origAnimateEthernet();
    };

    // === SLANTED FRONT FACE (bezel, glossy black) ===
    const faceW = 2.5, faceH = 1.2, faceD = 0.08, faceSlant = Math.PI / 7.5; // ~24 deg
    const faceRadius = 0.12, faceSmooth = 6;
    const faceGeometry = new THREE.RoundedBoxGeometry(faceW, faceH, faceD, faceSmooth, faceRadius);
    const faceMaterial = new THREE.MeshPhysicalMaterial({ color: 0x181a23, metalness: 0.85, roughness: 0.12, clearcoat: 1, clearcoatRoughness: 0.05 });
    const face = new THREE.Mesh(faceGeometry, faceMaterial);
    // Place the face at the front, slanted
    face.position.set(0, bodyH * 0.70, bodyD / 2 + faceD / 2 + .10);
    face.rotation.x = -faceSlant;
    deviceGroup.add(face);

    // === ORALYZER TEXT ON BEZEL (bottom right, small, white) ===
    const fontLoader = new THREE.FontLoader();
    fontLoader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function(font) {
        const textGeometry = new THREE.TextGeometry('ORALYZER', {
            font: font,
            size: 0.07, // small size
            height: 0.008,
            curveSegments: 12,
            bevelEnabled: false
        });
        const textMaterial = new THREE.MeshPhysicalMaterial({ 
            color: 0xffffff,
            metalness: 0.2,
            roughness: 0.1,
            emissive: 0x000000,
            emissiveIntensity: 0
        });
        const textMesh = new THREE.Mesh(textGeometry, textMaterial);
        textGeometry.computeBoundingBox();
        const textWidth = textGeometry.boundingBox.max.x - textGeometry.boundingBox.min.x;
        const textHeight = textGeometry.boundingBox.max.y - textGeometry.boundingBox.min.y;
        // Position: bottom right, just above the face surface
        textMesh.position.set(
            faceW/2 - textWidth - 0.4, // right edge with margin
            -faceH/2 + textHeight/2 + 0.04, // bottom edge with margin
            faceD/2 + 0.012 // just above the face surface
        );
        face.add(textMesh);
    });

  
    // === SCREEN (inset, inside the bezel) ===
    const screenW = 1.75, screenH = 0.8, screenD = 0.021; // smaller than bezel, slightly inset
    const screenGeometry = new THREE.BoxGeometry(screenW, screenH, screenD);
    const screenOnMaterial = new THREE.MeshPhysicalMaterial({ color: 0x2562b4, metalness: 0.2, roughness: 0.1, emissive: 0x1e90ff, emissiveIntensity: 0.18 });
    const screenOffMaterial = new THREE.MeshPhysicalMaterial({ color: 0x181a23, metalness: 0.2, roughness: 0.1, emissive: 0x000000, emissiveIntensity: 0 });
    const screen = new THREE.Mesh(screenGeometry, screenOffMaterial);
    // Inset the screen into the face (bezel)
    screen.position.set(0, 0, faceD / 2 + screenD / 2 - 0.015);
    face.add(screen);

    // === POWER BUTTON (silver with blue glow) ===
    const buttonW = 0.44, buttonH = 0.15, buttonD = 0.045, buttonRadius = 0.09, buttonSmooth = 6;
    // Glowing border (blue)
    const buttonGlowGeometry = new THREE.RoundedBoxGeometry(buttonW + 0.03, buttonH + 0.03, buttonD + 0.01, buttonSmooth, buttonRadius + 0.015);
    const buttonGlowMaterial = new THREE.MeshPhysicalMaterial({ color: 0x00bfff, metalness: 0.7, roughness: 0.18, emissive: 0x00bfff, emissiveIntensity: 0.32, transparent: true, opacity: 0.22, clearcoat: 1 });
    const buttonGlow = new THREE.Mesh(buttonGlowGeometry, buttonGlowMaterial);
    buttonGlow.position.set(0, 0.45, bodyD / 2 + buttonD / 2 + 0.004);
    deviceGroup.add(buttonGlow);
    // Main button (silver)
    const buttonGeometry = new THREE.RoundedBoxGeometry(buttonW, buttonH, buttonD, buttonSmooth, buttonRadius);
    const buttonMaterial = new THREE.MeshPhysicalMaterial({ color: 0xe6e7ea, metalness: 0.7, roughness: 0.16, clearcoat: 1, clearcoatRoughness: 0.06, emissive: 0x22223b, emissiveIntensity: 0.08 });
    const buttonOffMaterial = new THREE.MeshPhysicalMaterial({ color: 0xe6e7ea, metalness: 0.7, roughness: 0.16, clearcoat: 1, clearcoatRoughness: 0.06, emissive: 0x000000, emissiveIntensity: 0 });
    const button = new THREE.Mesh(buttonGeometry, buttonMaterial);
    button.position.set(0, 0.45, bodyD / 2 + buttonD / 2 + 0.01);
    button.userData.isPowerButton = true;
    deviceGroup.add(button);

    // Power icon (SVG path extrude for guaranteed power symbol)
    const powerPath = new THREE.Shape();
    powerPath.absarc(0, 0, 0.045, Math.PI * 0.15, Math.PI * 1.85, false);
    const hole = new THREE.Path();
    hole.absarc(0, 0, 0.032, Math.PI * 0.15, Math.PI * 1.85, false);
    powerPath.holes.push(hole);
    const lineShape = new THREE.Shape();
    lineShape.moveTo(-0.008, 0.045);
    lineShape.lineTo(-0.008, 0.075);
    lineShape.lineTo(0.008, 0.075);
    lineShape.lineTo(0.008, 0.045);
    lineShape.lineTo(-0.008, 0.045);
    const extrudeSettings = { depth: 0.012, bevelEnabled: false };
    const arcGeometry = new THREE.ExtrudeGeometry(powerPath, extrudeSettings);
    const lineGeometry = new THREE.ExtrudeGeometry(lineShape, extrudeSettings);
    // Icon materials for on/off
    const iconMaterialOn = new THREE.MeshPhysicalMaterial({ color: 0xffffff, metalness: 0.1, roughness: 0.1, emissive: 0x99eaff, emissiveIntensity: 1.1 });
    const iconMaterialOff = new THREE.MeshPhysicalMaterial({ color: 0xffffff, metalness: 0.1, roughness: 0.1, emissive: 0x22232b, emissiveIntensity: 0.08 });
    const arcMesh = new THREE.Mesh(arcGeometry, iconMaterialOn);
    const lineMesh = new THREE.Mesh(lineGeometry, iconMaterialOn);
    arcMesh.position.set(0, 0, buttonD / 2 + 0.013);
    lineMesh.position.set(0, 0, buttonD / 2 + 0.013);
    button.add(arcMesh);
    button.add(lineMesh);
    // Store for toggling
    button.userData.iconMeshes = [arcMesh, lineMesh];
    button.userData.iconMaterialOn = iconMaterialOn;
    button.userData.iconMaterialOff = iconMaterialOff;

    // Initialize both screen and button in on state
    button.material = buttonOffMaterial;
    screen.material = screenOffMaterial;
    let powerOn = false;

    // Add initial rotation animation
    let initialRotationComplete = false;
    let initialRotationProgress = 0;
    const initialRotationDuration = 2.5; // seconds
    const initialRotationStartTime = performance.now();
    const powerOnThreshold = 0.7; // Power on at 80% of rotation

    // === TRAY/SLOT (black, blue highlight) ===
    const trayW = 0.9, trayL = 1.35, trayWall = 0.035, trayDepth = 0.18;
    // Tray shape: long rectangle
    const trayShape = new THREE.Shape();
    trayShape.moveTo(-trayW/2, 0);
    trayShape.lineTo(trayW/2, 0);
    trayShape.lineTo(trayW/2, trayL);
    trayShape.lineTo(-trayW/2, trayL);
    trayShape.lineTo(-trayW/2, 0);

    // Rectangular slot for cassette (centered, with rounded corners)
    const slotW = 0.8, slotL = 0.98, slotR = 0.06;
    const slotX = 0, slotY = trayL/2;
    const slotPath = new THREE.Path();
    slotPath.absarc(slotX - slotW/2 + slotR, slotY - slotL/2 + slotR, slotR, Math.PI, 1.5 * Math.PI, false);
    slotPath.lineTo(slotX + slotW/2 - slotR, slotY - slotL/2);
    slotPath.absarc(slotX + slotW/2 - slotR, slotY - slotL/2 + slotR, slotR, 1.5 * Math.PI, 0, false);
    slotPath.lineTo(slotX + slotW/2, slotY + slotL/2 - slotR);
    slotPath.absarc(slotX + slotW/2 - slotR, slotY + slotL/2 - slotR, slotR, 0, 0.5 * Math.PI, false);
    slotPath.lineTo(slotX - slotW/2 + slotR, slotY + slotL/2);
    slotPath.absarc(slotX - slotW/2 + slotR, slotY + slotL/2 - slotR, slotR, 0.5 * Math.PI, Math.PI, false);
    slotPath.lineTo(slotX - slotW/2, slotY - slotL/2 + slotR);
    trayShape.holes.push(slotPath);

    const trayExtrudeSettings = {
        steps: 1,
        depth: trayDepth,
        bevelEnabled: false
    };
    const trayGeometry = new THREE.ExtrudeGeometry(trayShape, trayExtrudeSettings);
    const trayMaterial = new THREE.MeshPhysicalMaterial({ color: 0x181a23, metalness: 0.6, roughness: 0.22 });
    const trayHighlightMaterial = new THREE.MeshPhysicalMaterial({ color: 0x00bfff, metalness: 0.7, roughness: 0.1, emissive: 0x00bfff, emissiveIntensity: 0.3 });
    const tray = new THREE.Mesh(trayGeometry, trayMaterial);

    // === HANDLE/LIP (black) ===
    const lipW = trayW * 0.95, lipH = trayWall * 2.8, lipD = trayWall * 3.2;
    const lipGeometry = new THREE.BoxGeometry(lipW, lipH, lipD);
    const lipMaterial = new THREE.MeshPhysicalMaterial({ color: 0x23232b, metalness: 0.5, roughness: 0.2, clearcoat: 1 });
    const lip = new THREE.Mesh(lipGeometry, lipMaterial);
    // Position lip at the very front of the tray (z = front face of tray)
    lip.position.set(0, 0 - lipH / 2 + 0.01, trayDepth / 2 + lipD / 2 - 0.01);
    tray.add(lip);

    // === SECOND SECTION (thinner, at back of tray) ===
    const section2W = trayW + .01; // slightly narrower
    const section2H = trayWall; // thinner than main tray wall
    const section2D = trayWall * 7; // a bit longer for visual effect
    const section2Geometry = new THREE.BoxGeometry(section2W, section2H, section2D);
    const section2Material = new THREE.MeshPhysicalMaterial({ color: 0x727070, metalness: 0.7, roughness: 0.18, clearcoat: 1 });
    const section2 = new THREE.Mesh(section2Geometry, section2Material);
    // Position at the back of the tray (z = -trayDepth/2 + half of section2D)
    section2.position.set(.15, 0 - section2H + .7, -trayDepth / 2 + section2D / 2 + 0.01);
    section2.rotation.z = -Math.PI / 2;
    tray.add(section2);

    // Add a floor to the tray slot (not hollow, only fills the slot)
    const slotFloorThickness = 0.055;
    const slotFloorGeometry = new THREE.BoxGeometry(slotW + 0.01, slotFloorThickness, slotL + 0.11);
    const slotFloorMaterial = new THREE.MeshPhysicalMaterial({ color: 0x23232b, metalness: 0.5, roughness: 0.3 });
    const slotFloor = new THREE.Mesh(slotFloorGeometry, slotFloorMaterial);
    // Position at the center of the slot, at the bottom of the tray
    slotFloor.position.set(0, -trayDepth / 2 + slotFloorThickness / 2 + .75, slotY - trayL / 2);
    slotFloor.rotation.x = -Math.PI / 2;
    tray.add(slotFloor);

    // Position tray so that when in, the lip is flush with the oralyzer front
    const trayY = 0.05;
    const trayInZ = bodyD / 2 - lipD / 2 - 0.01; // so lip is flush with body front
    const trayOutZ = trayInZ + trayL * 0.9; // pull out almost the full tray length
    tray.position.set(0, trayY, trayInZ);
    tray.rotation.x = -Math.PI / 2;
    tray.userData.isTray = true;
    deviceGroup.add(tray);

    // === ADD WARNING TEXT TO TRAY ===
    fontLoader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function(font) {
        const trayTextGeometry = new THREE.TextGeometry('DO NOT PUT HERE', {
            font: font,
            size: 0.07, // slightly larger for visibility
            height: 0.010,
            curveSegments: 10,
            bevelEnabled: false
        });
        const trayTextMaterial = new THREE.MeshStandardMaterial({
            color: 0xff4444,
            emissive: 0xff0000,            // Red glow
            emissiveIntensity: .1,        // Increase for stronger glow
            metalness: 0.1,
            roughness: 0.3
        });
        const trayTextMesh = new THREE.Mesh(trayTextGeometry, trayTextMaterial);
        trayTextGeometry.computeBoundingBox();
        const textWidth = trayTextGeometry.boundingBox.max.x - trayTextGeometry.boundingBox.min.x;
        // Position: center on tray, near front edge, on top surface
        trayTextMesh.position.set(
            .72 - textWidth / 2, // center horizontally
            trayWall + .2,    // just above the tray's top surface
            trayL / 2 - .65// near the front edge of the tray
        );
        trayTextMesh.rotation.x = Math.PI; // lay flat on tray
        trayTextMesh.rotation.z = -Math.PI / 2; // lay flat on tray
        trayTextMesh.rotation.y = -Math.PI; // lay flat on tray
        tray.add(trayTextMesh);
    });

    // === GLOWING ACCENT LINES (bright cyan/blue) ===
    // Front face outline (on slanted face)
    const outlinePoints = [
        new THREE.Vector3(-faceW/2 + 0.07, faceH/2 - 0.07, faceD / 2 + 0.01),
        new THREE.Vector3(faceW/2 - 0.07, faceH/2 - 0.07, faceD / 2 + 0.01),
        new THREE.Vector3(faceW/2 - 0.07, -faceH/2 + 0.07, faceD / 2 + 0.01),
        new THREE.Vector3(-faceW/2 + 0.07, -faceH/2 + 0.07, faceD / 2 + 0.01),
        new THREE.Vector3(-faceW/2 + 0.07, faceH/2 - 0.07, faceD / 2 + 0.01)
    ];
    const outlineGeometry = new THREE.BufferGeometry().setFromPoints(outlinePoints);
    const outlineMaterial = new THREE.LineBasicMaterial({ color: 0x00eaff, linewidth: 3 });
    const outline = new THREE.Line(outlineGeometry, outlineMaterial);
    face.add(outline);
    // Base accent
    const baseAccentPoints = [
        new THREE.Vector3(-bodyW/2, 0, -bodyD/2 + 0.01),
        new THREE.Vector3(bodyW/2, 0, -bodyD/2 + 0.01),
        new THREE.Vector3(bodyW/2, 0, bodyD/2 - 0.01),
        new THREE.Vector3(-bodyW/2, 0, bodyD/2 - 0.01),
        new THREE.Vector3(-bodyW/2, 0, -bodyD/2 + 0.01)
    ];
    const baseAccentGeometry = new THREE.BufferGeometry().setFromPoints(baseAccentPoints);
    const baseAccent = new THREE.Line(baseAccentGeometry, outlineMaterial);
    deviceGroup.add(baseAccent);

    // === LIGHTING ===
    const ambientLight = new THREE.AmbientLight(0x404040, 0.9);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
    directionalLight.position.set(5, 10, 7);
    scene.add(directionalLight);
    const backLight = new THREE.DirectionalLight(0x00bfff, 0.7);
    backLight.position.set(-5, 5, -5);
    scene.add(backLight);

    // Camera position
    camera.position.set(0, 2.8, 4.5); // Adjusted for better initial view
    camera.lookAt(0, 1, 0);

    // === TRAY INTERACTIVITY (update references to tray and lip) ===
    let trayOut = false;
    let trayTargetZ = trayInZ;
    let trayAnimating = false;
    let trayHover = false;

    // Raycaster for mouse interaction (detect handle/lip hover)
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    renderer.domElement.addEventListener('mousemove', onMouseMove, false);
    renderer.domElement.addEventListener('click', onMouseClick, false);

    function onMouseMove(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        
        // Check for tray hover
        const trayIntersects = raycaster.intersectObject(lip);
        if (trayIntersects.length > 0) {
            if (!trayHover) {
                lip.material = trayHighlightMaterial;
                trayHover = true;
                renderer.domElement.style.cursor = 'pointer';
            }
        } else {
            if (trayHover) {
                lip.material = lipMaterial;
                trayHover = false;
                renderer.domElement.style.cursor = '';
            }
        }

        // Check for power button hover
        const buttonIntersects = raycaster.intersectObject(button);
        if (buttonIntersects.length > 0) {
            renderer.domElement.style.cursor = 'pointer';
        } else if (!trayHover) {
            renderer.domElement.style.cursor = '';
        }
    }

    function onMouseClick(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);

        // Check for power button click
        const buttonIntersects = raycaster.intersectObject(button);
        if (buttonIntersects.length > 0) {
            powerOn = !powerOn;
            // Update both button and screen materials together
            button.material = powerOn ? buttonMaterial : buttonOffMaterial;
            screen.material = powerOn ? screenOnMaterial : screenOffMaterial;
            // Update icon glow
            if (button.userData.iconMeshes) {
                for (const mesh of button.userData.iconMeshes) {
                    mesh.material = powerOn ? button.userData.iconMaterialOn : button.userData.iconMaterialOff;
                }
            }
            return;
        }

        // Handle tray click
        if (!trayHover || trayAnimating) return;
        trayOut = !trayOut;
        trayTargetZ = trayOut ? trayOutZ : trayInZ;
        trayAnimating = true;
    }

    // === TEST PIECE/CASSETTE ===
    const cassetteW = slotW /2, // Slightly smaller than slot width
          cassetteH = 0.04, // Thinner height
          cassetteL = slotL - 0.02; // Slightly smaller than slot length
    const cassetteGeometry = new THREE.BoxGeometry(cassetteW, cassetteH, cassetteL);
    const cassetteMaterial = new THREE.MeshPhysicalMaterial({ 
        color: 0xffffff, 
        metalness: 0.3, 
        roughness: 0.2, 
        clearcoat: 1,
        clearcoatRoughness: 0.1
    });
    const cassette = new THREE.Mesh(cassetteGeometry, cassetteMaterial);
    cassette.visible = false; // Start hidden
    deviceGroup.add(cassette);

    // Animation state
    let isAnimatingTest = false;
    let animationStartTime = 0;
    const animationDuration = 2000; // 2 seconds total

    // Animation sequence function
    function animateTestSequence() {
        if (isAnimatingTest) return;
        isAnimatingTest = true;
        animationStartTime = performance.now();
        
        // Show cassette and position it above the tray
        cassette.visible = true;
        cassette.position.set(-.12, 1, trayOutZ + 0.5);
        cassette.rotation.x = 0; // Start flat
        
        // Open tray
        trayOut = true;
        trayTargetZ = trayOutZ;
        trayAnimating = true;
    }

    // Update animation function
    function updateTestAnimation() {
        if (!isAnimatingTest) return;
        
        const elapsed = performance.now() - animationStartTime;
        const progress = Math.min(elapsed / animationDuration, 1);
        
        if (progress < 0.3) {
            // First phase: Move cassette down to tray
            const phaseProgress = progress / 0.3;
            cassette.position.y = 0.5 - (0.5 - (trayY + trayDepth/2 + cassetteH/2)) * phaseProgress;
        } else if (progress < 0.6) {
            // Second phase: Move cassette into tray
            const phaseProgress = (progress - 0.3) / 0.3;
            cassette.position.z = trayOutZ + 0.5 - (0.5 + trayL * 0.8) * phaseProgress;
        } else if (progress < 0.8) {
            // Third phase: Close tray
            const phaseProgress = (progress - 0.6) / 0.2;
            trayTargetZ = trayOutZ - (trayOutZ - trayInZ) * phaseProgress;
            trayAnimating = true;
        } else {
            // Final phase: Hide cassette and reset state
            cassette.visible = false;
            isAnimatingTest = false;
            trayOut = false;
            trayTargetZ = trayInZ;
        }
    }

    // Modify the animation loop to include test animation
    const baseAnimate = animate;
    animate = function() {
        baseAnimate();
        updateTestAnimation();
    };

    // Animation loop (add tray animation)
    function animate() {
        if (!modelVisible) return;
        
        animationFrameId = requestAnimationFrame(animate);
        
        // Handle initial rotation animation
        if (!initialRotationComplete) {
            const currentTime = performance.now();
            const elapsedTime = (currentTime - initialRotationStartTime) / 1000;
            initialRotationProgress = Math.min(elapsedTime / initialRotationDuration, 1);
            
            // Smooth easing function
            const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
            const easedProgress = easeOutCubic(initialRotationProgress);
            
            // Rotate the device group
            deviceGroup.rotation.y = easedProgress * Math.PI * 2;
            
            // Power on when reaching threshold
            if (initialRotationProgress >= powerOnThreshold && !powerOn) {
                powerOn = true;
                button.material = buttonMaterial;
                screen.material = screenOnMaterial;
                if (button.userData.iconMeshes) {
                    for (const mesh of button.userData.iconMeshes) {
                        mesh.material = button.userData.iconMaterialOn;
                    }
                }
                togglePowerUI();
            }
            
            if (initialRotationProgress >= 1) {
                initialRotationComplete = true;
                deviceGroup.rotation.y = 0; // Reset to final position
            }
        }
        
        controls.update();
        // Animate tray
        if (trayAnimating) {
            const speed = 0.08;
            tray.position.z += (trayTargetZ - tray.position.z) * speed;
            if (Math.abs(tray.position.z - trayTargetZ) < 0.01) {
                tray.position.z = trayTargetZ;
                trayAnimating = false;
            }
        }
        renderer.render(scene, camera);
    }

    // Responsive resize
    window.addEventListener('resize', onWindowResize, false);
    function onWindowResize() {
        if (!modelVisible) return;
        const container = document.getElementById('3d-container');
        camera.aspect = container.offsetWidth / container.offsetHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.offsetWidth, container.offsetHeight);
    }

    animate();

    // === UI Overlay for the 3D Screen ===
    const screenUI = document.getElementById('screen-ui');

    // UI HTML content (styled inline for now)
    function getScreenUIHTML() {
        // Use a fixed pixel size for the overlay content, always centered
        return `
        <div id="screen-ui-inner" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden;">
          <div id="screen-ui-main" style="position:relative;display:flex;flex-direction:column;width:700px;height:420px;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;box-shadow:0 2px 24px #0004;overflow:hidden;">
            <div style="display:flex;flex-direction:row;width:100%;height:100%;">
              <div style='display:flex;flex-direction:column;align-items:flex-start;justify-content:center;width:40%;height:100%;padding:2.5em 1.2em 2.5em 2.2em;gap:1.1em;background:rgba(37,98,180,0.98);border-radius:24px 0 0 24px;'>
                <div style="display:flex;align-items:center;gap:0.7em;font-weight:bold;font-size:1.15em;color:#fff;letter-spacing:0.5px;margin-bottom:0.7em;">
                 
                </div>
                <button class='screen-btn' id='order-list-btn'><span class="menu-icon">
                    <svg class="lower" width="28" height="28" viewBox="0 0 28 28">
                        <circle cx="6" cy="22" r="4" fill="#fff"/>
                        <circle cx="22" cy="22" r="4" fill="#fff"/>
                        <circle cx="14" cy="6" r="4" fill="#fff"/>
                        <line x1="14" y1="6" x2="6" y2="22" stroke="#fff" stroke-width="3"/>
                        <line x1="14" y1="6" x2="22" y2="22" stroke="#fff" stroke-width="3"/>
                    </svg>
                </span>Order List</button>
                <button class='screen-btn' id='results-btn'><span class="menu-icon">
                    <svg class="lower" width="24" height="24" viewBox="0 0 24 24">
                        <circle cx="6" cy="6" r="2" fill="#fff"/>
                        <circle cx="12" cy="6" r="2" fill="#fff"/>
                        <circle cx="18" cy="6" r="2" fill="#fff"/>
                        <circle cx="6" cy="12" r="2" fill="#fff"/>
                        <circle cx="12" cy="12" r="2" fill="#fff"/>
                        <circle cx="18" cy="12" r="2" fill="#fff"/>
                        <circle cx="6" cy="18" r="2" fill="#fff"/>
                        <circle cx="12" cy="18" r="2" fill="#fff"/>
                        <circle cx="18" cy="18" r="2" fill="#fff"/>
                    </svg>
                </span>Results</button>
                <button class='screen-btn' id='system-btn'><span class="menu-icon">&#9881;</span>System</button>
                <button class='screen-btn disabled' id='logout-btn' disabled><span class="menu-icon">&#x23CF;</span>Log Out</button>
              </div>
              <div style='flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;height:100%;background:transparent;'>
                <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:80%;height:80%;background:radial-gradient(circle at 60% 40%, #3fa9f5 60%, #2562b4 100%);border-radius:50%;z-index:0;"></div>
                <button class='start-btn' id='start-test-btn' style="position:relative;z-index:1;background:transparent;color:#2562b4;border:4px solid #fff;box-shadow:none;">START<br><span style="font-size:0.85em;font-weight:400;">NEW TEST</span></button>
              </div>
            </div>
            <div style='position:absolute;top:1.2em;left:2.2em;right:2.2em;display:flex;flex-direction:row;align-items:center;justify-content:space-between;color:#fff;font-size:1.08em;font-weight:bold;z-index:2;'>
              <span style="display:flex;align-items:center;gap:0.5em;">ADMIN</span>
              <span style="display:flex;align-items:center;gap:0.5em;">
                <svg id="ethernet-icon" width="28" height="28" viewBox="0 0 28 28" style="margin-right:0.5em;vertical-align:middle;">
                  <circle cx="6" cy="22" r="4" fill="#fff"/>
                  <circle cx="22" cy="22" r="4" fill="#fff"/>
                  <circle cx="14" cy="6" r="4" fill="#fff"/>
                  <line x1="14" y1="6" x2="6" y2="22" stroke="#fff" stroke-width="3"/>
                  <line x1="14" y1="6" x2="22" y2="22" stroke="#fff" stroke-width="3"/>
                </svg>
              </span>
              <span style="display:flex;align-items:center;gap:0.4em;font-size:0.98em;"><span style="font-size:1.1em;">&#128197;</span> <span id="screen-date">2025-03-28</span></span>
              <span style="display:flex;align-items:center;gap:0.4em;font-size:0.98em;"><span style="font-size:1.1em;">&#128337;</span> <span id="screen-time">09:49:05</span></span>
            </div>
          </div>
        </div>
        `;
    }

    // Add CSS for buttons and scaling
    const style = document.createElement('style');
    style.innerHTML = `
    #screen-ui-inner {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: none;
    }
    #screen-ui-main {
      width: 700px; height: 420px;
      display: flex; flex-direction: column; position: relative;
      background: linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);
      border-radius: 24px; box-shadow: 0 2px 24px #0004;
      overflow: hidden;
    }
    .screen-btn {
        width: 100%; min-width: 0; padding: 0.38em 1.1em; margin-bottom: 0.18em;
        background: rgba(255,255,255,0.10); color: #fff; border: none; border-radius: 18px;
        font-size: 1.13em; font-weight: 500; text-align: left; box-shadow: none;
        transition: background 0.2s, color 0.2s;
        cursor: pointer; pointer-events: auto;
        display: flex; align-items: center; gap: 0.7em;
        height: 2.7em; max-height: 2.8em;
        margin-top: 0.12em;
        border: 1.5px solid #3fa9f5;
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    .screen-btn .menu-icon {
        font-size: 1.35em; margin-right: 0.22em;
        width: 1.5em; display: inline-block; text-align: center;
        filter: none;
        color: #fff;
    }
    .screen-btn:hover { background: #3fa9f5; color: #fff; }
    .start-btn {
        width: 7vw; min-width: 90px; max-width: 160px; height: 7vw; min-height: 90px; max-height: 160px;
        background: transparent; color: #2562b4; border: 4px solid #fff; border-radius: 50%;
        font-size: 1.18em; font-weight: bold; box-shadow: none;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; pointer-events: auto;
        transition: background 0.2s, color 0.2s;
        text-align: center;
        line-height: 1.1;
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    .start-btn:hover { background: #3fa9f5; color: #fff; }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .update-ring {
        width: 100px;
        height: 100px;
        border: 6px solid #fff3;
        border-top: 6px solid #fff;
        border-radius: 50%;
        animation: rotate 2s linear infinite;
        margin-bottom: 1.5em;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #fff3;
        display: inline-block;
        margin: 0 4px;
        transition: all 0.3s;
    }

    .status-dot.active {
        background: #fff;
        animation: pulse 1s infinite;
    }

    .update-text {
        color: #fff;
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 0.5em;
        text-align: center;
    }

    .update-subtext {
        color: #fff8;
        font-size: 1em;
        text-align: center;
        margin-top: 0.3em;
    }
    `;
    document.head.appendChild(style);

    // Set UI HTML
    screenUI.innerHTML = getScreenUIHTML();

    // === Position the overlay to match the 3D screen ===
    function updateScreenUIPosition() {
        const container = document.getElementById('3d-container');
        const rect = container.getBoundingClientRect();
        // 3D screen corners in local space (centered on face)
        const sw = screenW, sh = screenH, sd = faceD/2 + screenD/2 - 0.015;
        const corners = [
            new THREE.Vector3(-sw/2,  sh/2, sd), // top-left
            new THREE.Vector3( sw/2,  sh/2, sd), // top-right
            new THREE.Vector3(-sw/2, -sh/2, sd), // bottom-left
            new THREE.Vector3( sw/2, -sh/2, sd)  // bottom-right
        ];
        corners.forEach(v => face.localToWorld(v));
        // Project to 2D
        const toScreen = v => {
            v = v.clone().project(camera);
            return {
                x: (v.x + 1) / 2 * rect.width,
                y: (1 - (v.y + 1) / 2) * rect.height
            };
        };
        const pts = corners.map(toScreen);
        // Bounding box
        const minX = Math.min(...pts.map(p => p.x)), maxX = Math.max(...pts.map(p => p.x));
        const minY = Math.min(...pts.map(p => p.y)), maxY = Math.max(...pts.map(p => p.y));
        // If fullscreen, make the menu much larger and centered
        if (screenUI.classList.contains('fullscreen')) {
            const main = screenUI.querySelector('#screen-ui-main');
            if (main) {
                main.style.position = 'absolute';
                main.style.left = '50%';
                main.style.top = '50%';
                main.style.transform = 'translate(-50%, -50%) scale(1)';
                main.style.width = '70vw';
                main.style.height = '70vh';
                main.style.maxWidth = '1100px';
                main.style.maxHeight = '800px';
                main.style.minWidth = '400px';
                main.style.minHeight = '300px';
            }
            screenUI.style.left = '0';
            screenUI.style.top = '0';
            screenUI.style.width = '100vw';
            screenUI.style.height = '100vh';
            screenUI.style.opacity = 1;
            screenUI.style.display = 'flex';
            return;
        }
        // Set overlay position/size to bounding box
        screenUI.style.left = `${rect.left + minX}px`;
        screenUI.style.top = `${rect.top + minY}px`;
        screenUI.style.width = `${maxX - minX}px`;
        screenUI.style.height = `${maxY - minY}px`;
        // Hide overlay if screen is not facing user, or fade out as it turns away
        const normal = new THREE.Vector3(0, 0, 1); // local z+
        normal.applyQuaternion(face.getWorldQuaternion(new THREE.Quaternion()));
        const screenWorldPos = face.getWorldPosition(new THREE.Vector3());
        const camDir = camera.position.clone().sub(screenWorldPos).normalize();
        const dot = normal.dot(camDir);
        let opacity = 0;
        if (dot > 0.2) {
            // Fade in as dot goes from 0.2 to 0.9
            opacity = Math.min(1, Math.max(0, (dot - 0.2) / 0.7));
            screenUI.style.display = 'block';
        } else {
            screenUI.style.display = 'none';
        }
        screenUI.style.opacity = opacity;
        // Set up clip-path polygon for the UI content
        const content = screenUI.firstElementChild;
        if (content) {
            content.style.position = 'absolute';
            content.style.left = '0';
            content.style.top = '0';
            content.style.width = '100%';
            content.style.height = '100%';
            // Calculate polygon points relative to bounding box
            const rel = p => `${((p.x - minX) / (maxX - minX) * 100).toFixed(2)}% ${((p.y - minY) / (maxY - minY) * 100).toFixed(2)}%`;
            const poly = [pts[0], pts[1], pts[3], pts[2]].map(rel).join(', ');
            content.style.clipPath = `polygon(${poly})`;
            content.style.webkitClipPath = `polygon(${poly})`;
            // Make only the content interactive
            screenUI.style.pointerEvents = 'none';
            content.style.pointerEvents = 'auto';
            // --- SCALE UI TO FIT ---
            // Find the main UI (fixed aspect ratio)
            const main = content.querySelector('#screen-ui-main');
            if (main) {
                const targetW = 700, targetH = 420, targetAspect = targetW / targetH;
                const boxW = maxX - minX, boxH = maxY - minY, boxAspect = boxW / boxH;
                let scale;
                if (boxAspect > targetAspect) {
                    // Fit by height
                    scale = boxH / targetH;
                } else {
                    // Fit by width
                    scale = boxW / targetW;
                }
                main.style.position = 'absolute';
                main.style.left = '50%';
                main.style.top = '50%';
                main.style.transform = `translate(-50%, -50%) scale(${scale})`;
                main.style.width = `${targetW}px`;
                main.style.height = `${targetH}px`;
                main.style.maxWidth = 'none';
                main.style.maxHeight = 'none';
            }
        }
    }

    // Show/hide overlay based on power state and screen facing
    function updateScreenUIVisibility() {
        // Only show if powered on and screen is facing camera
        if (!powerOn) {
            screenUI.style.display = 'none';
            return;
        }
        // Calculate screen normal in world space
        const normal = new THREE.Vector3(0, 0, 1); // local z+
        normal.applyQuaternion(face.getWorldQuaternion(new THREE.Quaternion()));
        // Camera direction (from screen to camera)
        const screenWorldPos = face.getWorldPosition(new THREE.Vector3());
        const camDir = camera.position.clone().sub(screenWorldPos).normalize();
        // Dot product: >0 means facing camera, <0 means away
        const dot = normal.dot(camDir);
        // Threshold: only show if mostly facing camera
        if (dot > 0.2) {
            screenUI.style.display = 'block';
        } else {
            screenUI.style.display = 'none';
        }
    }

    // Update overlay on resize/animation
    window.addEventListener('resize', () => {
        updateScreenUIPosition();
    });

    // Also update after each render (in animate)
    const origAnimate = animate;
    animate = function() {
        origAnimate();
        updateScreenUIPosition();
        updateScreenUIVisibility();
    };

    // Update overlay when power toggles
    function togglePowerUI() {
        updateScreenUIVisibility();
        updateScreenUIPosition();
    }

    // Patch power button click handler
    const origOnMouseClick = onMouseClick;
    onMouseClick = function(event) {
        const prevPower = powerOn;
        origOnMouseClick(event);
        if (!prevPower && powerOn) {
            resetToMainMenu();
        }
        if (powerOn !== prevPower) togglePowerUI();
    };

    // Initial UI state
    updateScreenUIVisibility();
    updateScreenUIPosition();

    // === Button event handlers ===
    function addScreenUIHandlers() {
        document.getElementById('order-list-btn').onclick = () => {
            if (powerOn) {
                showOrderList();
            }
        };
        document.getElementById('results-btn').onclick = () => {
            if (powerOn) {
                showResultsDashboard();
            }
        };
        document.getElementById('system-btn').onclick = () => {
            if (powerOn) {
                showSystemMenu();
            }
        };
        document.getElementById('logout-btn').onclick = () => {
            powerOn = false;
            button.material = buttonOffMaterial;
            screen.material = screenOffMaterial;
            if (button.userData.iconMeshes) {
                for (const mesh of button.userData.iconMeshes) {
                    mesh.material = button.userData.iconMaterialOff;
                }
            }
            togglePowerUI();
        };
        document.getElementById('start-test-btn').onclick = () => {
            if (powerOn && !isAnimatingTest) {
                animateTestSequence();
            }
        };
    }

    // Function to show order list modal
    function showOrderList() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        // Save current menu to restore later
        if (!main.dataset.original) {
            main.dataset.original = main.innerHTML;
        }

        // Dummy order data
        const orders = [
            { id: 'ORD001', patient: 'John Smith', date: '2024-03-28', status: 'Pending' },
            { id: 'ORD002', patient: 'Sarah Johnson', date: '2024-03-27', status: 'Completed' },
            { id: 'ORD003', patient: 'Michael Brown', date: '2024-03-26', status: 'In Progress' },
            { id: 'ORD004', patient: 'Emily Davis', date: '2024-03-25', status: 'Completed' },
            { id: 'ORD005', patient: 'Robert Wilson', date: '2024-03-24', status: 'Pending' }
        ];

        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="order-list-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Order List</h2>
                </div>
                <div id="order-list-container" style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    ${orders.map((order, i) => `
                        <div class="order-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;gap:1.2em;box-shadow:0 2px 8px #0002;opacity:0;transform:translateY(30px);transition:opacity 0.5s ${0.1*i+0.2}s,transform 0.5s ${0.1*i+0.2}s;">
                            <div style="flex:1;">
                                <div style="font-size:1.18em;font-weight:600;color:#fff;">${order.patient}</div>
                                <div style="font-size:0.98em;color:#e0e8f8;margin-top:2px;">${order.id}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;align-items:flex-end;">
                                <span style="font-size:1em;color:#fff;">${order.date}</span>
                                <span style="
                                    padding: 5px 14px;
                                    border-radius: 16px;
                                    font-size: 0.9em;
                                    font-weight: 600;
                                    background: ${order.status === 'Completed' ? '#d6f5e6' : order.status === 'In Progress' ? '#fff7e0' : '#ffe6e6'};
                                    color: ${order.status === 'Completed' ? '#1a7f4c' : order.status === 'In Progress' ? '#b97a00' : '#c0392b'};
                                    border: 1.5px solid ${order.status === 'Completed' ? '#a3e4c7' : order.status === 'In Progress' ? '#ffe0a3' : '#f5b7b1'};
                                    box-shadow: 0 1px 4px #0001;
                                    margin-top: 4px;
                                ">
                                    ${order.status}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <style>
            #order-list-container::-webkit-scrollbar { width: 0; background: transparent; }
            #order-list-container { scrollbar-width: none; }
            </style>
        `;

        // Animate in the cards
        setTimeout(() => {
            document.querySelectorAll('.order-card').forEach((el) => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            });
        }, 100);

        // Back button handler
        setTimeout(() => {
            const backBtn = document.getElementById('order-list-back-btn');
            if (backBtn) {
                backBtn.onclick = () => {
                    main.innerHTML = main.dataset.original;
                    addScreenUIHandlers();
                };
            }
        }, 0);
    }

    // Show animated results dashboard
    function showResultsDashboard() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        // Save current menu to restore later
        if (!main.dataset.original) {
            main.dataset.original = main.innerHTML;
        }
        // Dummy results data
        const results = [
            { test: 'Glucose', value: 98, unit: 'mg/dL', status: 'Normal', color: '#1abc9c' },
            { test: 'Cholesterol', value: 210, unit: 'mg/dL', status: 'High', color: '#e67e22' },
            { test: 'Hemoglobin', value: 13.5, unit: 'g/dL', status: 'Normal', color: '#3498db' },
            { test: 'Vitamin D', value: 18, unit: 'ng/mL', status: 'Low', color: '#e74c3c' },
            { test: 'Calcium', value: 9.2, unit: 'mg/dL', status: 'Normal', color: '#9b59b6' },
            { test: 'Iron', value: 55, unit: 'mcg/dL', status: 'Low', color: '#e74c3c' },
            { test: 'Potassium', value: 4.1, unit: 'mmol/L', status: 'Normal', color: '#1abc9c' }
        ];
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="results-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Results</h2>
                </div>
                <div id="results-anim-list" style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    ${results.map((r, i) => `
                        <div class="result-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;gap:1.2em;box-shadow:0 2px 8px #0002;opacity:0;transform:translateY(30px);transition:opacity 0.5s ${0.1*i+0.2}s,transform 0.5s ${0.1*i+0.2}s;">
                            <div style="flex:1;">
                                <div style="font-size:1.18em;font-weight:600;color:#fff;">${r.test}</div>
                                <div style="font-size:0.98em;color:#e0e8f8;margin-top:2px;">${r.status}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;align-items:flex-end;">
                                <span class="result-value" data-value="${r.value}" style="font-size:1.7em;font-weight:700;color:${r.color};">0</span>
                                <span style="font-size:1em;color:#fff;">${r.unit}</span>
                            </div>
                            <div style="flex-basis:120px;max-width:120px;width:120px;height:18px;background:#e3e8ef55;border-radius:9px;overflow:hidden;margin-left:1.2em;">
                                <div class="result-bar" data-value="${r.value}" style="height:100%;width:0;background:${r.color};border-radius:9px;transition:width 1.1s cubic-bezier(.6,1.5,.5,1);"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <style>
            #results-anim-list::-webkit-scrollbar { width: 0; background: transparent; }
            #results-anim-list { scrollbar-width: none; }
            </style>
        `;
        // Animate in the cards and bars
        setTimeout(() => {
            document.querySelectorAll('.result-card').forEach((el, i) => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            });
            // Animate bars and numbers
            document.querySelectorAll('.result-bar').forEach((bar, i) => {
                const val = parseFloat(bar.getAttribute('data-value'));
                let max = 250;
                if (val < 20) max = 20;
                if (val < 10) max = 15;
                bar.style.width = Math.min(100, (val / max) * 100) + '%';
            });
            document.querySelectorAll('.result-value').forEach((span) => {
                const target = parseFloat(span.getAttribute('data-value'));
                let current = 0;
                const step = target / 40;
                function animateNum() {
                    current += step;
                    if ((step > 0 && current >= target) || (step < 0 && current <= target)) {
                        span.textContent = target;
                    } else {
                        span.textContent = (Math.round(current * 100) / 100).toString();
                        requestAnimationFrame(animateNum);
                    }
                }
                animateNum();
            });
        }, 100);
        // Back button handler
        setTimeout(() => {
            const backBtn = document.getElementById('results-back-btn');
            if (backBtn) {
                backBtn.onclick = () => {
                    main.innerHTML = main.dataset.original;
                    addScreenUIHandlers();
                };
            }
        }, 0);
    }

    // Show system menu in 3x2 grid
    function showSystemMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        // Responsive gap/height for 3D/fullscreen
        const isFullscreen = document.getElementById('screen-ui')?.classList.contains('fullscreen');
        const gridGap = isFullscreen ? '1.2em' : '0.5em';
        const gridHeight = isFullscreen ? '260px' : '150px';
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="sys-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">System Menu</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:${gridGap};width:90%;max-width:500px;height:${gridHeight};align-items:center;justify-items:center;">
                        <button class='screen-btn' id="status-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                        Status
                        </button>
                        <button class='screen-btn' id="update-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                         Update Tests
                        </button>
                        <button class='screen-btn' id="settings-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                         Settings
                        </button>
                        <button class='screen-btn' id="maintenance-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                          Maintenance
                        </button>
                    </div>
                </div>
            </div>
        `;
        setTimeout(() => {
            document.getElementById('status-btn').onclick = () => showStatusMenu();
            document.getElementById('update-btn').onclick = () => showUpdateMenu();
            document.getElementById('settings-btn').onclick = () => showSettingsMenu();
            document.getElementById('maintenance-btn').onclick = () => showMaintenanceMenu();
            document.getElementById('sys-back-btn').onclick = () => resetToMainMenu();
        }, 0);
    }

    // Add new Status Menu function
    function showStatusMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="status-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">System Status</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:grid;grid-template-columns:1fr;grid-template-rows:1fr 1fr;gap:1.2em;width:90%;max-width:500px;height:180px;align-items:center;justify-items:center;">
                        <button class='screen-btn' id="info-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Info Menu
                        </button>
                        <button class='screen-btn' id="event-log-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Show Event Log
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('status-back-btn').onclick = () => showSystemMenu();
        document.getElementById('info-btn').onclick = () => showInfoMenu();
        document.getElementById('event-log-btn').onclick = () => showEventLogMenu();
    }

    // Add new Update Menu function
    function showUpdateMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="update-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Update Tests</h2>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="update-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Current Version</div>
                        <div style="color:#fff;">v2.4.1</div>
                    </div>
                    <div class="update-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Available Update</div>
                        <div style="color:#e67e22;">v2.4.2</div>
                    </div>
                    <div class="update-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Last Update</div>
                        <div style="color:#fff;">2024-03-15</div>
                    </div>
                    <button id="check-updates-btn" style="background:#fff2;color:#fff;border:1px solid #fff3;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:1.1em;font-weight:600;margin-top:1em;">Check for Updates</button>
                </div>
            </div>
        `;
        document.getElementById('update-back-btn').onclick = () => showSystemMenu();
        
        // Add check for updates functionality
        document.getElementById('check-updates-btn').onclick = function() {
            main.innerHTML = `
                <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                    <div class="update-ring"></div>
                    <div class="update-text">Checking for Updates</div>
                    <div class="update-subtext">Searching for new test versions...</div>
                    <div style="margin-top: 2em;">
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                    </div>
                </div>
            `;

            // Animate dots
            const dots = main.querySelectorAll('.status-dot');
            let currentDot = 0;
            const checkInterval = setInterval(() => {
                if (currentDot > 0) {
                    dots[currentDot - 1].classList.remove('active');
                }
                dots[currentDot].classList.add('active');
                currentDot = (currentDot + 1) % dots.length;
            }, 1000);

            // Show result after 3 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                main.innerHTML = `
                    <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                        <div style="font-size: 4em; color: #fff; margin-bottom: 0.5em;">✓</div>
                        <div class="update-text">Update Check Complete</div>
                        <div class="update-subtext">New version v2.4.2 is available</div>
                    </div>
                `;

                // Return to update menu after 2 seconds
                setTimeout(() => {
                    showUpdateMenu();
                }, 2000);
            }, 3000);
        };
    }

    // Settings Menu
    function showSettingsMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="settings-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Settings</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:grid;grid-template-columns:1fr;grid-template-rows:1fr 1fr;gap:1.2em;width:90%;max-width:500px;height:180px;align-items:center;justify-items:center;">
                        <button class='screen-btn' id="preferences-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Preferences
                        </button>
                        <button class='screen-btn' id="admin-area-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Admin Area
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('settings-back-btn').onclick = () => showSystemMenu();
        document.getElementById('preferences-btn').onclick = () => showPreferencesMenu();
        document.getElementById('admin-area-btn').onclick = () => showAdminAreaMenu();
    }

    // Network Menu
    function showNetworkMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 2em 0.5em 0;border-radius:24px 24px 0 0;'>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <button id="network-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                        <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Network</h2>
                    </div>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <span style="color:#fff;font-weight:600;">DHCP</span>
                        <label class="switch">
                            <input type="checkbox" id="dhcp-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="network-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">IP Address</div>
                        <input type="text" value="192.168.1.105" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div class="network-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Subnet Mask</div>
                        <input type="text" value="255.255.255.0" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div class="network-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Gateway</div>
                        <input type="text" value="192.168.1.1" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                </div>
            </div>
        `;

        // Add styles for the toggle switch
        const style = document.createElement('style');
        style.textContent = `
            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
            }
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
            }
            input:checked + .slider {
                background-color: #1abc9c;
            }
            input:checked + .slider:before {
                transform: translateX(26px);
            }
            .slider.round {
                border-radius: 34px;
            }
            .slider.round:before {
                border-radius: 50%;
            }
        `;
        document.head.appendChild(style);

        document.getElementById('network-back-btn').onclick = () => showCommSettingsMenu();
        
        // Add DHCP toggle functionality
        const dhcpToggle = document.getElementById('dhcp-toggle');
        const inputs = document.querySelectorAll('input[type="text"]');
        
        dhcpToggle.addEventListener('change', function() {
            inputs.forEach(input => {
                input.disabled = this.checked;
                input.style.opacity = this.checked ? '0.5' : '1';
            });
        });
    }

    // Info Menu
    function showInfoMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="info-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">System Info</h2>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">IP Address</div>
                        <div style="color:#fff;">192.168.1.105</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Gateway</div>
                        <div style="color:#fff;">192.168.1.1</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">MAC Address</div>
                        <div style="color:#fff;">00:1A:2B:3C:4D:5E</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Device Name</div>
                        <div style="color:#fff;">ORALYZER-Pro-X1</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Device ID</div>
                        <div style="color:#fff;">ORX1-2024-0428</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Serial No.</div>
                        <div style="color:#fff;">SN-2024-0428-001</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">ISW ID</div>
                        <div style="color:#fff;">ISW-2024-0428</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">ISW Version</div>
                        <div style="color:#fff;">v2.4.1</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Language Version</div>
                        <div style="color:#fff;">EN-US v1.2</div>
                    </div>
                    <div class="info-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">OS Version</div>
                        <div style="color:#fff;">ORALYZER-OS v3.1.0</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('info-back-btn').onclick = () => showStatusMenu();
    }

    // Event Log Menu
    function showMaintenanceMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="maintenance-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Maintenance</h2>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="maintenance-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">System Status</div>
                        <div style="color:#1abc9c;">All Systems Normal</div>
                    </div>
                    <div class="maintenance-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Last Calibration</div>
                        <div style="color:#fff;">2024-03-01</div>
                    </div>
                    <div class="maintenance-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Next Service Due</div>
                        <div style="color:#e67e22;">2024-05-15</div>
                    </div>
                    <div class="maintenance-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Run Diagnostics</div>
                        <button style="background:#fff2;color:#fff;border:1px solid #fff3;padding:8px 16px;border-radius:8px;cursor:pointer;">Run</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('maintenance-back-btn').onclick = () => showSystemMenu();
    }

    // Users Menu
    function showUsersMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="users-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Users</h2>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="user-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:40px;height:40px;background:#fff3;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;">👤</div>
                            <div>
                                <div style="font-size:1.18em;font-weight:600;color:#fff;">Dr. Sarah Johnson</div>
                                <div style="font-size:0.9em;color:#e0e8f8;">Administrator</div>
                            </div>
                        </div>
                        <div style="color:#1abc9c;">Active</div>
                    </div>
                    <div class="user-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:40px;height:40px;background:#fff3;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;">👤</div>
                            <div>
                                <div style="font-size:1.18em;font-weight:600;color:#fff;">Dr. Michael Brown</div>
                                <div style="font-size:0.9em;color:#e0e8f8;">Technician</div>
                            </div>
                        </div>
                        <div style="color:#1abc9c;">Active</div>
                    </div>
                    <div class="user-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px #0002;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:40px;height:40px;background:#fff3;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;">👤</div>
                            <div>
                                <div style="font-size:1.18em;font-weight:600;color:#fff;">Emily Davis</div>
                                <div style="font-size:0.9em;color:#e0e8f8;">Lab Assistant</div>
                            </div>
                        </div>
                        <div style="color:#e67e22;">Away</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('users-back-btn').onclick = () => showSystemMenu();
    }

    // Always reset to main menu on power on
    function resetToMainMenu() {
        const main = document.getElementById('screen-ui-main');
        if (main) {
            main.innerHTML = getScreenUIHTML();
            addScreenUIHandlers();
        }
    }

    addScreenUIHandlers();

    // Enable pointer events only when powered on
    function updatePointerEvents() {
        screenUI.style.pointerEvents = powerOn ? 'auto' : 'none';
    }
    updatePointerEvents();
    const origTogglePowerUI = togglePowerUI;
    togglePowerUI = function() {
        origTogglePowerUI();
        updatePointerEvents();
    };

    // === Real-time clock update ===
    function updateScreenDateTime() {
        const now = new Date();
        // Format date as YYYY-MM-DD
        const dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
        // Format time as HH:MM:SS
        const timeStr = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
        const dateElem = document.getElementById('screen-date');
        const timeElem = document.getElementById('screen-time');
        if (dateElem) dateElem.textContent = dateStr;
        if (timeElem) timeElem.textContent = timeStr;
    }
    setInterval(updateScreenDateTime, 1000);
    updateScreenDateTime();

    // Event Log Menu
    function showEventLogMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="event-log-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Event Log</h2>
                </div>
                <div style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div style="background:#fff2;border-radius:16px;padding:18px 24px;box-shadow:0 2px 8px #0002;">
                        <table style="width:100%;border-collapse:collapse;color:#fff;">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.2);">
                                    <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Date/Time</th>
                                    <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">User</th>
                                    <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                    <td style="padding:12px;">2025-06-02 16:11:01</td>
                                    <td style="padding:12px;">ADMIN</td>
                                    <td style="padding:12px;">Connect Settings saved successfully</td>
                                </tr>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                    <td style="padding:12px;">2025-06-02 16:10:45</td>
                                    <td style="padding:12px;">ADMIN</td>
                                    <td style="padding:12px;">Connect server available</td>
                                </tr>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                    <td style="padding:12px;">2025-06-02 16:10:30</td>
                                    <td style="padding:12px;">ADMIN</td>
                                    <td style="padding:12px;">System startup completed</td>
                                </tr>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                    <td style="padding:12px;">2025-06-02 16:10:15</td>
                                    <td style="padding:12px;">SYSTEM</td>
                                    <td style="padding:12px;">Initializing network connection</td>
                                </tr>
                                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                    <td style="padding:12px;">2025-06-02 16:10:00</td>
                                    <td style="padding:12px;">SYSTEM</td>
                                    <td style="padding:12px;">System boot sequence started</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('event-log-back-btn').onclick = () => showStatusMenu();
    }

    // Preferences Menu
    function showPreferencesMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="preferences-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Preferences</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:grid;grid-template-columns:1fr;grid-template-rows:1fr 1fr;gap:1.2em;width:90%;max-width:500px;height:180px;align-items:center;justify-items:center;">
                        <button class='screen-btn' id="brightness-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Brightness
                        </button>
                        <button class='screen-btn' id="language-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;">
                            Language
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('preferences-back-btn').onclick = () => showSettingsMenu();
        document.getElementById('brightness-btn').onclick = () => showBrightnessMenu();
        document.getElementById('language-btn').onclick = () => showLanguageMenu();
    }

    // Brightness Menu
    function showBrightnessMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style=\"width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;\">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id=\"brightness-back-btn\" style=\"background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;\">← Back</button>
                    <h2 style=\"color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;\">Brightness</h2>
                </div>
                <div style=\"flex:1;display:flex;align-items:center;justify-content:center;width:100%;\">
                    <div style=\"display:flex;flex-direction:column;align-items:center;justify-content:center;width:90%;max-width:500px;gap:2em;\">
                        <label for=\"brightness-slider\" style=\"color:#fff;font-size:1.18em;font-weight:600;margin-bottom:1em;\">Adjust Screen Brightness</label>
                        <input id=\"brightness-slider\" type=\"range\" min=\"0\" max=\"100\" value=\"80\" style=\"width:260px;\">
                    </div>
                </div>
            </div>
        `;
        document.getElementById('brightness-back-btn').onclick = () => showPreferencesMenu();
        // Optionally: Add JS to handle brightness changes here
    }

    // Language Menu
    function showLanguageMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style=\"width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;\">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id=\"language-back-btn\" style=\"background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;\">← Back</button>
                    <h2 style=\"color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;\">Language</h2>
                </div>
                <div style=\"flex:1;display:flex;align-items:center;justify-content:center;width:100%;\">
                    <div style=\"display:grid;grid-template-columns:1fr;grid-template-rows:1fr 1fr;gap:1.2em;width:90%;max-width:500px;height:180px;align-items:center;justify-items:center;\">
                        <button class='screen-btn' id=\"lang-de-btn\" style=\"border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;\">Deutsch</button>
                        <button class='screen-btn' id=\"lang-en-btn\" style=\"border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;display:flex;align-items:center;justify-content:center;gap:0.7em;width:100%;min-width:0;\">English</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('language-back-btn').onclick = () => showPreferencesMenu();
        // Optionally: Add JS to handle language selection here
    }

    // Admin Area Menu
    function showAdminAreaMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        // Determine if fullscreen (screen-ui has class 'fullscreen')
        const isFullscreen = document.getElementById('screen-ui')?.classList.contains('fullscreen');
        // Smaller gap/height for 3D, larger for fullscreen
        const gridGap = isFullscreen ? '1.2em' : '0.5em';
        const gridHeight = isFullscreen ? '420px' : '290px';
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="admin-area-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Admin Area</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div id='admin-area-grid' style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:repeat(4,1fr);gap:${gridGap};width:90%;max-width:600px;height:${gridHeight};align-items:center;justify-items:center;">
                        <button class='screen-btn' id="date-time-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Date & Time</button>
                        <button class='screen-btn' id="order-mode-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Order Mode</button>
                        <button class='screen-btn' id="manage-data-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Manage Data</button>
                        <button class='screen-btn' id="manufacturer-reset-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Manufacturer Reset</button>
                        <button class='screen-btn' id="user-management-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">User Management</button>
                        <button class='screen-btn' id="comm-settings-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Communication Settings</button>
                        <button class='screen-btn' id="update-software-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Update Software</button>
                        <button class='screen-btn' id="shutdown-settings-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Shutdown Settings</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('admin-area-back-btn').onclick = () => showSettingsMenu();
        document.getElementById('date-time-btn').onclick = () => showDateTimeMenu();
        document.getElementById('manage-data-btn').onclick = () => showManageDataMenu();
        document.getElementById('user-management-btn').onclick = () => showUserManagementMenu();
        document.getElementById('comm-settings-btn').onclick = () => showCommSettingsMenu();
        // Add more handlers as needed for other buttons
    }

    // User Management Menu
    function showUserManagementMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;

        let isUserManagementEnabled = true;
        let users = [
            { name: 'Dr. Sarah Johnson', role: 'Administrator', status: 'Active' },
            { name: 'Dr. Michael Brown', role: 'Technician', status: 'Active' },
            { name: 'Emily Davis', role: 'Lab Assistant', status: 'Away' }
        ];

        function renderUserRows() {
            return users.map((user, i) => `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                    <td style="padding:12px;">${user.name}</td>
                    <td style="padding:12px;">${user.role}</td>
                    <td style="padding:12px;"><span style="color:${user.status==='Active' ? '#1abc9c' : user.status==='Away' ? '#e67e22' : '#e74c3c'};">${user.status}</span></td>
                    <td style="padding:12px;">
                        <button class="edit-user-btn" data-index="${i}" style="background:#fff2;color:#fff;border:1px solid #fff3;padding:4px 12px;border-radius:6px;margin-right:8px;">Edit</button>
                        <button class="delete-user-btn" data-index="${i}" style="background:#fff2;color:#e74c3c;border:1px solid #e74c3c;padding:4px 12px;border-radius:6px;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateToggleState() {
            const toggleText = document.getElementById('toggle-text');
            const userManagementContent = document.getElementById('user-management-content');
            const toggleSlider = document.querySelector('.um-switch .slider');
            if (toggleText && userManagementContent && toggleSlider) {
                toggleText.textContent = isUserManagementEnabled ? 'ON' : 'OFF';
                toggleText.style.color = isUserManagementEnabled ? '#00eaff' : '#aaa';
                userManagementContent.style.display = isUserManagementEnabled ? 'flex' : 'none';
                toggleSlider.classList.toggle('on', isUserManagementEnabled);
                toggleSlider.classList.toggle('off', !isUserManagementEnabled);
            }
            // If off, set background blue and hide content
            const umWrapper = document.getElementById('um-wrapper');
            if (umWrapper) {
                umWrapper.style.background = isUserManagementEnabled
                    ? 'linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%)'
                    : '#2562b4';
            }
        }

        main.innerHTML = `
            <div id="um-wrapper" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;overflow:hidden;">
                <div style='width:100%;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2;background:transparent;padding:1.2em 2.2em 0.5em 2.2em;'>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <button id="user-management-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                        <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">User Management</h2>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.8em;">
                        <span id="toggle-text" style="color:#00eaff;font-weight:600;font-size:1.1em;user-select:none;">ON</span>
                        <label class="um-switch" tabindex="0" style="position:relative;display:inline-block;width:48px;height:28px;vertical-align:middle;cursor:pointer;">
                            <input type="checkbox" id="um-toggle-input" ${isUserManagementEnabled ? 'checked' : ''} style="opacity:0;width:0;height:0;">
                            <span class="slider${isUserManagementEnabled ? ' on' : ' off'}" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#222;transition:background 0.3s,box-shadow 0.3s;"></span>
                        </label>
                    </div>
                </div>
                <div id="user-management-content" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;width:100%;padding:0 2.2em 1.2em 2.2em;max-height:calc(100% - 80px);overflow-y:auto;">
                    <div style="width:100%;max-width:800px;display:flex;flex-direction:column;gap:1.2em;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;gap:1em;flex-wrap:wrap;">
                            <h3 style="color:#fff;font-size:1.4em;font-weight:600;margin:0;">User List</h3>
                            <form id="add-user-form" style="display:flex;gap:0.5em;align-items:center;">
                                <input id="add-user-name" type="text" placeholder="Name" required style="padding:0.3em 0.8em;border-radius:8px;border:1px solid #3fa9f5;font-size:0.98em;min-width:90px;max-width:120px;">
                                <input id="add-user-role" type="text" placeholder="Role" required style="padding:0.3em 0.8em;border-radius:8px;border:1px solid #3fa9f5;font-size:0.98em;min-width:80px;max-width:100px;">
                                <select id="add-user-status" style="padding:0.3em 0.8em;border-radius:8px;border:1px solid #3fa9f5;font-size:0.98em;">
                                    <option value="Active">Active</option>
                                    <option value="Away">Away</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                                <button type="submit" class='screen-btn' style="background:#3fa9f5;color:#fff;border:none;padding:0.3em 1em;border-radius:10px;font-size:0.98em;box-shadow:none;min-width:80px;">Add User</button>
                            </form>
                        </div>
                        <div style="background:#fff2;border-radius:16px;padding:1.2em;box-shadow:0 2px 8px #0002;overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;color:#fff;min-width:500px;">
                                <thead>
                                    <tr style="border-bottom:1px solid rgba(255,255,255,0.2);">
                                        <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Name</th>
                                        <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Role</th>
                                        <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Status</th>
                                        <th style="text-align:left;padding:12px;font-size:1.1em;font-weight:600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body">
                                    ${renderUserRows()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <style>
            .um-switch .slider {
                background: #222;
                border-radius: 28px;
                box-shadow: 0 0 0 #00eaff00;
                transition: background 0.3s, box-shadow 0.3s;
            }
            .um-switch .slider:before {
                content: '';
                position: absolute;
                height: 20px;
                width: 20px;
                left: 4px;
                bottom: 4px;
                background: #fff;
                border-radius: 50%;
                transition: transform 0.3s, background 0.3s;
                box-shadow: 0 2px 8px #0003;
            }
            .um-switch .slider.on {
                background: #00eaff;
                box-shadow: 0 0 8px 2px #00eaff88;
            }
            .um-switch .slider.on:before {
                transform: translateX(20px);
                background: #fff;
            }
            .um-switch .slider.off {
                background: #444;
                box-shadow: none;
            }
            .um-switch .slider.off:before {
                transform: translateX(0);
                background: #eee;
            }
            .um-switch input { cursor: pointer; }
            #user-management-content::-webkit-scrollbar { width: 8px; background: #222; }
            #user-management-content { scrollbar-width: thin; }
            </style>
        `;

        document.getElementById('user-management-back-btn').onclick = () => showAdminAreaMenu();

        // Toggle logic: make the whole label clickable
        const toggleInput = main.querySelector('.um-switch input');
        const toggleLabel = main.querySelector('.um-switch');
        const toggleSlider = main.querySelector('.um-switch .slider');
        function toggleSwitch() {
            isUserManagementEnabled = !isUserManagementEnabled;
            toggleInput.checked = isUserManagementEnabled;
            updateToggleState();
        }
        toggleInput.addEventListener('change', function() {
            isUserManagementEnabled = this.checked;
            updateToggleState();
        });
        toggleLabel.addEventListener('click', function(e) {
            if (e.target !== toggleInput) {
                toggleSwitch();
            }
        });
        toggleLabel.addEventListener('keydown', function(e) {
            if (e.key === ' ' || e.key === 'Enter') {
                toggleSwitch();
            }
        });

        // Add user logic
        const addUserForm = document.getElementById('add-user-form');
        addUserForm.onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('add-user-name').value.trim();
            const role = document.getElementById('add-user-role').value.trim();
            const status = document.getElementById('add-user-status').value;
            if (name && role) {
                users.push({ name, role, status });
                document.getElementById('user-table-body').innerHTML = renderUserRows();
                addUserForm.reset();
                attachUserRowHandlers();
            }
        };

        function attachUserRowHandlers() {
            main.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    users.splice(idx, 1);
                    document.getElementById('user-table-body').innerHTML = renderUserRows();
                    attachUserRowHandlers();
                };
            });
            main.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const user = users[idx];
                    const newName = prompt('Edit name:', user.name);
                    if (newName !== null && newName.trim() !== '') {
                        user.name = newName.trim();
                        document.getElementById('user-table-body').innerHTML = renderUserRows();
                        attachUserRowHandlers();
                    }
                };
            });
        }
        attachUserRowHandlers();

        updateToggleState();
    }

    // Manage Data Menu
    function showManageDataMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:1em;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 0 0.5em 0;border-radius:24px 24px 0 0;'>
                    <button id="manage-data-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;margin-left:2em;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0 0 0 1em;">Manage Data</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:repeat(3,1fr);gap:1.8em 2.2em;padding:2.2em 2.5em 2.2em 2.5em;width:92%;max-width:520px;height:320px;align-items:center;justify-items:center;">
                        <button class='screen-btn' id="delete-methods-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">
                            Delete Methods
                        </button>
                        <button class='screen-btn' id="delete-event-log-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">
                            Delete Event Log
                        </button>
                        <button class='screen-btn' id="delete-results-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">
                            Delete Results
                        </button>
                        <button class='screen-btn' id="export-raw-data-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">
                            Export Raw Data
                        </button>
                        <button class='screen-btn' id="delete-sunset-results-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;grid-column:1/span 2;">
                            Delete Sunset Results
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('manage-data-back-btn').onclick = () => showAdminAreaMenu();
        // Add handlers for the data management buttons
        document.getElementById('delete-methods-btn').onclick = () => {
            // Handle delete methods
            console.log('Delete Methods clicked');
        };
        document.getElementById('delete-results-btn').onclick = () => {
            // Handle delete results
            console.log('Delete Results clicked');
        };
        document.getElementById('delete-sunset-results-btn').onclick = () => {
            // Handle delete sunset results
            console.log('Delete Sunset Results clicked');
        };
        document.getElementById('delete-event-log-btn').onclick = () => {
            // Handle delete event log
            console.log('Delete Event Log clicked');
        };
        document.getElementById('export-raw-data-btn').onclick = () => {
            // Handle export raw data
            console.log('Export Raw Data clicked');
        };
    }

    // Date & Time Menu
    function showDateTimeMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style=\"width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;\">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id=\"date-time-back-btn\" style=\"background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;\">← Back</button>
                    <h2 style=\"color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;\">Date & Time</h2>
                </div>
                <div style=\"flex:1;display:flex;align-items:center;justify-content:center;width:100%;\">
                    <div style=\"display:flex;flex-direction:column;align-items:center;justify-content:center;width:90%;max-width:500px;gap:2em;\">
                        <label for=\"date-input\" style=\"color:#fff;font-size:1.18em;font-weight:600;margin-bottom:0.5em;\">Set Date</label>
                        <input id=\"date-input\" type=\"date\" style=\"font-size:1.1em;padding:0.5em 1em;border-radius:8px;border:1px solid #3fa9f5;\">
                        <label for=\"time-input\" style=\"color:#fff;font-size:1.18em;font-weight:600;margin-top:1.5em;margin-bottom:0.5em;\">Set Time</label>
                        <input id=\"time-input\" type=\"time\" style=\"font-size:1.1em;padding:0.5em 1em;border-radius:8px;border:1px solid #3fa9f5;\">
                        <button class='screen-btn' id=\"save-date-time-btn\" style=\"margin-top:2em;width:180px;\">Save</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('date-time-back-btn').onclick = () => showAdminAreaMenu();
        // Optionally: Add JS to handle saving date/time
    }

    /*function showCommSettingsMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="comm-settings-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Communication Settings</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.2em;width:90%;max-width:400px;">
                        <button class='screen-btn' id="network-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Network</button>
                        <button class='screen-btn' id="connect-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Connect</button>
                        <button class='screen-btn' id="security-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Security</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('comm-settings-back-btn').onclick = () => showAdminAreaMenu();
        document.getElementById('network-btn').onclick = () => showNetworkMenu();
        document.getElementById('connect-btn').onclick = () => showConnectMenu();
        document.getElementById('security-btn').onclick = () => showSecurityMenu();
        // Add handlers for the three buttons as needed
    }

*/
     function showCommSettingsMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='position:absolute;top:0;left:0;width:auto;display:flex;align-items:center;gap:1em;padding:1.2em 0 0.5em 2.2em;z-index:2;background:transparent;'>
                    <button id="comm-settings-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                    <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Communication Settings</h2>
                </div>
                <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;">
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.2em;width:90%;max-width:400px;">
                        <button class='screen-btn' id="network-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Network</button>
                        <button class='screen-btn' id="connect-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.13em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Connect</button>
                        <button class='screen-btn' id="security-btn" style="border-radius:999px;padding:1.1em 0;font-size:1.18em;font-weight:600;background:#fff2;color:#fff;border:1.5px solid #3fa9f5;width:100%;min-width:0;justify-content:center;align-items:center;text-align:center;">Security</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('comm-settings-back-btn').onclick = () => showAdminAreaMenu();
        document.getElementById('network-btn').onclick = () => showNetworkMenu();
        document.getElementById('connect-btn').onclick = () => showConnectMenu();
        document.getElementById('security-btn').onclick = () => showSecurityMenu();
        // Add handlers for the three buttons as needed
    }

    // Connect Menu
    function showConnectMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;

        // Get current user from global JS variable
        const username = window.CURRENT_USER || "default";
        const configKey = `connectionConfig_${username}`;

        // Load saved configuration for this user
        const savedConfig = localStorage.getItem(configKey);
        let hostnameValue = "AWSMMP01P01.PDSI.CORP";
        let portValue = "8080";
        let enabledValue = true;
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            hostnameValue = config.hostname;
            // Ensure portValue is a valid number, otherwise fallback to 8080
            portValue = (config.port && !isNaN(config.port) && config.port !== "") ? config.port : "8080";
            enabledValue = config.enabled;
        }

        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 2em 0.5em 0;border-radius:24px 24px 0 0;'>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <button id="connect-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                        <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Connect</h2>
                    </div>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <span id="connect-status" style="color:#fff;font-weight:600;">On</span>
                        <label class="switch">
                            <input type="checkbox" id="connect-toggle" ${enabledValue ? "checked" : ""}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div id="connect-content" style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="connect-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Hostname</div>
                        <input id="hostname-input" type="text" value="${hostnameValue}" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div class="connect-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">PORT NO.:</div>
                        <input id="port-input" type="number" min="1" max="65535" inputmode="numeric" value="${portValue}" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div style="display:flex;gap:1em;justify-content:center;margin-top:1em;">
                        <button id="test-btn" class="connect-btn" style="background:#fff2;color:#fff;font-size:1.1em;font-weight:600;padding:0.8em 2em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">Test</button>
                        <button class="connect-btn" style="background:#fff2;color:#fff;font-size:1.1em;font-weight:600;padding:0.8em 2em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">Save</button>
                        <button class="advanced-btn" id="advanced-btn" style="background:#fff2;color:#fff;font-size:1.1em;font-weight:600;padding:0.8em 2em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">Advanced</button>
                    </div>
                </div>
            </div>
        `;

        // Add styles for the toggle switch and animations
        const style = document.createElement('style');
        style.textContent = `
            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
            }
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
            }
            input:checked + .slider {
                background-color: #1abc9c;
            }
            input:checked + .slider:before {
                transform: translateX(26px);
            }
            .slider.round {
                border-radius: 34px;
            }
            .slider.round:before {
                border-radius: 50%;
            }

            @keyframes pulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.7; }
                100% { transform: scale(1); opacity: 1; }
            }

            @keyframes rotate {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .testing-screen {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);
                border-radius: 24px;
                animation: fadeIn 0.3s ease-out;
            }

            .connection-ring {
                width: 150px;
                height: 150px;
                border: 8px solid #fff3;
                border-top: 8px solid #fff;
                border-radius: 50%;
                animation: rotate 2s linear infinite;
                margin-bottom: 2em;
            }

            .status-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #fff3;
                display: inline-block;
                margin: 0 5px;
                transition: all 0.3s;
            }

            .status-dot.active {
                background: #fff;
                animation: pulse 1s infinite;
            }

            .testing-text {
                color: #fff;
                font-size: 1.5em;
                font-weight: 600;
                margin-bottom: 1em;
                text-align: center;
            }

            .testing-subtext {
                color: #fff8;
                font-size: 1.1em;
                text-align: center;
                margin-top: 0.5em;
            }
        `;
        document.head.appendChild(style);

        document.getElementById('connect-back-btn').onclick = () => showCommSettingsMenu();
        document.getElementById('advanced-btn').onclick = () => showAdvancedMenu();
        
        // Add connect toggle functionality
        const connectToggle = document.getElementById('connect-toggle');
        const connectStatus = document.getElementById('connect-status');
        const inputs = document.querySelectorAll('input[type="text"]');
        const buttons = document.querySelectorAll('.connect-btn');
        
        connectToggle.addEventListener('change', function() {
            const isEnabled = this.checked;
            connectStatus.textContent = isEnabled ? 'On' : 'Off';
            inputs.forEach(input => {
                input.disabled = !isEnabled;
                input.style.opacity = isEnabled ? '1' : '0.5';
            });
            buttons.forEach(button => {
                button.disabled = !isEnabled;
                button.style.opacity = isEnabled ? '1' : '0.5';
            });
        });

        // Add test button functionality
        document.getElementById('test-btn').addEventListener('click', function() {
            const hostnameInput = document.getElementById('hostname-input').value.trim();
            // Replace the entire main.innerHTML for the test phase, with NO back button or toggle
            main.innerHTML = `
                <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                    <div class="connection-ring"></div>
                    <div class="testing-text">Testing Connection</div>
                    <div class="testing-subtext">Verifying hostname and port...</div>
                    <div style="margin-top: 2em;">
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                    </div>
                </div>
            `;

            // Animate dots
            const dots = main.querySelectorAll('.status-dot');
            let currentDot = 0;
            const testInterval = setInterval(() => {
                if (currentDot > 0) {
                    dots[currentDot - 1].classList.remove('active');
                }
                dots[currentDot].classList.add('active');
                currentDot = (currentDot + 1) % dots.length;
            }, 1000);

            // Show result after 5 seconds
            setTimeout(() => {
                clearInterval(testInterval);

                // Check hostname
                const isValidHostname = hostnameInput === "AWSMMP01P01.PDSI.CORP" || 
                                        hostnameInput === "AWSMMP01P02.PDSI.CORP";

                if (isValidHostname) {
                    main.innerHTML = `
                        <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                            <div style="font-size: 4em; color: #fff; margin-bottom: 0.5em;">✓</div>
                            <div class="testing-text">Connection Successful</div>
                            <div class="testing-subtext">Hostname and port are accessible</div>
                        </div>
                    `;
                } else {
                    main.innerHTML = `
                        <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#b42525 0%,#f53f3f 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                            <div style="font-size: 4em; color: #fff; margin-bottom: 0.5em;">✕</div>
                            <div class="testing-text">Connection Failed</div>
                            <div class="testing-subtext">Invalid hostname: ${hostnameInput}</div>
                            <div class="testing-subtext" style="margin-top: 1em;">Valid hostnames are:</div>
                            <div class="testing-subtext">AWSMMP01P01.PDSI.CORP</div>
                            <div class="testing-subtext">AWSMMP01P02.PDSI.CORP</div>
                        </div>
                    `;
                }

                // Return to original screen after 3 seconds
                setTimeout(() => {
                    showConnectMenu();
                }, 3000);
            }, 5000);
        });

        // Add save button functionality
        document.querySelector('.connect-btn:nth-child(2)').addEventListener('click', function() {
            const hostnameInput = document.getElementById('hostname-input').value.trim();
            const portInput = document.getElementById('port-input').value.trim();
            const enabled = document.getElementById('connect-toggle').checked;

            // Show saving animation
            main.innerHTML = `
                <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                    <div class="connection-ring"></div>
                    <div class="testing-text">Saving Configuration</div>
                    <div class="testing-subtext">Storing your connection settings...</div>
                    <div style="margin-top: 2em;">
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                    </div>
                </div>
            `;

            // Animate dots
            const dots = main.querySelectorAll('.status-dot');
            let currentDot = 0;
            const saveInterval = setInterval(() => {
                if (currentDot > 0) {
                    dots[currentDot - 1].classList.remove('active');
                }
                dots[currentDot].classList.add('active');
                currentDot = (currentDot + 1) % dots.length;
            }, 1000);

            // Show success message after 3 seconds
            setTimeout(() => {
                clearInterval(saveInterval);

                // Save per user
                const config = {
                    hostname: hostnameInput,
                    port: portInput,
                    enabled: enabled
                };
                localStorage.setItem(configKey, JSON.stringify(config));

                main.innerHTML = `
                    <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                        <div style="font-size: 4em; color: #fff; margin-bottom: 0.5em;">✓</div>
                        <div class="testing-text">Configuration Saved</div>
                        <div class="testing-subtext">Your connection settings have been updated</div>
                    </div>
                `;

                // Return to original screen after 2 seconds
                setTimeout(() => {
                    showConnectMenu();
                }, 2000);
            }, 3000);
        });
    }

    function showAdvancedMenu() {
        const main = document.getElementById('screen-ui-main');
        if (!main) return;
        main.innerHTML = `
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;position:relative;">
                <div style='width:100%;text-align:left;margin-bottom:0.7em;position:sticky;top:0;z-index:2;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);padding:1.2em 2em 0.5em 0;border-radius:24px 24px 0 0;'>
                    <div style="display:flex;align-items:center;gap:1em;">
                        <button id="advanced-back-btn" style="background:#fff2;color:#2562b4;font-size:1.1em;font-weight:600;padding:0.5em 1.6em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">← Back</button>
                        <h2 style="color:#fff;font-size:2em;font-weight:700;letter-spacing:0.5px;margin:0;">Connect Advanced</h2>
                    </div>
                </div>
                <div id="advanced-content" style="width:92%;max-width:520px;flex:1 1 auto;overflow-y:auto;display:flex;flex-direction:column;gap:1.2em;padding-bottom:1.2em;margin-top:0.2em;border-radius:18px;background:rgba(255,255,255,0.03);scrollbar-width:none;">
                    <div class="advanced-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div class="custom-dropdown" tabindex="0">
                            <div class="custom-dropdown-selected" data-value="none">Receive no orders</div>
                            <div class="custom-dropdown-list" style="display:none;">
                                <div class="custom-dropdown-option" data-value="none">Receive no orders</div>
                                <div class="custom-dropdown-option" data-value="epic">Receive orders from EPIC</div>
                            </div>
                        </div>
                    </div>
                    <div class="advanced-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Client ID</div>
                        <input type="text" value="0101" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div class="advanced-card" style="background:#fff2;border-radius:16px;padding:18px 24px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px #0002;">
                        <div style="font-size:1.18em;font-weight:600;color:#fff;">Location ID</div>
                        <input type="text" value="0101" style="background:#fff3;border:1px solid #fff4;border-radius:8px;padding:8px 12px;color:#fff;font-size:1em;width:100%;">
                    </div>
                    <div style="display:flex;gap:1em;justify-content:center;margin-top:1em;">
                        <button id="advanced-save-btn" class="advanced-btn" style="background:#fff2;color:#fff;font-size:1.1em;font-weight:600;padding:0.8em 2em;border:none;border-radius:18px;box-shadow:0 2px 8px #0002;cursor:pointer;">Save</button>
                    </div>
                </div>
            </div>
        `;

        // Add custom styles for the custom dropdown
        const style = document.createElement('style');
        style.textContent = `
            .custom-dropdown {
                position: relative;
                width: 100%;
                user-select: none;
                background: linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);
                border-radius: 12px;
                border: 1px solid #fff4;
                color: #fff;
                font-size: 1em;
                padding: 8px 12px;
                box-shadow: 0 2px 8px #0002;
                cursor: pointer;
            }
            .custom-dropdown-selected {
                padding: 4px 0;
            }
            .custom-dropdown-list {
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 4px 16px #0003;
                z-index: 10;
                margin-top: 4px;
                overflow: hidden;
            }
            .custom-dropdown-option {
                padding: 12px;
                color: #2562b4;
                background: #fff;
                cursor: pointer;
                transition: background 0.2s, color 0.2s;
            }
            .custom-dropdown-option:hover, .custom-dropdown-option.active {
                background: #3fa9f5;
                color: #fff;
            }
        `;
        document.head.appendChild(style);

        // Add back button functionality
        document.getElementById('advanced-back-btn').onclick = () => showConnectMenu();

        // Custom dropdown JS
        const dropdown = main.querySelector('.custom-dropdown');
        const selected = dropdown.querySelector('.custom-dropdown-selected');
        const list = dropdown.querySelector('.custom-dropdown-list');
        const options = dropdown.querySelectorAll('.custom-dropdown-option');

        dropdown.addEventListener('click', function(e) {
            // Only toggle if not clicking an option
            if (!e.target.classList.contains('custom-dropdown-option')) {
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            }
        });
        options.forEach(option => {
            option.addEventListener('click', function(e) {
                selected.textContent = this.textContent;
                selected.dataset.value = this.dataset.value;
                list.style.display = 'none';
                // Optionally, mark the selected option
                options.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
        // Close dropdown if clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                list.style.display = 'none';
            }
        });
        // Keyboard accessibility
        dropdown.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                let idx = Array.from(options).findIndex(opt => opt.classList.contains('active'));
                options.forEach(opt => opt.classList.remove('active'));
                idx = (idx + 1) % options.length;
                options[idx].classList.add('active');
                options[idx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                let idx = Array.from(options).findIndex(opt => opt.classList.contains('active'));
                options.forEach(opt => opt.classList.remove('active'));
                idx = (idx - 1 + options.length) % options.length;
                options[idx].classList.add('active');
                options[idx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Escape') {
                list.style.display = 'none';
            }
        });

        // Add save button functionality
        document.getElementById('advanced-save-btn').addEventListener('click', function() {
            const main = document.getElementById('screen-ui-main');
            if (!main) return;

            // --- FIX: Read values BEFORE replacing the DOM ---
            // Get dropdown value
            const dropdown = main.querySelector('.custom-dropdown');
            const orderSource = dropdown.querySelector('.custom-dropdown-selected').dataset.value;
            // Get client and location IDs
            const textInputs = main.querySelectorAll('input[type="text"]');
            const clientId = textInputs[0] ? textInputs[0].value : '';
            const locationId = textInputs[1] ? textInputs[1].value : '';

            // Show saving animation
            main.innerHTML = `
                <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                    <div class="connection-ring"></div>
                    <div class="testing-text">Saving Configuration</div>
                    <div class="testing-subtext">Storing your advanced settings...</div>
                    <div style="margin-top: 2em;">
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                        <div class="status-dot"></div>
                    </div>
                </div>
            `;

            // Animate dots
            const dots = main.querySelectorAll('.status-dot');
            let currentDot = 0;
            const saveInterval = setInterval(() => {
                if (currentDot > 0) {
                    dots[currentDot - 1].classList.remove('active');
                }
                dots[currentDot].classList.add('active');
                currentDot = (currentDot + 1) % dots.length;
            }, 1000);

            // Show success message after 3 seconds
            setTimeout(() => {
                clearInterval(saveInterval);

                // Save advanced settings
                const config = {
                    orderSource: orderSource,
                    clientId: clientId,
                    locationId: locationId
                };
                localStorage.setItem(`advancedConfig_${window.CURRENT_USER || "default"}`, JSON.stringify(config));

                main.innerHTML = `
                    <div class="testing-screen" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(90deg,#2562b4 0%,#3fa9f5 100%);border-radius:24px;animation:fadeIn 0.3s ease-out;">
                        <div style="font-size: 4em; color: #fff; margin-bottom: 0.5em;">✓</div>
                        <div class="testing-text">Configuration Saved</div>
                        <div class="testing-subtext">Your advanced settings have been updated</div>
                    </div>
                `;

                // Return to original screen after 2 seconds
                setTimeout(() => {
                    showAdvancedMenu();
                }, 2000);
            }, 3000);
        });
    }

    document.querySelector('.connect-btn:last-child').addEventListener('click', () => showAdvancedMenu());
</script>
{% endblock %}

