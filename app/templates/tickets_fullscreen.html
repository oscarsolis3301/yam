{% extends "base.html" %}

{% block head %}
<style>
/* Full screen layout - work around sidebar */
.tickets-container {
    display: flex;
    height: calc(100vh - 80px); /* Account for sidebar banner */
    width: calc(100vw - 56px); /* Account for sidebar width */
    margin: 0; /* Remove margins since we're using absolute positioning */
    padding: 0;
    background: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
    position: absolute;
    top: 80px; /* Position flush with banner */
    left: 56px; /* Position flush with sidebar */
}

/* Left side - Ticket table */
.tickets-table-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    margin: 0;
    padding: 0;
}

/* Top bar */
.tickets-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 15, 15, 0.98);
    backdrop-filter: blur(10px);
}

.top-bar-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.select-all-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #ffffff;
}

.sort-dropdown {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
    color: #cccccc;
}

.top-bar-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.export-btn {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.pagination {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: #cccccc;
}

.pagination button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 6px;
    color: #ffffff;
    transition: all 0.3s ease;
}

.filter-toggle {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

/* Table */
.tickets-table {
    flex: 1;
    overflow: auto;
    background: rgba(15, 15, 15, 0.98);
}

.tickets-table table {
    width: 100%;
    border-collapse: collapse;
}

.tickets-table th {
    background: rgba(15, 15, 15, 0.98);
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    color: #ffffff;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.tickets-table th.sortable {
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
}

.tickets-table th.sortable:hover {
    background: rgba(139, 92, 246, 0.15);
    transform: translateY(-1px);
}

.tickets-table th.sortable.active {
    background: rgba(139, 92, 246, 0.2);
    color: #8b5cf6;
}

.tickets-table th.sortable .sort-icon {
    margin-left: 5px;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.tickets-table th.sortable:hover .sort-icon {
    opacity: 1;
}

.tickets-table th.sortable.active .sort-icon {
    opacity: 1;
    color: #8b5cf6;
}

.tickets-table td {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 14px;
    vertical-align: middle;
    color: #cccccc;
}

.tickets-table tr {
    cursor: pointer;
    transition: all 0.3s ease;
}

.tickets-table tr:hover {
    background: rgba(139, 92, 246, 0.08);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
}

/* Status column */
.status-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dropdown {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
}

.status-open { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
.status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
.status-resolved { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
.status-closed { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }

/* Priority column */
.priority-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.priority-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.priority-low { background: #22c55e; }
.priority-medium { background: #3b82f6; }
.priority-high { background: #fbbf24; }
.priority-urgent { background: #ef4444; }

/* Requester column */
.requester-cell {
    display: flex;
    align-items: center;
    gap: 10px;
}

.requester-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    border: 2px solid rgba(139, 92, 246, 0.3);
}

.requester-name {
    font-size: 14px;
    color: #ffffff;
}

/* Right side - Filter sidebar */
.filter-sidebar {
    flex: 1;
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    max-width: 350px;
    min-width: 300px;
    background: rgba(15, 15, 15, 0.98);
}

/* Filter tabs */
.filter-tabs {
    display: flex;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.filter-tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #888888;
    transition: all 0.3s ease;
}

.filter-tab.active {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6);
    color: white;
}

/* Filter content */
.filter-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.filter-title {
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
}

.reset-btn {
    background: none;
    border: none;
    color: #8b5cf6;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

/* Filter fields */
.filter-field {
    margin-bottom: 20px;
}

.filter-label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #cccccc;
}

.filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
    transition: all 0.3s ease;
}

.filter-input:focus {
    outline: none;
    border-color: #8b5cf6;
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.filter-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
    transition: all 0.3s ease;
}

/* Filter tags */
.filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.filter-tag {
    background: rgba(139, 92, 246, 0.15);
    color: #8b5cf6;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    border: 1px solid rgba(139, 92, 246, 0.3);
}

.filter-tag .remove {
    cursor: pointer;
    color: #8b5cf6;
    transition: all 0.3s ease;
}

/* Apply filters button */
.apply-filters-btn {
    background: linear-gradient(135deg, #8b5cf6, #8b5cf6);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    width: 100%;
    margin-top: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.apply-filters-btn:hover {
    background: linear-gradient(135deg, #7c3aed, #7c3aed);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

/* Checkbox styling */
.ticket-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #8b5cf6;
}

/* Enhanced hover effects */
.export-btn:hover {
    background: linear-gradient(135deg, #7c3aed, #7c3aed);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

.filter-toggle:hover {
    background: linear-gradient(135deg, #7c3aed, #7c3aed);
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

.pagination button:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.5);
    transform: translateY(-1px);
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.pagination button:disabled:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    transform: none;
}

.filter-tab:hover {
    background: rgba(139, 92, 246, 0.1);
    color: #8b5cf6;
}

.reset-btn:hover {
    color: #7c3aed;
    transform: scale(1.05);
}

.filter-tag .remove:hover {
    color: #7c3aed;
    transform: scale(1.2);
}

/* Enhanced status dropdown hover effects */
.status-dropdown:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Enhanced requester avatar hover effects */
.requester-avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

/* Custom scrollbar styling to match YAM theme */
.tickets-table::-webkit-scrollbar {
    width: 8px;
}

.tickets-table::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.tickets-table::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.3);
    border-radius: 4px;
}

.tickets-table::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.5);
}

.filter-content::-webkit-scrollbar {
    width: 6px;
}

.filter-content::-webkit-scrollbar-track {
    background: transparent;
}

.filter-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.filter-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Enhanced table row styling */
.tickets-table tr {
    transition: all 0.3s ease;
}

.tickets-table tr:hover {
    background: rgba(139, 92, 246, 0.08);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
}

/* Enhanced table cell styling */
.tickets-table td {
    transition: all 0.3s ease;
}

/* Loading spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .tickets-container {
        flex-direction: column;
    }
    
    .filter-sidebar {
        max-width: none;
        min-width: auto;
    }
}

/* Ticket Modal Styles */
.ticket-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999999;
    animation: overlayFadeIn 0.2s ease-out;
}

.ticket-modal {
    background: #1a1a1a;
    border-radius: 16px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    animation: modalBounceIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
}

.ticket-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: #2a2a2a;
    position: relative;
    flex-shrink: 0;
}

.ticket-modal-header h3 {
    margin: 0;
    color: #ffffff;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ticket-modal-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #ffffff;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 16px;
    right: 20px;
    z-index: 10;
}

.ticket-modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.ticket-modal-content {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.ticket-modal-content::-webkit-scrollbar {
    width: 4px;
}

.ticket-modal-content::-webkit-scrollbar-track {
    background: transparent;
}

.ticket-modal-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.ticket-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.ticket-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ticket-section h4 {
    margin: 0 0 12px 0;
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.ticket-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.ticket-field:last-child {
    border-bottom: none;
}

.ticket-field-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
    font-weight: 500;
}

.ticket-field-value {
    color: #ffffff;
    font-size: 12px;
    font-weight: 500;
    text-align: right;
    max-width: 60%;
    word-break: break-word;
}

.ticket-description {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
}

.ticket-description h4 {
    margin: 0 0 12px 0;
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.ticket-description-text {
    color: #ffffff;
    font-size: 13px;
    line-height: 1.5;
    margin: 0;
}

.ticket-timeline {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ticket-timeline h4 {
    margin: 0 0 12px 0;
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.timeline-item {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
    margin-top: 2px;
}

.timeline-content {
    flex: 1;
}

.timeline-action {
    color: #ffffff;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 2px;
}

.timeline-meta {
    color: rgba(255, 255, 255, 0.7);
    font-size: 11px;
}

.ticket-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
}

.ticket-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
}

.ticket-action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.ticket-status {
    padding: 3px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 10px;
    font-weight: 600;
}

.ticket-status-open {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.ticket-status-pending {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.ticket-status-resolved {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.ticket-status-closed {
    background: rgba(158, 158, 158, 0.2);
    color: #9e9e9e;
    border: 1px solid rgba(158, 158, 158, 0.3);
}

.ticket-priority {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ticket-priority-high {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.3);
}

.ticket-priority-medium {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.ticket-priority-low {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.ticket-priority-urgent {
    background: rgba(233, 30, 99, 0.2);
    color: #e91e63;
    border: 1px solid rgba(233, 30, 99, 0.3);
}

/* Modal animations */
@keyframes overlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes modalBounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-100px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@media (max-width: 768px) {
    .ticket-modal {
        width: 98%;
        max-height: 95vh;
    }
    
    .ticket-details {
        grid-template-columns: 1fr;
    }
    
    .ticket-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="tickets-container">
    <!-- Left side - Ticket table -->
    <div class="tickets-table-section">
        <!-- Top bar -->
        <div class="tickets-top-bar">
            <div class="top-bar-left">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="selectAll" class="ticket-checkbox">
                    <label for="selectAll">Select all</label>
                </div>
                <div class="sort-dropdown" id="sortDropdown">
                    Sort by: <span id="currentSortField">Last Modified</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            <div class="top-bar-right">
                <button class="export-btn">
                    <i class="bi bi-arrow-up"></i>
                    Export
                </button>
                <div class="pagination">
                    <button><i class="bi bi-chevron-left"></i></button>
                    <span>1 - 32 of 32</span>
                    <button><i class="bi bi-chevron-right"></i></button>
                </div>
                <button class="filter-toggle" id="filterToggle">
                    <i class="bi bi-funnel"></i>
                </button>
            </div>
        </div>
        
        <!-- Table -->
        <div class="tickets-table">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th class="sortable" data-sort="status">
                            Status 
                            <span class="sort-icon">
                                <i class="bi bi-chevron-up"></i>
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </th>
                        <th class="sortable" data-sort="subject">
                            Subject 
                            <span class="sort-icon">
                                <i class="bi bi-chevron-up"></i>
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </th>
                        <th class="sortable" data-sort="priority">
                            Priority 
                            <span class="sort-icon">
                                <i class="bi bi-chevron-up"></i>
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </th>
                        <th class="sortable" data-sort="updated_at">
                            Last Modified 
                            <span class="sort-icon">
                                <i class="bi bi-chevron-up"></i>
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </th>
                        <th class="sortable" data-sort="requester">
                            Requester 
                            <span class="sort-icon">
                                <i class="bi bi-chevron-up"></i>
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody id="ticketsTableBody">
                    <!-- Tickets will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Right side - Filter sidebar -->
    <div class="filter-sidebar" id="filterSidebar">
        <!-- Filter tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-tab="basic">Basic filter</button>
            <button class="filter-tab" data-tab="advanced">Advanced filter</button>
        </div>
        
        <!-- Filter content -->
        <div class="filter-content">
            <div class="filter-header">
                <span class="filter-title">Filter</span>
                <button class="reset-btn">Reset</button>
            </div>
            
            <!-- Search field -->
            <div class="filter-field">
                <label class="filter-label">Q Search fields</label>
                <input type="text" class="filter-input" id="searchInput" placeholder="Search tickets, subjects, categories... (Ctrl+K)">
                <div class="filter-tags" id="searchTags"></div>
            </div>
            
            <!-- Agents -->
            <div class="filter-field">
                <label class="filter-label">Agents</label>
                <input type="text" class="filter-input" placeholder="Search agents...">
                <div class="filter-tags">
                </div>
            </div>
            
            <!-- Created -->
            <div class="filter-field">
                <label class="filter-label">Created</label>
                <select class="filter-select">
                    <option value="any">Any</option>
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="this_week">This week</option>
                    <option value="this_month">This month</option>
                </select>
                <div class="filter-tags" id="createdTags"></div>
            </div>
            
            <!-- Status -->
            <div class="filter-field">
                <label class="filter-label">Status</label>
                <select class="filter-select" id="statusFilter">
                    <option value="all">All</option>
                    <option value="unresolved">All Unresolved</option>
                    <option value="open">Open</option>
                    <option value="pending">Pending</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <div class="filter-tags" id="statusTags">
                </div>
            </div>
            
            <!-- Requesters -->
            <div class="filter-field">
                <label class="filter-label">Requesters</label>
                <input type="text" class="filter-input" placeholder="Search name or email">
            </div>
            
            <!-- Departments -->
            <div class="filter-field">
                <label class="filter-label">Departments</label>
                <input type="text" class="filter-input" placeholder="Select">
            </div>
            
            <!-- Groups -->
            <div class="filter-field">
                <label class="filter-label">Groups</label>
                <input type="text" class="filter-input" placeholder="Select">
            </div>
            
            <!-- Due by -->
            <div class="filter-field">
                <label class="filter-label">Due by</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="overdue">
                    <label for="overdue" style="margin: 0;">Overdue</label>
                </div>
            </div>
            
            <!-- Apply filters button -->
            <button class="apply-filters-btn">Apply filters</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for sorting
let currentSortField = 'updated_at';
let currentSortDirection = 'desc';
let allTickets = [];
let filteredTickets = [];
let currentPage = 1;
let ticketsPerPage = 20;
let activeFilters = {};
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    // Load tickets from API
    loadTickets();
    
    // Filter toggle functionality
    document.getElementById('filterToggle').addEventListener('click', function() {
        const sidebar = document.getElementById('filterSidebar');
        sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
    });
    
    // Filter tabs functionality
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.ticket-checkbox:not(#selectAll)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Remove filter tags
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove')) {
            const filterType = e.target.parentElement.getAttribute('data-filter-type');
            const filterValue = e.target.parentElement.getAttribute('data-filter-value');
            removeFilter(filterType, filterValue);
        }
    });
    
    // Add sorting functionality to table headers
    document.querySelectorAll('.tickets-table th.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const sortField = this.getAttribute('data-sort');
            handleSort(sortField);
        });
    });
    
    // Add pagination functionality
    setupPagination();
    
    // Add filter functionality
    setupFilters();
});

function setupPagination() {
    const prevBtn = document.querySelector('.pagination button:first-child');
    const nextBtn = document.querySelector('.pagination button:last-child');
    
    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadTickets();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        // We'll get the total pages from the server response
        currentPage++;
        loadTickets();
    });
}

function setupFilters() {
    // Search field
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
        applyFilter('search', this.value);
    });
    
    // Status filter - dropdown functionality
    const statusSelect = document.getElementById('statusFilter');
    statusSelect.addEventListener('change', function() {
        applyFilter('status', this.value);
    });
    
    // Created filter
    const createdSelect = document.querySelector('.filter-select');
    createdSelect.addEventListener('change', function() {
        const value = this.value.toLowerCase().replace(' ', '_');
        applyFilter('created', value);
    });
    
    // Requesters filter
    const requestersInput = document.querySelector('.filter-input[placeholder="Search name or email"]');
    requestersInput.addEventListener('input', function() {
        applyFilter('requesters', this.value);
    });
    
    // Departments filter
    const departmentsInput = document.querySelector('.filter-input[placeholder="Select"]');
    departmentsInput.addEventListener('input', function() {
        applyFilter('departments', this.value);
    });
    
    // Groups filter
    const groupsInput = document.querySelector('.filter-input[placeholder="Select"]');
    groupsInput.addEventListener('input', function() {
        applyFilter('groups', this.value);
    });
    
    // Overdue filter
    const overdueCheckbox = document.getElementById('overdue');
    overdueCheckbox.addEventListener('change', function() {
        applyFilter('overdue', this.checked);
    });
    
    // Reset filters button
    const resetBtn = document.querySelector('.reset-btn');
    resetBtn.addEventListener('click', function() {
        resetAllFilters();
    });
    
    // Apply filters button
    const applyBtn = document.querySelector('.apply-filters-btn');
    applyBtn.addEventListener('click', function() {
        applyAllFilters();
    });
}

function applyFilter(filterType, value) {
    if (value && value.trim() !== '' && value !== false) {
        activeFilters[filterType] = value;
    } else if (value === false) {
        // Handle boolean false values (like unchecked checkboxes)
        delete activeFilters[filterType];
    } else {
        delete activeFilters[filterType];
    }
    
    // Update filter tags display
    updateFilterTags();
    
    // Add debouncing for search input
    if (filterType === 'search') {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterTickets();
        }, 300);
    } else {
        filterTickets();
    }
}

function updateFilterTags() {
    // Clear existing filter tags
    document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.remove();
    });
    
    // Add tags for active filters
    Object.entries(activeFilters).forEach(([type, value]) => {
        if (value && value !== 'all' && value !== 'any') {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.setAttribute('data-filter-type', type);
            tag.setAttribute('data-filter-value', value);
            tag.innerHTML = `
                ${getFilterDisplayName(type, value)}
                <span class="remove">&times;</span>
            `;
            
            // Add to appropriate container
            const container = document.getElementById(`${type}Tags`) || document.querySelector('.filter-tags');
            container.appendChild(tag);
        }
    });
}

function getFilterDisplayName(type, value) {
    const displayNames = {
        'search': `Search: "${value}"`,
        'status': `Status: ${value.charAt(0).toUpperCase() + value.slice(1)}`,
        'priority': `Priority: ${value.charAt(0).toUpperCase() + value.slice(1)}`,
        'created': `Created: ${value.replace('_', ' ')}`,
        'overdue': 'Overdue Only'
    };
    
    return displayNames[type] || `${type}: ${value}`;
}

function removeFilter(filterType, filterValue) {
    delete activeFilters[filterType];
    filterTickets();
    
    // Remove the filter tag from UI
    const tag = document.querySelector(`[data-filter-type="${filterType}"][data-filter-value="${filterValue}"]`);
    if (tag) {
        tag.remove();
    }
}

function resetAllFilters() {
    activeFilters = {};
    
    // Clear all filter inputs
    document.querySelectorAll('.filter-input').forEach(input => {
        input.value = '';
    });
    
    // Reset select dropdowns
    document.querySelectorAll('.filter-select').forEach(select => {
        if (select.id === 'statusFilter') {
            select.value = 'all';
        } else {
            select.selectedIndex = 0;
        }
    });
    
    document.getElementById('overdue').checked = false;
    
    // Clear filter tags
    document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.remove();
    });
    
    filterTickets();
}

function applyAllFilters() {
    // This function is called when the "Apply filters" button is clicked
    // The filters are already being applied in real-time, so this just ensures everything is up to date
    filterTickets();
}

function filterTickets() {
    // Reset to first page when filtering
    currentPage = 1;
    
    // Reload tickets with new filters (server-side filtering)
    loadTickets();
}

// Server-side pagination - no need for client-side slicing

function updatePagination(totalTickets = null, totalPages = null) {
    // Use provided values or calculate from filteredTickets
    const total = totalTickets || filteredTickets.length;
    const pages = totalPages || Math.ceil(total / ticketsPerPage);
    const startTicket = total > 0 ? (currentPage - 1) * ticketsPerPage + 1 : 0;
    const endTicket = Math.min(currentPage * ticketsPerPage, total);
    
    const paginationText = document.querySelector('.pagination span');
    paginationText.textContent = `${startTicket} - ${endTicket} of ${total}`;
    
    // Update button states
    const prevBtn = document.querySelector('.pagination button:first-child');
    const nextBtn = document.querySelector('.pagination button:last-child');
    
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === pages;
    
    // Add visual feedback for disabled buttons
    if (prevBtn.disabled) {
        prevBtn.style.opacity = '0.5';
        prevBtn.style.cursor = 'not-allowed';
    } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
    }
    
    if (nextBtn.disabled) {
        nextBtn.style.opacity = '0.5';
        nextBtn.style.cursor = 'not-allowed';
    } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
    }
}

function loadTickets() {
    // Show loading state
    showLoadingState();
    
    // Build query parameters from active filters
    const params = new URLSearchParams();
    
    // Add current filters
    if (activeFilters.search) params.append('search', activeFilters.search);
    if (activeFilters.status && activeFilters.status !== 'all') params.append('status', activeFilters.status);
    if (activeFilters.priority && activeFilters.priority !== 'all') params.append('priority', activeFilters.priority);
    if (activeFilters.created && activeFilters.created !== 'any') params.append('created', activeFilters.created);
    if (activeFilters.overdue) params.append('overdue', 'true');
    
    // Add sorting
    params.append('sort_by', currentSortField);
    params.append('sort_direction', currentSortDirection);
    
    // Add pagination
    params.append('page', currentPage);
    params.append('per_page', ticketsPerPage);
    
    fetch(`/api/tickets?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            hideLoadingState();
            if (data.tickets) {
                allTickets = data.tickets;
                filteredTickets = data.tickets; // Server-side filtering
                updatePagination(data.total, data.total_pages);
                displayTickets(filteredTickets);
            }
        })
        .catch(error => {
            hideLoadingState();
            console.error('Error loading tickets:', error);
            // Fallback to sample data for demonstration
            allTickets = generateSampleTickets();
            filteredTickets = [...allTickets];
            updatePagination();
            displayTickets(filteredTickets);
        });
}

function showLoadingState() {
    const tbody = document.getElementById('ticketsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #888888;">
                <div class="loading-spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(139, 92, 246, 0.3); border-top: 4px solid #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top: 16px; font-size: 16px;">Loading tickets...</div>
            </td>
        </tr>
    `;
}

function hideLoadingState() {
    // Loading state will be replaced when displayTickets is called
}

function generateSampleTickets() {
    const statuses = ['Open', 'Pending', 'Resolved', 'Closed'];
    const priorities = ['Low', 'Medium', 'High', 'Urgent'];
    const subjects = [
        'Network connectivity issue',
        'Software installation request',
        'Password reset needed',
        'Hardware malfunction',
        'Email configuration problem',
        'VPN access request',
        'Printer setup assistance',
        'System performance issue'
    ];
    
    const tickets = [];
    for (let i = 1; i <= 32; i++) {
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const priority = priorities[Math.floor(Math.random() * priorities.length)];
        const subject = subjects[Math.floor(Math.random() * subjects.length)];
        const requesterId = Math.floor(Math.random() * 10) + 1;
        const updatedAt = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
        
        tickets.push({
            id: 1990000 + i,
            status: status,
            subject: subject,
            priority: priority,
            requester_id: requesterId,
            updated_at: updatedAt.toISOString()
        });
    }
    return tickets;
}

function displayTickets(tickets) {
    const tbody = document.getElementById('ticketsTableBody');
    tbody.innerHTML = '';
    
    if (tickets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #888888;">
                    <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                    <div style="font-size: 16px; margin-bottom: 8px;">No tickets found</div>
                    <div style="font-size: 14px;">Try adjusting your filters or search criteria</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tickets.forEach(ticket => {
        const row = document.createElement('tr');
        
        // Generate requester avatar
        const requesterName = `User ${ticket.requester_id}`;
        const avatarInitial = requesterName.charAt(0).toUpperCase();
        const avatarColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
        const avatarColor = avatarColors[ticket.requester_id % avatarColors.length];
        
        row.innerHTML = `
            <td>
                <input type="checkbox" class="ticket-checkbox" data-ticket-id="${ticket.id}">
            </td>
            <td>
                <div class="status-cell">
                    <button class="status-dropdown status-${ticket.status.toLowerCase()}">
                        ${ticket.status}
                    </button>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </td>
            <td>${ticket.subject} #INC-${ticket.id}</td>
            <td>
                <div class="priority-cell">
                    <div class="priority-dot priority-${ticket.priority.toLowerCase()}"></div>
                    ${ticket.priority}
                    <i class="bi bi-chevron-down"></i>
                </div>
            </td>
            <td>${formatDate(ticket.updated_at)}</td>
            <td>
                <div class="requester-cell">
                    <div class="requester-avatar" style="background-color: ${avatarColor}">
                        ${avatarInitial}
                    </div>
                    <span class="requester-name">${requesterName}</span>
                </div>
            </td>
        `;
        
        // Add click event to the entire row
        row.addEventListener('click', (e) => {
            // Don't trigger if clicking on checkbox or dropdown buttons
            if (e.target.closest('.ticket-checkbox') || e.target.closest('.status-dropdown') || e.target.closest('.priority-cell i')) {
                return;
            }
            showTicketModal(ticket);
        });
        
        // Add status dropdown functionality
        const statusDropdown = row.querySelector('.status-dropdown');
        if (statusDropdown) {
            statusDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                showStatusDropdown(ticket, statusDropdown);
            });
        }
        
        // Add priority dropdown functionality
        const priorityDropdown = row.querySelector('.priority-cell i');
        if (priorityDropdown) {
            priorityDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                showPriorityDropdown(ticket, priorityDropdown);
            });
        }
        
        tbody.appendChild(row);
    });
}

function handleSort(sortField) {
    // Toggle direction if same field, otherwise set to ascending
    if (currentSortField === sortField) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortField = sortField;
        currentSortDirection = 'asc';
    }
    
    // Update visual indicators
    updateSortIndicators();
    
    // Reload tickets with new sorting (server-side sorting)
    loadTickets();
}

function updateSortIndicators() {
    // Remove active class from all headers
    document.querySelectorAll('.tickets-table th.sortable').forEach(header => {
        header.classList.remove('active');
        const icons = header.querySelectorAll('.sort-icon i');
        icons.forEach(icon => icon.style.display = 'none');
    });
    
    // Add active class to current sort header
    const activeHeader = document.querySelector(`[data-sort="${currentSortField}"]`);
    if (activeHeader) {
        activeHeader.classList.add('active');
        const icons = activeHeader.querySelectorAll('.sort-icon i');
        if (currentSortDirection === 'asc') {
            icons[0].style.display = 'inline'; // chevron-up
            icons[1].style.display = 'none';   // chevron-down
        } else {
            icons[0].style.display = 'none';   // chevron-up
            icons[1].style.display = 'inline'; // chevron-down
        }
    }
    
    // Update top bar sort dropdown
    const sortFieldNames = {
        'status': 'Status',
        'subject': 'Subject',
        'priority': 'Priority',
        'updated_at': 'Last Modified',
        'requester': 'Requester'
    };
    
    const currentSortFieldElement = document.getElementById('currentSortField');
    if (currentSortFieldElement) {
        currentSortFieldElement.textContent = sortFieldNames[currentSortField] || currentSortField;
    }
}

// Server-side sorting - no need for client-side sorting

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Ticket Modal Functions
function showTicketModal(ticket) {
    // Generate comprehensive ticket data
    const ticketData = generateTicketData(ticket);
    
    // Create modal HTML
    const modalHTML = `
        <div id="ticketModal" class="ticket-modal-overlay">
            <div class="ticket-modal">
                <div class="ticket-modal-header">
                    <h3><i class="bi bi-ticket-detailed"></i> ${ticketData.title}</h3>
                    <button class="ticket-modal-close" onclick="closeTicketModal()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="ticket-modal-content">
                    <div class="ticket-details">
                        <div class="ticket-section">
                            <h4><i class="bi bi-info-circle"></i> Ticket Information</h4>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Ticket ID</span>
                                <span class="ticket-field-value">#INC-${ticketData.id}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Status</span>
                                <span class="ticket-field-value">
                                    <span class="ticket-status ticket-status-${ticketData.status.toLowerCase()}">${ticketData.status}</span>
                                </span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Priority</span>
                                <span class="ticket-field-value">
                                    <span class="ticket-priority ticket-priority-${ticketData.priority.toLowerCase()}">${ticketData.priority}</span>
                                </span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Category</span>
                                <span class="ticket-field-value">${ticketData.category}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Created</span>
                                <span class="ticket-field-value">${ticketData.created}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Updated</span>
                                <span class="ticket-field-value">${ticketData.updated}</span>
                            </div>
                        </div>
                        
                        <div class="ticket-section">
                            <h4><i class="bi bi-person"></i> User Information</h4>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Requester</span>
                                <span class="ticket-field-value">${ticketData.requester}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Department</span>
                                <span class="ticket-field-value">${ticketData.department}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Location</span>
                                <span class="ticket-field-value">${ticketData.location}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Contact</span>
                                <span class="ticket-field-value">${ticketData.contact}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Assigned To</span>
                                <span class="ticket-field-value">${ticketData.assignedTo}</span>
                            </div>
                            <div class="ticket-field">
                                <span class="ticket-field-label">Escalation</span>
                                <span class="ticket-field-value">${ticketData.escalation}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ticket-description">
                        <h4><i class="bi bi-chat-text"></i> Description</h4>
                        <p class="ticket-description-text">${ticketData.description}</p>
                    </div>
                    
                    <div class="ticket-timeline">
                        <h4><i class="bi bi-clock-history"></i> Timeline</h4>
                        ${ticketData.timeline.map(item => `
                            <div class="timeline-item">
                                <div class="timeline-icon ticket-priority-${item.priority}">
                                    <i class="bi ${item.icon}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-action">${item.action}</div>
                                    <div class="timeline-meta">${item.meta}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="ticket-actions">
                        <button class="ticket-action-btn" onclick="editTicket('${ticket.id}')">
                            <i class="bi bi-pencil"></i>
                            Edit Ticket
                        </button>
                        <button class="ticket-action-btn" onclick="addComment('${ticket.id}')">
                            <i class="bi bi-chat"></i>
                            Add Comment
                        </button>
                        <button class="ticket-action-btn" onclick="escalateTicket('${ticket.id}')">
                            <i class="bi bi-arrow-up"></i>
                            Escalate
                        </button>
                        <button class="ticket-action-btn" onclick="closeTicket('${ticket.id}')">
                            <i class="bi bi-check-circle"></i>
                            Close Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add click outside to close functionality
    const modalOverlay = document.getElementById('ticketModal');
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            closeTicketModal();
        }
    });
    
    // Add escape key to close functionality
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            closeTicketModal();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + K to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }
        
        // Escape to clear search
        if (e.key === 'Escape') {
            const searchInput = document.getElementById('searchInput');
            if (document.activeElement === searchInput) {
                searchInput.value = '';
                applyFilter('search', '');
            }
        }
    });
}

function generateTicketData(ticket) {
    const categories = [
        'Hardware', 'Software', 'Network', 'Access', 'Account', 'Email', 'Printing', 'Security'
    ];
    
    const departments = [
        'IT Support', 'HR', 'Finance', 'Operations', 'Sales', 'Marketing', 'Engineering'
    ];
    
    const locations = [
        'Main Office', 'Branch A', 'Branch B', 'Remote', 'HQ', 'Satellite Office'
    ];
    
    const assignees = [
        'John Smith', 'Sarah Johnson', 'Mike Davis', 'Lisa Wilson', 'David Brown', 'Emily Chen'
    ];
    
    const descriptions = [
        'User experiencing issues with network connectivity. Unable to access shared drives and email services.',
        'Software installation request for new accounting software. Need admin privileges and proper licensing.',
        'Password reset required for user account. Account has been locked due to multiple failed login attempts.',
        'Hardware malfunction reported. Computer not powering on and making unusual noises.',
        'Email configuration problem. Unable to send or receive emails through Outlook client.',
        'VPN access request for remote work. Need secure connection to company network.',
        'Printer setup assistance needed. New printer installed but not connecting to network.',
        'System performance issue. Computer running very slowly and applications taking too long to load.'
    ];
    
    const requesterName = `User ${ticket.requester_id}`;
    const category = categories[ticket.id % categories.length];
    const department = departments[ticket.requester_id % departments.length];
    const location = locations[ticket.requester_id % locations.length];
    const assignedTo = assignees[ticket.id % assignees.length];
    const description = descriptions[ticket.id % descriptions.length];
    
    // Generate timeline based on ticket status
    const timeline = [];
    const createdDate = new Date(ticket.updated_at);
    const updatedDate = new Date(ticket.updated_at);
    
    timeline.push({
        action: 'Ticket created',
        meta: `Created by ${requesterName} on ${createdDate.toLocaleDateString()}`,
        icon: 'bi-plus-circle',
        priority: 'low'
    });
    
    if (ticket.status !== 'Open') {
        timeline.push({
            action: 'Ticket assigned',
            meta: `Assigned to ${assignedTo} on ${new Date(createdDate.getTime() + 2 * 60 * 60 * 1000).toLocaleDateString()}`,
            icon: 'bi-person-check',
            priority: 'medium'
        });
    }
    
    if (ticket.status === 'Resolved' || ticket.status === 'Closed') {
        timeline.push({
            action: 'Issue resolved',
            meta: `Resolved by ${assignedTo} on ${new Date(createdDate.getTime() + 4 * 60 * 60 * 1000).toLocaleDateString()}`,
            icon: 'bi-check-circle',
            priority: 'low'
        });
    }
    
    if (ticket.status === 'Closed') {
        timeline.push({
            action: 'Ticket closed',
            meta: `Closed by ${assignedTo} on ${new Date(createdDate.getTime() + 6 * 60 * 60 * 1000).toLocaleDateString()}`,
            icon: 'bi-x-circle',
            priority: 'low'
        });
    }
    
    return {
        id: ticket.id,
        title: ticket.subject,
        status: ticket.status,
        priority: ticket.priority,
        category: category,
        created: createdDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }),
        updated: updatedDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }),
        requester: requesterName,
        department: department,
        location: location,
        contact: `${requesterName.toLowerCase().replace(' ', '.')}@company.com`,
        assignedTo: assignedTo,
        escalation: ticket.priority === 'High' || ticket.priority === 'Urgent' ? 'Level 2' : 'Level 1',
        description: description,
        timeline: timeline
    };
}

function closeTicketModal() {
    const modal = document.getElementById('ticketModal');
    if (modal) {
        modal.remove();
    }
}

function editTicket(ticketId) {
    alert(`Edit ticket ${ticketId} - This would open the edit form`);
}

function addComment(ticketId) {
    alert(`Add comment to ticket ${ticketId} - This would open the comment form`);
}

function escalateTicket(ticketId) {
    alert(`Escalate ticket ${ticketId} - This would escalate the ticket`);
}

function closeTicket(ticketId) {
    if (confirm('Are you sure you want to close this ticket?')) {
        alert(`Ticket ${ticketId} closed successfully`);
        closeTicketModal();
    }
}

function showStatusDropdown(ticket, dropdownElement) {
    const statuses = ['Open', 'Pending', 'Resolved', 'Closed'];
    const currentStatus = ticket.status;
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown-menu';
    dropdown.style.cssText = `
        position: absolute;
        background: #2a2a2a;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 8px 0;
        z-index: 1000;
        min-width: 120px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    
    statuses.forEach(status => {
        const item = document.createElement('div');
        item.className = 'status-dropdown-item';
        item.textContent = status;
        item.style.cssText = `
            padding: 8px 16px;
            cursor: pointer;
            color: #ffffff;
            font-size: 14px;
            transition: background 0.2s;
        `;
        
        if (status === currentStatus) {
            item.style.background = 'rgba(139, 92, 246, 0.2)';
            item.style.color = '#8b5cf6';
        }
        
        item.addEventListener('click', () => {
            updateTicketStatus(ticket.id, status);
            dropdown.remove();
        });
        
        item.addEventListener('mouseenter', () => {
            if (status !== currentStatus) {
                item.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        });
        
        item.addEventListener('mouseleave', () => {
            if (status !== currentStatus) {
                item.style.background = 'transparent';
            }
        });
        
        dropdown.appendChild(item);
    });
    
    // Position dropdown
    const rect = dropdownElement.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    // Add to page
    document.body.appendChild(dropdown);
    
    // Close dropdown when clicking outside
    const closeDropdown = (e) => {
        if (!dropdown.contains(e.target) && !dropdownElement.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeDropdown);
    }, 100);
}

function showPriorityDropdown(ticket, dropdownElement) {
    const priorities = ['Low', 'Medium', 'High', 'Urgent'];
    const currentPriority = ticket.priority;
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'priority-dropdown-menu';
    dropdown.style.cssText = `
        position: absolute;
        background: #2a2a2a;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 8px 0;
        z-index: 1000;
        min-width: 120px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    
    priorities.forEach(priority => {
        const item = document.createElement('div');
        item.className = 'priority-dropdown-item';
        item.textContent = priority;
        item.style.cssText = `
            padding: 8px 16px;
            cursor: pointer;
            color: #ffffff;
            font-size: 14px;
            transition: background 0.2s;
        `;
        
        if (priority === currentPriority) {
            item.style.background = 'rgba(139, 92, 246, 0.2)';
            item.style.color = '#8b5cf6';
        }
        
        item.addEventListener('click', () => {
            updateTicketPriority(ticket.id, priority);
            dropdown.remove();
        });
        
        item.addEventListener('mouseenter', () => {
            if (priority !== currentPriority) {
                item.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        });
        
        item.addEventListener('mouseleave', () => {
            if (priority !== currentPriority) {
                item.style.background = 'transparent';
            }
        });
        
        dropdown.appendChild(item);
    });
    
    // Position dropdown
    const rect = dropdownElement.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    // Add to page
    document.body.appendChild(dropdown);
    
    // Close dropdown when clicking outside
    const closeDropdown = (e) => {
        if (!dropdown.contains(e.target) && !dropdownElement.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeDropdown);
    }, 100);
}

function updateTicketStatus(ticketId, newStatus) {
    fetch(`/api/tickets/${ticketId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            console.log(`Ticket ${ticketId} status updated to ${newStatus}`);
            loadTickets(); // Reload to show the change
        } else {
            console.error('Error updating ticket status:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating ticket status:', error);
    });
}

function updateTicketPriority(ticketId, newPriority) {
    fetch(`/api/tickets/${ticketId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: newPriority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            console.log(`Ticket ${ticketId} priority updated to ${newPriority}`);
            loadTickets(); // Reload to show the change
        } else {
            console.error('Error updating ticket priority:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating ticket priority:', error);
    });
}
</script>
{% endblock %} 